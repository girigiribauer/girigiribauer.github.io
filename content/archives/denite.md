+++
date = "2017-01-25T19:57:53+09:00"
title = "unite.vim 改め denite.nvim を導入した話"
tags = [
  "Vim",
]
draft = true
author = "girigiribauer"
layout = "archives"
categories = [
  "tech",
]

+++
denite.nvim を導入した話です。



## introduction

Vim を使い出すようになってから色々とカスタマイズをしていったものの、
unite.vim に関してだけは以前からずっと馴染めずにおりました。

誤解のないように言っておきますが、
決して使い勝手が悪いからとかそういう理由からではなく、
**僕のスキルレベルと概念理解が追いついていなかった** のです。

そして使わなくなって早数年、
unite.vim の後継である denite.nvim がリリースされ、
**そろそろ使いこなせるようになろう** と思い立ったところです。

きっと僕と同じく使いこなせてない人は一定いるだろうと思うので
そういった方のためにメモっておきます。



## 事前準備

先に入れておくべきものがあります。

* Vim 8.0 (or NeoVim)
* Python 3
* dein.vim (or neobundle.vim)

正直 NeoVim のことは知らない子なので分かりませんが、
素直に Vim 8.0 にアップデートしました。

ところで NeoVim って Python 3 で動いてるんですかね？

denite.nvim が NeoVim と Vim 8.0 の両方で動くものの、
Vim 8.0 の方は Python 3 が必要だということです。

これも

    brew install python3

で入れました。

正直 Python のことは知らない子なので分かりませんが、
2系と3系でめんどくさいというイメージしかありません。

ただ Homebrew で入れたら `/usr/local/bin/python3` に入ったので
もともと入ってる2系とバッティングすることは無さそうです。

（余談ですが、 ansible が Python の2系で、頑張って3系に移行させようとしてるのを見て大変そうだなあと思って横目で見てます）

最後に Vim のプラグインマネージャは入れておきましょう。
Vim に限らず、プラグインマネージャは何らか入ってないと今の時代つらいですね。

ちなみに今回はせっかくなので、
開発のストップした neobundle.vim から dein.vim へ併せて移行しております。

<https://github.com/Shougo/dein.vim>

こちらの導入の話をメモると話それちゃうのでやめておきます。



## インストール

ここからは dein.vim を導入しているという前提でメモっておきます。

denite.nvim をインストールしていきます。

<https://github.com/Shougo/denite.nvim>

dein.vim 導入済みであれば、
きっと bundles.toml などの **TOML ファイルにプラグイン情報を集約** しているはずなので、

    [[plugins]]
    repo = 'Shougo/denite.nvim'

上記のように追記するだけで OK ですね。



## 自らを denite/unite インターフェースに適合させる

ぶっちゃけインストールしただけでメリットが享受できる類のものではありません。

きちんと概念を理解し、時には標準に従い、
時にはカスタマイズすることで自由に使いこなせるようになってくると思います。

※インストール直後からこれを書いてますが、順にメモりながら自分も理解が深まればと思います。

* [level.0 - とにかく使ってみる](#level0)
* [level.1 - 標準のキーマッピングを知る](#level1)
* [level.2 - 少し踏み込んで使ってみる](#level2)
* [level.3 - 最低限の設定を行う](#level3)



## level.0 - とにかく使ってみる {#level0}

とにかく使うだけなら、以下が一番シンプルだと思います。
先に何かテキストファイルを開いておいてください。

    :Denite line

**Enter キーを押すと、今開いているファイルの行 (line) が全て候補になってます。**

そのまま何かキーワードを入力します。
ここでは該当記事（この記事）の Hugo / Markdown ファイル上で `denite` と入力しています。

![:Denite line で denite を絞り込んだ結果][1]

ファイルの中で `denite` というキーワードを含む行がハイライトされ、
**キーワードを1文字1文字入力するたびに、マッチするものだけが候補に残っていきます。**

さらにそのまま Enter キーを押すと、
カーソルがある一番上の候補となっているものが選択されたことになり、
**選択した行に移動** して denite が終了します。

### 何が起きているのか整理する

結局やっているのは **インクリメンタルサーチ** なんですよね。
実際に上のように動かしてみると良く分かります。

unite.vim から、さらに言えば Emacs の anything.el などからの共通の話になるのですが、
こういった系のプラグインのすごいところは、
**色々なもの (source)** から **インクリメンタルに探し **て **色々できる (action)** ことが、**共通のインターフェースとなっている** ことにあります。

上でやったのはファイルの行というのを source にして、
キーワードを入力し、それを含む行を絞り込み、
選択して（実際は選択してないけど一番上を選択したことにする）、
移動という action をする、ということをやってます。

### インクリメンタルサーチは超便利

探すという行為をもっと優れた行為にするために、
インクリメンタルサーチはとても良い選択肢だと思います。

別の記事（<http://girigiribauer.com/archives/1873/>）で似たようなことを書いていますが、
コマンド履歴においても、
ファイルを探す行為においても、
順に過去を遡って探したりフォルダを順に開いて探したりするのは
非常に効率が悪いです。

**インクリメンタルサーチを利用して何かを探す、何かを実行する、
その探すものは自由に決められる、
探したものをどうするかも自由に決められる、というのが denite/unite だと思います。**



## level.1 - 標準のキーマッピングを知る {#level1}

何はともかく、まずは help を読みましょう。

    :h denite

それなりに多いので標準のキーマッピングだけが載っているとこだけでも読みましょう。

    :h denite_default_key_mappings

色々載っていますが、正直覚えられませんし覚える必要もないです。
まずは **最低限の操作ができるところだけを拾い読みしていきます。**

### モードに関わらず常に使えるキーマッピング

| key | mapping | memo |
|---|---|---|
| \<Esc\> | \<denite:leave_mode\> | denite を終了する |
| \<CR\> | \<denite:do_action:default\> | default の action を実行する |

これはシンプルですね。どのモードであろうと Esc キーを押せば元の状態に戻ります。
Enter で default の action を実行したのは先の例の通りです。

### insert モードのときのみ使えるキーマッピング

| key | mapping | memo |
|---|---|---|
| \<C-G\> | \<denite:move_to_next_line\> | 下の候補に移動 |
| \<C-T\> | \<denite:move_to_previous_line\> | 上の候補に移動 |
| \<C-O\> | \<denite:enter_mode:normal\> | normal モードへ切り替え |

正直なところ、上下の候補に移動するキーマッピングが一番しっくりきません。

**Ctrl-G で下、 Ctrl-T で上移動** です。

**違和感満点** なのですが、これはこういうものとして一旦受け取っておきましょう。
まずは最低限の標準の操作を知るところから。

### normal モードのときのみ使えるキーマッピング

| key | mapping | memo |
|---|---|---|
| i | \<denite:enter_mode:insert\> | insert モードへ切り替え |
| j | \<denite:move_to_next_line\> | 下の候補に移動 |
| k | \<denite:move_to_previous_line\> | 上の候補に移動 |

normal モードでは比較的普通の normal モードで使えていたキーマッピングがそのまま使えます。

i キーの insert モードへ切り替えは普通に使いますし、
そもそも上下移動に j/k キーを使うのに違和感を感じているようなら、
**vimtutor からやり直した方がいいでしょう。**
denite どうこう言ってる場合じゃない気がします。

とりあえずこれだけ知っておけば、
最低限の操作はできるんじゃないかと思います。

最低限の操作だけまとめると・・・

* **候補の上下移動は insert モードでは \<C-G\>/\<C-T\> 、 normal モードでは j/k**
* **モード切り替えは insert->normal が \<C-O\> 、 normal-\>insert が i**
* **default の action 実行は Enter 、 終了したいときは Esc**

それ以外にも normal モードのときに候補を複数選択するときに Space キーを用いるなどはありますが、
最低限ということで省略しておきます。



## level.2 - 少し踏み込んで使ってみる {#level2}

カスタマイズは次に置いておいて、
もう少しヘルプに沿って踏み込んで使ってみます。



## level.3 - 最低限の設定を行う {#level3}

毎回 `:Denite line` などと入力して候補も追加で入力して・・・とやっていると面倒なので、
よく使う source のキーマッピングとオプション設定だけでもしておきたいと思います。

本格的なカスタマイズはまた後にして、今回は本当に最低限の設定にします。

> Denite can accept a list of strings, separated with ":", after
> the name of sources.  You must escape ":" and "\" with "\"
> in parameters themselves.



## まとめ

 [1]: /img/2017/01/denite01.png

