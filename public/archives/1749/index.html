<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="http://girigiribauer.com/css/style.css">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://girigiribauer.com/index.xml">

    <title>Vagrant で SSH の接続ポート番号を変える、という発想がそもそも間違ってた - ばうあーろぐ</title>
    <meta property='og:title' content="Vagrant で SSH の接続ポート番号を変える、という発想がそもそも間違ってた - ばうあーろぐ">
    <meta property="og:type" content="article">

    <meta property="og:url" content="http://girigiribauer.com/archives/1749">
    
    
    <meta name="generator" content="Hugo 0.15" />
</head>
<body>
  <div class="wrapper">
    <header class="blogheader">

      <a href="/" class="blogtitle"><img src="/images/sitetitle.png" alt="ばうあーろぐ"></a>

    </header>


    <div class="maincontents" role="main">
      <header class="postheader">
        <h1 class="posttitle">Vagrant で SSH の接続ポート番号を変える、という発想がそもそも間違ってた</h1>
        <div class="poststatus">
          <span class="poststatus__date">2015年4月1日</span>
          <ul class="poststatus__tags">

            <li><i class="icon-tag"></i>Chef</li>

            <li><i class="icon-tag"></i>SSH</li>

            <li><i class="icon-tag"></i>Vagrant</li>

          </ul>
          
        </div>

      </header>

      <article class="postcontents freetext">


<p>2013年に書いていた、『Vagrant で SSH の接続ポート番号を変えると、けっこう複雑になるという話』（<a href="http://girigiribauer.com/archives/1127/" target="_blank">http://girigiribauer.com/archives/1127/</a>）という記事の続きです。</p>

<p>2013年の段階では、まだまだ考え方みたいなものがまとまりきっておらず、Vagrant が用いる接続ポート番号を変えるという方向で色々考えていたのですが、今振り返ってみるとそもそも根本の考え方を見直すべきでした。</p>

<hr />

<h2 id="vagrant-の使いどころ-考えどころ">Vagrant の使いどころ・考えどころ</h2>

<p>ざっと『Vagrant の使いどころ・考えどころ』（<a href="http://girigiribauer.com/archives/1729/" target="_blank">http://girigiribauer.com/archives/1729/</a>）に書いたのですが、Vagrant を用いる用途としては大きく2種類あると考えています。</p>

<ol>
<li><strong>ローカルの開発用</strong>としてローカルでのみ使い続ける</li>
<li><strong>本番環境の検証用</strong>として、同じレシピを仮想マシン・リモート環境にそれぞれ適用</li>
</ol>

<p>SSH の接続ポート番号を変えるという大きな理由は<strong>セキュリティ</strong>にあると思います。 デフォルトの22番ポートで使っていると外部からのアタックに弱いため、ポート番号を変えたい、そのためのレシピを書きたい、という点が根本にあると思います。</p>

<p>つまり、2.の<strong>『本番環境の検証用として、同じレシピを仮想マシン・リモート環境にそれぞれ適用』</strong>ってのがやりたいわけです。</p>

<p>もし1.が目的だったのなら、わざわざポート番号を変える必要はありません。<a href="http://girigiribauer.com/archives/1127/" target="_blank">Vagrant で SSH の接続ポート番号を変えると、けっこう複雑になるという話</a> にもあるように、ホスト OS が 2424 番、ゲスト OS が 22 番で接続している最中に、<strong>ゲスト OS を 22 番をレシピで別ポートに変更してしまうと接続が切れてしまいます。ローカルで動作しているのならわざわざ変える必要はありません。</strong>何が面倒なのかは、詳しくはそちらの記事をご覧ください。</p>

<h2 id="同じレシピをローカル-リモートに適用する">同じレシピをローカル、リモートに適用する</h2>

<p>本番環境の検証用として利用したいという用途で、 同じレシピをローカル、リモートの両方に適用したいということであれば、<strong>json ファイルに設定をくくり出してやれば OK</strong> です。</p>

<p>ローカルは Vagrant で動いていますが、リモートはそうではないので、両方で同じレシピ適用方法が可能な <strong>knife コマンド</strong>を使いましょうー。</p>

<h3 id="ローカル">ローカル</h3>

<p>以下は実際にそのまま使っているわけではないですが、<code>nodes/localhost.json</code> として Vagrant で動作しているローカル VM にレシピを適用するための設定ファイル（の一例）です</p>

<pre><code>{
  &quot;name&quot;: &quot;localhost&quot;,
  &quot;automatic&quot;: {
    &quot;ipaddress&quot;: &quot;192.168.24.24&quot;
  },

  &quot;fqdn&quot;: &quot;localhost&quot;,
  &quot;platform_family&quot;: &quot;rhel&quot;,
  &quot;platform&quot;: &quot;centos&quot;,
  &quot;platform_version&quot;: &quot;6.6&quot;,

  &quot;run_list&quot;: [
    &quot;recipe[openssh]&quot;
  ],

  &quot;openssh&quot;: {
    &quot;server&quot;: {
      &quot;port&quot;: 22,
      &quot;password_authentication&quot;: &quot;no&quot;
    }
  }
}
</code></pre>

<p>あとは knife コマンドにて、</p>

<pre><code>knife solo bootstrap localhost
</code></pre>

<p>あるいは</p>

<pre><code>knife solo prepare localhost
knife solo cook localhost
</code></pre>

<p>でレシピを適用してやるだけです。</p>

<p>Vagrant 上で openssh のレシピを適用するのですが、<strong>ポート番号は 22 から 22 に変える、みたいなレシピにしておく</strong>と良いです。変更後のポート番号を設定値としてくくり出しておきます。</p>

<p>あっ、Berkshelf の説明とか platform, platform_family とかの項目の説明は端折ってますが、また別記事にでも書いておきます。。。</p>

<h3 id="リモート">リモート</h3>

<p>同様に、リモートマシン（nodes/production.json）に対しては、</p>

<pre><code>{
  &quot;name&quot;: &quot;production&quot;,
  &quot;automatic&quot;: {
    &quot;ipaddress&quot;: &quot;123.456.789.012&quot;
  },

  &quot;fqdn&quot;: &quot;example.com&quot;,
  &quot;platform_family&quot;: &quot;rhel&quot;,
  &quot;platform&quot;: &quot;centos&quot;,
  &quot;platform_version&quot;: &quot;6.6&quot;,

  &quot;run_list&quot;: [
    &quot;recipe[openssh]&quot;
  ],

  &quot;openssh&quot;: {
    &quot;server&quot;: {
      &quot;port&quot;: 12345,
      &quot;password_authentication&quot;: &quot;no&quot;
    }
  }
}
</code></pre>

<p>同様にポート番号をくくり出しておき、それを利用してレシピを適用することで、 リモートのサーバの SSH のポート番号を変更することが可能です。</p>

<p>で、ちょっと気をつけないといけないのが、 <strong>初回のレシピ適用時と、2回目以降のレシピ適用時のポート番号が異なる点</strong>です。</p>

<p>僕は以下のように、初回のみオプションで上書きしています。</p>

<pre><code>knife solo bootstrap production -p 22 -x root
</code></pre>

<p><code>knife solo prepare --help</code> には以下のようなオプションがあり、</p>

<pre><code>-p, --ssh-port PORT              The ssh port
-x, --ssh-user USERNAME          The ssh username
</code></pre>

<p>これを利用して、初回のみポート番号を 22 で、かつ root ユーザーにてレシピ適用します。 （この段階ではもちろんパスワード認証なので、何回かパスワードの入力を求められます。）</p>

<h3 id="リモートにレシピを適用するときの注意点">リモートにレシピを適用するときの注意点</h3>

<p>それ以外にも、自分がはまったなーというものをメモっておきます。</p>

<p>初回アクセス時に <code>~/.ssh/known_hosts</code> に接続情報が保持されます。</p>

<p>「あー、ぐちゃぐちゃしてきたから、一旦リセットして最初からレシピを適用し直したいなー」というときに、 上記ファイルに残っている情報をクリアしておかないと接続ができないケースがあるようです。</p>

<p>また、さくらVPS のサービスを利用しているのですが、OS のインストールをし直した際は、少し時間を置いてからでないとうまく適用できません。焦らずコーヒーでも飲みましょう。</p>

<h2 id="まとめ">まとめ</h2>

<ul>
<li>Vagrant を用いる際の目的をはっきりさせる</li>
<li>サーバの設定値をくくり出す</li>
</ul>

<p>なお、本当にどうでもいい話ですが、ドラマ TwentyFour では、テロリストや CTU 職員が IP アドレスを指定するときに、262.xxx.xxx.xxx のような、実際には存在しない 255 を超えた数値をドラマ内で言ったりします。</p>

      </article>

      <footer class="postfooter">
<ul class="socialbuttons">
  <li>
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li>
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li>
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

        <div class="poststatus">
          <span class="poststatus__date">2015年4月1日</span>
          <ul class="poststatus__tags">

            <li><i class="icon-tag"></i>Chef</li>

            <li><i class="icon-tag"></i>SSH</li>

            <li><i class="icon-tag"></i>Vagrant</li>

          </ul>
          
        </div>

      </footer>
    </div>

      <footer class="blogfooter">
        <div class="inner">
          <ul class="links">
            <li><a href="/categories/tech/" target="_blank"><i class="icon icon-folder"></i>技術系記事を読む</a></li>
            <li><a href="/categories/twentyfour/" target="_blank"><i class="icon icon-folder"></i>TwentyFour のネタ記事を読む</a></li>
            <li><a href="/categories/tech/index.xml" target="_blank"><i class="icon icon-rss"></i>RSSで技術系の記事のみ取得（おすすめ）</a></li>
            <li><a href="/index.xml" target="_blank"><i class="icon icon-rss"></i>RSSで全ての記事を取得</a></li>
          </ul>
          <p class="attention"><i class="icon icon-attention"></i>このブログは個人の見解であり、所属する組織の公式見解ではありません</p>
          <p class="copyright"><i class="copyright-mark">&copy;</i> ばうあーろぐ Generated by <a href="https://gohugo.io/" target="_blank">Hugo</a></p>
        </div>
      </footer>
    </div>

    
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36767095-1']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>


    
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.6&appId=396423247105258";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

  </body>
</html>

