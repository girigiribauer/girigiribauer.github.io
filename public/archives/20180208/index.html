<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/github-markdown.css" type="text/css" media="all">
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="all">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://girigiribauer.com/index.xml">
    <title>Docker 再入門2018 - 実践編 - ばうあーろぐ</title>
    <meta property="og:title" content="Docker 再入門2018 - 実践編 - ばうあーろぐ">
    <meta property="og:type" content="article">
    <meta name="description" content="今回は実践編です。 コンテナ編から順に読むことをお勧めします。 目次 コンテナ編 読むと Docker のコンテナ周りがざっくり分かる コマンド編 読むと Docker コマンドを">
    <meta property="og:description" content="今回は実践編です。 コンテナ編から順に読むことをお勧めします。 目次 コンテナ編 読むと Docker のコンテナ周りがざっくり分かる コマンド編 読むと Docker コマンドを">
    <meta property="og:url" content="http://girigiribauer.com/archives/20180208/">
    <meta property="fb:app_id" content="396423247105258">
    <meta property="og:image" content="http://girigiribauer.com/img/ogimage.png">
<meta name="generator" content="Hugo 0.20.7" />
  </head>
  <body>

<div class="markdown-body">
<header>
<a href="/">ばうあーろぐ TOP へ戻る</a>
</header>


<div class="maincontents">

<h1>Docker 再入門2018 - 実践編</h1>

<div class="poststatus">
  <p>  <time datetime="2018/02/08">2018/02/08</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/docker/">Docker</a></li>
  </ul>
</div>




<p>今回は実践編です。
コンテナ編から順に読むことをお勧めします。</p>

<h2 id="index">目次</h2>

<ol>
<li><strong><a href="/archives/20180205/">コンテナ編</a></strong>

<ul>
<li>読むと Docker のコンテナ周りがざっくり分かる</li>
</ul></li>
<li><strong><a href="/archives/20180206/">コマンド編</a></strong>

<ul>
<li>読むと Docker コマンドを中心に Docker の全体像がなんとなく分かる</li>
</ul></li>
<li><strong><a href="/archives/20180207/">エコシステム編</a></strong>

<ul>
<li>読むと DockerHub のサービスの活用方法がざっくり分かる</li>
</ul></li>
<li><strong><a href="/archives/20180208/">実践編</a> （いまここ）</strong>

<ul>
<li>読むと Docker で環境構築する方法が分かる、怖くなくなる</li>
<li>自分で LAMP 環境を作ってみる</li>
<li>要件をまとめる</li>
<li>不足した部分だけ Dockerfile を書く</li>
<li>さらなる Docker 環境のカスタマイズ</li>
<li>おまけ</li>
</ul></li>
</ol>

<h2 id="自分で-lamp-環境を作ってみる">自分で LAMP 環境を作ってみる</h2>

<p>ようやくここまでたどり着きました。
そろそろ自分で LAMP 環境を作ってみましょう。</p>

<p>ちなみに <strong>当然知ってるとは思いますが、</strong>
LAMP 環境というのは <strong>Linux, Apache, MySQL(MariaDB), PHP</strong> の頭文字を利用した環境のことです。</p>

<p>もちろん今は LAMP じゃない環境が多く存在しているのは重々承知していますが、
ただ、基本でもあるこの LAMP 環境を（きちんと理解しつつ）自分で作ることが出来れば、
他の環境も自分で用意することが出来るようになるのではないでしょうか。</p>

<p>ということでやったことない人、頑張ってみましょう。</p>

<h3 id="考えることは普通のサーバ立てるときとほぼ同じ">考えることは普通のサーバ立てるときとほぼ同じ</h3>

<p>誤解を恐れず書きますが、
結局のところ <strong>Docker は薄くて軽い、小さな Linuxとほぼ同じです。</strong></p>

<p>そう考えると、検討すべきポイントもだいたい予想がつくと思います。</p>

<p>やることは <strong>普通に Linux に対して Apache 、 MySQL 、 PHP などをインストールする手順とほぼ同じです。</strong>
良く分からないという方は、これを機に一通り触れてみると良いかと思います。
この辺はフロントエンドであれ、バックエンドであれ必須項目だと思います。
良い機会だと思ってやってみましょう。</p>

<p>今回の要件は・・・どうしましょうかね。
全く公式と同じ環境だと、そのイメージを入れれば良いよね？って話になってしまうので、
ちょっとだけ違う要件を混ぜてみましょうか。</p>

<ul>
<li>Ubuntu じゃなくて、サーバに多そうな CentOS をベースにする</li>
<li>日本語周りのサポートを厚めにする（言語設定、タイムゾーン、文字コードなど）</li>
<li>データベース確認しやすくするために phpmyadmin も入れる</li>
<li>データベースに SQL を突っ込みやすくしておく</li>
</ul>

<p>今回は汎用的な LAMP 環境を作りたいのですが、
作ったあとの検証のために何か入れて動かしてみましょう。
とはいえ、特に思いつくものもないので、 WordPress でもインストールしてみましょうか。
（ただし、WordPress のイメージを使うのではなく、作った LAMP 環境にそのまま WordPress を入れてみます）</p>

<h3 id="役割ごとに-docker-コンテナを分ける">役割ごとに Docker コンテナを分ける</h3>

<p>こうした方がシンプルに Docker コンテナを管理出来ます。</p>

<ul>
<li>Web アプリケーション: Apache, PHP</li>
<li>データベース: MySQL</li>
</ul>

<p>PHP にはモジュール版（Web サーバがモジュールとして PHP を動かす）と CGI 版とがありますが、
Web サーバと PHP を分けても良いのですし、別にしても良いです。
今回は一緒にしてモジュール版で動かすため、 Apache と PHP は同じコンテナにします。</p>

<p>それとは別に、MySQL をデータベースとして用意しておきます。
MySQL のイメージについては、前回まででだいぶ掘り下げて見ているので、利用の仕方は問題ないと思います。
データベース方面は特に特殊な使い方をするわけではないので、
公式で用意されているイメージを継承して、最低限の設定のみ加えます。</p>

<h3 id="公式ドキュメントを良く読む">公式ドキュメントを良く読む</h3>

<p><img src="/img/2018/02/docker2018d-01.png" alt="docker docs - Best practices for writing Dockerfiles" /></p>

<p><strong>docker docs - Best practices for writing Dockerfiles</strong> というページが公式に用意されています。
(<a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/" target="_blank">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/</a>)</p>

<p>このブログの毎度の記事の最後には、まとめに『ドキュメントを良く読む』で締めている記事が多いのですが、
<strong>大抵の問題はドキュメントを読めば解決します。</strong></p>

<p>例えば・・・</p>

<ul>
<li>Avoid installing unnecessary packages （不必要なパッケージのインストールを避ける）</li>
<li>Minimize the number of layers (レイヤーの数を最小限に抑える、RUN などの命令1行分のこと)</li>
<li>ADD or COPY (ADD と COPY どっち使ったらいいの？)</li>
<li>Examples for Official Repositories (公式のリポジトリあるから参考にするといいよ)</li>
</ul>

<p>とか、諸々書いてあります。 <strong>本格的に書く前には一通り読みましょう。</strong></p>

<h2 id="要件をまとめる">要件をまとめる</h2>

<p>あくまで2018年1月末時点の情報です。
都度アップデートなどしましょう。</p>

<ul>
<li>CentOS 7 (latest)</li>
<li>Apache 2.4</li>
<li>MySQL 5.7</li>
<li>PHP 7.2</li>
</ul>

<p>なお、もし本番環境がすでにあって、それ向けの開発環境を作りたい場合は、
このように先に要件を全部洗い出してから、環境が可能な限り近くなるように作ると良いです。
<strong>本番環境に開発環境を合わせていきましょう。</strong></p>

<h3 id="centos">CentOS</h3>

<p>これはあくまで僕の印象値ですが、
日本では RedHat 系（CentOS はこっち）、海外では Debian 系（Ubuntu はこっち）という感じがしてます。</p>

<p>Chef のレシピや DockerHub のイメージなどで公開されているものは、大抵 Debian 系になっており、
RedHat 系をベースにしたものはあまりないです。
（海外だからなのか、サーバ用途じゃないからなのか、定かではないですが・・・。
その辺の事情知ってる方居たらぜひ教えてください！）</p>

<p>今回はサーバに CentOS が採用されているであろうことを想定して CentOS の最新版にします。</p>

<h3 id="apache">Apache</h3>

<p>Apache は 1.3, 2.0, 2.2, 2.4 とバージョンが複数ありますが、
最近まで使われていたであろう 2.2 系については、
<strong>2017年7月11日の最終版のリリースの後はセキュリティアップデートがなされていないようですので、もう使うのはやめましょう。</strong>
(<a href="https://httpd.apache.org/#apache-httpd-2234-released-end-of-life-2017-07-11" target="_blank">https://httpd.apache.org/#apache-httpd-2234-released-end-of-life-2017-07-11</a>)</p>

<p>Apache 使うなら 2.4 使いましょう。（または Apache 以外でもいいです）</p>

<h4 id="apache-設定ファイル">Apache 設定ファイル</h4>

<p>また、事前に知ってないといけないことをまとめておきます。（RedHad 系）</p>

<ul>
<li>メインの設定ファイルは通常 /etc/httpd/conf/httpd.conf にある</li>
<li>サブの設定ファイルは /etc/httpd/conf.d/ 以下に拡張子 conf で入れると昇順で読み込む</li>
</ul>

<p>これ Docker 関係なく事前に知っておくべき話です。</p>

<h3 id="mysql">MySQL</h3>

<p>MySQL は、特にこだわりもないので最新版でも入れておきましょうか。
2018年1月末時点で 5.7.20 が最新のようです。
DockerHub でも、 5.7 が提供されているようですので、そちらを入れます。</p>

<p>なお、互換性を持つ MariaDB を入れても構いません。
(<a href="https://hub.docker.com/_/mariadb/" target="_blank">https://hub.docker.com/_/mariadb/</a>)</p>

<p>ざっくり言うと、 MySQL 5.5 ≒ MariaDB 5.5 で、そこから MySQL が 5.6 になったのに対して、 MariaDB は 10.0 になってます。
<strong>より OSS 寄りなものを扱いたいなら、 MariaDB を選択した方が良いかもしれません。</strong>
こちらも話が逸れてしまうので、詳しくはおググりください。</p>

<h3 id="php">PHP</h3>

<p>PHP は 5.5, 5.6 の次が 7.0 になって、現在 7.2 が最新です。
いくつか廃止になった機能はあるものの、大部分は互換性を保っていますので、
特に問題なければ一旦最新の 7.2 を入れておきます。</p>

<p>もし万が一もっと古い PHP のバージョンの環境が必要であれば、
おそらく Docker イメージが公開されていないと思います。（現時点で 5.6 までしか用意されていませんね）</p>

<p>その場合、公式の Dockerfile を参考にしつつ、自分で古い PHP の Docker イメージを作ると良いです。
ただし、その前にその古い環境をなんとか出来ないか努力する方が先でしょうけども。</p>

<h3 id="php-のバッケージ">PHP のバッケージ</h3>

<p>PHP 本体以外に、以下のものを入れたいと思います。</p>

<ul>
<li>php-cli: コマンドラインで PHP を実行</li>
<li>php-common: 大抵依存関係で入る</li>
<li>php-devel: phpize とか拡張モジュール追加したりするやつ</li>
<li>php-gd: 画像関係</li>
<li>php-mbstring: マルチバイト文字列</li>
<li>php-mysqli: MySQL 、後述</li>
<li>php-mysqlnd: MySQL 、後述</li>
<li>php-pecl-apcu: キャッシュ機構のサポート</li>
<li>php-xml: XML</li>
<li>php-xmlrpc: XML-RPC のサポート</li>
</ul>

<p>不要なパッケージは入れなくて良いと思います。
（XML-RPC とか要らんと思うけど、一応あとで WordPress とか入れるので・・・）</p>

<p>MySQL については、PHP の公式にドキュメントが用意されています。</p>

<ul>
<li>どの API を使うか: <a href="http://php.net/manual/ja/mysqlinfo.api.choosing.php" target="_blank">http://php.net/manual/ja/mysqlinfo.api.choosing.php</a></li>
<li>どのライブラリを選ぶか: <a href="http://php.net/manual/ja/mysqlinfo.library.choosing.php" target="_blank">http://php.net/manual/ja/mysqlinfo.library.choosing.php</a></li>
</ul>

<p>この辺をざっと見て、 mysqli (API) と mysqlnd (driver) を入れることにします。</p>

<h2 id="不足した部分だけ-dockerfile-を書く">不足した部分だけ Dockerfile を書く</h2>

<p>さて、ようやく作るところまで来ました。
作業用ディレクトリを作りましょう。仮に名前を <code>my_lamp</code> とします。</p>

<p>また、 Docker の設定を行うディレクトリを <code>docker-compose.yml</code> と並列に作るので、
ファイル構成はだいたいこんな感じになりそうです。</p>

<ul>
<li>my_lamp/

<ul>
<li>docker-compose.yml</li>
<li>docker/

<ul>
<li>app/

<ul>
<li>Dockerfile</li>
</ul></li>
<li>mysql/

<ul>
<li>Dockerfile</li>
</ul></li>
<li>public/</li>
</ul></li>
</ul></li>
</ul>

<p>あーあと Web 用の公開ディレクトリが要りますね。
<code>public</code> としておきます。</p>

<p>一番最初にも書きましたが、やったことない人は <strong>読むだけじゃなく手を動かしましょうね。</strong></p>

<h3 id="docker-compose-yml">docker-compose.yml</h3>

<pre><code class="language-yaml">version: &quot;3&quot;
services:
  app:
    build:
      context: &quot;docker/app/&quot;
    ports:
      - 8093:80
    volumes:
      - &quot;./public/:/var/www/html&quot;
    depends_on:
      - mysql
  mysql:
    build:
      context: &quot;docker/mysql/&quot;
    environment:
      - MYSQL_DATABASE=sampledb
      - MYSQL_HOST=localhost
      - MYSQL_USER=root
      - MYSQL_ROOT_PASSWORD=mypassword
    volumes:
      - &quot;storage:/var/lib/mysql&quot;
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    ports:
      - 8094:80
    environment:
      - PMA_HOST=mysql
      - PMA_USER=root
      - PMA_PASSWORD=mypassword
    depends_on:
      - mysql
volumes:
  storage:
</code></pre>

<p>通常イメージを指定するところを、今回は Dockerfile を元にイメージをビルドするので、
<code>image</code> の代わりに <code>build</code> となっています。</p>

<p>抜粋します。</p>

<pre><code class="language-yaml">app:
  build:
    context: &quot;docker/app/&quot;
mysql:
  build:
    context: &quot;docker/mysql/&quot;
</code></pre>

<p>公式にあるイメージを見に行く代わりに、手元の <code>docker/app/</code> 以下にある Dockerfile をベースにして、
Docker イメージを作ります。</p>

<p>phpmyadmin については特にカスタマイズする必要がないので、
そのまま phpmyadmin が提供しているイメージを引っ張って来て利用します。
(<a href="https://github.com/phpmyadmin/docker" target="_blank">https://github.com/phpmyadmin/docker</a>)</p>

<pre><code class="language-yaml">phpmyadmin:
  image: phpmyadmin/phpmyadmin:latest
</code></pre>

<p>もう詳しく説明はしませんが、 <a href="https://hub.docker.com/r/phpmyadmin/phpmyadmin/" target="_blank">https://hub.docker.com/r/phpmyadmin/phpmyadmin/</a> に書いてある、
環境変数を適切に設定することでカスタマイズすることが可能です。</p>

<p>なお、ポート番号はそれぞれ 8093, 8094 としていますが、
使っていたりすれば他のものに変えてください。</p>

<h3 id="docker-app-dockerfile">docker/app/Dockerfile</h3>

<pre><code class="language-Dockerfile">FROM centos:7

# 各パッケージのアップデート
RUN yum -y update

# remi リポジトリの追加（remi を入れるには epel も必要）
RUN yum -y install epel-release
RUN rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm

# Apache(httpd), PHP のインストール
RUN yum -y --enablerepo=remi,remi-php72 install \
    httpd \
    php \
    php-cli \
    php-common \
    php-devel \
    php-gd \
    php-mbstring \
    php-mysqli \
    php-mysqlnd \
    php-pecl-apcu \
    php-xml \
    php-xmlrpc

# httpd.conf のログを stdout, stderr に繋ぐ
RUN ln -sf /dev/stdout /var/log/httpd/access_log &amp;&amp; \
    ln -sf /dev/stderr /var/log/httpd/error_log

# mime タイプのファイル追加
RUN ln -sf /etc/mime.types /etc/httpd/conf/mime.types

# httpd をフォアグラウンドで動かす（コンテナ内で処理が終わらない）
CMD [&quot;/usr/sbin/httpd&quot;,&quot;-D&quot;,&quot;FOREGROUND&quot;]
</code></pre>

<p>一旦正しく動作するところまでやって、後から若干のカスタマイズをします。</p>

<p>PHP 7.2 を入れるには、 yum のパッケージマネージャに remi リポジトリを追加する必要があります。
remi リポジトリを追加するには、先に epel リポジトリを入れる必要があります。
ちなみにこの辺は全然 Docker の話ではなくて、普通に CentOS7 で PHP7.2 入れるなら、という話なので、
詳しくはおググりください。たくさん記事ありますよ。</p>

<h4 id="ログの表示について">ログの表示について</h4>

<p>Docker の /dev/stdout, /dev/stderr が、
それぞれ Docker コンテナの外側から見たログになります。
なので、シンボリックリンクなどで /dev/stdout, /dev/stderr に紐づけてやれば、
そのまま外からログを確認することが出来ます。</p>

<p>追記: あと MIME 設定もないとエラー出てたんで追加しました。</p>

<h4 id="cmd-の使い方">CMD の使い方</h4>

<p>実行したいコマンドを CMD の後に続けて書きますが、
複数書きたい場合は配列っぽい書き方で上のように列挙します。</p>

<p>一番最初のコンテナ編で書いたのですが、 Docker コンテナというのは本来処理を一通り終えたら終了するものです。
apache も例外ではなく、
<strong>特に何も指定しなければバックグラウンドで動作し、メインプロセスはそのまま終了します。</strong></p>

<p><code>service httpd start</code> みたいなコマンドを打ったことがあると思いますが、
打った後はそのまま入力可能な状態に戻るかと思います。それはつまりバックグラウンド処理になっているということです。</p>

<p>フォアグラウンドで処理をさせ、apache が動いている間は主導権を返さない、ということであれば、
<strong><code>-DFOREGROUND</code> オプションをつけましょう。</strong>
(<a href="https://httpd.apache.org/docs/2.4/programs/httpd.html#options" target="_blank">https://httpd.apache.org/docs/2.4/programs/httpd.html#options</a>)</p>

<p>一旦ここまでで、とりあえず Apache + PHP は動くと思います。
<code>docker build docker/app/</code> などと入力して、ビルドできるかテストしてみましょう。</p>

<h3 id="docker-mysql-dockerfile">docker/mysql/Dockerfile</h3>

<pre><code class="language-Dockerfile">FROM mysql:5.7
</code></pre>

<p>特に設定しないのなら、公式のをそのまま使えばいいんですけどね・・・。
あとで追記するのを見越して、一旦 FROM 行だけにしておきます。</p>

<p>これはビルドできるに決まってますが、ログだけ貼り付けておきます。</p>

<pre><code class="language-txt">% docker build docker/mysql/
Sending build context to Docker daemon  2.048kB
Step 1/1 : FROM mysql:5.7
 ---&gt; f008d8ff927d
Successfully built f008d8ff927d
</code></pre>

<h3 id="最低限の動作確認">最低限の動作確認</h3>

<p>一旦ここまでで、用意した環境が一式ビルド出来るか確認してみましょう！
先に <code>public</code> ディレクトリを作っておきます。</p>

<p>さて、 <code>docker-compose build</code> を実行してみます。
それぞれの Docker イメージで <code>docker build .</code> を実行しているのと同じです。</p>

<pre><code class="language-txt">% dcom build
Building mysql
Step 1/1 : FROM mysql:5.7
 ---&gt; f008d8ff927d
Successfully built f008d8ff927d
Successfully tagged mylamp_mysql:latest
Building app
Step 1/7 : FROM centos:7
 ---&gt; ff426288ea90
Step 2/7 : RUN yum -y update
 ---&gt; Using cache
 ---&gt; da7857a866c6
Step 3/7 : RUN yum -y install epel-release
 ---&gt; Using cache
 ---&gt; 7b3d7660b892
Step 4/7 : RUN rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm
 ---&gt; Using cache
 ---&gt; 940ef752a0a8
Step 5/7 : RUN yum -y --enablerepo=remi,remi-php72 install     httpd     php     php-cli     php-common     php-devel     php-gd     php-mbstring     php-mysqli     php-mysqlnd     php-pecl-apcu     php-xml     php-xmlrpc
 ---&gt; Using cache
 ---&gt; e11733031a7a
Step 6/7 : RUN ln -sf /dev/stdout /var/log/httpd/access_log &amp;&amp;     ln -sf /dev/stderr /var/log/httpd/error_log
 ---&gt; Using cache
 ---&gt; a3033aa0525f
Step 7/7 : CMD [&quot;/usr/sbin/httpd&quot;,&quot;-D&quot;,&quot;FOREGROUND&quot;]
 ---&gt; Using cache
 ---&gt; 06c309459634
Successfully built 06c309459634
Successfully tagged mylamp_app:latest

phpmyadmin uses an image, skipping
</code></pre>

<p>出来ましたね。</p>

<p>では、 <code>docker-compose up -d</code> して <a href="http://localhost:8093" target="_blank">http://localhost:8093</a> にアクセスしてみましょう！</p>

<p><img src="/img/2018/02/docker2018d-02.png" alt="my_lamp1" /></p>

<p><strong>おおっ、表示できてます！</strong></p>

<p>さらに、 public の中に index.php を作り、 <code>&lt;?php phpinfo();</code> を書いてみましょう。</p>

<p><img src="/img/2018/02/docker2018d-03.png" alt="my_lamp2" /></p>

<p><strong>良いですね、良いですね！</strong></p>

<p>さらに DB にアクセス出来るかどうか、先ほど PHP 公式ページにあったテストコードで試してみましょう。</p>

<pre><code class="language-php">&lt;?php
// mysqli
$mysqli = new mysqli(&quot;mysql&quot;, &quot;root&quot;, &quot;mypassword&quot;, &quot;sampledb&quot;);
$result = $mysqli-&gt;query(&quot;SELECT 'Hello, dear MySQL user!' AS _message FROM DUAL&quot;);
$row = $result-&gt;fetch_assoc();
echo htmlentities($row['_message']);
</code></pre>

<p>さっきの <code>phpinfo()</code> の代わりに、こちらの mysqli を介して MySQL に接続するコードを貼り付けます。
<code>Hello, dear MySQL user!</code> というメッセージが出たでしょうか？</p>

<p>ちなみに、 Docker コンテナの中にある /etc/resolv.conf と、
外に自動的に作られた <code>mylamp_default</code> というネットワークが名前解決をしてくれているので、
<strong>mysql という名前をつけたコンテナに対して、 mysql という名前でネットワークが通ります。</strong>
なので、 app コンテナから mysql コンテナに対しては、 <strong>localhost ではなく mysql という名前で呼びましょう。</strong></p>

<p>そもそも app コンテナの中に MySQL はないのですから、 localhost という指定は間違いだと分かりますね。</p>

<p>それにしても、ネットワークの名前解決がめっちゃ便利ですね。
<strong>Docker コマンド単体で行なっていたら、この辺のネットワークも事前に作っておかないといけないのですが、
この辺もうまく Docker Compose が行なってくれています。楽すぎる・・・！</strong></p>

<p>ちなみに、昔は /etc/hosts に自動で書かれていたように思いますが・・・
（もしかするとコンテナ同士を繋げる <code>--link</code> オプションがそうなるのかもしれません、ちょっと確かじゃないです）
いずれにしても便利になったものです。</p>

<h2 id="さらなる-docker-環境のカスタマイズ">さらなる Docker 環境のカスタマイズ</h2>

<p>さて、もう少しだけ頑張ってみましょう。</p>

<p>公式のイメージは、日本語環境の場合とかはあんまり考えてくれてません。
まあ全世界共通のイメージですからある意味当然です。</p>

<ul>
<li><del>Ubuntu じゃなくて、サーバに多そうな CentOS をベースにする</del></li>
<li>日本語周りのサポートを厚めにする（言語設定、タイムゾーン、文字コードなど）</li>
<li><del>データベース確認しやすくするために phpmyadmin も入れる</del></li>
<li>データベースに SQL を突っ込みやすくしておく</li>
</ul>

<p>半分くらいは片付いているので、残り半分見直していきます。
まずは DB 側からカスタマイズしましょうか。</p>

<h3 id="docker-mysql-dockerfile-の改修">docker/mysql/Dockerfile の改修</h3>

<p>やりたいことは以下の通りです。</p>

<ul>
<li>MySQL の設定ファイルである my.cnf に日本語周りの設定を追記したい</li>
<li>コンテナ内の /docker-entrypoint-initdb.d に穴を開けて、sql を自動で実行できるようにしておきたい</li>
</ul>

<p>前者は、<code>/etc/my.cnf</code> を直接書き換えるか、 <code>/etc/mysql/conf.d/*.cnf</code> にファイルを置けるようにするか、
どちらかの方法で実現できます。</p>

<p>ちなみに <code>/etc/mysql/conf.d/docker.cnf</code> と <code>/etc/mysql/conf.d/mysql.cnf</code> はすでに存在してますので、
この辺は触らない方が良さそうですね・・・。
逆に、 <code>/etc/my.cnf</code> は Docker コンテナの中には存在していないようです。
このため、 <code>/etc/my.cnf</code> を直接書き換える（というか無いので新規作成）方法を取ります。</p>

<p><code>docker/mysql/my.cnf</code> を作りつつ、
ファイルの中身を日本語周りの設定にしておきます。</p>

<pre><code class="language-txt">[mysqld]
character-set-server=utf8mb4

[client]
default-character-set=utf8mb4
</code></pre>

<p>さらに、Dockerfile に COPY 行を追記します。</p>

<pre><code class="language-Dockerfile">FROM mysql:5.7

COPY my.cnf /etc/my.cnf
</code></pre>

<p><code>docker/mysql/initdb/</code> というディレクトリを新たに作り、
<code>docker-compose.yml</code> の方に <code>/docker-entrypoint-initdb.d</code> との穴を繋ぐための設定を書きます。</p>

<p>MySQL のところだけ抜粋するとこんな感じですね。</p>

<pre><code class="language-yaml">mysql:
  build:
    context: &quot;docker/mysql/&quot;
  environment:
    - MYSQL_DATABASE=sampledb
    - MYSQL_HOST=localhost
    - MYSQL_USER=root
    - MYSQL_ROOT_PASSWORD=mypassword
  volumes:
    - &quot;storage:/var/lib/mysql&quot;
    - &quot;./docker/mysql/initdb/:/docker-entrypoint-initdb.d&quot;
</code></pre>

<p>MySQL の方はここまでで OK ですね。</p>

<p>ちなみに、一方は Dockerfile のイメージの方に、
もう一方は docker-compose.yml の方に、つまり Docker コンテナ起動時に設定する方に書いてますが、
実際必要に応じて使い分ければ良いと思います。</p>

<p>今回は日本語設定のカスタマイズがされたイメージを作り、
そこからさらに SQL ファイルがあったときだけ必要に応じて穴をあけてファイルを突っ込める、
という感じで作っています。</p>

<h3 id="docker-app-dockerfile-の改修">docker/app/Dockerfile の改修</h3>

<p>やりたいことは以下の通りです。</p>

<ul>
<li>大元の Linux のタイムゾーンを設定する</li>
<li>php.ini を設置して日本語周りの設定を追記したい</li>
<li>httpd.conf を設置して、サーバの設定変更したい</li>
</ul>

<h4 id="タイムゾーン">タイムゾーン</h4>

<p>タイムゾーンまだでした。</p>

<p>Docker 関係ないですが、タイムゾーンの設定は
<code>/usr/share/zoneinfo/Asia/Tokyo</code> に置いてあるサンプルファイルを、
<code>/etc/localtime</code> に置いたらおっけーです。</p>

<p>Dockerfile 上で RUN のあとにシンボリックリンク貼ったらいいです。</p>

<pre><code class="language-Dockerfile">RUN ln -sf  /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
</code></pre>

<h4 id="php-ini-の日本語周り">php.ini の日本語周り</h4>

<p>php.ini は Dockerfile 上で、
httpd.conf は docker-compose.yml 上で行うことにします。</p>

<p><code>docker/app/php.ini</code> を書いておきます。</p>

<pre><code class="language-php.ini">default_charset = &quot;UTF-8&quot;

mbstring.language = Japanese

# エンコーディング、自動変換しない
mbstring.encoding_translation = Off

# 文字コード自動検出の優先順位
mbstring.detect_order = &quot;UTF-8,SJIS,EUC-JP,JIS,ASCII&quot;

date.timezone = &quot;Asia/Tokyo&quot;

# X-Powered-By ヘッダーでバージョン晒す
expose_php = On

# 使用メモリ
memory_limit = 128M

# POST リクエスト最大サイズ
post_max_size = 128M

# アップロードファイル最大サイズ
upload_max_filesize = 128M
</code></pre>

<p><code>docker/app/Dockerfile</code> に対して、最後の CMD の前あたりに以下を追記します。</p>

<pre><code class="language-Dockerfile"># PHP 設定ファイル
COPY php.ini /etc/php.ini
</code></pre>

<h4 id="httpd-conf-を自由にいじれるように">httpd.conf を自由にいじれるように</h4>

<p>さらに、 Docker のコンテナ内から httpd.conf を持ってきて、
<code>docker/app/httpd.conf</code> に配置して適当にカスタマイズします。</p>

<p>今回は別にそのままでも良いのでカスタマイズは載せませんが、
コンテナの中身を持ってくるときは以下のコマンドが便利です。</p>

<pre><code>docker exec -it mylamp_app_1 cat /etc/httpd/conf/httpd.conf &gt; httpd.conf
</code></pre>

<p>コンテナに対して端末を共有しつつ、 <code>cat</code> 以下のコマンドを実行させて、
表示された内容を自分のところにファイルとして保存する、といった流れです。</p>

<p>最後に、 <code>docker-compose.yml</code> に穴を開ける箇所を追記します。
app 部分だけ抜粋します。</p>

<pre><code class="language-Dockerfile">app:
  build:
    context: &quot;docker/app/&quot;
  ports:
    - 8093:80
  volumes:
    - &quot;./public/:/var/www/html&quot;
    - &quot;./docker/app/httpd.conf:/etc/httpd/conf/httpd.conf&quot;
  depends_on:
    - mysql
</code></pre>

<p>これで app 周りのカスタマイズはすべて完了です。</p>

<h3 id="カスタマイズ完了">カスタマイズ完了！</h3>

<p>長くなりましたが、これで一通り終えましたので以下を順に実行します。</p>

<ol>
<li>docker-compose build</li>
<li>docker-compose up -d</li>
<li><a href="http://localhost:8093" target="_blank">http://localhost:8093</a> を確認</li>
<li>WordPress の公式から最新をダウンロードして <code>public</code> 以下に解凍して置く</li>
<li>wp-config-sample.php をコピーして wp-config.php を作る</li>
<li>以下のように編集する</li>
<li><a href="http://localhost:8093/wordpress/" target="_blank">http://localhost:8093/wordpress/</a> を確認</li>
</ol>

<pre><code class="language-php">/** WordPress のためのデータベース名 */
define('DB_NAME', 'sampledb');

/** MySQL データベースのユーザー名 */
define('DB_USER', 'root');

/** MySQL データベースのパスワード */
define('DB_PASSWORD', 'mypassword');

/** MySQL のホスト名 */
define('DB_HOST', 'mysql');

/** データベースのテーブルを作成する際のデータベースの文字セット */
define('DB_CHARSET', 'utf8');
</code></pre>

<p>結構記事ボリュームが増えてきているので、WordPress の設置は箇条書きで端折ります・・・。</p>

<p>さて、アクセスしてみましょう。</p>

<p><img src="/img/2018/02/docker2018d-04.png" alt="my_lamp - WordPress" /></p>

<p><strong>できてたー！</strong></p>

<p>Docker を使いはしたものの、そんなに難しいことはしてません。
<strong>ぜひとも自分でやってみてください！</strong></p>

<h3 id="最終形">最終形</h3>

<p>ここに置いてあります。
<a href="https://github.com/girigiribauer/sample-dockerized-lamp" target="_blank">https://github.com/girigiribauer/sample-dockerized-lamp</a></p>

<p>以下の順に実行していけば LAMP 環境が動作します。</p>

<ol>
<li>git clone <a href="https://github.com/girigiribauer/sample-dockerized-lamp" target="_blank">https://github.com/girigiribauer/sample-dockerized-lamp</a></li>
<li>cd sample-dockerized-lamp/</li>
<li>docker-compose build</li>
<li>docker-compose up -d</li>
<li><a href="http://localhost:8093" target="_blank">http://localhost:8093</a></li>
</ol>

<p>これである程度特殊な要件の環境も、Docker ベースで作れるようになったと思います。</p>

<p>そろそろローカル環境に立ててあった MAMP, XAMPP, Vagrant などの環境を、
順次 Docker に置き換えて行っても良いのではないでしょうか？</p>

<h2 id="おまけ">おまけ</h2>

<p>Docker 豆知識 です。</p>

<h3 id="docker-コマンドは良く使うのでショートカットを用意しておく">Docker コマンドは良く使うのでショートカットを用意しておく</h3>

<p>僕の場合ですが、もうすでに <code>d</code> は <code>docker</code> コマンドのショートカットにしてあります。
<strong>D は Docker の D!</strong></p>

<p>また、コレクション系も <code>docker image</code> を <code>di</code> にしたり、
<code>docker-compose</code> を <code>dcom</code> とかにしたりすると捗ります。</p>

<ul>
<li>docker = d</li>
<li>docker container = dc (dc は元々逆ポーランド計算機のコマンドが入ってたりするので注意)</li>
<li>docker image = di</li>
<li>docker network = dn</li>
<li>docker volume = dv</li>
<li>docker-compose = dcom</li>
</ul>

<p>こうしておくと、イメージ一覧見たいときに <code>di ls</code> だけで済みますし、
Docker Compose 使って起動したいときは <code>dcom up -d</code> だけで済みます。
単に長いの置き換えてるだけなので、 他のオプションも <code>dcom build</code> とか <code>dcom down</code> とか使えて便利ですね。</p>

<h2 id="まとめ">まとめ</h2>

<p>Docker 周りはまだ色々ありますが、再入門という範囲では必要十分な内容がまとめられたかと思います。</p>

<p>結局のところ、今まで説明したことの <strong>大部分は公式のドキュメントに書いてあります。</strong>
自分含めてですが、 <strong>公式のドキュメントをもっとちゃんと読みましょう。</strong></p>

<p>いやー、4部作になってしまった・・・やっと終わった・・・。</p>

<p>もし読んでみて理解しやすかったならば、
周りの Docker よく分からんとか言って食わず嫌いしている社員の方とかにオススメしてみてください。
分かってない人が減れば、各々関わっているプロジェクトで Docker の開発環境をより提供しやすくなると思います。</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="https://docs.docker.com/" target="_blank">https://docs.docker.com/</a></li>
<li><a href="https://hub.docker.com/" target="_blank">https://hub.docker.com/</a></li>
<li><a href="https://qiita.com/tsukapah/items/677b1f5c89dcbe520344" target="_blank">https://qiita.com/tsukapah/items/677b1f5c89dcbe520344</a></li>
<li><a href="http://affiwork.net/php-settings/" target="_blank">http://affiwork.net/php-settings/</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2018/02/08">2018/02/08</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/docker/">Docker</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>



</div>

<footer>

<h2>Tags</h2>

<ul class="tags">
  <li class="flow">
    <a href="/tags/angular">Angular (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ansible">Ansible (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/apache">Apache (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/apps">Apps (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/cli">CLI (10)</a>
  </li>
  <li class="flow">
    <a href="/tags/css">CSS (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/css3">CSS3 (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/cssfilter">CSSfilter (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/canvas">Canvas (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/chef">Chef (9)</a>
  </li>
  <li class="flow">
    <a href="/tags/cordova">Cordova (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/crawler">Crawler (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/dom">DOM (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/docker">Docker (9)</a>
  </li>
  <li class="flow">
    <a href="/tags/ecmascript">ECMAScript (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/english">English (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ftp">FTP (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/firebase">Firebase (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/font">Font (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/functionallanguage">FunctionalLanguage (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/glsl">GLSL (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/git">Git (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/golang">Golang (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/googleappengine">GoogleAppEngine (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/html">HTML (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/html5">HTML5 (7)</a>
  </li>
  <li class="flow">
    <a href="/tags/html5-outline">HTML5-outline (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/homebrew">Homebrew (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/hugo">Hugo (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/icon-font">Icon-Font (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/javascript">JavaScript (6)</a>
  </li>
  <li class="flow">
    <a href="/tags/linux">Linux (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/mvc">MVC (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/opengraph">OpenGraph (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/php">PHP (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/python">Python (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/rdfa">RDFa (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ssh">SSH (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/svg">SVG (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/scala">Scala (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/shellscript">ShellScript (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/smartphone">Smartphone (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/static-site-generator">Static Site Generator (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/vagrant">Vagrant (15)</a>
  </li>
  <li class="flow">
    <a href="/tags/vim">Vim (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualbox">VirtualBox (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualization">Virtualization (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webapp">WebApp (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webaudioapi">WebAudioAPI (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webfont">WebFont (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webgl">WebGL (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webrtc">WebRTC (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webserver">WebServer (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/yeoman">Yeoman (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/zsh">Zsh (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/ajax">ajax (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/anyenv">anyenv (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/auth">auth (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/automation">automation (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/bot">bot (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/bugs">bugs (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/event-conference">event-conference (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/getusermedia">getUserMedia (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/gitconfig">gitconfig (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ios">iOS (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/iterm">iTerm (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ionic">ionic (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jquery">jQuery (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/jinja2">jinja2 (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jq">jq (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jsperf">jsperf (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/lint">lint (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/mediaquery">mediaQuery (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/namespace">namespace (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/naming">naming (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/oldie">oldIE (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/output">output (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/polyfills">polyfills (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/preloader">preloader (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/rsync">rsync (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/slack">slack (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/tmux">tmux (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/viewport">viewport (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/vimrc">vimrc (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualization">virtualization (6)</a>
  </li>
  <li class="flow">
    <a href="/tags/wget">wget (1)</a>
  </li>
</ul>

<h2>Categories</h2>

<ul>
  <li>
    <a href="/categories/tech/">Category / Tech</a>
  </li>
  <li>
    <a href="/categories/twentyfour/">Category / TwentyFour</a>
  </li>
</ul>

<h2>RSS</h2>

<ul>
  <li>
    <a href="/categories/tech/index.xml" target="_blank">RSS: Category / Tech</a>
  </li>
  <li>
    <a href="/index.xml" target="_blank">RSS: All articles</a>
  </li>
</ul>

<hr>

<ul>
  <li>このブログは個人の見解であり、所属する組織の公式見解ではありません</li>
  <li>自分がひっかかった技術的なことをメモってインターネット上に解き放ち、忘れた頃に自分含む誰かがググったときの助けになれば、というポリシーでブログを書いています</li>
</ul>
<p>&copy; ばうあーろぐ Generated by <a href="https://gohugo.io/" target="_blank">Hugo</a> and <a href="https://github.com/sindresorhus/github-markdown-css" target="_blank">github-markdown-css</a></p>

</footer>

</div>


<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36767095-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.6&appId=396423247105258";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


  </body>
</html>

