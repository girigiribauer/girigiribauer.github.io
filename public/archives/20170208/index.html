<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="all">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://girigiribauer.com/index.xml">
    <title>zsh で日付などを補完・入力補助する方法 - ばうあーろぐ</title>
    <meta property="og:title" content="zsh で日付などを補完・入力補助する方法 - ばうあーろぐ">
    <meta property="og:type" content="article">
    <meta name="description" content="その場で展開したいのです。 結論から先に書いておきます。 function print_date() { zle -U `date &amp;quot;&#43;%y%m%d&amp;quot;` } zle -N print_date bindkey &amp;quot;^Xd&amp;quot; print_date zsh における入力バッファの概念だとか、 zle (zsh line editor) だとか、 その辺">
    <meta property="og:description" content="その場で展開したいのです。 結論から先に書いておきます。 function print_date() { zle -U `date &amp;quot;&#43;%y%m%d&amp;quot;` } zle -N print_date bindkey &amp;quot;^Xd&amp;quot; print_date zsh における入力バッファの概念だとか、 zle (zsh line editor) だとか、 その辺">
    <meta property="og:url" content="http://girigiribauer.com/archives/20170208/">
    <meta property="fb:app_id" content="396423247105258">
    <meta property="og:image" content="http://girigiribauer.com/img/ogimage.png">
<meta name="generator" content="Hugo 0.46" />
  </head>
  <body>

<div class="container">
<header class="globalheader">
<a href="/">ばうあーろぐ TOP へ戻る</a>
</header>


<div class="maincontents">
    <h1 class="heading-single">zsh で日付などを補完・入力補助する方法</h1>
<div class="poststatus">
  <p class="time">
  <time datetime="2017-02-08 18:10:11">2017/02/08</time>
</p>
  <p class="expired"><strong>この記事は書かれてから1年以上が経過しており、最新の情報とは異なる可能性があります</strong></p>

  <ul class="tags">
    <li><a href="/tags/cli/"><i class="fas fa-tag"></i>CLI</a></li>
    <li><a href="/tags/shellscript/"><i class="fas fa-tag"></i>ShellScript</a></li>
  </ul>
</div>

<div class="article">


<p>その場で展開したいのです。</p>

<p>結論から先に書いておきます。</p>

<pre><code>function print_date() {
  zle -U `date &quot;+%y%m%d&quot;`
}
zle -N print_date
bindkey &quot;^Xd&quot; print_date
</code></pre>

<p>zsh における入力バッファの概念だとか、 zle (zsh line editor) だとか、
その辺が少し分かっていなかったので、ちょっとだけ試行錯誤してました。</p>

<p>せっかくなのでメモしておきます。</p>

<h2 id="当初の入力補助する案">当初の入力補助する案</h2>

<p>当初考えたのがこちら。頭空っぽで書きました。</p>

<pre><code>function print_date() {
  echo -n `date &quot;+%y%m%d&quot;`
}
bindkey &quot;^Xd&quot; print_date
</code></pre>

<p><code>bindkey</code> コマンドで現在割り当ててあるキーマップの一覧が確認できるので、
空いてそうな <strong>Ctrl-X -&gt; D</strong> キーを割り当てることにしました。date の D です。</p>

<p>そして .zshrc に反映して実行してみます。</p>

<pre><code>% 170208
</code></pre>

<p>表示されましたが、ここで違和感が。
<strong>Ctrl-W で消えません。</strong></p>

<p>あれ？おかしい・・・？と思い、<code>mkdir</code> のあとに実行して 日付のディレクトリを作ってみることに。</p>

<pre><code>% mkdir 170208
mkdir: missing operand
Try 'mkdir --help' for more information.
</code></pre>

<p><strong>missing operand</strong> と表示されここで初めて気づきます。</p>

<p><strong>あー、これ単に出力されてるだけか、と。</strong></p>

<p>ここでようやく <strong>マニュアル読まないと、</strong> となりました。</p>

<h2 id="man-zshzle-を読む">man zshzle を読む</h2>

<p>zsh に関するマニュアルはいくつかに分割されています。</p>

<p>man zsh を引用します。</p>

<pre><code>OVERVIEW
       Because zsh contains many features, the zsh manual has been split into a number of sections:

       zsh          Zsh overview (this section)
       zshroadmap   Informal introduction to the manual
       zshmisc      Anything not fitting into the other sections
       zshexpn      Zsh command and parameter expansion
       zshparam     Zsh parameters
       zshoptions   Zsh options
       zshbuiltins  Zsh built-in functions
       zshzle       Zsh command line editing
       zshcompwid   Zsh completion widgets
       zshcompsys   Zsh completion system
       zshcompctl   Zsh completion control
       zshmodules   Zsh loadable modules
       zshcalsys    Zsh built-in calendar functions
       zshtcpsys    Zsh built-in TCP functions
       zshzftpsys   Zsh built-in FTP client
       zshcontrib   Additional zsh functions and utilities
       zshall       Meta-man page containing all of the above
</code></pre>

<p>マニュアルが分割されているとありますね。</p>

<p>この中で、今回の入力バッファなどの編集については、
<strong>zsh command line editor (zle)</strong> が相当します。
なので zshzle を読みましょう。</p>

<pre><code>man zshzle
</code></pre>

<p>ずらっと読んでいくと、 ZLE BUILTINS の中の zle コマンドのところにこんなオプションがあります。</p>

<pre><code>-U string
       This  pushes the characters in the string onto the input stack of ZLE.  After the
       widget currently executed finishes ZLE will behave as if the  characters  in  the
       string were typed by the user.
</code></pre>

<p>大まか -U の後の文字列を追加することは分かったのですが、
<strong>ん？ widget ってなんです？</strong></p>

<p>何やら知らない概念があるらしいので、もうちょっと掘り下げてみます。</p>

<p>最初の方に戻ってさらっと読むと、 <strong>Widgets セクションがあるから読んでみて</strong>
とあるのでそちらを探してみます。</p>

<p>・・・。</p>

<p>細かく説明してると手間なので、詳しくは気になる人がそれぞれ実際に読めば良いと思うのですが、
ざっと紹介するとこんな感じです。</p>

<p>zle には widget という概念が存在しており、
builtin で用意された widget とユーザーが独自に定義した widget とを
同じように扱うことができるようです。</p>

<p><strong>関数をキーバインドで呼び出すのではなく、
widget を呼び出す</strong> のが zsh の流儀のようです。</p>

<p>さらに <code>zle -N</code> の説明が書いてあるところを読むと、</p>

<pre><code>-N widget [ function ]
       Create  a  user-defined  widget.  If there is already a widget with the specified
       name, it is overwritten.  When the new widget is invoked from within the  editor,
       the  specified  shell  function  is called.  If no function name is specified, it
       defaults to the same name as the widget.  For further information, see  the  sec-
       tion `Widgets' below.
</code></pre>

<p>これでユーザー定義の widget が登録できるので、
キーバインドを設定する前に、まずは widget を登録します。</p>

<p>ちなみに、用意した引数が widget 分しかなかった場合は、
<strong>同じ名前で function 名がある前提で登録をしてくれるようです。</strong>
合わせておくと管理上分かりやすいので名前を同じにしておきます。</p>

<p>ちょっと分かりづらくなってきたので、まとめるとこんな感じです。</p>

<ol>
<li>ユーザー定義の関数を用意する</li>
<li>その関数を <strong>widget として登録する (zle -N)</strong></li>
<li>widget を <strong>キーバインドで呼び出す (bindkey)</strong></li>
</ol>

<p>この流れですね。</p>

<p>以上を踏まえて書き直したのがこちら。</p>

<pre><code>function print_date() {
  zle -U `date &quot;+%y%m%d&quot;`
}
zle -N print_date
bindkey &quot;^Xd&quot; print_date
</code></pre>

<p>これで正しく動作しました。</p>

<p>キーバインドで日付が入力できるようにしておくと、
汎用的に利用ができるので良いと思います。</p>

<h2 id="まとめ">まとめ</h2>

<p>いつも同じ結論ですが、<strong>マニュアルはきちんと読みましょう。</strong></p>

<p>そのコマンドなりアプリなりを作ってくれた人は、
<strong>その開発に割いた時間に加えて、ヘルプなりドキュメントなりを書いてくれているのです。
もう本当に感謝しかありません。</strong></p>

<p>逆にマニュアル読まずにググってばかりの人は、
これを機に <strong>マニュアルを読む癖</strong> をつけた方が良いと思います。
書いてくれた人のためにもね。</p>

<p>僕は感謝しながらマニュアルを読みつつ、
感謝をこめてブログにメモしようと思いました。</p>

</div>
<ul class="socialbuttons">
  <li>
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li>
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p class="time">
  <time datetime="2017-02-08 18:10:11">2017/02/08</time>
</p>
  <p class="expired"><strong>この記事は書かれてから1年以上が経過しており、最新の情報とは異なる可能性があります</strong></p>

  <ul class="tags">
    <li><a href="/tags/cli/"><i class="fas fa-tag"></i>CLI</a></li>
    <li><a href="/tags/shellscript/"><i class="fas fa-tag"></i>ShellScript</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>


</div>

<footer class="globalfooter">

<h2>Tags</h2>

<ul class="tags">
  <li>
    <a href="/tags/angular"><i class="fa fa-tag"></i>Angular (1)</a>
  </li>
  <li>
    <a href="/tags/ansible"><i class="fa fa-tag"></i>Ansible (5)</a>
  </li>
  <li>
    <a href="/tags/apache"><i class="fa fa-tag"></i>Apache (1)</a>
  </li>
  <li>
    <a href="/tags/apps"><i class="fa fa-tag"></i>Apps (1)</a>
  </li>
  <li>
    <a href="/tags/cli"><i class="fa fa-tag"></i>CLI (11)</a>
  </li>
  <li>
    <a href="/tags/css"><i class="fa fa-tag"></i>CSS (4)</a>
  </li>
  <li>
    <a href="/tags/css3"><i class="fa fa-tag"></i>CSS3 (1)</a>
  </li>
  <li>
    <a href="/tags/cssfilter"><i class="fa fa-tag"></i>CSSfilter (1)</a>
  </li>
  <li>
    <a href="/tags/canvas"><i class="fa fa-tag"></i>Canvas (1)</a>
  </li>
  <li>
    <a href="/tags/chef"><i class="fa fa-tag"></i>Chef (9)</a>
  </li>
  <li>
    <a href="/tags/cordova"><i class="fa fa-tag"></i>Cordova (1)</a>
  </li>
  <li>
    <a href="/tags/crawler"><i class="fa fa-tag"></i>Crawler (1)</a>
  </li>
  <li>
    <a href="/tags/dom"><i class="fa fa-tag"></i>DOM (1)</a>
  </li>
  <li>
    <a href="/tags/docker"><i class="fa fa-tag"></i>Docker (9)</a>
  </li>
  <li>
    <a href="/tags/ecmascript"><i class="fa fa-tag"></i>ECMAScript (1)</a>
  </li>
  <li>
    <a href="/tags/english"><i class="fa fa-tag"></i>English (1)</a>
  </li>
  <li>
    <a href="/tags/ftp"><i class="fa fa-tag"></i>FTP (1)</a>
  </li>
  <li>
    <a href="/tags/firebase"><i class="fa fa-tag"></i>Firebase (1)</a>
  </li>
  <li>
    <a href="/tags/font"><i class="fa fa-tag"></i>Font (1)</a>
  </li>
  <li>
    <a href="/tags/functionallanguage"><i class="fa fa-tag"></i>FunctionalLanguage (2)</a>
  </li>
  <li>
    <a href="/tags/glsl"><i class="fa fa-tag"></i>GLSL (1)</a>
  </li>
  <li>
    <a href="/tags/git"><i class="fa fa-tag"></i>Git (3)</a>
  </li>
  <li>
    <a href="/tags/golang"><i class="fa fa-tag"></i>Golang (4)</a>
  </li>
  <li>
    <a href="/tags/googleappengine"><i class="fa fa-tag"></i>GoogleAppEngine (1)</a>
  </li>
  <li>
    <a href="/tags/html"><i class="fa fa-tag"></i>HTML (1)</a>
  </li>
  <li>
    <a href="/tags/html5"><i class="fa fa-tag"></i>HTML5 (7)</a>
  </li>
  <li>
    <a href="/tags/html5-outline"><i class="fa fa-tag"></i>HTML5-outline (1)</a>
  </li>
  <li>
    <a href="/tags/https"><i class="fa fa-tag"></i>HTTPS (1)</a>
  </li>
  <li>
    <a href="/tags/homebrew"><i class="fa fa-tag"></i>Homebrew (1)</a>
  </li>
  <li>
    <a href="/tags/hugo"><i class="fa fa-tag"></i>Hugo (4)</a>
  </li>
  <li>
    <a href="/tags/icon-font"><i class="fa fa-tag"></i>Icon-Font (1)</a>
  </li>
  <li>
    <a href="/tags/javascript"><i class="fa fa-tag"></i>JavaScript (6)</a>
  </li>
  <li>
    <a href="/tags/linux"><i class="fa fa-tag"></i>Linux (3)</a>
  </li>
  <li>
    <a href="/tags/mvc"><i class="fa fa-tag"></i>MVC (1)</a>
  </li>
  <li>
    <a href="/tags/mongodb"><i class="fa fa-tag"></i>MongoDB (1)</a>
  </li>
  <li>
    <a href="/tags/opengraph"><i class="fa fa-tag"></i>OpenGraph (1)</a>
  </li>
  <li>
    <a href="/tags/php"><i class="fa fa-tag"></i>PHP (1)</a>
  </li>
  <li>
    <a href="/tags/python"><i class="fa fa-tag"></i>Python (1)</a>
  </li>
  <li>
    <a href="/tags/rdfa"><i class="fa fa-tag"></i>RDFa (1)</a>
  </li>
  <li>
    <a href="/tags/ssh"><i class="fa fa-tag"></i>SSH (4)</a>
  </li>
  <li>
    <a href="/tags/svg"><i class="fa fa-tag"></i>SVG (1)</a>
  </li>
  <li>
    <a href="/tags/scala"><i class="fa fa-tag"></i>Scala (2)</a>
  </li>
  <li>
    <a href="/tags/shellscript"><i class="fa fa-tag"></i>ShellScript (3)</a>
  </li>
  <li>
    <a href="/tags/smartphone"><i class="fa fa-tag"></i>Smartphone (2)</a>
  </li>
  <li>
    <a href="/tags/static-site-generator"><i class="fa fa-tag"></i>Static Site Generator (2)</a>
  </li>
  <li>
    <a href="/tags/vscode"><i class="fa fa-tag"></i>VSCode (1)</a>
  </li>
  <li>
    <a href="/tags/vagrant"><i class="fa fa-tag"></i>Vagrant (15)</a>
  </li>
  <li>
    <a href="/tags/vim"><i class="fa fa-tag"></i>Vim (5)</a>
  </li>
  <li>
    <a href="/tags/virtualbox"><i class="fa fa-tag"></i>VirtualBox (3)</a>
  </li>
  <li>
    <a href="/tags/virtualization"><i class="fa fa-tag"></i>Virtualization (1)</a>
  </li>
  <li>
    <a href="/tags/webapp"><i class="fa fa-tag"></i>WebApp (1)</a>
  </li>
  <li>
    <a href="/tags/webaudioapi"><i class="fa fa-tag"></i>WebAudioAPI (1)</a>
  </li>
  <li>
    <a href="/tags/webfont"><i class="fa fa-tag"></i>WebFont (1)</a>
  </li>
  <li>
    <a href="/tags/webgl"><i class="fa fa-tag"></i>WebGL (1)</a>
  </li>
  <li>
    <a href="/tags/webrtc"><i class="fa fa-tag"></i>WebRTC (1)</a>
  </li>
  <li>
    <a href="/tags/webserver"><i class="fa fa-tag"></i>WebServer (1)</a>
  </li>
  <li>
    <a href="/tags/yeoman"><i class="fa fa-tag"></i>Yeoman (1)</a>
  </li>
  <li>
    <a href="/tags/zsh"><i class="fa fa-tag"></i>Zsh (2)</a>
  </li>
  <li>
    <a href="/tags/ajax"><i class="fa fa-tag"></i>ajax (1)</a>
  </li>
  <li>
    <a href="/tags/anyenv"><i class="fa fa-tag"></i>anyenv (1)</a>
  </li>
  <li>
    <a href="/tags/auth"><i class="fa fa-tag"></i>auth (1)</a>
  </li>
  <li>
    <a href="/tags/automation"><i class="fa fa-tag"></i>automation (3)</a>
  </li>
  <li>
    <a href="/tags/bot"><i class="fa fa-tag"></i>bot (1)</a>
  </li>
  <li>
    <a href="/tags/bugs"><i class="fa fa-tag"></i>bugs (1)</a>
  </li>
  <li>
    <a href="/tags/event-conference"><i class="fa fa-tag"></i>event-conference (5)</a>
  </li>
  <li>
    <a href="/tags/getusermedia"><i class="fa fa-tag"></i>getUserMedia (1)</a>
  </li>
  <li>
    <a href="/tags/gitconfig"><i class="fa fa-tag"></i>gitconfig (1)</a>
  </li>
  <li>
    <a href="/tags/ios"><i class="fa fa-tag"></i>iOS (1)</a>
  </li>
  <li>
    <a href="/tags/iterm"><i class="fa fa-tag"></i>iTerm (1)</a>
  </li>
  <li>
    <a href="/tags/ionic"><i class="fa fa-tag"></i>ionic (1)</a>
  </li>
  <li>
    <a href="/tags/jquery"><i class="fa fa-tag"></i>jQuery (3)</a>
  </li>
  <li>
    <a href="/tags/jinja2"><i class="fa fa-tag"></i>jinja2 (1)</a>
  </li>
  <li>
    <a href="/tags/jq"><i class="fa fa-tag"></i>jq (1)</a>
  </li>
  <li>
    <a href="/tags/jsperf"><i class="fa fa-tag"></i>jsperf (1)</a>
  </li>
  <li>
    <a href="/tags/lint"><i class="fa fa-tag"></i>lint (1)</a>
  </li>
  <li>
    <a href="/tags/mediaquery"><i class="fa fa-tag"></i>mediaQuery (1)</a>
  </li>
  <li>
    <a href="/tags/namespace"><i class="fa fa-tag"></i>namespace (1)</a>
  </li>
  <li>
    <a href="/tags/naming"><i class="fa fa-tag"></i>naming (1)</a>
  </li>
  <li>
    <a href="/tags/oldie"><i class="fa fa-tag"></i>oldIE (3)</a>
  </li>
  <li>
    <a href="/tags/output"><i class="fa fa-tag"></i>output (3)</a>
  </li>
  <li>
    <a href="/tags/polyfills"><i class="fa fa-tag"></i>polyfills (4)</a>
  </li>
  <li>
    <a href="/tags/preloader"><i class="fa fa-tag"></i>preloader (1)</a>
  </li>
  <li>
    <a href="/tags/rsync"><i class="fa fa-tag"></i>rsync (1)</a>
  </li>
  <li>
    <a href="/tags/slack"><i class="fa fa-tag"></i>slack (1)</a>
  </li>
  <li>
    <a href="/tags/tmux"><i class="fa fa-tag"></i>tmux (4)</a>
  </li>
  <li>
    <a href="/tags/viewport"><i class="fa fa-tag"></i>viewport (2)</a>
  </li>
  <li>
    <a href="/tags/vimrc"><i class="fa fa-tag"></i>vimrc (2)</a>
  </li>
  <li>
    <a href="/tags/virtualization"><i class="fa fa-tag"></i>virtualization (6)</a>
  </li>
  <li>
    <a href="/tags/wget"><i class="fa fa-tag"></i>wget (1)</a>
  </li>
</ul>

<h2>Categories</h2>

<ul>
  <li>
    <a href="/categories/tech/">Category / Tech</a>
  </li>
  <li>
    <a href="/categories/twentyfour/">Category / TwentyFour</a>
  </li>
</ul>

<h2>RSS</h2>

<ul>
  <li>
    <a href="/categories/tech/index.xml" target="_blank">RSS: Category / Tech</a>
  </li>
  <li>
    <a href="/index.xml" target="_blank">RSS: All articles</a>
  </li>
</ul>

<hr>

<ul>
  <li>このブログは個人の見解であり、所属する組織の公式見解ではありません</li>
  <li>自分がひっかかった技術的なことをメモってインターネット上に解き放ち、忘れた頃に自分含む誰かがググったときの助けになれば、というポリシーでブログを書いています</li>
</ul>
<p class="copyright">&copy; ばうあーろぐ</p>

</footer>

</div>


<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36767095-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

  </body>
</html>

