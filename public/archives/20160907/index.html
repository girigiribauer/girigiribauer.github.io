<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="http://girigiribauer.com/css/style.css">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://girigiribauer.com/index.xml">

    <title>Ansible で Docker のインストール - ばうあーろぐ</title>
    <meta property='og:title' content="Ansible で Docker のインストール - ばうあーろぐ">
    <meta property="og:type" content="article">

    <meta property="og:url" content="http://girigiribauer.com/archives/20160907/">
    
    <meta property="og:image" content="http://girigiribauer.com/img/ogimage.png">
    <meta name="generator" content="Hugo 0.15" />
  </head>
  <body>
    <div class="wrapper">
      <header class="blogheader">

        <a href="/" class="blogtitle"><img src="/img/sitetitle.png" alt="ばうあーろぐ"></a>

      </header>


<div class="maincontents" role="main">
  <header class="postheader">
    <h1 class="posttitle">Ansible で Docker のインストール</h1>
        <div class="poststatus">
          <span class="poststatus__date">2016年9月7日</span>
          <ul class="poststatus__tags">

            <li><i class="icon-tag"></i>Ansible</li>

            <li><i class="icon-tag"></i>Docker</li>

          </ul>
          
        </div>

  </header>

  <article class="postcontents freetext">


<p><a href="http://girigiribauer.com/archives/20160906/" target="_blank">Ansible で再起動後にも playbook を継続する方法</a> で
再ログインに関しても一緒にまとめておこうと思ったのですが、
Docker の方が話の割合として多くなりそうだったので別記事でまとめておきます。
特に Ansible で Docker をインストールするときはこれに該当するんじゃないかと思います。</p>

<h2 id="ansible-で-docker">Ansible で Docker</h2>

<p>まず話がややこしくならないように事前に触れておきますが、
Ansible &amp; Docker の話は複数あって、</p>

<ol>
<li>Ansible の playbook の実行（の検証？）に Docker コンテナを用いる話</li>
<li>Ansible の playbook で Docker をインストールする話</li>
</ol>

<p>が挙げられますが、今回は 1 ではなく 2 の話です。</p>

<p>ちなみに 1 についてですが、
例えばローカルに用意した VirtualBox や外部に借りている VPS の環境だったり、
SSH がつながる環境であれば Ansible の実行は可能ですが、
それが Docker コンテナまで利用できるように広がってきたよという話です。
（僕も詳しくないのでここまでしか把握してません。）</p>

<p>詳しくは &ldquo;ansible docker connection plugin&rdquo; でおググりください。</p>

<h2 id="docker-インストール時のグループ追加について">Docker インストール時のグループ追加について</h2>

<p>手動でやっててけっこうはまった箇所なのですが、
<strong>各種 docker コマンドを実行する際は、sudo をつけて実行するか、
docker グループにユーザーを追加してから docker コマンドを実行する必要があります。</strong></p>

<p>Ansible 実行ユーザーを docker グループに追加し Docker 関連の操作をさせる際に、
Ansible の playbook を Ansible 実行ユーザー自身が実行中なため、
<strong>一度ログインし直してグループに追加したことを設定反映する必要があります。</strong></p>

<p>つまり、Docker インストール用の playbook を実行して、
ansible ユーザーを docker グループに入れたからといって、
docker_image, docker_container モジュールを用いた playbook は動作しません。</p>

<p>予め手動で ansible ユーザーを docker グループに入れた直後にログアウトせず、
そのまま <code>docker ps</code> などを実行してみると、</p>

<pre><code>$ sudo usermod -aG docker ansible
$ docker ps
Cannot connect to the Docker daemon. Is the docker daemon running on this host?
</code></pre>

<p>というメッセージが出て Docker 周りの操作は何もできません。
（id -a などでグループに追加されているか確認しても、自分自身はログアウトしない限り追加されてません）</p>

<h2 id="docker-インストール用-playbook">Docker インストール用 playbook</h2>

<p>Ansible 実行ユーザー（ここでは ansible）を
docker グループに入れたまま docker コマンドが操作できる playbook を書いてみました。</p>

<p>仕組みとしては前回の <a href="http://girigiribauer.com/archives/20160906/" target="_blank">Ansible で再起動後にも playbook を継続する方法</a> と同じで
local_action を用いてログアウト後に待機します。</p>

<p>またまた抜粋ですみません・・・。改めてまとめなおします。</p>

<pre><code>- name: Docker 用 yum リポジトリの追加
  yum_repository:
    name: dockerrepo
    description: Docker Repository
    baseurl: https://yum.dockerproject.org/repo/main/centos/$releasever/
    enabled: yes
    gpgkey: https://yum.dockerproject.org/gpg
    gpgcheck: yes
  tags: dockerhost
  become: True

- name: docker-engine のインストール
  yum: name=docker-engine enablerepo=dockerrepo state=latest
  tags: dockerhost
  become: True

- name: docker-python のインストール
  yum: name=docker-python enablerepo=dockerrepo state=latest
  tags: dockerhost
  become: True

- name: Docker 起動時の DNS 設定
  copy: src=&quot;docker&quot; dest=&quot;/etc/sysconfig/docker&quot; owner=ansible group=ansible mode=0400
  tags: dockerhost
  become: True

- name: Docker サービス自動起動設定
  service: name=docker state=running enabled=True
  tags: dockerhost
  become: True

- name: Docker グループにユーザー追加
  user: name=ansible groups=docker append=yes
  tags: dockerhost
  become: True

- name: Ansible 実行ユーザー自身のグループ状況の取得
  shell: id -a
  register: group_status
  changed_when: False
  tags: dockerhost

- name: Docker グループ追加後の再ログイン
  shell: &quot;sleep 2 &amp;&amp; pkill -u ansible sshd&quot;
  async: 1
  poll: 0
  when: group_status.stdout.find('docker') == -1
  tags: dockerhost
  become: True

- name: Docker グループ追加後の再ログイン完了まで待機
  local_action: wait_for host={{ inventory_hostname }} port={{ ssh_port }} delay=10
  when: group_status.stdout.find('docker') == -1
  tags: dockerhost
  become: False

- name: Docker コマンドが Ansible 実行ユーザーで使えるかテスト
  shell: docker version
  changed_when: False
  tags: dockerhost
  become: False
</code></pre>

<p>docker-python と python-docker-py は多分同じパッケージなんじゃないかと思われます。
yum info を見てみると、どちらも docker が提供してるので、
単に <code>yum install docker</code> でインストールして入るであろう docker-python の方を指定しています。
（Ansible のドキュメントには docker-py が必要とありましたが、docker-python で問題なかったです）</p>

<pre><code>$ yum info docker-python
読み込んだプラグイン:fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirror.nus.edu.sg
 * extras: mirror.vodien.com
 * updates: mirror.vastspace.net
利用可能なパッケージ
名前                : docker-python
アーキテクチャー    : x86_64
バージョン          : 1.4.0
リリース            : 115.el7
容量                : 94 k
リポジトリー        : extras/7/x86_64
要約                : An API client for docker written in Python
URL                 : http://www.docker.com
ライセンス          : ASL 2.0
説明                : An API client for docker written in Python

$ yum info python-docker-py
読み込んだプラグイン:fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirror.nus.edu.sg
 * extras: mirror.vodien.com
 * updates: mirror.vastspace.net
インストール済みパッケージ
名前                : python-docker-py
アーキテクチャー    : noarch
バージョン          : 1.7.2
リリース            : 1.el7
容量                : 235 k
リポジトリー        : installed
提供元リポジトリー  : extras
要約                : An API client for docker written in Python
URL                 : https://github.com/docker/docker-py/
ライセンス          : ASL 2.0
説明                : An API client for docker written in Python
</code></pre>

<p>前回と同様に、実行するかどうかのステータスを取得して、
必要なければスキップするようになっています。</p>

<p>また、local_action と wait_for モジュールの組み合わせで再度 ssh でつなぎにいくのを待機しつつ検知しています。
最後の <code>docker version</code> では、実際にコマンドが有効かどうかを実行して確かめています。
仕組みとしては大きく前回と違いはありません。</p>

<h2 id="まとめ">まとめ</h2>

<p>まだ Docker ホストとして動作するまでしか用意してないので、
アプリケーションなどは特に動いてませんが、
開発用途であれ、サービス用途であれ、
これからはコンテナを中心とした環境にかなり移行していくと思うので、
<strong>Docker ホストとして最低限動作するところまでは playbook として共通化できる</strong> と思います。</p>

<p>ここまでやっておくと残りは Docker イメージや Docker コンテナの操作が中心になってきますね。</p>

<p>まだ、playbook は現時点でごちゃごちゃせずにすっきりしている（と個人的には思っている）ので、
docker-compose を導入せずにこのまま Ansible で Docker の構成管理してもいいんじゃないかとも思っています。</p>

<p>ちなみに、言うまでも無いことですが、
手動でセットアップできないのに Docker や Ansible を使えば知識なしに出来るわけはないので、
まずは空っぽの環境を用意して手動でやってみることをお勧めします。</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="https://docs.docker.com/engine/installation/linux/centos/" target="_blank">https://docs.docker.com/engine/installation/linux/centos/</a></li>
<li><a href="https://docs.ansible.com/ansible/docker_container_module.html" target="_blank">https://docs.ansible.com/ansible/docker_container_module.html</a></li>
<li><a href="https://github.com/ansible/ansible-modules-core/issues/921" target="_blank">https://github.com/ansible/ansible-modules-core/issues/921</a></li>
</ul>

  </article>

  <footer class="postfooter">
<ul class="socialbuttons">
  <li>
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li>
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li>
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

        <div class="poststatus">
          <span class="poststatus__date">2016年9月7日</span>
          <ul class="poststatus__tags">

            <li><i class="icon-tag"></i>Ansible</li>

            <li><i class="icon-tag"></i>Docker</li>

          </ul>
          
        </div>

  </footer>
</div>

      <footer class="blogfooter">
        <div class="inner">
          <h2 class="linkstitle">タグ一覧</h2>
          <ul class="links links--tags">
            
            <li><a href="/tags/ansible"><i class="icon icon-tag"></i>Ansible (4)</a></li>
            
            <li><a href="/tags/apache"><i class="icon icon-tag"></i>Apache (1)</a></li>
            
            <li><a href="/tags/cli"><i class="icon icon-tag"></i>CLI (6)</a></li>
            
            <li><a href="/tags/css"><i class="icon icon-tag"></i>CSS (2)</a></li>
            
            <li><a href="/tags/css3"><i class="icon icon-tag"></i>CSS3 (1)</a></li>
            
            <li><a href="/tags/cssfilter"><i class="icon icon-tag"></i>CSSfilter (1)</a></li>
            
            <li><a href="/tags/canvas"><i class="icon icon-tag"></i>Canvas (1)</a></li>
            
            <li><a href="/tags/chef"><i class="icon icon-tag"></i>Chef (9)</a></li>
            
            <li><a href="/tags/crawler"><i class="icon icon-tag"></i>Crawler (1)</a></li>
            
            <li><a href="/tags/dom"><i class="icon icon-tag"></i>DOM (1)</a></li>
            
            <li><a href="/tags/docker"><i class="icon icon-tag"></i>Docker (4)</a></li>
            
            <li><a href="/tags/ftp"><i class="icon icon-tag"></i>FTP (1)</a></li>
            
            <li><a href="/tags/font"><i class="icon icon-tag"></i>Font (1)</a></li>
            
            <li><a href="/tags/functionallanguage"><i class="icon icon-tag"></i>FunctionalLanguage (2)</a></li>
            
            <li><a href="/tags/glsl"><i class="icon icon-tag"></i>GLSL (1)</a></li>
            
            <li><a href="/tags/git"><i class="icon icon-tag"></i>Git (2)</a></li>
            
            <li><a href="/tags/golang"><i class="icon icon-tag"></i>Golang (2)</a></li>
            
            <li><a href="/tags/html"><i class="icon icon-tag"></i>HTML (1)</a></li>
            
            <li><a href="/tags/html5"><i class="icon icon-tag"></i>HTML5 (7)</a></li>
            
            <li><a href="/tags/html5-outline"><i class="icon icon-tag"></i>HTML5-outline (1)</a></li>
            
            <li><a href="/tags/homebrew"><i class="icon icon-tag"></i>Homebrew (1)</a></li>
            
            <li><a href="/tags/hugo"><i class="icon icon-tag"></i>Hugo (2)</a></li>
            
            <li><a href="/tags/icon-font"><i class="icon icon-tag"></i>Icon-Font (1)</a></li>
            
            <li><a href="/tags/javascript"><i class="icon icon-tag"></i>JavaScript (5)</a></li>
            
            <li><a href="/tags/linux"><i class="icon icon-tag"></i>Linux (2)</a></li>
            
            <li><a href="/tags/mvc"><i class="icon icon-tag"></i>MVC (1)</a></li>
            
            <li><a href="/tags/opengraph"><i class="icon icon-tag"></i>OpenGraph (1)</a></li>
            
            <li><a href="/tags/php"><i class="icon icon-tag"></i>PHP (1)</a></li>
            
            <li><a href="/tags/rdfa"><i class="icon icon-tag"></i>RDFa (1)</a></li>
            
            <li><a href="/tags/ssh"><i class="icon icon-tag"></i>SSH (4)</a></li>
            
            <li><a href="/tags/svg"><i class="icon icon-tag"></i>SVG (1)</a></li>
            
            <li><a href="/tags/scala"><i class="icon icon-tag"></i>Scala (2)</a></li>
            
            <li><a href="/tags/shellscript"><i class="icon icon-tag"></i>ShellScript (2)</a></li>
            
            <li><a href="/tags/smartphone"><i class="icon icon-tag"></i>Smartphone (2)</a></li>
            
            <li><a href="/tags/static-site-generator"><i class="icon icon-tag"></i>Static Site Generator (1)</a></li>
            
            <li><a href="/tags/vagrant"><i class="icon icon-tag"></i>Vagrant (14)</a></li>
            
            <li><a href="/tags/vim"><i class="icon icon-tag"></i>Vim (3)</a></li>
            
            <li><a href="/tags/virtualbox"><i class="icon icon-tag"></i>VirtualBox (3)</a></li>
            
            <li><a href="/tags/virtualization"><i class="icon icon-tag"></i>Virtualization (1)</a></li>
            
            <li><a href="/tags/webapp"><i class="icon icon-tag"></i>WebApp (1)</a></li>
            
            <li><a href="/tags/webaudioapi"><i class="icon icon-tag"></i>WebAudioAPI (1)</a></li>
            
            <li><a href="/tags/webfont"><i class="icon icon-tag"></i>WebFont (1)</a></li>
            
            <li><a href="/tags/webgl"><i class="icon icon-tag"></i>WebGL (1)</a></li>
            
            <li><a href="/tags/webrtc"><i class="icon icon-tag"></i>WebRTC (1)</a></li>
            
            <li><a href="/tags/webserver"><i class="icon icon-tag"></i>WebServer (1)</a></li>
            
            <li><a href="/tags/yeoman"><i class="icon icon-tag"></i>Yeoman (1)</a></li>
            
            <li><a href="/tags/zsh"><i class="icon icon-tag"></i>Zsh (2)</a></li>
            
            <li><a href="/tags/ajax"><i class="icon icon-tag"></i>ajax (1)</a></li>
            
            <li><a href="/tags/automation"><i class="icon icon-tag"></i>automation (3)</a></li>
            
            <li><a href="/tags/bugs"><i class="icon icon-tag"></i>bugs (1)</a></li>
            
            <li><a href="/tags/event-conference"><i class="icon icon-tag"></i>event-conference (5)</a></li>
            
            <li><a href="/tags/getusermedia"><i class="icon icon-tag"></i>getUserMedia (1)</a></li>
            
            <li><a href="/tags/gitconfig"><i class="icon icon-tag"></i>gitconfig (1)</a></li>
            
            <li><a href="/tags/ios"><i class="icon icon-tag"></i>iOS (1)</a></li>
            
            <li><a href="/tags/iterm"><i class="icon icon-tag"></i>iTerm (1)</a></li>
            
            <li><a href="/tags/jquery"><i class="icon icon-tag"></i>jQuery (3)</a></li>
            
            <li><a href="/tags/jinja2"><i class="icon icon-tag"></i>jinja2 (1)</a></li>
            
            <li><a href="/tags/jq"><i class="icon icon-tag"></i>jq (1)</a></li>
            
            <li><a href="/tags/jsperf"><i class="icon icon-tag"></i>jsperf (1)</a></li>
            
            <li><a href="/tags/mediaquery"><i class="icon icon-tag"></i>mediaQuery (1)</a></li>
            
            <li><a href="/tags/namespace"><i class="icon icon-tag"></i>namespace (1)</a></li>
            
            <li><a href="/tags/oldie"><i class="icon icon-tag"></i>oldIE (3)</a></li>
            
            <li><a href="/tags/output"><i class="icon icon-tag"></i>output (3)</a></li>
            
            <li><a href="/tags/polyfills"><i class="icon icon-tag"></i>polyfills (4)</a></li>
            
            <li><a href="/tags/preloader"><i class="icon icon-tag"></i>preloader (1)</a></li>
            
            <li><a href="/tags/rsync"><i class="icon icon-tag"></i>rsync (1)</a></li>
            
            <li><a href="/tags/tmux"><i class="icon icon-tag"></i>tmux (2)</a></li>
            
            <li><a href="/tags/viewport"><i class="icon icon-tag"></i>viewport (2)</a></li>
            
            <li><a href="/tags/vimrc"><i class="icon icon-tag"></i>vimrc (2)</a></li>
            
            <li><a href="/tags/virtualization"><i class="icon icon-tag"></i>virtualization (6)</a></li>
            
            <li><a href="/tags/wget"><i class="icon icon-tag"></i>wget (1)</a></li>
            
          </ul>

          <h2 class="linkstitle">その他リンク</h2>
          <ul class="links links--others">
            <li><a href="/categories/tech/"><i class="icon icon-folder"></i>技術系記事を読む</a></li>
            <li><a href="/categories/twentyfour/"><i class="icon icon-folder"></i>TwentyFour のネタ記事を読む</a></li>
            <li><a href="/categories/tech/index.xml" target="_blank"><i class="icon icon-rss"></i>RSSで技術系の記事のみ取得（おすすめ）</a></li>
            <li><a href="/index.xml" target="_blank"><i class="icon icon-rss"></i>RSSで全ての記事を取得</a></li>
          </ul>
          <p class="attention"><i class="icon icon-attention"></i>このブログは個人の見解であり、所属する組織の公式見解ではありません</p>
          <p class="copyright"><i class="copyright-mark">&copy;</i> ばうあーろぐ Generated by <a href="https://gohugo.io/" target="_blank">Hugo</a></p>
        </div>
      </footer>
    </div>

    
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36767095-1']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>


    
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.6&appId=396423247105258";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

  </body>
</html>

