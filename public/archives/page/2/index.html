<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/github-markdown.css" type="text/css" media="all">
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="all">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://girigiribauer.com/index.xml">
    <title>Archives - ばうあーろぐ</title>
    <meta property="og:title" content="Archives - ばうあーろぐ">
    <meta property="og:type" content="article">
    <meta name="description" content="Webテクノロジーに関するメモ、あるいはTwentyFour">
    <meta property="og:description" content="Webテクノロジーに関するメモ、あるいはTwentyFour">
    <meta property="og:url" content="http://girigiribauer.com/archives/">
    <meta property="fb:app_id" content="396423247105258">
    <meta property="og:image" content="http://girigiribauer.com/img/ogimage.png">
<meta name="generator" content="Hugo 0.17" />
  </head>
  <body>

<div class="markdown-body">
<header>
<a href="/">ばうあーろぐ TOP へ戻る</a>
</header>


<div class="maincontents">

<h1>Archives / 2 of 4</h1>

<div class="poststatus">
  <p>  <time datetime="2015年3月25日">2015年3月25日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/apache/">Apache</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/webserver/">WebServer</a></li>
  </ul>
</div>




<p>罠があるのでまとめておきます。（体験談） なお、box ファイルは CentOS6 ベースのもの、Web サーバは apache です。（本番環境を想定した開発環境なので、nginx は別のところで使っています）</p>

<h2 id="レシピを適用しても上手く表示されない">レシピを適用しても上手く表示されない</h2>

<p>レシピ適用した後で、 <code>vagrant up</code> や <code>vagrant reload</code> などで VM を起動したとしても、Web サーバがうまく動かなかったケースとかありませんでしたか？私はありました。</p>

<p><strong>/var/www を synced folder に指定しているとはまります。</strong></p>

<p>なんともならなかったので、毎回 ssh でログインして <code>sudo service httpd restart</code> してごまかしてましたが、なんだかはまる人多そうだなーと思ったのでこちらにまとめておきます。</p>

<h3 id="vagrant-の動作順おさらい">Vagrant の動作順おさらい</h3>

<p>レシピの指定を Vagrantfile に書いているケース、knife コマンドを使うケースのいずれにおいても、 <code>vagrant up --provision</code> もしくは <code>vagrant provision</code> 時に以下のような順序で動作します。（ログ見れば分かりますが）</p>

<ol>
<li>box ファイルの設定、仮想マシンの電源ON（ブート処理）</li>
<li>Vagrant が使う SSH のポートフォワーディング周りの設定</li>
<li>synced folder の設定</li>
<li>（Vagrantfile 内に記述があれば）レシピの適用</li>
</ol>

<p>なお、古いバージョンの Vagrant では、<code>vagrant up</code> とするだけで up した後に <code>vagrant provision</code> を実行した時の処理が毎回走っていましたが、最近のやつは <code>vagrant up</code> するだけでは Vagrantfile 内に書かれたレシピは適用されなくなりました。（こちらが通常だと思います）</p>

<p>なぜ synced folder を Web サーバのドキュメントルートにしてしまった場合にうまく動かないかというと、 <strong>1.の段階で Web サービスが起動してしまい（chkconfig など）、3.で行われるはずの synced folder の設定がこの段階では行われておらず、/var/www が無いために Web サービスがうまく動かない</strong>、といったことが起きています。</p>

<p>この動作順はどうしようもないので、別の方法を考えなくてはいけません。</p>

<h3 id="upstart-の仕組みを利用する">Upstart の仕組みを利用する</h3>

<p>Upstart というワードをよくご存知の方は、なんとなく予想がつくかと思いますが、 システム起動時に特定のイベントが起きた際、予め指定されたジョブを実行するという仕組みがあります。</p>

<p>Linux は起動時に色々なサービスを立ち上げていますが、 <code>/etc/init</code> 以下に設定ファイルを設置することで、それらを行っています。</p>

<p>今回は、<strong><code>/etc/init/httpd.conf</code> というファイルを作成</strong>し、以下のような内容を記述します。</p>

<pre><code># start apache on vagrant mounted
start on vagrant-mounted
exec sudo service httpd start
</code></pre>

<p>この2行目の <code>vagrant-mounted</code> というのが、先ほどの Vagrant の動作順の 3. である synced folder の設定に相当するので、こちらのマウントが行われたら、<code>sudo service httpd start</code> を行う設定です。 ちなみに、<code>/var/www</code> が無い状態では httpd は起動してないので、restart ではなく start で問題無いようです。</p>

<p>こうすることで、1.の段階で Web サービスの起動に失敗したとしても、3.の直後に Upstart の仕組みによって Web サービスが起動するので、手動で Web サービスの起動などをしなくとも良くなりますね。</p>

<p>Upstart に関してはこちらに詳細あります。</p>

<ul>
<li><a href="http://stackoverflow.com/questions/22718785/apache-doesnt-start-after-vagrant-reload" target="_blank">http://stackoverflow.com/questions/22718785/apache-doesnt-start-after-vagrant-reload</a></li>
<li><a href="http://www.usupi.org/sysad/188.html" target="_blank">http://www.usupi.org/sysad/188.html</a></li>
</ul>

<p>ちなみに、これはあくまで CentOS6, apache の際の話です。CentOS7 は Upstart ではなく systemd になったとかいう話を聞いていつつもまだ試せてないので、お試しになった方がいれば <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> まで教えていただけると嬉しいです。</p>

<h2 id="表示がおかしい-ファイルが途中で途切れる">表示がおかしい、ファイルが途中で途切れる</h2>

<p>これも知らずにはまりました。</p>

<p>特に動的にコンテンツを出力しているわけではないのに、<strong>途中からファイルが \0 やら謎の文字列やらで埋め尽くされ、どうやら途中で切れている</strong>ようでした。ざっくり言うとシステムコールのキャッシュに起因する問題のようで、静的なファイルが対象です。</p>

<p>apache の EnableSendfile ディレクティブ を OFF にしておく必要があるので、 自分で用意した Cookbook の場合は、httpd.conf の template に</p>

<pre><code>EnableSendfile Off
</code></pre>

<p>を入れておきます。</p>

<p>詳しくは EnableSendfile ディレクティブや sendfile システムコールに関しての詳細はこちら。</p>

<ul>
<li><a href="http://httpd.apache.org/docs/2.2/mod/core.html#enablesendfile" target="_blank">http://httpd.apache.org/docs/2.2/mod/core.html#enablesendfile</a></li>
<li><a href="http://blog.1000k.net/2013/03/20/vm-%E3%81%AE%E5%85%B1%E6%9C%89%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E5%86%85%E3%81%AE-%E9%9D%99%E7%9A%84%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E6%AD%A3%E3%81%97%E3%81%8F%E3%83%AD%E3%83%BC/" target="_blank">http://blog.1000k.net/2013/03/20/vm-%E3%81%AE%E5%85%B1%E6%9C%89%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E5%86%85%E3%81%AE-%E9%9D%99%E7%9A%84%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E6%AD%A3%E3%81%97%E3%81%8F%E3%83%AD%E3%83%BC/</a></li>
<li><a href="https://github.com/hiboma/hiboma/blob/master/VirtualBox%E3%81%AEsendfile%E3%81%AE%E3%83%8F%E3%82%99%E3%82%AF%E3%82%99.md" target="_blank">https://github.com/hiboma/hiboma/blob/master/VirtualBox%E3%81%AEsendfile%E3%81%AE%E3%83%8F%E3%82%99%E3%82%AF%E3%82%99.md</a></li>
</ul>

<p>正直、カーネルレベルまで掘り下げて調べてもメリットが少なかったので、あまり掘り下げて理解してません。。。</p>

<p>※ 2015/04/16 追記</p>

<p>nginx では <code>sendfile off;</code> で良さそうですね。</p>

<p><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile" target="_blank">http://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile</a></p>

<h2 id="まとめ">まとめ</h2>

<p>このあたりがクリア出来た頃あたりからは、Vagrant 上の開発環境に問題が起きることが少なくなりました。</p>

<p>この辺に対応するだけでグッと使えるようになると思うので、開発環境を本番環境に近づけられるよう設定してみてはいかがでしょうか。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2015年3月25日">2015年3月25日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/apache/">Apache</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/webserver/">WebServer</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2015年3月4日">2015年3月4日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>




<p>先に <a href="http://girigiribauer.com/archives/1729/" target="_blank">Vagrant の使いどころ・考えどころ</a> を見ると良いかもです。</p>

<p>先に列挙します。 Vagrant 1.6.5 時点で入れたやつなので、すぐに変わる可能性ありです。</p>

<ul>
<li>vagrant-omnibus (1.4.1)</li>
<li>vagrant-vbguest (0.10.0)</li>
<li>sahara (0.0.17)</li>
<li>vagrant-dnsmasq (0.1.1)</li>
<li>landrush (0.18.0)</li>
</ul>

<h2 id="初回の-vagrant-up-に重宝するプラグイン">初回の vagrant up に重宝するプラグイン</h2>

<p><a href="https://github.com/chef/vagrant-omnibus" target="_blank">https://github.com/chef/vagrant-omnibus</a></p>

<p>box ファイルを起動する際に、Chef が入っていなかったらインストールしてくれるプラグインです。 以下のように指定しておけば常に最新版を入れてくれます。</p>

<pre><code>Vagrant.configure(&quot;2&quot;) do |config|
  # ------------------------------ #
  # plugin settings
  # see: vagrant plugin list
  # ------------------------------ #

  # 中略

  if defined? config.omnibus
    config.omnibus.chef_version = :latest
  end

  # 中略

end
</code></pre>

<p>ちなみに、Vagrant のプラグインのインストールは vagrant のサブコマンドから出来ます。</p>

<pre><code>vagrant plugin install --help
</code></pre>

<p><a href="https://github.com/dotless-de/vagrant-vbguest" target="_blank">https://github.com/dotless-de/vagrant-vbguest</a></p>

<p>VirtualBox + Vagrant で使っているので、仮想 OS は VirtualBox が用意してくれているわけですが、 VirtualBox での利用をより便利にするために、GuestAddition をインストールします。</p>

<p>Guest Additions 自体の説明は、以下のページが分かりやすいかもしれません。</p>

<p><a href="http://vboxmania.net/content/guest-additions%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" target="_blank">http://vboxmania.net/content/guest-additions%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB</a></p>

<p>ただ、この Guest Additions と VirtualBox 自体のバージョンに差異があったりすると、 vagrant up がうまくいかないケースが出てきます。 Guest Additions が予め入った box ファイルでも、 VirtualBox 自体のバージョンを上げた際にうまく合わずにエラーが出るケースがあるので、 その辺の調整を行ってくれるプラグインを導入しました。</p>

<pre><code>Vagrant.configure(&quot;2&quot;) do |config|
  # ------------------------------ #
  # plugin settings
  # see: vagrant plugin list
  # ------------------------------ #

  # 中略
  unless defined? config.vbguest
    require &quot;vagrant-vbguest&quot;
  end
  config.vbguest.auto_update = true

  # 中略

end
</code></pre>

<p>これを入れる前はその辺の細かなバージョンの差異に悩まされることが多かったのですが、 導入後は意識しないくらいスムーズになりました。感謝しています。</p>

<h2 id="レシピを繰り返し適用するときに重宝するプラグイン">レシピを繰り返し適用するときに重宝するプラグイン</h2>

<p><a href="https://github.com/jedi4ever/sahara" target="_blank">https://github.com/jedi4ever/sahara</a></p>

<p>過去に <a href="http://girigiribauer.com/archives/1003/" target="_blank">Vagrant に仮想マシンのスナップショットがとれる sahara というプラグインを入れた</a> で書いてたのですが、未だに使ってます。</p>

<p><a href="http://girigiribauer.com/archives/1729/" target="_blank">Vagrant の使いどころ・考えどころ</a> でも書いたのですが、Vagrantfile にレシピを書かない方針で進めているので、初回の vagrant up は、仮想マシンの起動と最低限の設定のみになっているはずです。</p>

<p>その段階で一度スナップショットを取る癖をつけておくと、いつでもクリーンな状態にすぐ戻せるのでレシピを書くのがはかどります。</p>

<pre><code>vagrant sandbox on [vm_machine_name]
</code></pre>

<h2 id="開発時のサブドメインの名前解決に重宝するプラグイン">開発時のサブドメインの名前解決に重宝するプラグイン</h2>

<p>正直なところ、この辺りは時間が出来たらちょっと見直したいところなのですが、 今のままでも全然問題なく使えています。 （欲を言えば、他の VM からも設定なしで名前解決できるようにしたい・・・）</p>

<p><a href="https://github.com/mattes/vagrant-dnsmasq" target="_blank">https://github.com/mattes/vagrant-dnsmasq</a></p>

<p>landrush というプラグインも、以下の記事を読んで試してみたのですがなかなか便利でした。</p>

<p><a href="http://uasi.hatenablog.com/entry/2014/06/26/232348" target="_blank">vagrant up すると .dev ローカルドメインを設定してくれる Landrush が便利な話</a></p>

<p>開発用の名前解決なので、名前の解決さえできればそれほど望むことは多くなく、 hosts ファイルを直接編集してくれる vagrant-hostsupdater でも事足りるかもしれません。</p>

<h2 id="その他">その他</h2>

<p><a href="http://vagrantmanager.com/" target="_blank">Vagrant Manager</a> という、GUI で Vagrant の状態管理ができるツールがあるので、試しに使ってみています。 近い将来、GUI だけで使うとどうなるか？みたいなところで上手く使えたらいいなと思っています。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2015年3月4日">2015年3月4日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2015年3月3日">2015年3月3日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>




<p>Vagrant, Chef 周りの知見が溜まってきたのでそろそろまとめていきたいと思っているのですが、 まだまだ自分の中で分からない部分も多く、 かつ自分はインフラエンジニアではないので、 正直どこまで書いたらいいのか迷っています。</p>

<p>また、chef-solo はなくなるから、これからは chef-zero だ、なんて言われても、 インフラに関する前提知識が薄いので、なかなかついていくことができません・・・。</p>

<p>とはいえ、少なくとも使っていく中で<strong>自分なりの思想</strong>みたいなものははっきりしてきたので、 まずはそこから書いてみようと思います。</p>

<h2 id="vagrant-の用途を考える">Vagrant の用途を考える</h2>

<p>Vagrant が何なのかを知らない人に説明するとすれば、 <strong>仮想マシン（VM）をコマンドラインで統一的に扱えるインターフェース</strong>のようなものだと説明できると思います。</p>

<p>決して仮想環境そのものではなく、仮想環境を提供してくれるものと<strong>セットで</strong>使います。 例えば VirtualBox や VMWare 、あるいはリモートですが AWS(Amazon Web Service) なんかも選択肢になり得ます。</p>

<p>詳しくは <a href="https://www.vagrantup.com/" target="_blank">https://www.vagrantup.com/</a> からインストール手順などを参考にして、実際に試されると良いかと思います。 （今回はこの辺り、一切触れません）</p>

<p>Vagrant をどういう用途で使うかというと、おそらく大きく2種類に分かれると思います。（主観）</p>

<ol>
<li><strong>ローカルの開発用</strong>としてローカルでのみ使い続ける</li>
<li><strong>本番環境の検証用</strong>として、同じレシピを仮想マシン・リモート環境にそれぞれ適用</li>
</ol>

<p>1.は<strong>開発寄り</strong>の人が一番思いつきやすい用途だと思います。 全く同一でもない限り、ローカルで開発したものをリモート環境へ持っていくと、 少なからず環境による差異が問題になってきます。</p>

<p>2.は、<strong>運用寄り</strong>（インフラ寄り？）の人が一番思いつきやすい用途だと思います。 いくら Chef が便利だからといっても、本番環境にトライアンドエラーでレシピ適用して 問題がないケースはほとんどないと言っていいと思います。 この場合、手元の仮想マシンに対してレシピを適用して検証、問題なければ本番マシンに対して適用、 という流れが良いのではないかと考えています。</p>

<h2 id="僕なりの-vagrant-chef-の使い方">僕なりの Vagrant, Chef の使い方</h2>

<p>ここからはポイントに絞ってまとめていきます。</p>

<h3 id="開発と運用とで-vagrantfile-を分けた">開発と運用とで Vagrantfile を分けた</h3>

<p>上記の用途の違いから、もし両方の用途が想定される場合は、 そもそも <strong>Vagrantfile を複数ディレクトリで分けて管理</strong>するとすっきりします。</p>

<p>Vagrantfile 上には、複数の仮想マシンの定義が記述できるため、 まとめて書こうと思えば全然書けてしまうのですが、 目的が全然異なっているので、<strong>使うレシピも共通化しない</strong>ケースが多くなってくると思います。 （例えば開発用であれば、本番環境ほどセキュリティに過敏にならなくても良い場合があります）</p>

<p>Vagrantfile と同階層に cookbooks, site-cookbooks といった 適用するレシピのディレクトリを作って管理していますが、 レシピを共通化しないのであれば、あえて混ぜる理由もありません。</p>

<h3 id="ポート番号-ip-アドレスの管理をしっかり行う">ポート番号、IP アドレスの管理をしっかり行う</h3>

<p>Vagrantfile が複数存在していると、今度は <strong>SSH で接続するためのポート番号や、 VM にアクセスするための IP アドレスが重複してくる可能性</strong>がどんどん高くなります。</p>

<p>開発想定の VM は何番から何番のポートを順に使い、IP アドレスはここから順に割り当てる、 運用想定の VM はこの番号から順に使う、といったように、 ポート番号、IP アドレスの管理をしっかり行うのが重要だと思います。</p>

<p>.ssh/config に、しっかり名前付きで記述しておき、 どの VM にもすぐにアクセスできるようにしておくと気持ちいいです。</p>

<pre><code>Host virtual_machine_name
  HostName 127.0.0.1
  User vagrant
  Port 12345
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /path/to/insecure_private_key
  IdentitiesOnly yes
  LogLevel FATAL
</code></pre>

<p>認証鍵のレシピがうまく適用できるようになったら、 この辺りの設定も、その認証鍵設定済みのユーザーで気軽にアクセスできるようになっていると なお気持ちいいです。 （この辺りの話はまた改めてまとめ直したいです・・・）</p>

<p>あっ、当たり前ですが、Vagrant で VM を複数管理するときは、 ポート番号を全部バラバラにしないといけません。（当たり前）</p>

<pre><code>vagrant ssh-config &gt;&gt; ~/.ssh/config
</code></pre>

<p>上記コマンドで設定を勝手に吐き出して追記してくれる便利なコマンドが用意されていますが、 複数 VM を想定したものになっていない（と思われる）ため、 例えば apple_vm, banana_vm の設定を順に追記してのち、 banana_vm に SSH してたつもりが、ずっと apple_vm に SSH してたことになってた、 なんてことが起こるかもしれません。（体験談）</p>

<p>接続ではまらないためにも、<strong>VM にアクセスするためのポート番号と VM 作成時の IP アドレスは きちんと管理</strong>すると良いと思います。</p>

<h3 id="レシピの適用は-vagrant-provision-よりも-knife-コマンドで">レシピの適用は vagrant provision よりも knife コマンドで</h3>

<p>Vagrant はあくまで<strong>仮想マシン（VM）をコマンドラインで統一的に扱えるインターフェース</strong>なので、 仮想マシンの管理に徹した方がすっきりします。</p>

<p>以下は、Vagrant 1.6.5 で vagrant init したときの初期設定（コメント付き）を抜粋したものです。</p>

<pre><code>config.vm.provision &quot;chef_solo&quot; do |chef|
  chef.cookbooks_path = &quot;../my-recipes/cookbooks&quot;
  chef.roles_path = &quot;../my-recipes/roles&quot;
  chef.data_bags_path = &quot;../my-recipes/data_bags&quot;
  chef.add_recipe &quot;mysql&quot;
  chef.add_role &quot;web&quot;

  # You may also specify custom JSON attributes:
  chef.json = { mysql_password: &quot;foo&quot; }
end
</code></pre>

<p>このような形で、レシピの変更があるたびに Vagrantfile を触るというのは、 なんというか本質的ではないので、あくまで Vagrantfile には以下の情報のみが書かれているのが望ましいのでは？と思っています。（もちろん追加で synced_folder とか）</p>

<ul>
<li>vm.hostname（名前）</li>
<li>vm.box = &#8220;chef/centos-6.6&#8243;（box ファイル用）</li>
<li>vm.network :forwarded_port, id: &#8220;ssh&#8221;, host: 12345, guest: 22（Vagrant 用ポート番号）</li>
<li>vm.network :forwarded_port, host: 8080, guest: 80（HTTP 用ポート番号）</li>
<li>vm.network :private_network, ip: &#8220;192.168.24.24&#8221;（IP アドレス）</li>
</ul>

<p>2つ目のところは自分が使いたい box ファイルを URL で指定すれば良いらしいですが、 以下に公開されているところを名前を指定するだけでも OK です。</p>

<p><a href="https://vagrantcloud.com/boxes/search" target="_blank">https://vagrantcloud.com/boxes/search</a></p>

<p>ちょっと脱線しましたが、<strong>Vagrantfile 上には仮想マシンの定義のみをできるだけシンプルに管理しつつ、 レシピの適用は knife コマンドを用いて行った方がスムーズ</strong>だと思います。</p>

<p>こちらの方法のメリットとして、上記の運用想定の Vagrant 管理において、 ローカル環境、本番環境とで同一の knife コマンドでレシピの適用ができるため、 レシピの適用方法が、適用先の環境に依存することなくスムーズにレシピ適用できる点があると思います。</p>

<p>また、仮想マシンが起動中に Vagrantfile の設定変更を行ってしまうことで、 うまく再起動などができなくなるケースが出てきます。 （例えば Vagrant 自身が SSH で接続するポート番号を途中で変えてしまうなど） <strong>起動中に Vagrantfile はできるだけ触らない方が良い</strong>のではないかと思います。</p>

<p>ただ、vagrant provision でレシピを適用できるようにしておくと、 一通り GUI で扱えるようにしておいた場合に、 コマンドラインが苦手な人とも一緒に扱えるという利点が出てくる場合もあり得ます。</p>

<p>とはいえ、knife コマンドに慣れておいて損はないかなと、使ってみてそう思っています。 （この辺の掘り下げた話も追い追いで・・・）</p>

<h2 id="まとめ">まとめ</h2>

<p>時間もそこまで取れなかったので、とりあえず自分なりの思想的なところまでをまとめてみました。</p>

<p>実際まだまだ書ききれないことも多く、 例えば Vagrant のプラグインでこれ入れておくとこういうシーンで便利とか、 Web サーバにおいて、Vagrant 特有のはまりポイントと解決方法など、 過去に書いた記事の疑問点もだいぶ解消されてきたところもあるので、 改めてまとめ直したいと思います。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2015年3月3日">2015年3月3日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2015年1月19日">2015年1月19日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/tmux/">tmux</a></li>
    <li class="flow"><a href="/tags/shellscript/">ShellScript</a></li>
    <li class="flow"><a href="/tags/cli/">CLI</a></li>
  </ul>
</div>




<p>2015年最初の投稿です。本年もよろしくお願いいたします。</p>

<p>全然書いてなかったので書きます。 ブログは定期的に書いてないと書き方を忘れてしまいがちなので、 もう少し気軽に書いていければと思います。</p>

<h2 id="tmux-のウィンドウ-ペインの準備の時間を削りたい">tmux のウィンドウ、ペインの準備の時間を削りたい</h2>

<p><strong>tmux、めっちゃ便利ですよねー。</strong></p>

<p>便利なので、開きっぱなしにしちゃいがちなんですが、 本当は使うもの以外を閉じておきたいのです。</p>

<p>そもそも tmux のセッション管理だとか、あるいは <strong>tmuxinator</strong> など色々便利なものがありますが、 もうちょっと気軽にさくっと扱えればいいなーと思ってました。</p>

<p>何がやりたいかというと・・・</p>

<ol>
<li>少しのショートカットキーとプロジェクト名を入力するだけで準備が整う</li>
<li>エディター、シェル、タスクランナーの3分割</li>
<li>上記構成を比較的柔軟に変えられる</li>
</ol>

<p>このあたりができればいいなと思います。</p>

<h2 id="構成を考える">構成を考える</h2>

<p>特に tmux の細かな使い方が理解できていなかったので、 <code>man tmux</code> や <code>[prefix] ?</code> などでドキュメントを読んでみました。</p>

<pre><code># ウィンドウを新しく作って、最初のディレクトリを合わせて指定
new-window -c &quot;/path/to/dir&quot;

# ウィンドウを上下に分割（水平）
split-window -h

# 現在のペインに対してキー入力を行う
send-keys &quot;echo 'test123'&quot;

# tmux で入力を受け付けて、シェルスクリプトを実行
command-prompt &quot;run-shell 'cd /path/to/dir'&quot;
</code></pre>

<p>他にもたくさんありますが、今回関連しそうなのはこのあたりっぽいですねー。</p>

<h3 id="プロジェクト名を受け取り-画面を作るシェルスクリプト">プロジェクト名を受け取り、画面を作るシェルスクリプト</h3>

<p>まず、プロジェクト名の引数を1つとって、上記のコマンドの組み合わせでお好みのペインを作るところまでをシェルスクリプトで用意します。</p>

<p>たぶん人によってやりたいことは大分違ってきますし、 画面の分割以外にも<strong>シェルスクリプトでやれることなら色々と書ける</strong>はずなので、 僕の場合はタスクランナーを実際に走らせるところまでやっています。 （それ以上の細かいところは、これから考えていければと・・・）</p>

<pre><code>#!/bin/sh

if [ $# -eq 1 ]; then
  TMUX_PROJECT_NAME=&quot;/var/www/$1&quot;
else
  echo &quot;usage: tmux-project (projectname)&quot; 1&gt;&amp;2
  exit 1
fi

if [ ! -e $TMUX_PROJECT_NAME ]; then
  echo &quot;no exist: $TMUX_PROJECT_NAME&quot; 1&gt;&amp;2
  exit 1
fi

tmux new-window -c $TMUX_PROJECT_NAME
tmux split-window -c $TMUX_PROJECT_NAME -h
tmux split-window -c $TMUX_PROJECT_NAME -v

# has Gruntfile.js
if [ -e &quot;$TMUX_PROJECT_NAME/Gruntfile.js&quot; ]; then
  tmux send-keys &quot;grunt watch^M&quot;
fi

tmux select-pane -t 1
</code></pre>

<p>※実際はもっと具体的な記述になってますが、ざっくりこのような感じです。</p>

<p>このシェルスクリプトをとりあえず <strong>proj</strong> という名前にしておき、 ホームディレクトリの bin ディレクトリに入れて、パスを通して使ってます。 （＆実行権限も）</p>

<h3 id="tmux-の-command-prompt-run-shell-を使い-引数付きのシェルスクリプトを呼び出す">tmux の command-prompt, run-shell を使い、引数付きのシェルスクリプトを呼び出す</h3>

<p>今度は .tmux.conf に以下の設定を追記します。</p>

<pre><code># 予め用意した proj シェルスクリプトに tmux の入力受け付けで引数を渡す
# シェルスクリプト上でエディタ、シェル、タスクランナーなどに分割表示
bind-key P command-prompt -p &quot;projectname:&quot; &quot;run-shell 'proj %1'&quot;
</code></pre>

<p>プロジェクト管理ということなので、プレフィックスキーに続いて Shift-P キーで起動するようにしてみました。 command-prompt を割り当てた場合、そのキーを押すと以下のように入力部分が出てきます。</p>

<p><img src="/img/2015/01/tmuxproj01.png" alt="" /></p>

<p>入力した文字が <strong>%1</strong>, <strong>%2</strong> などで利用できるので、先ほどのシェルスクリプトと組み合わせると幸せになれますね。</p>

<h2 id="まとめ">まとめ</h2>

<p>tmux のオプションがたくさんあって、調べるのにけっこう時間かかってしまいましたが、 同じペインの組み合わせを作ることがけっこう多いので、 そういった部分は可能な限り<strong>自動化</strong>されていると良いですよね。</p>

<p>試してみて、以下の組み合わせは有用だと思いました。</p>

<ol>
<li><strong>tmux の command-prompt によるキーショートカット + キーワード入力</strong></li>
<li><strong>tmux の run-shell とシェルスクリプトによる任意コマンド実行</strong></li>
</ol>

<p>ベースの部分がシェルスクリプトなので、今後新たなツールとかが出てきたとしても、 コマンドラインで動作できるものであれば、シェルスクリプトに落とし込みが可能です。 依存してるものが少ないというのもメリットなのかもしれませんね。</p>

<p>ではそろそろ、元々の仕事に戻りたいと思います・・・。</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="http://mojavy.com/blog/2013/01/11/alc-nokogiri-tmux/" target="_blank">http://mojavy.com/blog/2013/01/11/alc-nokogiri-tmux/</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2015年1月19日">2015年1月19日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/tmux/">tmux</a></li>
    <li class="flow"><a href="/tags/shellscript/">ShellScript</a></li>
    <li class="flow"><a href="/tags/cli/">CLI</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年10月27日">2014年10月27日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/git/">Git</a></li>
    <li class="flow"><a href="/tags/tmux/">tmux</a></li>
    <li class="flow"><a href="/tags/vim/">Vim</a></li>
    <li class="flow"><a href="/tags/vimrc/">vimrc</a></li>
    <li class="flow"><a href="/tags/zsh/">Zsh</a></li>
  </ul>
</div>




<p><a href="https://github.com/girigiribauer/dotfiles" target="_blank">https://github.com/girigiribauer/dotfiles</a></p>

<p>ようやく dotfiles 一式をアップできました・・・。一応メモ。</p>

<p>相当いろいろと削りまくったため、これから必要なものは順次追加していく必要がありますが、まあ一旦ということで。</p>

<p>これとは別に、<strong>profiles</strong> というのが手元にはあって、 こっちは個人情報が載ってる系のものを一式入れてあります。 例えば .gitconfig や .ssh/* あたりですね。</p>

<h2 id="以下-todo">以下 ToDo</h2>

<ul>
<li>特定のプログラムが入ってないと動かない記述がまだ残ってるので、どっか空のサーバ借りてきてシンボリックリンク貼るだけで8割方使える状態にしておきたい</li>
<li>vimrc のプラグインをばっさばっさと切りまくったので、精査しつつ入れ直し</li>
<li>なぜそうしたのかをどっかで補足できたらいいな（今でもコメントでけっこう書いてるけど）</li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年10月27日">2014年10月27日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/git/">Git</a></li>
    <li class="flow"><a href="/tags/tmux/">tmux</a></li>
    <li class="flow"><a href="/tags/vim/">Vim</a></li>
    <li class="flow"><a href="/tags/vimrc/">vimrc</a></li>
    <li class="flow"><a href="/tags/zsh/">Zsh</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年10月23日">2014年10月23日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/css3/">CSS3</a></li>
    <li class="flow"><a href="/tags/oldie/">oldIE</a></li>
    <li class="flow"><a href="/tags/polyfills/">polyfills</a></li>
  </ul>
</div>




<p>2014年9月現在、IE のシェアは過去と比べて劇的に変化しています。</p>

<p><a href="http://gs.statcounter.com/#desktop-browser_version_partially_combined-JP-monthly-201309-201409" target="_blank">http://gs.statcounter.com/#desktop-browser_version_partially_combined-JP-monthly-201309-201409</a> を見ると分かるように、 IE11 が全ブラウザの 30% を上回り、IE8,9,10 がそれぞれ 4% 前後の値です。</p>

<p><img src="/img/2014/10/css3pie01.png" alt="" /></p>

<p>ここまで来ると、oldIE の対応は完全にマイノリティとなってきており、 出来るブラウザを基準にして作るのがもう当たり前になってきていると言っていいかもしれません。</p>

<hr />

<p>そんな中、</p>

<p><strong>『IE7,8 などでも、どうしても同じように見せなきゃいけないんだ・・・！』</strong></p>

<p>という非常にもったいないケースにおいて、 <strong>CSS3 PIE</strong> というライブラリが検討の選択肢に入ってくることもあるかと思います。 （いやぁもったいないですね・・・）</p>

<p><img src="/img/2014/10/css3pie02.png" alt="" /></p>

<p>このライブラリで、border-radius, box-shadow, linear-gradient などの、本来 oldIE では使えなかった CSS3 のプロパティが使えるようになるわけです。</p>

<p>ですが、<strong>動作原理を知っておかないと思わぬところではまる場合が出てくるので注意が必要です。</strong> 全く同じように動作するわけではなく、<strong>副作用が存在します。</strong></p>

<h2 id="css3-pie-の使い方-振り返り">CSS3 PIE の使い方（振り返り）</h2>

<p>ということで、まずは CSS3 PIE の使い方を軽く振り返ります。</p>

<p><a href="http://css3pie.com/" target="_blank">http://css3pie.com/</a></p>

<ol>
<li>PIE.js を読み込む</li>
<li>対象セレクタ内に behavior: url(PIE.php); を入れる</li>
</ol>

<p>PIE.php 内では、</p>

<pre><code>header( 'Content-type: text/x-component' );
include( 'PIE.htc' );
</code></pre>

<p>とあるだけなので、Web サーバの方で ContentType の追加さえできれば、 直接 PIE.htc を読み込んでも良いわけですね。</p>

<h2 id="pie-htc-の中身">PIE.htc の中身</h2>

<p>そもそも htc というのは、<strong>HTML Components</strong> のことを指しています。 （最近流行の Web Components とは全く関係ありません・・・。）</p>

<p>IE9 までは、CSS 内に</p>

<pre><code>behavior: ***;
</code></pre>

<p>などと書くことで、CSS 内部にスクリプトを埋め込むことが出来ます。</p>

<p>ちなみに、PIE.htc の中身はこんな感じにちょっと独自拡張したスクリプトになっています。</p>

<pre><code>&lt;!--
PIE: CSS3 rendering for IE
Version 1.0.0
http://css3pie.com
Dual-licensed for use under the Apache License Version 2.0 or the General Public License (GPL) Version 2.
--&gt;
&lt;PUBLIC:COMPONENT lightWeight=&quot;true&quot;&gt;
&lt;!-- saved from url=(0014)about:internet --&gt;
&lt;PUBLIC:ATTACH EVENT=&quot;oncontentready&quot; FOR=&quot;element&quot; ONEVENT=&quot;init()&quot; /&gt;
&lt;PUBLIC:ATTACH EVENT=&quot;ondocumentready&quot; FOR=&quot;element&quot; ONEVENT=&quot;init()&quot; /&gt;
&lt;PUBLIC:ATTACH EVENT=&quot;ondetach&quot; FOR=&quot;element&quot; ONEVENT=&quot;cleanup()&quot; /&gt;

&lt;script type=&quot;text/javascript&quot;&gt;
var doc = element.document;var f=window.PIE;
...（以下略）
</code></pre>

<p>今更覚えても何の得にもならないと思うので、詳しく知りたい方は以下をご覧ください。</p>

<p><a href="http://msdn.microsoft.com/ja-jp/library/ms532146(v=vs.85).aspx" target="_blank">http://msdn.microsoft.com/ja-jp/library/ms532146(v=vs.85).aspx</a></p>

<h2 id="開発者ツールで見てみる">開発者ツールで見てみる</h2>

<p>css3pie.com のトップにちょうどサンプルがあるので、それに対してどんな変化が起きているのか開発者ツールで見てみます。</p>

<p><img src="/img/2014/10/css3pie03.png" alt="" /></p>

<p>なお、IE の開発者ツールは、<strong>HTML が一通り読み込まれた後の DOM の変化については、更新ボタンを押さないと反映されない</strong>ので、左上にある『最新の情報に更新』のアイコンをクリックします。</p>

<p><img src="/img/2014/10/css3pie04.png" alt="" /></p>

<p>すると、こんな感じに</p>

<pre><code>&lt;css3pie id=_pie_101&gt;
  &lt;pievml:shape id=_pie_shadow0_98&gt;
    &lt;pievml:fill&gt;&lt;/pievml:fill&gt;
  &lt;/pievml:shape&gt;
  &lt;pievml:shape id=_pie_bgImage0_99&gt;
    &lt;pievml:fill&gt;&lt;/pievml:fill&gt;
  &lt;/pievml:shape&gt;
  &lt;pievml:shape id=_pie_border0_100&gt;
    &lt;pievml:fill&gt;&lt;/pievml:fill&gt;
  &lt;/pievml:shape&gt;
&lt;/css3pie&gt;
&lt;div class=&quot; pie_first-child &quot; id=&quot;target&quot;&gt;
</code></pre>

<p>対象の要素の上に css3pie という要素が追加され、見た目の情報がすべてそちらに描画されます。（動的なスタイルは長くなるので省略）</p>

<p>ちなみに、 css3pie.com のトップでは、どうやら PIE-2.0 beta1 を利用しているようで、 ダウンロードしてきたファイルの PIE_IE678.js 内には、</p>

<pre><code>H.createElement(&quot;css3pie&quot;);
</code></pre>

<p>や、</p>

<pre><code>'&lt;css3pie id=&quot;_pie'+h.Q.pa(this)+'&quot; style=&quot;'+this.ac()+'&quot;&gt;'
</code></pre>

<p>といった記述が存在しており、HTML Components を利用して、見た目だけの要素を動的に生成していることがここからも分かります。</p>

<h2 id="css3-pie-の副作用">CSS3 PIE の副作用</h2>

<p>例えば、CSS3 を用いたスタイルを当てたい対象が、以下のようなツリーだったとします。</p>

<pre><code>&lt;ul&gt;
  &lt;li&gt;item 1&lt;/li&gt;
  &lt;li id=&quot;target&quot;&gt;item 2&lt;/li&gt;
&lt;/ul&gt;
</code></pre>

<p>これに対して、</p>

<pre><code>li + li {
  background-color: #f00;
}
</code></pre>

<p>といったように、連続した兄弟セレクタに対して別途スタイルをあてる記述が存在していた場合、 これが<strong>上手く適用されないケース</strong>が存在します。</p>

<p>CSS3 PIE のライブラリが id=&#8221;target&#8221; に対して動作した場合、 ツリーは以下のように変化します。</p>

<pre><code>&lt;ul&gt;
  &lt;li&gt;item 1&lt;/li&gt;
  &lt;css3pie ... &gt;&lt;/css3pie&gt;
  &lt;li id=&quot;target&quot;&gt;item 2&lt;/li&gt;
&lt;/ul&gt;
</code></pre>

<p>こうなってしまうと、li が連続している前提のスタイルは、<strong>DOM ツリーが変化してしまうことにより</strong> スタイルがあたらない（または意図してないスタイルがあたる）ケースが出てきます。</p>

<h2 id="まとめ">まとめ</h2>

<p><strong>そのライブラリが、（大まかにでも）何やってるのか把握するべきだと思います。</strong></p>

<p>今回のケースでは、『CSS3 PIE というのは、見た目用の要素を対象の要素のすぐ下に生成し、見た目の情報をそちらに全部載せることで実現していて、副作用として DOM ツリーが変化してしまっている』ということまで分かっていれば、どうとでも対処できます。</p>

<p>なんでもかんでも『これさえ読み込めばオッケー！』みたいに考えてると、いざってときに何も出来ないので、 大まかにでも良いのでどういう仕組みで動いているのか、理解することは大事だなーと思います。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年10月23日">2014年10月23日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/css3/">CSS3</a></li>
    <li class="flow"><a href="/tags/oldie/">oldIE</a></li>
    <li class="flow"><a href="/tags/polyfills/">polyfills</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年9月25日">2014年9月25日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/viewport/">viewport</a></li>
  </ul>
</div>




<p>これはさすがに書いておいた方がよいかと思ったので書いておきます。</p>

<p>結論だけ先に言うと、設定によって viewport の値が変わるので注意です。</p>

<h2 id="設定によって-viewport-の値が変わる件">設定によって viewport の値が変わる件</h2>

<p>2014年の9月に iPhone6, iPhone6 Plus がそれぞれ発売されたわけですが、 購入して初期設定してるときに気になる画面が。</p>

<p><img src="/img/2014/09/iphone6-viewport01.png" alt="" /></p>

<p>へぇーー。初期設定の際に画面全体を標準サイズにするか、拡大サイズにするかを選択できるようになってました。</p>

<p>また、初期設定後であっても、<strong>設定 &gt; 画面表示と明るさ &gt; 画面表示の拡大</strong> という項目で自由に変更できるようになっています。</p>

<p>プレビュー画面も用意されているので分かりやすいです。こちらが標準設定。</p>

<p><img src="/img/2014/09/iphone6-viewport02.png" alt="" /></p>

<p>以下が拡大設定です。</p>

<p><img src="/img/2014/09/iphone6-viewport03.png" alt="" /></p>

<h2 id="比率は一定で横幅柔軟にしましょう">比率は一定で横幅柔軟にしましょう</h2>

<p>端末はデカくなったのですが、今までの考え方に沿うのであれば、マルチデバイスであっても<strong>比率は一定で横幅（or 高さ）を柔軟に考えていきましょう</strong>という意味での device-width（or device-height） なので、画面がデカくなれば横幅が増えるはずです。</p>

<p>実際今回もその通りになっていて、iPhone6 の viewport は、<strong>device-width = 375(px), device-height = 559(px)</strong> です。</p>

<p>上のキャプチャを見てもらえれば分かるように、ボタンのサイズ感はそのままなので、以前のものと同じような押しやすさになっており、ボタン間の余白が調整されています。</p>

<p>正直ここまでは予想通りだったかと思います。いまどき 320px の幅固定で作っちゃってる人は、まあ当然異なるスクリーンサイズが出て来ちゃったらはまるよねー、という感じで、device-width が異なるものが出てくるのは、もう既定路線というか、想定の範囲内だったと思います。</p>

<h2 id="そこで颯爽と登場した-画面表示の拡大-設定">そこで颯爽と登場した『画面表示の拡大』設定</h2>

<p>この拡大設定にしたときに、Safari で見たらどうなるんだろうとふと思ったのですが、比率が異なっているのであれば、逆に viewport の設定も変化しているのでは？と思い、それぞれ見比べてみました。</p>

<p>以下が通常設定時。</p>

<p><img src="/img/2014/09/iphone6-viewport04.jpg" alt="" /></p>

<p>対して、こちらが拡大設定時。</p>

<p><img src="/img/2014/09/iphone6-viewport05.jpg" alt="" /></p>

<p>ご覧の通り、この設定によって拡大率が変わってくるので、viewport の値も変わってきます。（余談ですが、device-width が小さくなっているのと同様に、キャプチャサイズも小さくなってました）</p>

<p>で、少し問題になってくるのが、初期設定のこの画面です。</p>

<p><img src="/img/2014/09/iphone6-viewport01.png" alt="" /></p>

<p><strong>必ずどちらかユーザーが選択する</strong>ようになっています。</p>

<h3 id="ie-のズーム機能との違い">IE のズーム機能との違い</h3>

<p>IE では、何もしなくてもズーム機能の値が標準になっているので、特に設定をいじらなければ標準のままですが、iPhone6 からは初期設定時に必ずユーザーが選択する必要があります。（というのをキャプチャ見せながら書くために再度出荷時にまで戻してキャプチャ取りました・・・）</p>

<p>IE のズーム機能の対応は、おそらくやる場合とやらない場合が出て来たかと思います。通例などは知りませんが、一例として、『何も触らなければ標準なんだし、標準の設定の場合だけサポートしますね』というのはよくある謳い文句かと思います。</p>

<p>ただ、今回のケースはそれとは異なり、必ずユーザーがどちらか選ばないといけません。 年配の方であれば、他の年代よりも拡大表示を選ぶ可能性が高くなるのではないでしょうか？</p>

<h3 id="同じ端末なのに異なる-viewport-で閲覧するケースが出てくる">同じ端末なのに異なる viewport で閲覧するケースが出てくる</h3>

<p>横幅（高さ）固定のレイアウトで作っていなくても、例えば CSS の Media Queries を用いてスタイルの切り替えを行っていたり、window.matchMedia を用いて特定のスクリーンサイズのみ動作する処理を用意していたりする場合、こちらの設定によって動作する／しない、表示される／されない、といったケースが考えられます。</p>

<p>例えば、作ったものをクライアントに確認出ししているときに、今3カラムになってるんだけど4カラムに直してよ、と言われても、こちらの端末にはもうすでに4カラムになっていて直しようがない、とか。</p>

<p>まだ目に見える範囲であれば、キャプチャとってもらって確認すれば、『ひょっとして・・・』と気づくかもしれませんが、見た目に見えないところだと気づかない可能性もありますね。</p>

<h2 id="まとめ">まとめ</h2>

<p><strong>『比率は一定で横幅を柔軟に作る』というのは大前提</strong>なのですが、 それとは別に iPhone6 以降では、<strong>拡大設定によって viewport が異なり、 同じ実機、同じブラウザでも、人によって見ているものが異なる可能性がある</strong>ということを頭の片隅に入れておく必要があると思います。</p>

<p>今回の例は iPhone6 だけですが、まあ間違いなく iPhone6 Plus の方にも同様の問題があると思われます。（まだ実機手に入れてないので、もしお持ちの方は以下のページで報告いただけたら嬉しいです。）</p>

<ul>
<li><a href="http://viewportsizes.com/mine/" target="_blank">http://viewportsizes.com/mine/</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年9月25日">2014年9月25日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/viewport/">viewport</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年8月12日">2014年8月12日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/automation/">automation</a></li>
  </ul>
</div>




<p>どうしても環境を変えられず SSH のパスフレーズを手動入力せざるをえないときってありますよね？</p>

<p>それが1回、2回であればまだ良いのですが、ある程度定期的に SSH でログインしてあれこれやらなきゃいけないってなると、もう発狂ものです。</p>

<p>こういったケースはときどき発生するのですが、<strong>実は自動入力出来る方法がある</strong>ってことをふいに知ったのでメモっておきます。</p>

<p>※数ヶ月前の話ですが、それでもブログに記録を残しておいた方が良いと思ったので、タイミングずれましたが書いておきます。</p>

<h2 id="ssh-でのログインの仕方">SSH でのログインの仕方</h2>

<p>先に、普通に SSH でログインする方法とベストな選択肢に触れておきます。</p>

<p>一番シンプルに使うのなら、以下の方法ですね。</p>

<pre><code>ssh -p 12345 user@example.com
</code></pre>

<p>ユーザー名: user、ポート番号: 12345 のとき、パスフレーズなしで公開鍵認証の設定がしてあれば、このままログイン出来るはずです。</p>

<h3 id="毎回やることが決まっているとき">毎回やることが決まっているとき</h3>

<p>これも今回のケースが解決してから知ったので余談になりますが、 ログイン先のサーバにて公開鍵を載せておくファイル、<code>.ssh/authorized_keys</code> に <code>command=&quot;command&quot;</code> といった形式でコマンドを書いておくと、<strong>ここに書かれたコマンドしか実行出来なくなる</strong>ようです。</p>

<p>今度改めて調べてみようかな。</p>

<h2 id="手動入力を強いられているんだ">手動入力を強いられているんだ！</h2>

<p>さて、上記の SSH によるログインで、パスフレーズが設定されていた場合、</p>

<pre><code>user@example.com's password: 
</code></pre>

<p>こんな感じに、「パスフレーズを入力してね？」と表示されるわけですが、 毎回毎回与えられたパスフレーズをテキストファイルからコピってターミナルに貼付けて・・・とやっていると、<strong>段々と強いられている感がじわじわきて心情的にもよろしくありません。</strong></p>

<p>実はこちら、<strong>expect, spawn, send</strong> あたりのコマンドを使うことにより、手動想定のインタラクティブな入力画面においても、自動で入力、その後のコマンドが実行できます。（全部使ったことなかった・・・）</p>

<h3 id="expect-コマンド">expect コマンド</h3>

<p>期待した入力と一致した場合に、任意のコマンドを実行できます。</p>

<p>-c オプションとともにコマンドを渡すことが出来ます。さらにこのコマンド内で interact コマンドを呼ぶと、処理をシェルに戻してくれると。</p>

<h3 id="spawn-コマンド">spawn コマンド</h3>

<p>後に続くコマンドを送り先で実行します。expect コマンドとセットで使うこと前提なんですかね？</p>

<h3 id="send-コマンド">send コマンド</h3>

<p>今回のようなケースでは、expect コマンドの後に実際の入力待ちで入力を行う場合などに使います。</p>

<h3 id="組み合わせ例">組み合わせ例</h3>

<pre><code>expect -c &quot;
spawn command arg1 arg2
expect \&quot;user@example.com's password: \&quot;
sleep 1
send \&quot;passphrase123\n\&quot;
interact
&quot;
</code></pre>

<p>あとは、これを例えばシェルコマンドとしてファイルにまとめておいて、任意のタイミングで実行してあげれば良いだけですね。</p>

<p>内部の expect コマンドで「パスフレーズを入力してね？」と聞かれた際に、 予めこういうテキストが入力されたら、と用意されているところにマッチするので、パスフレーズを send コマンドで送ってくれます。<strong>自動化最高。</strong></p>

<h2 id="まとめ">まとめ</h2>

<p>『なぜ知らなかった』の一言に尽きます。</p>

<p>今度機会があれば、もうちょっと掘り下げて使えるようになりたいですね！</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="http://www.uetyi.mydns.jp/wordpress/command/entry-158.html" target="_blank">expectコマンドの使い方 – No:158 – Linuxで自宅サーバ構築（新森からの雑記）</a></li>
<li><a href="http://blog.wnotes.net/blog/article/expect-other-programs" target="_blank">http://blog.wnotes.net/blog/article/expect-other-programs</a></li>
<li><a href="http://d.hatena.ne.jp/lurker/20060728/1154093951" target="_blank">http://d.hatena.ne.jp/lurker/20060728/1154093951</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年8月12日">2014年8月12日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/automation/">automation</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年7月11日">2014年7月11日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/event-conference/">event-conference</a></li>
  </ul>
</div>




<p>メモだけ残しておきます。</p>

<h2 id="予約系">予約系</h2>

<ul>
<li>100名規模の会場は3か月前だとぎりぎり、もうちょっと手前で押さえるべき</li>
<li>オプション品（マイクやらプロジェクタ、スクリーンなど）は後追いでも全く問題無し</li>
<li>LT用のドラは直前でも問題なくレンタル出来た。名古屋なら『なんでも貸します』のアレは超便利</li>
</ul>

<h2 id="お金系">お金系</h2>

<ul>
<li>非営利でやるときの口座は、営利目的のものと混ぜられないので注意</li>
<li>初めてで口座とかないときは、当日現金支払いのみで割り切ってやるのも必要</li>
</ul>

<p>事前準備であれこれタスク増やしすぎて<strong>テンション下げないこと超重要。</strong> イベント開催自体が目的ではない。</p>

<h3 id="支出-大まかに">支出（大まかに）</h3>

<ul>
<li>会場費 100,000 〜 150,000円（名古屋、休日駅近く）</li>
<li>会場オプション品 〜 50,000円</li>
<li>その他雑費 〜 50,000円</li>
<li>告知ページ制作費 200,000円前後</li>
</ul>

<p>なお・・・</p>

<ul>
<li>雑費の中に、ネックストラップ（参加者用、スタッフ用）、関係者の懇親会費用などを含む</li>
<li>告知ページはちゃんとしたデザインを含んでいて手を抜けない部分</li>
<li>告知ページ制作費は、最悪 <strong>焼き肉メソッド</strong> を使うことができる</li>
</ul>

<h3 id="収入-大まかに">収入（大まかに）</h3>

<ul>
<li>参加費 3,000円 x 最大 100名 = 300,000円</li>
<li>会場は関係者・スタッフが20名入っても問題ないところを予め押さえた</li>
</ul>

<p>当然、最大100名枠で当日キャンセルが発生しないわけはない・・・（後は察してください</p>

<h2 id="当日">当日</h2>

<ul>
<li>御釣りは事前準備が必要（100,000円分、事前に崩しておいた）</li>
<li>あとは他イベントのやり方パクリつつなんとか</li>
</ul>

<h2 id="まとめ">まとめ</h2>

<ul>
<li>焼き肉メソッドで制作費をクリアにしたら、ちょいマイナスでなんとか収まった</li>
<li>旨い飯は偉大</li>
<li>頑張りすぎない</li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年7月11日">2014年7月11日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/event-conference/">event-conference</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年2月12日">2014年2月12日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/dom/">DOM</a></li>
    <li class="flow"><a href="/tags/javascript/">JavaScript</a></li>
    <li class="flow"><a href="/tags/jquery/">jQuery</a></li>
    <li class="flow"><a href="/tags/polyfills/">polyfills</a></li>
  </ul>
</div>




<p>意図せずシリーズ化してしまった、前回からの続き3回目です。</p>

<ul>
<li><a href="/archives/1233/">jQuery から卒業するための第1歩を polyfills から学ぼう</a></li>
<li><a href="/archives/1254/">jQuery から卒業するための第1歩を polyfills から学ぼう – その2</a></li>
</ul>

<p><a href="https://github.com/inexorabletash/polyfill" target="_blank">https://github.com/inexorabletash/polyfill</a> にある web.js をソースコードリーディングしています。 また、es5.js は予め読み込まれている前提となります。</p>

<h2 id="selectors-api-level-1">Selectors API Level 1</h2>

<p><strong>DOM ツリー</strong>に関する polyfills です。</p>

<p><strong>Selectors API</strong> って何なのー？って思う方もいるかもしれませんが、 例えば jQuery でいう <strong>$(‘.element’)</strong> みたいなアレとほぼ同じです。</p>

<p>大まかに以下の5つに関する polyfills が用意されています。</p>

<ul>
<li>querySelectorAll</li>
<li>querySelector</li>
<li>getElementsByClassName</li>
<li>TextRectangle</li>
<li>DOM Enumerations</li>
</ul>

<h3 id="queryselectorall-queryselector">querySelectorAll, querySelector</h3>

<p><strong>querySelectorAll</strong> は、CSS のセレクタ（ .element とか #title とか）を指定して、それに<strong>当てはまる要素全てを取得</strong>できます。</p>

<p>試しに今閲覧しているブラウザで開発者ツールを開き、</p>

<pre><code>document.querySelectorAll('.entry-content h2')
</code></pre>

<p>などと入力してみると、このページの class=”entry-content” と書かれた中にある h2 の要素を一通り取得出来ていることが分かると思います。</p>

<p><img src="/img/2014/02/polyfills08.png" alt="" /></p>

<p>この <strong>querySelectorAll / querySelector は IE8 から使えることが出来る</strong>ため、 IE7 以前のブラウザでは一切動作しなくてもいい、というケースにおいては普通に使うことが出来ますね。 （とはいえ、全く動かないのもアレなので、こういった polyfills があるとより親切かと思います）</p>

<p>ただ、単に要素を取得するだけであれば、元々ある他の方法（ getElementById, getElementsByTagName など）を用いれば 同等のものが実現出来ることも容易に想像がつきます。</p>

<p>さて、181〜199行目を抜粋します。（間の空行が上手く表示できなかったので詰めています）</p>

<pre><code>if (!document.querySelectorAll) {
  document.querySelectorAll = function (selectors) {
    var style = document.createElement('style'), elements = [], element;
    document.documentElement.firstChild.appendChild(style);
    document._qsa = [];
    style.styleSheet.cssText = selectors + '{x-qsa:expression(document._qsa &amp;&amp; document._qsa.push(this))}';
    window.scrollBy(0, 0);
    style.parentNode.removeChild(style);
    while (document._qsa.length) {
      element = document._qsa.shift();
      element.style.removeAttribute('x-qsa');
      elements.push(element);
    }
    document._qsa = null;
    return elements;
  };
}
</code></pre>

<p>かなり<strong>ハック的な方法</strong>が用いられているので、正直ざっくりとしか理解できていませんが、 普通に polyfills を実現しようとすると速度面でかなり劣ることが分かっているため、 どうにかして IE7 以前でも普通に使えるレベルまでもっていけないか？という試行錯誤の跡になっています。</p>

<p>難しいので特徴だけ軽くまとめてみようかと・・・。</p>

<ul>
<li>本来の document.querySelectorAll と異なり、document._qsa などに一時的に計算結果を保存している（副作用がある）</li>
<li>CSS 内に JavaScript が書ける Expressions が使われている（IE5 で導入、セキュリティのため IE8 以降では無視される）</li>
<li>本来 Expressions を用いるとめちゃめちゃ遅くなるが、要素取得のみに限定して使うことで全体として速くなっている（らしい）</li>
</ul>

<p>（まあハックなのでこれくらいの理解でいいかなと・・・）</p>

<p>詳しくは以下に掲載されているようです。</p>

<p><a href="http://ajaxian.com/archives/creating-a-queryselector-for-ie-that-runs-at-native-speed" target="_blank">http://ajaxian.com/archives/creating-a-queryselector-for-ie-that-runs-at-native-speed</a></p>

<p>querySelector の方も、All で取得したものの頭のものを持ってくるだけなので省略します。</p>

<h3 id="getelementsbyclassname">getElementsByClassName</h3>

<p><strong>getElementsByClassName</strong> は、<strong>getElementsByTagName</strong> や <strong>getElementById</strong> と同じで 要素をクラス名で取得します。今まで無かったのが不思議ですね。</p>

<p>同じく開発者ツールを開いて、以下のように取得ができます。</p>

<p>document.getElementsByClassName(&#8216;entry-content&#8217;) （クラス名をそのまま入れるので、頭のドットは不要ですね）</p>

<p>処理の中身である210, 211行目のみ抜粋します。</p>

<p>classNames = String(classNames).replace(/^|s+/g, &#8216;.&#8217;); return document.querySelectorAll(classNames); こちらの処理も querySelector と同じく、<strong>querySelectorAll</strong> を流用して提供されています。 クラス名を受け取って、querySelectorAll に渡してやっているだけですね。</p>

<p>こちら、クラス名の指定が正しくされている時以外は、ひょっとするとエラーになるケースもあるかもしれませんが、 <strong>/^|s+/g</strong> の正規表現で、先頭かもしくはホワイトスペースが1つ以上続く場合、それを . に置き換えるようになっています。</p>

<p>普通に <strong>&#8216;toggle&#8217;</strong> みたいな文字列が指定されれば、 <strong>&#8216;.toggle&#8217;</strong> に置き換えられますし、 <strong>&#8216;aaa, bbb&#8217;</strong> のような文字列であれば、<strong>&#8216;.aaa,.bbb&#8217;</strong> に置き換えられますね。</p>

<p>※これだと、カンマの後にスペースが無いと上手く replace されないっぽいですかね？ （ひょっとすると不完全かもしれません）</p>

<h3 id="textrectangle">TextRectangle</h3>

<p>ざっと流していくだけなら比較的すらすらっと読めるのですが、 このように丁寧に順を追って見ていくと、かなり時間がかかりますね。</p>

<p>次は TextRectangle についてです。 TextRectangle が一体なんなのか、というところから書いてみます。</p>

<h4 id="textrectangle-って">TextRectangle って？</h4>

<p>とある要素に対して、「この要素の位置やサイズくださいー」と呼び出すと、以下のようなプロパティが含まれているオブジェクトが返ってきます。</p>

<pre><code>{
  bottom: 171.78125,
  height: 540,
  left: 40,
  right: 580,
  top: -368.21875,
  width: 540,
  ...
}
</code></pre>

<p>実際に、var foo = getElement… などで取得した要素に対して、</p>

<pre><code>foo.getBoundingClientRect();
</code></pre>

<p>のように、「この要素の位置やサイズくださいー」と要素に対して呼び出してやると、 <strong>TextRectangle</strong> オブジェクトが返ってきます。</p>

<p>上記をそのまま試したキャプチャです。</p>

<p><img src="/img/2014/02/polyfills09.png" alt="" /></p>

<p>真ん中に黒枠で囲まれた要素が存在していますが、それに対して <strong>getBoundingClientRect()</strong> を呼び出してやると、 その要素が上から何ピクセル、左から何ピクセル、あるいは幅が何ピクセルか、などが一通り分かります。</p>

<p>こんな感じで位置やサイズが取得でき、その返ってくるオブジェクトが <strong>TextRectangle オブジェクト</strong>です。</p>

<p>jQuery の内部でも offset（≒上、左からどんだけずれているか）などの処理で使われているようです。</p>

<h4 id="textrectangle-の-width-height-のみを補完する">TextRectangle の width, height のみを補完する</h4>

<p>ただし、この TextRectangle オブジェクトは、 ブラウザの対応度合いによって不足しているプロパティがあり、IE8 では <strong>width, height が不足</strong>しています。</p>

<p>ということで、長くなりましたが、その不足分の width, height のみを補完するためのコードが216〜221行目に相当します。</p>

<pre><code>if ('TextRectangle' in this &amp;&amp; !('width' in TextRectangle.prototype)) {
  Object.defineProperties(TextRectangle.prototype, {
    'width': { get: function() { return this.right - this.left; } },
    'height': { get: function() { return this.bottom - this.top; } }
  });
}
</code></pre>

<p>上記でだいぶ詳しく説明したので、このコードが大まかに何をやっているのかは分かると思いますが、 <strong>Object.defineProperties</strong> だけ触れておこうと思います。</p>

<h4 id="object-defineproperties-って">Object.defineProperties って？</h4>

<p><strong>Object.defineProperties(obj, props)</strong> は、ECMAScript5 (ES5) に定義されているもので、 IE9 以降からしか使えません。</p>

<p>obj に対して、props のプロパティを上書き（なければそのまま定義）することができます。</p>

<p>詳しくは MDN をご覧いただいた方が良いと思います。（毎回 MDN 見て、で済んでしまう気が・・・）</p>

<p><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperties" target="_blank">https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperties</a></p>

<p>jQuery にも似たような機能が用意されており、<strong>jQuery.extend</strong> で同等のことが実現出来ます。 その公式ページからの抜粋です。</p>

<pre><code>var object1 = {
  apple: 0,
  banana: { weight: 52, price: 100 },
  cherry: 97
};
var object2 = {
  banana: { price: 200 },
  durian: 100
};
// Merge object2 into object1
$.extend( object1, object2 );
</code></pre>

<p>このときに返ってくるオブジェクトは、</p>

<pre><code>{
  apple: 0,
  banana: {
    price: 200
  },
  cherry: 97,
  durian: 100
}
</code></pre>

<p>のようになります。存在しているところは上書きされていますね。</p>

<p>こちらも、詳しくは以下の公式ページに掲載されています。</p>

<p><a href="http://api.jquery.com/jQuery.extend/" target="_blank">http://api.jquery.com/jQuery.extend/</a></p>

<h3 id="dom-enumerations">DOM Enumerations</h3>

<p>最後は、Node オブジェクト（≒DOM ツリーの構成要素）や DOMException オブジェクト（≒例外処理）に対して、 本来あるべき定数を変数として定義しているだけなのですが、 226行目のみ抜粋してみます。</p>

<pre><code>window.Node = window.Node || function Node() { throw TypeError(&quot;Illegal constructor&quot;); };
</code></pre>

<p>グローバルに対して、すでに Node が存在していればそれを使い、 なければ function() { … } を使う、というのは前回までで触れましたが、 その中身では、すぐに例外を投げています。</p>

<p>これは、直接 DOM の要素を new Node() などで作れないようになっており、 DOM ツリーへの要素追加も、document.createElement() を介して要素を生成するようになっているためです。 また、DOM へのアクセスも getElement… や querySelectorAll などからしか出来ないようになっています。</p>

<p>このあたりは HTML を表示しようとした時点で色々勝手にやってくれている部分であり、 ひょっとしたら知る必要はないのかもしれませんが、 とはいえ <strong>window.Node には DOM ツリーを構成する役割があって、少なくとも Node という名前はグローバルで使っているんだ</strong>、 ということくらいは知っておいてもいいのかもしれません。</p>

<p>（※なお、ここで言っている Node というのは、Node.js とは関係しません。あくまで DOM ツリーの構成要素という意味での Node です。）</p>

<h2 id="まとめ">まとめ</h2>

<p>イベントの方まで行けませんでした・・・。</p>

<p>ブログ記事として書き始めたのを若干後悔しています。しばらく（不定期で）続きます。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年2月12日">2014年2月12日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/dom/">DOM</a></li>
    <li class="flow"><a href="/tags/javascript/">JavaScript</a></li>
    <li class="flow"><a href="/tags/jquery/">jQuery</a></li>
    <li class="flow"><a href="/tags/polyfills/">polyfills</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年2月5日">2014年2月5日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/ios/">iOS</a></li>
    <li class="flow"><a href="/tags/bugs/">bugs</a></li>
  </ul>
</div>




<p>タイトル通りなのですが、色々調べたりするのに時間かかったので一応メモしておきます。</p>

<p>ひょっとすると、iOS7.1 以降にアップデートすると解消される内容かもしれません。 ただし現時点（2014/02/06）では iOS7.0.4 が最新であり、こちらのバージョンでは問題が確認できた内容です。</p>

<h2 id="ipad-のランドスケープモードの表示でずれる">iPad のランドスケープモードの表示でずれる</h2>

<p>たまたま手元に iOS6 のままアップデートしていない iPad があり、 まずそちらで検証して上手く行っていたのですが、 一通り検証し終わって「iOS7 にアップデートするかー」というタイミングで確認できた事象です。</p>

<p>iOS7.0.4 の最新にアップデートした後で、iPad を横向きにした状態、 つまりランドスケープモードにして再度確認してみたら、 なんだかスクロールバーのようなものが出て、タッチして上下にスクロールが出来てしまいます。</p>

<p>キャプチャにとって調べてみると、どうやら 20px ほど中身の要素が大きくはみ出てしまっている模様です。</p>

<h2 id="スクロールバーの問題と思いきや-ただのバグだった">スクロールバーの問題と思いきや、ただのバグだった</h2>

<p>iOS でそのサイズに相当するものが余分に表示、もしくは消えているなどで、 20px 相当ずれてしまっているのかな？と思ったのですが、 <strong>html 要素に対して height: 100% のスタイルを充てた状態だと、window.innerHeight は 672px ですが、window.outerHeight は 692px になるというバグ</strong>があるようです。</p>

<p>検証用ページを用意されている方がいるようですので利用させてもらい、確認してみました。</p>

<p><a href="http://krpano.com/ios/bugs/ios7-ipad-landscape/" target="_blank">http://krpano.com/ios/bugs/ios7-ipad-landscape/</a></p>

<p><img src="/img/2014/02/ipad-ios7-landscape01.png" alt="" /></p>

<p>これが Firefox 27（現時点で最新）のキャプチャです。 Chromeでも同じですがサイズ通りの表示です。</p>

<p><img src="/img/2014/02/ipad-ios7-landscape02.png" alt="" /></p>

<p>次が iPad（iOS シミュレータ、ただし実機でも確認して同様）のポートレートモードのキャプチャです。 こちらも問題ないですね。</p>

<p><img src="/img/2014/02/ipad-ios7-landscape03.png" alt="" /></p>

<p>こちらが問題の iPad, iOS7, ランドスケープモードのキャプチャです。 offsetHeight, clientHeight あたりの数値が 20px ほど（21px のときも？）増えちゃってます。</p>

<p>うーん。こういうの困りますねー。まあまだ Android のカオスっぷりと比べたら、こんなの優しいのかもしれませんが。。。</p>

<h2 id="対策">対策</h2>

<p>やはり皆さん困っていらっしゃったようで、困ったときの Stack Overflow 様々ですね。</p>

<p><a href="http://stackoverflow.com/questions/19012135/ios-7-ipad-safari-landscape-innerheight-outerheight-layout-issue" target="_blank">http://stackoverflow.com/questions/19012135/ios-7-ipad-safari-landscape-innerheight-outerheight-layout-issue</a></p>

<p>ただ、この対策をとったとしても、iOS7.1 以降ではまだどうなるか分からないため、 後は対応度合いやバージョンのシェアの推移などを見て総合的に判断していくしかなさそうです。 （という玉虫色の結論で締めておきます。）</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年2月5日">2014年2月5日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/ios/">iOS</a></li>
    <li class="flow"><a href="/tags/bugs/">bugs</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年2月2日">2014年2月2日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/ajax/">ajax</a></li>
    <li class="flow"><a href="/tags/javascript/">JavaScript</a></li>
    <li class="flow"><a href="/tags/jquery/">jQuery</a></li>
    <li class="flow"><a href="/tags/jsperf/">jsperf</a></li>
    <li class="flow"><a href="/tags/polyfills/">polyfills</a></li>
  </ul>
</div>




<p>前回からの続きです。 <a href="/archives/1233/">jQuery から卒業するための第1歩を polyfills から学ぼう</a></p>

<p><a href="https://github.com/inexorabletash/polyfill" target="_blank">https://github.com/inexorabletash/polyfill</a> にある web.js をソースコードリーディングしています。 また、es5.js は予め読み込まれている前提となります。</p>

<h2 id="xmlhttprequest-xhr">XMLHttpRequest（XHR）</h2>

<p>いわゆる Ajax の核となる API です。</p>

<p><a href="http://ja.wikipedia.org/wiki/XMLHttpRequest" target="_blank">http://ja.wikipedia.org/wiki/XMLHttpRequest</a></p>

<p>例えば、jQuery を用いてファイルを非同期で取得する場合、 以下のように書いた経験があるかもしれません。</p>

<pre><code>$.ajax({
  type: &quot;POST&quot;,
  url: &quot;some.php&quot;,
  data: { name: &quot;John&quot;, location: &quot;Boston&quot; }
})
</code></pre>

<p><a href="http://api.jquery.com/jQuery.ajax/" target="_blank">http://api.jquery.com/jQuery.ajax/</a> の Examples からの引用です。</p>

<p>この $.ajax の内部で使われているのが、<strong>window.XMLHttpRequest</strong> ですね。</p>

<p>window.XMLHttpRequest は、IE7 から使えるのですが、IE6 以前では使えはするものの、同じ記述ではできません。</p>

<p>23〜37行目を抜粋します。</p>

<pre><code>  //
  // XMLHttpRequest (http://www.w3.org/TR/XMLHttpRequest/)
  //
  window.XMLHttpRequest = window.XMLHttpRequest || function () {
    /*global ActiveXObject*/
    try { return new ActiveXObject(&quot;Msxml2.XMLHTTP.6.0&quot;); } catch (e1) { }
    try { return new ActiveXObject(&quot;Msxml2.XMLHTTP.3.0&quot;); } catch (e2) { }
    try { return new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); } catch (e3) { }
    throw Error(&quot;This browser does not support XMLHttpRequest.&quot;);
  };
  XMLHttpRequest.UNSENT = 0;
  XMLHttpRequest.OPENED = 1;
  XMLHttpRequest.HEADERS_RECEIVED = 2;
  XMLHttpRequest.LOADING = 3;
  XMLHttpRequest.DONE = 4;
</code></pre>

<p>ActiveX について掘り下げると本質的ではなくなってしまうのであまり触れませんが、IE6 で Ajax を実現するためには、<strong>ActiveXObject</strong> を用います。</p>

<p>try ~ catch を用いて、試しにオブジェクトを作って上手くいけばそれを採用しています。 try 文の中で、すぐに return するように書かれているので、 new ActiveXObject 部分に問題がなければそのまま function の処理が終わります。 （逆に問題があれば “Illegal return statement” などの SyntaxError が起きますが、catch 文でそのままキャッチアンドリリースしちゃってるので、実際何も起きません。）</p>

<p>その後、XMLHttpRequest オブジェクトに対して、 必要な定数（正確には大文字なだけでただの変数ですが、定数として見なして使っています）を 定義しています。</p>

<p>このあたりの話はかなり使い古されており、もうすでに caniuse.com にすら項目として掲載されていないくらい当たり前の手法となっています。詳しくは以下などをご覧ください。</p>

<p><a href="http://ja.wikipedia.org/wiki/XMLHttpRequest#.E5.88.A9.E7.94.A8.E6.B3.95" target="_blank">http://ja.wikipedia.org/wiki/XMLHttpRequest#.E5.88.A9.E7.94.A8.E6.B3.95</a></p>

<p>なお、<strong>XHR</strong> という略は本当によく使うので、 知らなかった人はこれだけは覚えておいた方が良いと思います。 <strong>XHR = XML Http Request</strong> です。</p>

<h2 id="xmlhttprequest-level-2-xhr2">XMLHttpRequest Level 2 (XHR2)</h2>

<p>上記のパワーアップ版です。</p>

<p>先に42行目、73行目を抜粋します。</p>

<pre><code>  if (!('FormData' in window)) {
  }
</code></pre>

<p>外枠は FormData オブジェクトがあるかどうかで判別をしています。この FormData が一体なんなのか？というのを知るのと同時に、XHR2 でざっくり何が出来るようになったのかを調べてみます。</p>

<p><a href="http://caniuse.com/#feat=xhr2" target="_blank">http://caniuse.com/#feat=xhr2</a></p>

<p><img src="/img/2014/02/polyfills04.png" alt="" /></p>

<p>IE10, iOS5.0, Android3.x, 4.x 以降、その他モダンブラウザで使えるようになったものですが、 <strong>ファイルアップロード時の進捗</strong>を取れたり（progress）、<strong>クロスドメインのリクエスト</strong>などが出来るようになりました。</p>

<p>その他にも、フォームに入力された情報を FormData オブジェクトとして XHR オブジェクトにそのまま渡す仕組みも導入されています。以下に詳しく載ってますが、サンプルコードだけ抜粋します。</p>

<p><a href="http://www.html5rocks.com/ja/tutorials/file/xhr2/#toc-send-formdata" target="_blank">http://www.html5rocks.com/ja/tutorials/file/xhr2/#toc-send-formdata</a></p>

<pre><code>function sendForm() {
  var formData = new FormData();
  formData.append('username', 'johndoe');
  formData.append('id', 123456);

  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/server', true);
  xhr.onload = function(e) { ... };

  xhr.send(formData);
}
</code></pre>

<p>最後の xhr.send(formData) で、FormData オブジェクトを引数にして XHR オブジェクトに渡しているのがなんとなく分かると思います。</p>

<p>という感じで、XHR2 の新しい機能みたいなのは大まかには知ることが出来たと思います。</p>

<h3 id="果たして-xhr2-をすべて-polyfills-として提供できるのか">果たして、XHR2 をすべて polyfills として提供できるのか？</h3>

<p>ここまで読んで、<strong>全部は無理じゃね？</strong>と気づかれた方もいるのではないでしょうか。</p>

<p>クロスドメインのリクエストなんかは、IE8 では非標準の <strong>XDomainRequest</strong> を代用して 実現は出来るのですが、IE7 以前でクロスドメインでファイルのリクエストをするのは難しいです。</p>

<p>自分も日々気をつけたいと思っているのですが、polyfills があるから安易に 「クロスブラウザ対応、問題なくできちゃいます！」と判断しちゃうと、 後で痛い目見ることになると思うので注意が必要です。 <strong>実際に読んで把握したり試したりするのがやっぱり大事ですね。</strong></p>

<p>さっきの抜粋だと、</p>

<pre><code>  if (!('FormData' in window)) {
  }
</code></pre>

<p>FormData オブジェクトがあるかどうかチェックしているため、 FormData オブジェクトに関する polyfills であることが分かります。</p>

<h3 id="即時関数と-jsperf">即時関数と jsperf</h3>

<p>さらにもう内側、43行目、72行目</p>

<pre><code>    (function(global) {
      （中略）
    }(this));
</code></pre>

<p>このように、function （と丸括弧）で挟んでやることで、 引数を渡してすぐにその引数を受け取って実行することが出来るわけですが<strong>（即時関数）</strong>、 this は元々 global であるため、無くてもちゃんと動きます。</p>

<p>何が違うかというと、function の仮引数である global は、function の中だけで有効なローカル変数となっているので、ローカル変数へのアクセスとなり、window オブジェクトへの頻繁なアクセスを避けた方が効率的であるためです。</p>

<p>・・・なんのことを言っているのか分からない人もいると思うので、実際に動かしてみましょう。</p>

<p><strong>jsperf</strong> というサイトがあって、検証コードをその場で試して動かすことが可能です。なお、js の <strong>perf</strong>ormance の略です。 （jsperf に関しては、余裕があればまた改めて記事として書ければなーと思います。）</p>

<p><a href="http://jsperf.com/writing-to-global-objects" target="_blank">http://jsperf.com/writing-to-global-objects</a></p>

<p><img src="/img/2014/02/polyfills05.png" alt="" /></p>

<p>IE8 にて動作させた結果のキャプチャです。</p>

<p>そのまま global として扱った場合と、一度即時関数内でローカル変数として扱った場合とでは、<strong>IE8 にて約5%のパフォーマンスの差異</strong>が出るようです。（もちろんブラウザによって異なります）</p>

<p>なので、こういった頻繁に window オブジェクトにアクセスするようなものは、 予め即時関数でラッピングしてどうこうする、みたいに書かれることが多いですね。勉強になります。</p>

<h3 id="xhr2-の-formdata-オブジェクトの-polyfills">XHR2 の FormData オブジェクトの polyfills</h3>

<p>大分寄り道しましたが、中身を読んでいきます。 とはいえ、全部紹介してたらきりがないので、ポイントだけ抜粋します。</p>

<p>44〜49行目の抜粋です。</p>

<pre><code>      function FormData(form) {
        this._data = [];
        if (!form) return;
        for (var i = 0; i &lt; form.elements.length; ++i)
          this.append(form.elements[i].name, form.elements[i].value);
      }
</code></pre>

<p>new するための FormData オブジェクトを用意しています。 そもそもの FormData オブジェクトの使い方として、引数に HTMLFormElement を取ることが出来るので、引数が無ければそのまま return、あれば append を呼ぶ、となってます。</p>

<p>続いて51〜55行目です。</p>

<pre><code>      FormData.prototype.append = function(name, value /*, filename */) {
        if ('Blob' in global &amp;&amp; value instanceof global.Blob) throw TypeError(&quot;Blob not supported&quot;);
        name = String(name);
        this._data.push([name, value]);
      };
</code></pre>

<p>後追いでフォームの名前と値を追加できるメソッドを用意しています。XHR2 になって、Blob データも送ることが出来るようになったので、Blob 関連の記述もあります。</p>

<p>63行目です。</p>

<pre><code>      global.FormData = FormData;
</code></pre>

<p>global のプロパティに紐付けてやることで、即時関数内で定義したものを外からも呼べるようになります。</p>

<p>最後に64〜71行目の抜粋です。</p>

<pre><code>      var send = global.XMLHttpRequest.prototype.send;
      global.XMLHttpRequest.prototype.send = function(body) {
        if (body instanceof FormData) {
          this.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          arguments[0] = body.toString();
        }
        return send.apply(this, arguments);
      };
</code></pre>

<p>ここからは、FormData オブジェクトについてではなく、それに関連した既存の XHR オブジェクトの send メソッドの改良についてです。</p>

<p>元々 XHR には send メソッドがあるのですが、新たに FormData も送ることが出来るようになったので、基本の仕組みはそのまま踏襲しつつも、FormData オブジェクトも受け取れるようにしなくてはなりません。</p>

<p>そこで、まず var send = &#8230; として一時的に send 変数に入れておき、 新たに global.XMLHttpRequest.prototype.send として定義して、 FormData オブジェクトだったときの処理を挟みつつ、最後に send.apply で元々の処理を呼んでやるという流れになっています。</p>

<p>・・・とこんな感じで XHR, XHR2 と通信周りを順に読んでみましたが、polyfills を追っていくだけでも色々と勉強になりますね。 いやぁ、けっこう長くなりました。</p>

<h2 id="requestanimationframe">requestAnimationFrame</h2>

<p>お次は requestAnimationFrame です。</p>

<p>HTMLベースのアニメーションは、ほとんどパラパラアニメの仕組みと同じで、 フレームごとに再描画して動いているわけですが、 長らく setTimeout, setInterval などのタイマーを用いてそれが行われていました。</p>

<p>これはもう名前のごとく、アニメーションフレームをリクエストするためのメソッドですね。</p>

<p>詳しい説明はこちらです。</p>

<p><a href="https://developer.mozilla.org/ja/docs/Web/API/window.requestAnimationFrame" target="_blank">https://developer.mozilla.org/ja/docs/Web/API/window.requestAnimationFrame</a></p>

<p>これも元々 setTimeout, setInterval があるので、polyfills として問題なく提供できるはずですね。</p>

<p>流れは XHR とほとんど同じで、即時関数にラッピングして最後に global に紐付けする形です。 requestAnimationFrame が global に紐付けされる前までに、即時関数内だけで使われている処理、94行目から106行目を抜粋します。</p>

<pre><code>    function onFrameTimer() {
      var cur_requests = requests;

      requests = Object.create(null);
      timeout_handle = -1;

      Object.keys(cur_requests).forEach(function(id) {
        var request = cur_requests[id];
        if (!request.element || isVisible(request.element)) {
          request.callback(Date.now());
        }
      });
    }
</code></pre>

<p>これは毎フレームごとに呼ばれる関数となっています。 request は、function のすぐ上に requests = Object.create(null); という変数で用意されており、function 内にも全く同じ記述がされています。</p>

<h3 id="proto-と-console-dir">proto と console.dir</h3>

<p>じゃあ、この Object.create(null) っていうのは一体何やってるのか？というと、 本当の意味で何もない空のオブジェクトを生成しています。</p>

<p>例えば、今開発者ツールを開いて、</p>

<pre><code>var a = Object.create(null);
var b = {};
a === b; // =&gt; ?
</code></pre>

<p>と入力してみると、実際 <strong>false</strong> になります。 そういうときは、例えば <strong>console.dir</strong> などを使ってオブジェクトの中身を詳しく見てみると違いが分かると思います。</p>

<p><img src="/img/2014/02/polyfills06.png" alt="" /></p>

<p>こちらが Firefox での console.dir の表示結果です。</p>

<p><strong>proto</strong> があるかないかの違いが見られます。</p>

<p><img src="/img/2014/02/polyfills07.png" alt="" /></p>

<p>こちらは Chrome での console.dir の表示結果です。（もちろん結果は同じです）</p>

<p>何らかの key, value を持ったオブジェクトを作り、それを for in などでループして何か処理しようとしても、プロトタイプ継承によって余分なプロパティまでもアクセスできてしまいます。それを防ぐために、for in ループの中に Object.prototype.hasOwnProperty を使って自分自身のプロパティでないものは外す、といった定石は有名ですね。</p>

<pre><code>var buz = {
  fog: 'stack'
};

for (var name in buz) {
  if (buz.hasOwnProperty(name)) {
    alert(&quot;this is fog (&quot; + name + &quot;) for sure. Value: &quot; + buz[name]);
  } else {
    alert(name); // toString or something else
  }
}
</code></pre>

<p><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/hasOwnProperty" target="_blank">https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/hasOwnProperty</a> の『例: オブジェクトのプロパティの反復処理』より抜粋</p>

<p>これを実現する別の方法として、何にも継承していない本当に空のオブジェクトを Object.create(null) で作ってやることで、for などでループを回しても継承元がどうこうと考えなくてもよくなります。</p>

<h3 id="requestanimationframe-の残り">requestAnimationFrame の残り</h3>

<p>だいぶ話がそれましたが、Object.keys で cur_requests のキーだけの配列を取得し、それぞれ callback を呼んでいます。</p>

<p>いまいち element が何なのか分からなかったのですが、 （仕様には callback しかなく、第2引数に element を指定するような仕組みはないっぽい・・・）element が無ければ if の中がそのまま実行されるので無視しても良さそうです。</p>

<p>最後に128〜134行目の抜粋です。</p>

<pre><code>    global.requestAnimationFrame =
      global.requestAnimationFrame ||
      global.webkitRequestAnimationFrame ||
      global.mozRequestAnimationFrame ||
      global.oRequestAnimationFrame ||
      global.msRequestAnimationFrame ||
      requestAnimationFrame;
</code></pre>

<p>他のものと同様に、最後に global に紐付けて即時関数の外からも呼べるようにするのですが、 ブラウザの実装度合いによってベンダープレフィックスがついている場合もあるので、それも考慮した書き方になっています。</p>

<p>論理和ごとに順に使えるかどうかチェックして、使えるものがあればそれ、なければ次のものを見ていき、最終的にどれも使えなければ、今即時関数内に用意している requestAnimationFrame を使う、といった流れです。</p>

<h2 id="setimmediate">setImmediate</h2>

<p>似たような API として、今のところ IE だけが対応している setImmediate というのがあります。</p>

<p>ほぼ requestAnimationFrame と同じでそれよりもシンプルなので、 149〜154行目だけ抜粋しておきます。</p>

<pre><code>    function setImmediate(callback/*, args*/) {
      var params = [].slice.call(arguments, 1);
      return global.setTimeout(function() {
        callback.apply(null, params);
      }, 0);
    }
</code></pre>

<p>同様に setTimeout を用いて実現しています。</p>

<p>[].slice.call(arguments, 1) は何をしているかというと、 arguments がその関数内における仮引数のリスト（配列っぽいオブジェクト）に相当するので、 それを実際に配列オブジェクトに用意されている slice メソッドを使って 1つだけ切り出してます。</p>

<p>[0, 1, 2].slice(1) // =&gt; [1, 2] このまま使えばこんな感じですが、arguments はあくまで配列っぽいオブジェクトであるため、 slice メソッドなどは持ち合わせてませんので、call を使って実現しています。</p>

<h2 id="まとめ">まとめ</h2>

<p>はーー、思ったよりも進まない・・・。</p>

<p>ソースコードを読むこと自体は、そんなに時間のかかる行為ではないんですが、それをブログに説明として分かりやすく載せるとなると、意外に時間かかっちゃうものですね。</p>

<p>たぶんその4、その5あたりまで行っちゃうかもしれません。</p>

<p>お次は DOM 周りの polyfills です。イベントもいけたらいいな。</p>

<p>追記：<a href="/archives/1269/">続き書きました。</a></p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年2月2日">2014年2月2日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/ajax/">ajax</a></li>
    <li class="flow"><a href="/tags/javascript/">JavaScript</a></li>
    <li class="flow"><a href="/tags/jquery/">jQuery</a></li>
    <li class="flow"><a href="/tags/jsperf/">jsperf</a></li>
    <li class="flow"><a href="/tags/polyfills/">polyfills</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年1月30日">2014年1月30日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/javascript/">JavaScript</a></li>
    <li class="flow"><a href="/tags/jquery/">jQuery</a></li>
    <li class="flow"><a href="/tags/polyfills/">polyfills</a></li>
  </ul>
</div>




<p>jQuery というライブラリは非常に便利な JavaScript ライブラリであります。</p>

<h2 id="jquery-便利">jQuery 便利！</h2>

<p>いやー、便利ですよね。便利すぎて、JavaScript を書いてHTML要素を何かしようと思ったときに、無条件で使用してしまうケースもけっこう多いのではないでしょうか。</p>

<p>ただ、知っている人は、jQuery のファイルサイズが若干重いことも知っています。</p>

<p>2014年2月時点での jQuery の最新バージョンでファイルサイズを見てみると、</p>

<ul>
<li>jquery-1.11.0.js (277KB)</li>
<li>jquery-1.11.0.min.js (95KB)</li>
<li>jquery-2.1.0.js (240KB)</li>
<li>jquery-2.1.0.min.js (82KB)</li>
</ul>

<p>IE8未満をばっさり切った 2.x 系だと、圧縮したもので 82KB あります。IE8未満も含めた 1.x 系だと、圧縮したもので 95KB もあります。</p>

<p>また、jQuery にはプラグイン機構があるため、ライブラリのファイルに続けて、プラグイン用のファイルをいくつか読み込むことが多いと思います。</p>

<p>ファイルサイズの問題うんぬんもあるのですが、それに加えて<strong>同時リクエスト数の問題</strong>もあります。例えば画像ファイルなどであれば、例えば6ファイルなどを同時にリクエストすることが出来ますが、スクリプトのファイルだと、実行順などの問題もあるので、<strong>スクリプトファイルを読み込んでいる最中は他スクリプトがストップしてしまう</strong>ので、あれこれとプラグイン用のファイルを読み込んでいると、いつまでたっても全体の処理が終わらないことになります。</p>

<p>そのあたりの説明は、以下に詳しく載ってます。</p>

<p><a href="https://developers.google.com/speed/docs/best-practices/rtt?hl=ja&amp;csw=1#CombineExternalJS" target="_blank">https://developers.google.com/speed/docs/best-practices/rtt?hl=ja&amp;csw=1#CombineExternalJS</a></p>

<h3 id="jquery-は甘え-という風潮">「jQuery は甘え」という風潮</h3>

<p>便利なライブラリである一方で、安易に使いまくる人に対して、甘えだーという人も一定数居ます。</p>

<p>個人的には、無理に使用を縛らずケースバイケースで普通に使っていくべきだとは思いますが、 ちょっとした処理をしたいときに毎回 「jQuery がないとダメ、何にもできない・・・。」みたいなのも少しずつ改めていくべきだとは思います。</p>

<p>例えば、class=”toggle” がついている要素を取得して何かしたい場合、 jQuery であれば以下のように書きます。</p>

<pre><code>var toggles = $('.toggle');
</code></pre>

<p>ただ、これくらいであれば、jQuery を介さずとも簡単に取得できます。</p>

<pre><code>var toggles = document.querySelectorAll('.toggle');
</code></pre>

<p>どちらもそれほど変わらない記述で class=”toggle” を含む要素を取得できるので、その後の処理によってはわざわざ jQuery を読み込まずとも、素の JavaScript でも問題なかったりしますね。</p>

<h3 id="クロスブラウザという現実的な問題">クロスブラウザという現実的な問題</h3>

<p>・・・という理想郷の話だったわけですが、現実はそう簡単にはいかないケースも多いです。</p>

<p>jQuery が吸収してくれているのは、こういったブラウザ間の JavaScript の実装差異だったりします。</p>

<p>例えば、先ほど書いた document.querySelectorAll の例ですが、 IE8未満では実はサポートされていません。</p>

<p><a href="http://caniuse.com/#feat=queryselector" target="_blank">http://caniuse.com/#feat=queryselector</a></p>

<p><img src="/img/2014/01/polyfills01.png" alt="" /></p>

<p>この例だと、たまたま IE8 以上か IE7 以下かで分けられるので、 IE7 以前なんていいじゃん、というケースも出てくるかもしれませんが、 ブラウザの対応度合いは様々なので、その都度対応しているかどうかを考えて、 この場合はこうして・・・などと毎回考えていくのはあまり本質的ではありませんね。 やりたいことを解決するために時間を使った方が良いと思います。</p>

<h2 id="jquery-から卒業するための第1歩を-polyfills-から学ぼう">jQuery から卒業するための第1歩を polyfills から学ぼう</h2>

<p>そこで本記事のタイトルです。</p>

<p><strong>polyfills（ポリフィル）</strong>というのは、数年前から言われている概念なので、 知っている人もいくらかいるのではないかと思いますが、 モダンブラウザで普通に出来て、レガシーブラウザで出来ない機能を、既存の技術で（あるいはそれらの組み合わせで）同等のものを提供する、という手法です。</p>

<p>※ちなみに fallback（フォールバック）は、提供が難しいものに対してそれに近しいもので代替することを指すので、ちょっと違うと思います。</p>

<p>つまり、polyfills を利用して、レガシーブラウザ用に機能が足りてない部分を 補完してやることで、レガシーブラウザの場合にああしてこうして・・・といった部分の 考えるコストを一定低減することが出来ます。</p>

<h3 id="polyfills-を知ることでブラウザの実装の歴史を知る">polyfills を知ることでブラウザの実装の歴史を知る</h3>

<p>色んな方が polyfills を公開しています。</p>

<p>まとめられているページがこちら。</p>

<p><a href="https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-browser-Polyfills" target="_blank">https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-browser-Polyfills</a></p>

<p>たくさんあるのですが、今回読んだのがこちら。</p>

<p><a href="https://github.com/inexorabletash/polyfill" target="_blank">https://github.com/inexorabletash/polyfill</a></p>

<p><img src="/img/2014/01/polyfills02.png" alt="" /></p>

<p>こちらでは、例えば JavaScript の仕様である ECMAScript の、 バージョン5に相当する ECMAScript5 (ES5) と見比べて、 不足している実装部分を <strong>es5.js</strong> として提供されていたり、 あるいは バイナリデータ（映像、音声など）を効率良く扱うための Typed Array の polyfills が <strong>typedarray.js</strong> として提供されていたりします。</p>

<p><img src="/img/2014/01/polyfills03.png" alt="" /></p>

<p>その中で、<strong>Web Standards / Browser</strong> として提供されている polyfills、<strong>web.js</strong> というのがあります。</p>

<p>こちらは、上記に挙げたようなある特定の仕様に対して不足があるかどうか？というよりは、一般的に Web 標準で考えた場合に不足があるかどうか？を元に polyfills がまとめられています。 なので、こちらのコードを追っていくことで<strong>逆にブラウザの実装の歴史が分かるのではないでしょうか。</strong></p>

<p>・・・ということで、前振りが長かったですが、一言で言うと、<strong>『このリポジトリの web.js というファイルを順に読んでブラウザの実装差異について理解していこう！』</strong>という記事になります。</p>

<h2 id="polyfills-のソースコードリーディングを始めよう">polyfills のソースコードリーディングを始めよう</h2>

<p>早速10行目と613行目を抜粋します。</p>

<pre><code>if ('window' in this &amp;&amp; 'document' in this) {
  //（中略）
}
</code></pre>

<p>this は、通常ブラウザで読み込むと global に相当しますので、global に window と document がある場合にのみ処理されます。（要するに処理されます）</p>

<p>次は、18行目から21行目です。簡単なところから始まってて（ブログ書きやすくて）良かったですね。</p>

<pre><code>//
// document.head (HTML5)
//
</code></pre>

<p>document.head = document.head || document.getElementsByTagName(&#8216;head&#8217;)[0]; 僕これ知らなかったのですが、HTML5 だと document オブジェクトに head プロパティがあり、 それが HTML 内の head 要素を指すのですね。</p>

<p>対応しているものは、document.head がそのまま使われるのですが、対応してないものは undefined を返すので、|| の後ろが実行されます。</p>

<p>document.getElementsByTagName は、getElementById と同じく 古いIEでも普通に使えます。 読んで字のごとく、要素（複数）をタグ名で取得するってことで、 head 要素を取得してから、それの一番最初のやつを使いますってことですね。</p>

<p>このように論理和（||）を用いて実装の差異を埋めてやることで、polyfills を上手く実現していることが見てとれます。</p>

<h2 id="まとめ">まとめ</h2>

<p>ちょっと前振りが長かったので一旦切りたいと思います。</p>

<p>このように、polyfills を順に追っていくことで、ブラウザの実装の歴史を知るのもなかなかお手軽で良いのではないでしょうか。</p>

<p>こちらのコードに書かれているような実装差異の吸収の仕方、テクニックを見ていくことで、ついでに自分が書くときにもプラスになるのでは？と思うので、これから順に見ていきたいと思います。</p>

<p>なお、最初の8行のコメントにもあるように、</p>

<pre><code>//----------------------------------------------------------------------
//
// Browser Polyfills
//
// This assumes ES5 or ES3 + es5.js
// (polyfill.js is es5.js + web.js for convenience)
//
//----------------------------------------------------------------------
</code></pre>

<p>正確には polyfill.js 全体が es5.js と web.js の組み合わせで出来ていますが、今回は ES5 に注目して読むよりも、Web Standards な方に注目して見てみたい、という意図があったので、web.js の方を見ています。</p>

<p>なので、このまま読んでいくと、ES5 前提の記述をちらほら見かけます。これは予め es5.js の機能を読み込んでいるためです。次回以降の続きの記事でたぶん出てきますので予めご了承ください。</p>

<p>たぶん続きます。</p>

<p>追記： <a href="/archives/1254/">続き書きました。</a></p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年1月30日">2014年1月30日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/javascript/">JavaScript</a></li>
    <li class="flow"><a href="/tags/jquery/">jQuery</a></li>
    <li class="flow"><a href="/tags/polyfills/">polyfills</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年11月13日">2013年11月13日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/css/">CSS</a></li>
    <li class="flow"><a href="/tags/mediaquery/">mediaQuery</a></li>
    <li class="flow"><a href="/tags/viewport/">viewport</a></li>
    <li class="flow"><a href="/tags/smartphone/">Smartphone</a></li>
  </ul>
</div>




<p>最近改めて使い分けないとなーと実感したので、その実感を忘れないうちにメモしておこうと思います。</p>

<h2 id="デバイスの幅-width-と-device-width-の違いについて">デバイスの幅(width)と device-width の違いについて</h2>

<p>そもそもの話ですが、そのデバイスで何ピクセル x 何ピクセルで表示できますよーという値と、 device-width の値は異なります。（結果的に同じ場合もあり得ますが）</p>

<p><a href="http://screensiz.es/" target="_blank">http://screensiz.es/</a></p>

<p><img src="/img/2014/01/device-width01.png" alt="" /></p>

<p>こちらに、デバイスごとの width, device-width がまとめてあります。たまに見ます。</p>

<p>iPhone 3GS の時代であれば、width = 320px, device-width = 320px であったので問題なかったのですが、 retina ディスプレイが出てきてから、 width = 640px, device-width = 320px になってきています。</p>

<p>それならまだ 1:2 になるので分かりやすくて良かったのですが、 そうではない多種多様なデバイスが世に出回っています。</p>

<p>例えば Surface Pro は、1920 x 1200px で device-width = 1280px であったり、 Nexus7 は、800 x 1280px で device-width = 601px であったり、 さらに Nexus7 の例のように、<strong>アップデートで device-width は変化したりもします。</strong></p>

<p>一緒に作ってる人と話すときにそのあたりの認識が異なる場合がそこそこあるのですが、 device-width は、あくまでそのデバイスを提供している側が、<strong>見せたい側の都合の良いサイズ</strong>を決めているだけにすぎないもので、 width と device-width に依存関係はないと考えています。</p>

<p>タブレット周りは特にそれが顕著で、サイズ的にも『PCレイアウトで見せたい！』というデバイスの開発側の意図により、 PCレイアウトに近くなるような device-width が決められています。 （768px であったり、1024px であったり・・・）</p>

<p>そもそも device-width がどっちの辺を指すのか？も、デバイスの開発側の意図によるもので、 デバイスによって様々です。大変ですね。</p>

<p>なので、「必ずこの端末は意図した通りのデザインで見せたい！」とか、 「アプリとしてリリースするけど、この部分はWebViewでー」とか、そういったケースで viewport のメタタグに device-width が設定してある場合などは、 （当たり前とは思いつつも）きちんとチーム内で作る対象のサイズを共有しなければと思っているところです。</p>

<h2 id="max-width-と-max-device-width-の違い">max-width と max-device-width の違い</h2>

<p>こちらが本題です。</p>

<p>CSS の mediaQuery で幅に応じてスタイルの出し分けを行ったりするケースで使うのですが、</p>

<blockquote>
<p>@media only screen and (max-width: 480px) {</p>
</blockquote>

<p>とか、</p>

<blockquote>
<p>@media only screen and (max-device-width: 480px) {</p>
</blockquote>

<p>などのように使います。</p>

<p>max-width と max-device-width はどのような違いがあるかというと、 <strong>表示領域の幅</strong>なのか、<strong>そのデバイスそのものの幅</strong>なのかの違いがあります。</p>

<p>例えば以下のケースで、違いが顕著になってくると思います。</p>

<ol>
<li>スマートフォンレイアウトの検証を、簡易的にWebブラウザのウィンドウ幅を変えることで検証を行っている場合</li>
<li>スマートフォンなどのモバイルデバイスを縦横に傾けた場合</li>
</ol>

<p>max-width などの表示領域の幅で指定がしてあった場合、 1.のケースでは例えば開発者ツールを開きながらの検証が非常にスムーズであると思います。 これは表示領域の幅で切り替えており、ウィンドウサイズを変えることでこちらの数値が変わるためにスタイルのあたり方が変化することによるものです。</p>

<p>また、2.のケースでは、仮にしきい値が 480px にしてあった場合、iPhone5 などを縦から横に傾けた場合、 表示領域の幅が 320px から 568px に変化することにより、スタイルのあたり方は同様に変化します。</p>

<p>max-device-width などのデバイスそのものの幅で指定がしてあった場合、 1.のケースでウィンドウサイズを変化させただけでは表示の変化はしません。 この場合は開発者ツールなどでデバイスのサイズ（device metrics）を上書きしてやる必要が出てくると思います。</p>

<p>また、2.のケースでは、一部のデバイスを除き（どれまでかは細かく知らないです）、 デバイスごとに、device-widthを「Webコンテンツをこの幅で見せたいんだ！」と開発側が決めているため、 縦横に傾けてもこの数値は変わらず、上記の mediaQuery 指定でスタイルが変化することはありません。</p>

<p>こういった違いがあるため、作っているものによって使い分ける必要があるのではないかと思います。</p>

<h2 id="例えばレスポンシブレイアウトなど">例えばレスポンシブレイアウトなど</h2>

<p>例えばレスポンシブレイアウトなどで、大きく 480px あたりでPC用リソース、スマートフォン用リソースを出し分けていると仮定します。</p>

<p>max-width で指定してあった場合に、480px の幅を下回るデバイスで閲覧し、横に傾けて 480px を上回るケースでは、 傾けた時点で表示領域・幅が変化することになるため、 適用されるスタイルが大きく変わります。</p>

<p>PC用、スマートフォン用とでリソースを多く出し分けていたとしたら、<strong>傾けた時点で多くのリソースの読み込みが発生してしまう</strong>ことになります。大変なことですね。</p>

<p>どちらが良いとか決めうちで決められるものではないので、作っているものによってこのあたりの違いを踏まえて毎回適切な実装方法を考えていかないといけないなーと、改めて実感したところです。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年11月13日">2013年11月13日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/css/">CSS</a></li>
    <li class="flow"><a href="/tags/mediaquery/">mediaQuery</a></li>
    <li class="flow"><a href="/tags/viewport/">viewport</a></li>
    <li class="flow"><a href="/tags/smartphone/">Smartphone</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年7月26日">2013年7月26日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>




<p>2015/04/01追記：続き書きました。<a href="/archives/1749/">Vagrant で SSH の接続ポート番号を変える、という発想がそもそも間違ってた</a></p>

<p>最近は、隙を見つけて（あんまりないけど） Vagrant + Chef で色々検証をしてたりします。</p>

<p>現実のサーバ構築になるべく即した形でレシピを書こうとしたとき、 <strong>SSH のポート番号を変更する</strong>、といったケースは往々にして出てくるかと思います。（デフォルトは22ですが、そのまま22を使うとアタックを受けやすくなるので変えましょう、という記事は山のようにありますね）</p>

<p><a href="http://easyramble.com/change-ssh-port-number.html" target="_blank">SSH 接続のポート番号を変更 | EasyRamble</a></p>

<p>ただ、Vagrant で SSH のポート番号を変更すると、ちょっとしたところではまってしまって 思いのほか時間がかかったところがあったので、その部分だけメモっておきたいと思います。</p>

<p>なお、CentOS 6 での検証です。他のディストリビューションで設定ファイルなどが異なる可能性はありますが、考え方などはほぼ共通しているかと思いますので、適宜置き換えて考えていただければと思います。</p>

<h2 id="通常のサーバの設定箇所">通常のサーバの設定箇所</h2>

<p>まず、Vagrant などを使わずに設定する場合、どのファイルをいじる必要があるかというと、以下のファイルになるかと思います。</p>

<ol>
<li>/etc/ssh/sshd_config</li>
<li>/etc/sysconfig/iptables</li>
</ol>

<p>1.は、SSH のポート番号を何番にするか？などの設定ファイルです。（もちろん他にも色々項目ありますが）</p>

<p>こちらに、</p>

<pre><code>Port 22
</code></pre>

<p>という設定が書かれているので、これを適当な番号、</p>

<pre><code>Port 12424
</code></pre>

<p>などとして、 <code>/etc/init.d/sshd restart</code> で SSH のサービスを再起動することで設定が有効になります。</p>

<p>2.は、そのポート番号の通信を許可するかどうか？などの設定ファイルです。</p>

<p>こちらに、</p>

<pre><code>-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
</code></pre>

<p>という設定が書かれているので、こちらも先ほどの番号に合わせる形で</p>

<pre><code>-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 12424 -j ACCEPT
</code></pre>

<p>などとします。 こちらも同様に <code>/etc/init.d/networking restart</code> でネットワークの再起動をすることで設定が有効になります。</p>

<p>ここまでは特に新しいことではなく、&#8221;linux ssh ポート 変更&#8221; とか、&#8221;linux iptables&#8221; とかでググればたくさんありますので、紹介程度にとどめておきます。</p>

<h2 id="vagrant-chef-で行う場合">Vagrant + Chef で行う場合</h2>

<p>今までの記事、<a href="http://girigiribauer.localhost/archives/1048" target="_blank">http://girigiribauer.localhost/archives/1048</a> などを見てもらえれば分かるように、 各 Resource のうち、以下だけで上記レシピは書くことができるはずです。</p>

<ul>
<li>file（ファイルの設置）</li>
<li>service（サービスの起動・停止・再起動）</li>
</ul>

<p>ですが、結論から言うと、 SSH のポート番号を変えた際に、vagrant コマンド経由で仮想マシンへの接続が出来なくなってしまい、 （正確には、ポート番号を変えてサービスの再起動を行ったタイミングですね） 結果として上手くいきませんでした。</p>

<p>具体的には、<code>vagrant up</code> にて、最初のレシピが実行され、<code>vagrant up</code> の終了までは上手くいきます。 ですが、そこから <code>vagrant halt</code> や、<code>vagrant reload</code> などを行っても、そもそも仮想マシンとの通信が上手くいかなくなってしまい、最終的には <code>vagrant destroy</code> で世界の終わりを迎えるしかなくなってしまいます。</p>

<p>うーん、困りましたね。みなさんどうしているのでしょうか？</p>

<h3 id="vagrant-up-などで使うポート">vagrant up などで使うポート</h3>

<p><code>vagrant up</code> や、<code>vagrant halt</code> 、または <code>vagrant reload</code> のコマンドで仮想マシンに接続するのですが、 こちらの接続にも（おそらく）SSH が使われています。 デフォルトで22番ポートを使用することになるかと思います。</p>

<p>1回も仮想マシンを動かしておらず、Chef のレシピも実行されていないとき、仮想マシンのセットアップ処理が走ります。</p>

<p>結果として、vagrant という名前のユーザーとともに、すべて初期の設定ファイルが設置されるため、 SSH の接続も、最初は22番ポートでせざるをえないのかなーと思います。</p>

<h2 id="解決方法を色々考えてみた">解決方法を色々考えてみた</h2>

<p>まず前置きとして、Vagrantfile に書かれていない SSH の設定項目が存在しています。</p>

<p>ホストOSとゲストOSを SSH で接続する際、ホストOSの22番ポートを使わず、代わりに別の番号（2222番とか）を使用する、<strong>ポートフォワーディング</strong>の設定が暗黙的に行われています。</p>

<ul>
<li>host:2222 =&gt; guest: 22</li>
</ul>

<p>この設定が暗黙的に行われることで、ホスト側の2222番ポートでアクセスすると、ゲスト側である仮想OSの22番ポートに接続される、といった仕組みです。</p>

<p>今回やりたいのは、初回のレシピが実行され、SSH のポート番号が変更された時点で、</p>

<ul>
<li>host: 2222 =&gt; guest: 12424</li>
</ul>

<p>という接続ポート番号の変更を行いたいわけです。</p>

<h2 id="無理っぽくね">無理っぽくね？</h2>

<p>Vagrantfile が解釈されるのは、<code>vagrant up</code> などのコマンドが入力された時点になるかと思います。</p>

<p>その後レシピが実行されて SSH のポート番号が変更になっても、初回実行時はまだ22番ポートで普通に接続しているので、 レシピの実行が終わり、<code>vagrant halt</code> もしくは <code>vagrant reload</code> で再度仮想マシンに接続し直すと、 もうすでにポート番号が変わっていて、22番で接続できなくなっているという状態に陥ります。</p>

<h3 id="vagrantfile-上での-ssh-のポート番号の変更">Vagrantfile 上での SSH のポート番号の変更</h3>

<p>ちなみに、Vagrantfile 上で SSH のポート番号の変更をするには、以下のように書けば良いっぽいです。</p>

<pre><code>ssh_port = 12424

Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;CentOS_6.4_x86_64_Minimal&quot;

  config.ssh.guest_port = ssh_port

  config.vm.define :vmclient1 do |vmclient|

    vmclient.vm.hostname = &quot;vmclient1&quot;
    vmclient.vm.network :private_network, ip: &quot;192.168.100.11&quot;
    vmclient.vm.network :forwarded_port, guest: ssh_port, host: 2222, id: &quot;ssh&quot;
（以下略）
</code></pre>

<p>ゲスト側、つまりレシピが実際に動いている仮想OS上の SSH ポート番号を、変数 ssh_port としてありますが、当然直に書いても動きます。</p>

<p>forwarded_port の設定で、 <strong>id: &#8220;ssh&#8221; と付け加えてやることで、SSH のデフォルトで動くポートフォワーディングの設定の上書きが出来る</strong>ようです。</p>

<h3 id="レシピ実行中に-ssh-のポート番号を変える">レシピ実行中に SSH のポート番号を変える・・・？</h3>

<p>Vagrantfile 上でなんとかレシピの実行中にポート番号変えられないかと色々調べてもみましたが、やはり無理そうです。</p>

<p>となると、 Vagrantfile 上でポート番号を変えるまでは、サービスの再起動などをしてはいけないことになります。</p>

<p>初回だけは、22番ポートを使って接続しつつ、設定ファイルのみ書き換えておき、サービスの再起動は後回し。 その後仮想OSをシャットダウンさせ（<code>vagrant reload</code> だと、この後 Vagrantfile を書き換えるタイミングを見失うので、ここでは <code>vagrant halt</code> でシャットダウンさせる）、 Vagrantfile の、さっきの ssh_port の変数のところを 22 から 12424 などに変え、<code>vagrant up</code> でゲストOSを立ち上げます。</p>

<p>こうすれば、SSH のポート番号の変更が可能になるわけですが、非常にめんどくさい話ですね。</p>

<h2 id="まとめ">まとめ</h2>

<p>本当に何から何まで自動化したい場合は、vagrant コマンドの外側を管理する何かが必要になるんじゃないかなーとか思ってます。 （1回目の起動は22番使って、そこから自動で <code>vagrant halt</code> して、Vagrantfile のポート書き換えて再度 <code>vagrant up</code> してくれる何か）</p>

<p>とはいっても、そこまで厳密にワンストップですべて自動化したいかと言われると、そうでもなかったりするので、 SSH のポート番号を変えたいときは、以下の手順でやろうと思いました。</p>

<ol>
<li><strong>初回だけ22番</strong>で動かし、ssh の設定を走らせる（<strong>サービスの再起動はしない</strong>）</li>
<li><code>vagrant halt</code> で一旦シャットダウンする</li>
<li>Vagrantfile の<strong>ポート部分書き換え</strong></li>
<li>普通に <code>vagrant up</code></li>
</ol>

<p>逆になんかいい方法あれば教えてほしいです。ぜひ。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年7月26日">2013年7月26日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年7月7日">2013年7月7日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/yeoman/">Yeoman</a></li>
  </ul>
</div>




<p>すみません、ブログしばらく書いておりませんでしたので、先週土曜の大なごやJSで発表した内容でも貼付けておきます。</p>

<p><a href="http://www.slideshare.net/girigiribauer/20130629-yeoman" target="_blank">http://www.slideshare.net/girigiribauer/20130629-yeoman</a></p>

<h2 id="yeoman-って">Yeoman って？</h2>

<p>一言で言うと、<strong>「よし、開発スタートしよう！」</strong>と思った瞬間から、<strong>「さて、これでようやく開発環境整ったぞ！」</strong>というところまでの サポートをしてくれるツールです。</p>

<p>発表内容の本筋としては、初期のテンプレート（ここでは generator と呼ばれていますが）を簡単に利用できるし、 外部に公開もできるし、ローカルで自分専用で持っておくこともできるので、 もうここまでくるとツールじゃなくてインフラだよね、フロント寄りの開発するなら選択肢の1つに入ってくるかも？みたいな流れの発表をしました。</p>

<p>実際僕もそこまで使ってきたわけではないですし、勘違いしてスルーしてた面もあるので、 これから少しずつ使ってみようかなと思っています。</p>

<p>※大阪の方々がとても使いこなしてる印象をもっているので、スライドなどを漁ってみようかなー</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年7月7日">2013年7月7日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/yeoman/">Yeoman</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年5月17日">2013年5月17日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>




<p>よーし、いろいろアプリケーションのインストールの自動化しちゃうぞー！ と思っていましたが、 先に試しておいた方が良さそうなものがあったので、そちらを先にやります。</p>

<h2 id="yum-のリポジトリの追加">yum のリポジトリの追加</h2>

<p>RPM系Linuxディストリビューション、つまり CentOS だったり、 Fedora などの Linux のディストリビューションでは、 <strong>yum (Yellowdog Updater Modified)</strong> と呼ばれるパッケージ管理システムが採用されています。</p>

<p>yum に限らずですが、ソースコードから毎回インストールするのはかなり骨の折れる作業だったりします。 （もちろんやったことない場合には、絶対経験しておくべき作業ではあると思うのですが。）</p>

<p>この yum は、パッケージのインストールがコマンド 1行で出来るので非常に便利ではあるものの、そのまま使うと場合によってはちょっと古めのパッケージ（PHP5.3, MySQL5.1 など）がインストールされてしまいます。</p>

<p>ゲストOS上で、sandbox モードになった状態で試しに PHP をインストールしてみます。</p>

<p>※これは、ゲストOSに実際にログインして手作業でコマンド打ってます。</p>

<pre><code>[vagrant@vmclient1 ~]$ sudo yum install php
（略）
Dependencies Resolved

================================================================================
 Package            Arch        Version                      Repository    Size
================================================================================
Installing:
 php                x86_64      5.3.3-22.el6                 base         1.1 M
Installing for dependencies:
 apr                x86_64      1.3.9-5.el6_2                base         123 k
 apr-util           x86_64      1.3.9-3.el6_0.1              base          87 k
 apr-util-ldap      x86_64      1.3.9-3.el6_0.1              base          15 k
 httpd              x86_64      2.2.15-28.el6.centos         updates      821 k
 httpd-tools        x86_64      2.2.15-28.el6.centos         updates       73 k
 mailcap            noarch      2.1.31-2.el6                 base          27 k
 php-cli            x86_64      5.3.3-22.el6                 base         2.2 M
 php-common         x86_64      5.3.3-22.el6                 base         524 k

Transaction Summary
================================================================================
Install       9 Package(s)

Total download size: 4.9 M
Installed size: 16 M
Is this ok [y/N]: （y と入力）
（略）
Installed:
  php.x86_64 0:5.3.3-22.el6

Dependency Installed:
  apr.x86_64 0:1.3.9-5.el6_2                       apr-util.x86_64 0:1.3.9-3.el6_0.1        apr-util-ldap.x86_64 0:1.3.9-3.el6_0.1        httpd.x86_64 0:2.2.15-28.el6.centos
  httpd-tools.x86_64 0:2.2.15-28.el6.centos        mailcap.noarch 0:2.1.31-2.el6            php-cli.x86_64 0:5.3.3-22.el6                 php-common.x86_64 0:5.3.3-22.el6

Complete!
</code></pre>

<p>入りました。さてバージョンを表示してみます。</p>

<pre><code>[vagrant@vmclient1 ~]$ php -v
PHP 5.3.3 (cli) (built: Feb 22 2013 02:51:11)
Copyright (c) 1997-2010 The PHP Group
Zend Engine v2.3.0, Copyright (c) 1998-2010 Zend Technologies
</code></pre>

<p><strong>5.3.3</strong> が入ったようです。</p>

<p>ちなみに現時点での最新が5.4.15 で、5.5.0 の RC1（リリース候補版、もうすぐ出るよー的な意味）も出ていますし、 5.3 は若干古くなっているバージョンと言ってもいいかもしれません。 （というと、古くねえよ！全然マシだろ！という声がどこかから上がってくるかもしれませんが・・・）</p>

<p>また、PHP の拡張モジュールも何が入っているのやらさっぱりです。</p>

<p>yum のリポジトリを追加することで、最新のパッケージを選択することが可能となるので、 <strong>RPMforge, EPEL, Remi</strong> あたりのリポジトリを追加して、最新のパッケージをインストールできるよう、Chef で色々設定してみます。</p>

<h2 id="手動でリポジトリ追加するのけっこうめんどい">手動でリポジトリ追加するのけっこうめんどい</h2>

<p>学生のころ、yum のリポジトリの追加を手動で何回かやったことがあるのですが、 これがちょっとめんどくさかった記憶があります。</p>

<p>確かに今まで出て来た方法でやれば、yum のリポジトリの追加は自動化できるのですが、 そろそろ先人の知恵をお借りしてもいいのではないかなと思います。</p>

<p><img src="/img/2013/05/chef-thirdparty.png" alt="" /></p>

<p>公式のコミュニティサイトでは、先人の知恵が詰まった Cookbook が多数公開されています。 <a href="http://community.opscode.com/cookbooks" target="_blank">http://community.opscode.com/cookbooks</a></p>

<p>この中に、yum というのももちろん公開されているので、どんなものかを一通り眺めつつ、サードパーティの Cookbook を使って yum のリポジトリの追加を行ってみようと思います。</p>

<h3 id="先にリポジトリの一覧を調べておく">先にリポジトリの一覧を調べておく</h3>

<p>一応、入ったかどうか確認するために、あらかじめ現在の yum のリポジトリ一覧を確認しておきましょう。</p>

<pre><code>[vagrant@vmclient1 ~]$ yum repolist all
（長いので略）
base                                                                            CentOS-6 - Base                                                                         enabled: 6,381
c6-media                                                                        CentOS-6 - Media                                                                        disabled
centosplus                                                                      CentOS-6 - Plus                                                                         disabled
contrib                                                                         CentOS-6 - Contrib                                                                      disabled
debug                                                                           CentOS-6 - Debuginfo                                                                    disabled
extras                                                                          CentOS-6 - Extras                                                                       enabled:    12
updates                                                                         CentOS-6 - Updates                                                                      enabled:   676
repolist: 7,069
</code></pre>

<p>あとで比較に使おうと思います。</p>

<h2 id="vagrantfile-に-cookbook-を追加する">Vagrantfile に Cookbook を追加する</h2>

<p>Vagrant で使用する Cookbook は、~/Vagrant/cookbooks ディレクトリに入れていくルールにしてましたので、</p>

<pre><code>$ cd ~/Vagrant/cookbooks
</code></pre>

<p>cookbooks ディレクトリへ移動して、</p>

<pre><code>$ git clone https://github.com/opscode-cookbooks/yum.git
</code></pre>

<p>公開されている yum の Cookbook を git clone で持ってきます。</p>

<p>すると、自分で作った vmclient1, vmclient2 の他に、yum というディレクトリが出来ているはずなので、ざっと中を覗いてみます。</p>

<pre><code>$ cd yum/recipes
</code></pre>

<p>自分で書いたように、通常は recipes/default.rb が呼ばれますので、こちらを見てみると・・・</p>

<p><strong>コメント文だけで中には特に何も書いてありませんでした。</strong></p>

<p>さてさて、Vagrant のドキュメントを見てみます。</p>

<p><img src="/img/2013/05/chef-thirdparty02.png" alt="" /></p>

<p>&#8216;apache&#8217; っていう Cookbook が使いたかったら、<code>chef.add_recipe 'apache'</code> って書くと追加できるよ！とあります。</p>

<p>また、EPEL であれば &#8216;yum::epel&#8217; 、remi であれば &#8216;yum::remi&#8217; と入れることで Cookbook の指定が出来るようです。</p>

<p>つまり、<strong>default.rb</strong> には何も書いてないけど、<strong>epel.rb</strong> や <strong>remi.rb</strong> にレシピが書いてあるので、 この名前を指定することで<strong>ライブラリのように呼び出して使う</strong>ことができるようですね。</p>

<p>なるほど。</p>

<p>ではさっそく Vagrant に追記して、実行してみます。</p>

<h3 id="vagrantfile-への追記">Vagrantfile への追記</h3>

<p>Vagrantfile の必要なところだけ抜粋します。</p>

<pre><code>vmclient.vm.provision :chef_solo do |chef|
  chef.cookbooks_path = &quot;cookbooks&quot;
  chef.data_bags_path = &quot;data_bags&quot;
  chef.add_recipe &quot;yum::epel&quot;
  chef.add_recipe &quot;yum::remi&quot;
  chef.add_recipe &quot;vmclient1&quot;
end
</code></pre>

<p>※どうやら最初にレシピ書いた段階では、<code>chef.run_list</code> と書いてましたが、<code>chef.add_recipe</code> の方で統一すべきのようです。</p>

<h3 id="cookbook-への追記">Cookbook への追記</h3>

<pre><code>package 'php' do
  action  :install
end
</code></pre>

<p>ここに options &#8216;hogehoge&#8217; と書くことで、コマンドラインにつけるオプションをそのまま書くことが出来るようですが、 Cookbook で yum のリポジトリを追加するだけでどう変化するのかを見るので、一旦何も指定せずにそのままインストールしてみます。</p>

<h3 id="vagrant-sandbox-rollback-で元に戻す">vagrant sandbox rollback で元に戻す</h3>

<p>そして、さっきゲストOSを色々いじってしまったので、 <code>vagrant sandbox rollback</code> で元に戻してから、仮想マシンを再起動します。</p>

<pre><code>$ vagrant sandbox rollback
</code></pre>

<p>綺麗さっぱり元通りです。</p>

<h2 id="yum-のリポジトリ追加-php-のインストールのコンボ">yum のリポジトリ追加 → PHP のインストールのコンボ</h2>

<pre><code>$ vagrant reload
</code></pre>

<p>さてどうなるでしょうか。</p>

<p>さすがにログ全部は長過ぎなんで、ポイントだけを順番に抜粋してみます。</p>

<pre><code>[2013-05-16T18:11:39+00:00] INFO: Setting the run_list to [&quot;recipe[yum::epel]&quot;, &quot;recipe[yum::remi]&quot;, &quot;recipe[vmclient1]&quot;] from JSON
[2013-05-16T18:11:39+00:00] INFO: Run List is [recipe[yum::epel], recipe[yum::remi], recipe[vmclient1]]
[2013-05-16T18:11:39+00:00] INFO: Run List expands to [yum::epel, yum::remi, vmclient1]
</code></pre>

<p>3つのレシピが順に実行されていくのが分かります。</p>

<pre><code>[2013-05-16T18:12:35+00:00] WARN: Cloning resource attributes for yum_key[RPM-GPG-KEY-EPEL-6] from prior resource (CHEF-3694)
[2013-05-16T18:12:35+00:00] WARN: Previous yum_key[RPM-GPG-KEY-EPEL-6]: /tmp/vagrant-chef-1/chef-solo-1/cookbooks/yum/recipes/epel.rb:22:in `from_file'
[2013-05-16T18:12:35+00:00] WARN: Current  yum_key[RPM-GPG-KEY-EPEL-6]: /tmp/vagrant-chef-1/chef-solo-1/cookbooks/yum/providers/repository.rb:85:in `repo_config'
</code></pre>

<p>途中でGPGキーに関する警告が色々出てるっぽいです。この辺今回はすっ飛ばしてやってますからねー。</p>

<pre><code>[2013-05-16T18:12:36+00:00] INFO: template[/etc/yum.repos.d/epel.repo] updated content
[2013-05-16T18:12:36+00:00] INFO: template[/etc/yum.repos.d/epel.repo] mode changed to 644
[2013-05-16T18:12:36+00:00] INFO: template[/etc/yum.repos.d/epel.repo] sending run action to execute[yum-makecache] (immediate)
</code></pre>

<p>Template Resource を使って、 `/etc/yum.repos.d/epel.repo を色々書いてくれていますね。</p>

<pre><code>[2013-05-16T18:15:39+00:00] INFO: Processing yum_key[RPM-GPG-KEY-remi] action add (yum::remi line 22)
</code></pre>

<p>remi リポジトリも同様でした。</p>

<pre><code>[2013-05-16T18:24:58+00:00] INFO: Processing package[php][/php] action install (vmclient1::default line 19)
[2013-05-16T18:24:58+00:00] INFO: package[php][/php] installing php-5.4.15-1.el6.remi from remi repository
</code></pre>

<p>さて、PHP のインストールがされているようですが、 どうやら <strong>PHP 5.4.15</strong> が入っているようですね！</p>

<p>こんな感じで一通りの自動化作業が終わったところで、実際に何がインストールされたか見てみましょう。</p>

<pre><code>[vagrant@vmclient1 ~]$ php -v
PHP 5.4.15 (cli) (built: May  9 2013 08:20:20)
Copyright (c) 1997-2013 The PHP Group
Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies
</code></pre>

<p>おおー、ちゃんと入っておりました。</p>

<p>ちなみに yum のリポジトリはどうでしょう？</p>

<pre><code>base                                                              CentOS-6 - Base                                                                                       enabled: 6,381
c6-media                                                          CentOS-6 - Media                                                                                      disabled
centosplus                                                        CentOS-6 - Plus                                                                                       disabled
contrib                                                           CentOS-6 - Contrib                                                                                    disabled
debug                                                             CentOS-6 - Debuginfo                                                                                  disabled
epel                                                              Extra Packages for Enterprise Linux                                                                   enabled: 8,783
extras                                                            CentOS-6 - Extras                                                                                     enabled:    12
remi                                                              Les RPM de remi pour Enterprise Linux 6.4 - x86_64                                                    enabled: 1,015
updates                                                           CentOS-6 - Updates                                                                                    enabled:   678
repolist: 16,869
</code></pre>

<p><strong>epel と remi が増えておりますね！</strong></p>

<h2 id="まとめ">まとめ</h2>

<p>時間がないので今回はここまでですが、あとでサードパーティ Cookbook の中で何が行われていて、結果どういうファイルがどう変わったか？というのは、しっかりと見ておこうと思います。</p>

<p>中で何やってるのかよく分からないけど、順番通りにやったらなんかできましたーみたいなのをよく聞きますが、 そういう<strong>ブラックボックス的な使い方は非常に危険だと思う</strong>ので、 あくまで「普通にやったら 100 の労力かかるけど、それを 1 にしてくれるショートカットツール」みたいな、 <strong>めんどくさいところの時間短縮を行ってくれるツール、という位置づけで常に使うことを心がけていきたいです。</strong></p>

<p>（あ、前者の使い方って、実装者が「よくわかんないけど jQuery プラグインをポンと入れたら動いちゃったんでオッケーですー」って言ってるのと大差ないかもしれないですね・・・。）</p>

<h2 id="参考url">参考URL</h2>

<ul>
<li><a href="http://community.opscode.com/cookbooks" target="_blank">http://community.opscode.com/cookbooks</a></li>
<li><a href="https://github.com/opscode-cookbooks/yum" target="_blank">https://github.com/opscode-cookbooks/yum</a></li>
<li><a href="http://qiita.com/items/98a7cc5ac33225619e69" target="_blank">CentOS6 で remi から php や mysql をインストールするための yum の設定</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年5月17日">2013年5月17日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年5月14日">2013年5月14日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>




<p>Chef のユーザー管理を突き詰めてみるだけでも、色々と勉強になっていますね。</p>

<p>前回までで、Chef の Cookbook にユーザー作成やグループ作成のレシピを記述することで、 ユーザー作成の自動化を試してみましたが、今回はもうちょっと複雑なことをやりたいので、 別の方法を試してみようと思います。</p>

<p>『入門 Chef Solo』によると、</p>

<blockquote>
<p>システムに追加されるべきユーザーの各種データなどはノードの「属性」でもないし Resource の「属性」でもないデータと見ることができます。 こういったドメインモデル的なデータは Chef のデータ管理の仕組みである Data Bag を使うほうが扱いやすい。</p>

<p>(『入門 Chef Solo』 #19 Attribute と Data Bag より引用)</p>
</blockquote>

<p>とのことで、データを扱うための仕組みが存在するようです。</p>

<p>また、</p>

<blockquote>
<p>Data Bag はクックブック単位ではなく、レポジトリ全体にグローバルなスコープのデータです。</p>

<p>(『入門 Chef Solo』 #19 Attribute と Data Bag より引用)</p>
</blockquote>

<p>ともありますね。</p>

<p>ということで、今回は Data Bag の仕組みを使って、もうちょっと凝ったユーザー作成の自動化をやってみようと思います。</p>

<h2 id="まずは-data-bag-を使ってみる">まずは Data Bag を使ってみる</h2>

<p>この Data Bag、Cookbook とは別のところに書いて、Cookbook 側から読み込んで使う類のものらしいです。 対象ディレクトリの下に、種別のサブディレクトリを区切って、その中に JSON ファイルをデータごとに用意するようです。</p>

<p>であれば、まずは自分で作った cookbooks ディレクトリと並列なところに、 data_bags というディレクトリでも作り、users というサブディレクトリを作っておきます。</p>

<pre><code>$ mkdir -p data_bags/users
$ cd data_bags/users
</code></pre>

<p>で、それぞれのユーザーごとに [ユーザー名].json のファイルを作ります。 ちなみにこの JSON ファイルは、あくまで任意のデータを扱うためのもので、あとで Cookbook 側から読み込むために用意するので、 前回設定した項目がこちらに用意できればオーケーですね。前回と同じことが出来るところまで設定しましょう。</p>

<pre><code>$ cat alice.json
// alice
{
  &quot;id&quot;: &quot;alice&quot;,
  &quot;shell&quot;: &quot;/bin/bash&quot;,
  &quot;password&quot;: &quot;megckhCt3LluU&quot;
}
</code></pre>

<p>そして、default.rb のレシピはこんな感じ。</p>

<pre><code># Cookbook ユーザーとグループのテスト

data_ids = data_bag('users')
data_ids.each do |id|
  u = data_bag_item('users', id)
  user u['id'] do
    shell    u['shell']
    password u['password']
    supports :manage_home =&gt; true, :non_unique =&gt; false
    action   [:create]
  end
end

group 'samplegroup' do
  group_name 'samplegroup'
  members    ['alice', 'bob']
  action     [:create]
end
</code></pre>

<p>Data Bag の機能を使っているところとしては、</p>

<ul>
<li><strong>data_bag(&#8216;[サブディレクトリ名]&#8217;)</strong> で id 一覧が取得できる</li>
<li><strong>data_bag_item(&#8216;[サブディレクトリ名]&#8217;, id)</strong> で指定した ID のオブジェクトを Data Bag から取り出し</li>
</ul>

<p>ですね。この辺は Ruby のスクリプトであることを意識すればそれほど難しいことではないかなーと思います。</p>

<p>また、書いてるときにちょっと気づいたのですが、 Ruby で色々書こうとするときに、<strong>変数名とかに配慮が必要</strong>ですね。</p>

<p>というのも、<code>user</code> とか <code>group</code> とか <code>directory</code> とか書くと、実際はメソッド呼び出しになっている部分の上書きになると思うので、 きっとこの辺の名前は使えません。</p>

<p>『入門 Chef Solo』にも、u とか使ってたのですが、これは user だとかぶってしまうからなのではないかなーと邪推してます。</p>

<h3 id="vagrantfile-の編集">Vagrantfile の編集</h3>

<p>Vagrant から、Cookbook のファイルは見えていますが、Data Bag のファイルはまだ見えてません。</p>

<p>Vagrant の公式のドキュメントの中の、Chef Solo のページにちゃんと書いてあるので見てみます。</p>

<p><a href="http://docs.vagrantup.com/v2/provisioning/chef_solo.html" target="_blank">http://docs.vagrantup.com/v2/provisioning/chef_solo.html</a></p>

<p><img src="/img/2013/05/chef-user06.png" alt="" /></p>

<p>Cookbook の場所の指定と同じように、Data Bag の場所も指定してやります。</p>

<p>今回は、cookbook ディレクトリと同列に data_bags ディレクトリを作ったので、以下のようになるはずです。</p>

<pre><code>vmclient.vm.provision :chef_solo do |chef|
  chef.cookbooks_path = &quot;cookbooks&quot;
  chef.data_bags_path = &quot;data_bags&quot;
  chef.run_list = &quot;recipe[vmclient1]&quot;
end
</code></pre>

<h3 id="vagrant-up">vagrant up!</h3>

<p>さて、ここまで書けたら <code>vagrant up</code> なり <code>vagrant reload</code> なりで起動して確認してみます。 一度まっさらな状態にして確認してみるのもいいかもしれません。</p>

<pre><code>[vmclient1] -- /tmp/vagrant-chef-1/chef-solo-1/cookbooks
[vmclient1] -- /tmp/vagrant-chef-1/chef-solo-2/data_bags
</code></pre>

<p>お、Cookbook だけじゃなく、Data Bag も何らか作用していることがログから確認できますね。</p>

<p>さらにさらに、</p>

<pre><code>[2013-05-11T19:16:29+00:00] INFO: Processing user[alice] action create (vmclient1::default line 6)
[2013-05-11T19:16:29+00:00] INFO: Processing user[bob] action create (vmclient1::default line 6)
[2013-05-11T19:16:29+00:00] INFO: Processing user[carol] action create (vmclient1::default line 6)
[2013-05-11T19:16:29+00:00] INFO: user[carol] created
[2013-05-11T19:16:29+00:00] INFO: Processing group[samplegroup] action create (vmclient1::default line 14)
[2013-05-11T19:16:29+00:00] INFO: Chef Run complete in 0.071730458 seconds
[2013-05-11T19:16:29+00:00] INFO: Running report handlers
[2013-05-11T19:16:29+00:00] INFO: Report handlers complete
</code></pre>

<p>僕は前回のところから立て続けにやっているので、carol だけが削除されていない状態でした。</p>

<p>alice, bob はもう作られていたので、carol だけが作られているのが、<code>user[carol] created</code> というログから予想できます。</p>

<p>さて、ログインして見てみます。</p>

<pre><code>[vagrant@vmclient1 ~]$ su - alice
パスワード:
[alice@vmclient1 ~]$ su - bob
Password:
[bob@vmclient1 ~]$ su - carol
Password:
[carol@vmclient1 ~]$
</code></pre>

<p><strong>成功しました！</strong></p>

<p>前回までと同じく、パスワード認証ではありますが、それぞれ3人のユーザーを作ることが出来ていますね。</p>

<p>ただ、前回の検証時にもあったように、単にCookbook から記述を消すだけではユーザーの削除は行われないので、<a href="http://tech.blog.piyo.org/2012/06/19/chef-data-bag%E6%B4%BB%E7%94%A8%E6%B3%95/" target="_blank">http://tech.blog.piyo.org/2012/06/19/chef-data-bag%E6%B4%BB%E7%94%A8%E6%B3%95/</a> にもあるように、ユーザーの有効/無効を Data Bag のパラメータとして管理する方法が良いのかもしれません。</p>

<h3 id="普通にパスワード認証で-ssh-までしてみる">普通にパスワード認証で SSH までしてみる</h3>

<p>ちょっと脇道それます。これまでは、ゲストOS内で <code>su - alice</code> などで確認をしてましたが、 実際仮想マシン作っているので、ちゃんとIPアドレスも割り振られていて、普通に SSH で入れるはずですよね。</p>

<p>ホストOS（つまり今触ってるPC）から、ゲストOSへ SSH で接続確認をしてみます。</p>

<p>まずは始めから用意されていて、<code>vagrant ssh vmclient1</code> とかでいつも SSH でログインしているであろう vagrant ユーザーで試します。</p>

<pre><code>$ ssh vagrant@192.168.100.11
The authenticity of host '192.168.100.11 (192.168.100.11)' can't be established.
RSA key fingerprint is xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.100.11' (RSA) to the list of known hosts.
vagrant@192.168.100.11's password:
Last login: Sat May 11 19:20:10 2013 from xxx.xxx.xxx.xxx
Welcome to your Vagrant-built virtual machine.
[vagrant@vmclient1 ~]$ logout
</code></pre>

<p>はい、これは出来て当然ですね。 いつも &#8216;default&#8217; というホスト名でログインしちゃってたので、IPアドレス直打ちだと最初に「初めて接続するけどいい？」って聞かれますが、問題ないので <strong>yes</strong> ですね。</p>

<p>お次は alice ユーザーです。</p>

<pre><code>$ ssh alice@192.168.100.11
alice@192.168.100.11's password:
Welcome to your Vagrant-built virtual machine.
[alice@vmclient1 ~]$
</code></pre>

<p>やったー、SSH で入れました！</p>

<h2 id="鍵認証したくてたまらない">鍵認証したくてたまらない</h2>

<p>今度は、パスワード認証以外の方法を自動化できるようにしていきたいなーと思います。</p>

<p>パスワードなしで鍵認証が出来るようにするには、この辺の設定が自動化出来ればいいんじゃないかと思います。</p>

<ul>
<li>手元に各ユーザーの鍵ファイルを作成</li>
<li>/home/[ユーザー名]/.ssh/authorized_keys へ公開鍵を登録する</li>
<li>パーミッションの変更 (0600)</li>
<li>/etc/ssh/sshd_config の設定項目編集</li>
<li>sshd サービスの再起動</li>
</ul>

<p>実際の運用フローを考えるのなら、秘密鍵は本人以外誰にも渡すべきではないものなので、 本人が作成した鍵のうち、公開鍵のみをサーバ運用担当に「これで登録しておいてー」と渡す感じになるのかなと思います。</p>

<p>今回は検証用なので、各ユーザーごとに秘密鍵・公開鍵を用意して、公開鍵のみをさっきの Data Bag の方に記載してみることにします。</p>

<h3 id="公開鍵認証の仕組みについて">公開鍵認証の仕組みについて</h3>

<p>これは完全に余談で、ググったらたくさん情報が載っているのですが、触れずに進めるのもアレなので さらっと鍵認証の仕組みについて触れておきます。</p>

<p><strong>鍵を作るとき</strong></p>

<ol>
<li>秘密鍵、公開鍵という2種類の鍵が存在（今から作る）</li>
<li>なんかの文字列に対して、<strong>暗号化だけできるのが公開鍵、それを元に戻せる（復号化）できるのが秘密鍵</strong></li>
<li>手元には、誰にも見せない秘密鍵を置いておく</li>
<li>接続対象のサーバには、公開鍵を置いておく</li>
</ol>

<p><strong>接続するとき</strong></p>

<ol>
<li>ユーザーがサーバに対して「接続したいですー」とアクセス</li>
<li>サーバ側は、持っている公開鍵でなんかの文字を暗号化してユーザーに返す</li>
<li>ユーザーは、持っている秘密鍵で復号化して、なんかの文字をサーバに再度送る</li>
<li><strong>秘密鍵でしか復号化できない＝秘密鍵をもってる正規のユーザー</strong> であることが確認できる</li>
</ol>

<p>という流れですね。</p>

<p>つまり今からやろうとしているのは、ホストOS上で鍵を作り、公開鍵のみを Data Bag に書き込み、ゲストOSの公開鍵として設定しようとしているわけです。</p>

<p>その後、ホストOSで一緒に作った秘密鍵を使って、ゲストOSに鍵認証で接続確認をする流れです。</p>

<h3 id="公開鍵と秘密鍵を用意する">公開鍵と秘密鍵を用意する</h3>

<p>alice だけだと複数人のときでも上手くいってる保証にならないので、2人分の alice と bob の鍵を用意しておきます。</p>

<p>検証用なので作る場所はどこでも良いのですが、ホームディレクトリに作った Vagrant ディレクトリの直下に、 alice, bob のディレクトリを作って、そこに入れておくことにします。</p>

<pre><code>$ mkdir alice
$ mkdir bob
$ cd alice
</code></pre>

<p><code>ssh-keygen</code> というコマンドを用いるので、先に help を読み漁りましょう。</p>

<pre><code>SSH-KEYGEN(1)             BSD General Commands Manual            SSH-KEYGEN(1)

NAME
     ssh-keygen -- authentication key generation, management and conversion

SYNOPSIS
     ssh-keygen [-q] [-b bits] -t type [-N new_passphrase] [-C comment] [-f output_keyfile]

(中略)

     -t type
             Specifies the type of key to create.  The possible values are ``rsa1'' for protocol version 1 and ``dsa'', ``ecdsa'' or ``rsa'' for protocol version
             2.
</code></pre>

<p>長いので使うところだけ抜粋します。</p>

<p><code>-t</code> オプションで鍵の種類を指定できて、<strong>rsa1, dsa, ecdsa, rsa</strong> の4種類が指定できるようです。 今回は rsa を使います。</p>

<p><code>ssh-keygen -t rsa</code> のコマンドを実行すると、後は対話的に進みます。</p>

<pre><code>$ ssh-keygen -t rsa
Generating public/private rsa key pair.
</code></pre>

<p>公開鍵・秘密鍵のセットを作りますよー、と。</p>

<pre><code>Enter file in which to save the key (/Users/[ユーザー名]/.ssh/id_rsa): /Users/[ユーザー名]/Vagrant/alice/id_rsa
</code></pre>

<p>ファイルをどこに保存するか聞かれていますが、デフォルトのままだとホストOSのホームディレクトリ直下の .ssh 以下に入っちゃうので、 ここは Vagrant/alice になるようにします。</p>

<pre><code>Enter passphrase (empty for no passphrase):
Enter same passphrase again:
</code></pre>

<p>認証するときのパスフレーズですが、ここは空にしておきます。2回聞かれます。</p>

<pre><code>Your identification has been saved in /Users/[ユーザー名]/Vagrant/alice/id_rsa.
Your public key has been saved in /Users/[ユーザー名]/Vagrant/alice/id_rsa.pub.
The key fingerprint is:
（略）
The key's randomart image is:
（略）
</code></pre>

<p>なんかずらずらーと出ます。これで鍵は出来てます。（検証用なのでさらしても問題はないのですが、臆病なのでやめておきます・・・）</p>

<pre><code>$ ls
id_rsa     id_rsa.pub
</code></pre>

<p>id_rsa が秘密鍵で、id_rsa.pub の方が公開鍵ですね。</p>

<p>サーバに登録するのは公開鍵なので、公開鍵の中身を Data Bag の方へ &#8220;key&#8221; という項目を新たに設けて追加しておきます。</p>

<pre><code>$ cat data_bags/users/alice.json
// alice
{
  &quot;id&quot;: &quot;alice&quot;,
  &quot;shell&quot;: &quot;/bin/bash&quot;,
  &quot;password&quot;: &quot;megckhCt3LluU&quot;,
  &quot;key&quot;: &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDE......（略）&quot;
}
</code></pre>

<p>bob も同様に作ります。</p>

<pre><code>$ cat data_bags/users/bob.json
// bob
{
  &quot;id&quot;: &quot;bob&quot;,
  &quot;shell&quot;: &quot;/bin/bash&quot;,
  &quot;password&quot;: &quot;8Q14e7OP5wroc&quot;,
  &quot;key&quot;: &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCg......（略）&quot;
}
</code></pre>

<p>これで鍵ファイル自体の用意はできました。</p>

<h2 id="ユーザーの公開鍵における-cookbook-見直し">ユーザーの公開鍵における Cookbook 見直し</h2>

<p>Cookbook 内でディレクトリとファイルを作る必要があります。opscode からドキュメント探します。</p>

<p><a href="http://docs.opscode.com/resource_directory.html" target="_blank">http://docs.opscode.com/resource_directory.html</a> <a href="http://docs.opscode.com/resource_file.html" target="_blank">http://docs.opscode.com/resource_file.html</a></p>

<p>こちらを参考にして、各ユーザーごとのホームディレクトリに .ssh ディレクトリと、authorized_keys ファイルを権限など変えつつ 自動的に作るレシピを書きます。</p>

<pre><code># Cookbook ユーザーとグループのテスト

data_ids = data_bag('users')
data_ids.each do |id|
  u = data_bag_item('users', id)
  user u['id'] do
    shell    u['shell']
    password u['password']
    supports :manage_home =&gt; true, :non_unique =&gt; false
    action   [:create]
  end

  directory &quot;/home/#{id}/.ssh&quot; do
    owner u['id']
    group u['id']
    mode 0700
    action :create
  end

  file &quot;/home/#{id}/.ssh/authorized_keys&quot; do
    owner u['id']
    mode  0600
    content u['key']
    action :create_if_missing
  end
end

group 'samplegroup' do
  group_name 'samplegroup'
  members    ['alice', 'bob']
  action     [:create]
end
</code></pre>

<p>ディレクトリは、本人だけが読み書き実行 (0700)、ファイルについても、本人だけが読み書き (0600) という権限のものを作ります。</p>

<p>鍵認証の確認の前に、実際にディレクトリやファイルが出来ているかどうかだけでも確認しておきましょう。</p>

<pre><code>[vagrant@vmclient1 ~]$ su - alice
パスワード:
[alice@vmclient1 ~]$ ls -la
total 28
drwx------  3 alice alice 4096 May 11 21:49 .
drwxr-xr-x. 7 root  root  4096 May 11 19:16 ..
-rw-------  1 alice alice   23 May 11 21:45 .bash_history
-rw-r--r--  1 alice alice   18 Feb 21 21:09 .bash_logout
-rw-r--r--  1 alice alice  176 Feb 21 21:09 .bash_profile
-rw-r--r--  1 alice alice  124 Feb 21 21:09 .bashrc
drwx------  2 alice alice 4096 May 11 21:49 .ssh
</code></pre>

<p>おおー、.ssh ディレクトリは出来ておりますね。</p>

<pre><code>[alice@vmclient1 ~]$ cd .ssh/
[alice@vmclient1 .ssh]$ ls
authorized_keys
[alice@vmclient1 .ssh]$ cat authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDE...（略）[alice@vmclient1 .ssh]$
</code></pre>

<p>authorized_keys というファイルも出来ていて、中身も反映されておりました。ここまではオーケーですね！</p>

<h2 id="template-を使って設定ファイルを配置する">Template を使って設定ファイルを配置する</h2>

<p>さあ、あと残っているのは『/etc/ssh/sshd_config の設定項目編集』と『sshd サービスの再起動』だけです。</p>

<p>※sshd サービスの再起動に関しては、パッケージのインストールを詳しくやるタイミングで併せてやった方がいいので、今回は仮想マシンの再起動で代用してしまおうと思います。</p>

<p>今まで Cookbook の中に user, group, file, directory, package という記述を色々書いてきましたが、 これらは Resource と呼ばれています。</p>

<p>今度はこういったサーバの設定ファイルを配置するための Resource である、<strong>template</strong> を使います。</p>

<h3 id="まずはテンプレートのファイルを用意する">まずはテンプレートのファイルを用意する</h3>

<p>レシピの方からテンプレートを指定するわけですが、先にテンプレートファイルを設置します。</p>

<p>Cookbook の中に recipes ディレクトリを作り、その中に default.rb というレシピファイルを作って今までいじってきましたが、 この recipes ディレクトリと並列に <strong>templates ディレクトリ</strong> を作ります。</p>

<pre><code>$ mkdir cookbooks/vmclient1/templates
</code></pre>

<p><strong>※実はここ、置き場所間違ってますが後で説明します・・・</strong></p>

<p>その下に、sshd_config というファイルであれば、sshd_config.erb というファイルを作り、実際にゲストOSで使われている /etc/ssh/sshd_config というファイルの中身をごっそりもってきて、以下の必要最低限のところだけ修正します。</p>

<pre><code>$ cat cookbooks/vmclient1/templates/sshd_config.erb
（長いので略）
PubkeyAuthentication yes
AuthorizedKeysFile     .ssh/authorized_keys
（長いので略）
</code></pre>

<p>公開鍵認証を有効にする設定のコメントアウトを外し、認証鍵ファイルの置き場所の設定もコメントアウトします。置き場所はさっきの通りですね。</p>

<p>これだけだと、変数とかの埋め込みがなくてテンプレート使ってる意味がないかもしれませんが、ここから先は erb の記法と同じく変数の埋め込みが可能です。（機会があれば後日行いたいと思います。）</p>

<blockquote>
<p>※あとで調べたら、変数使わずに単にファイルを設置するときは、Template じゃなくて、File を使えば良かったっぽいですね。。。 <a href="http://docs.opscode.com/resource_file.html" target="_blank">http://docs.opscode.com/resource_file.html</a></p>
</blockquote>

<h3 id="テンプレートをレシピから読み込む">テンプレートをレシピから読み込む</h3>

<p>レシピが徐々に長くなってきたので、追記部分のみ記載しておきます。</p>

<pre><code>template '/etc/ssh/sshd_config' do
  owner 'root'
  group 'root'
  mode 0600
end
</code></pre>

<p>元々置いてあったファイルが上記の設定だったので、合わせて root:root, 0600 にしてあります。</p>

<p>さて、さっき作ったテンプレートファイルは、ファイル名を合わせておけばこれだけで動くとのことですが、 ホントにこれだけで問題ないのか試してみます。</p>

<h3 id="vagrant-up-vagrant-up">vagrant up! vagrant up!</h3>

<pre><code>[2013-05-11T22:35:06+00:00] FATAL: Chef::Exceptions::FileNotFound: template[/etc/ssh/sshd_config] (vmclient1::default line 28) had an error: Chef::Exceptions::FileNotFound: Cookbook 'vmclient1' (0.0.0) does not contain a file at any of these locations:
  templates/centos-6.4/sshd_config.erb
  templates/centos/sshd_config.erb
  templates/default/sshd_config.erb
</code></pre>

<p>なんかエラー出ました。これによると、テンプレートファイルが見つからなかったようです。</p>

<p>テンプレートファイルは、<strong>&#8216;Linuxディストリビューション名&#8217;-&#8216;バージョン&#8217;, &#8216;Linuxディストリビューション名&#8217;, &#8216;default&#8217;</strong> を それぞれ自動で探してくれるようになっているようです。<strong>素敵ですねー。</strong></p>

<p>ということで、<strong>正しいパスは templates/default/sshd_config.erb でしたー。</strong>移動させて再度試します。</p>

<pre><code>[2013-05-11T22:41:13+00:00] INFO: Processing template[/etc/ssh/sshd_config] action create (vmclient1::default line 28)
[2013-05-11T22:41:13+00:00] INFO: template[/etc/ssh/sshd_config] backed up to /var/chef/backup/etc/ssh/sshd_config.chef-20130511224113
[2013-05-11T22:41:13+00:00] INFO: template[/etc/ssh/sshd_config] updated content
[2013-05-11T22:41:13+00:00] INFO: template[/etc/ssh/sshd_config] owner changed to 0
[2013-05-11T22:41:13+00:00] INFO: template[/etc/ssh/sshd_config] group changed to 0
[2013-05-11T22:41:13+00:00] INFO: template[/etc/ssh/sshd_config] mode changed to 600
[2013-05-11T22:41:13+00:00] INFO: Chef Run complete in 0.121144117 seconds
[2013-05-11T22:41:13+00:00] INFO: Running report handlers
[2013-05-11T22:41:13+00:00] INFO: Report handlers complete
</code></pre>

<p>ログを見る限りだと、上手いこと出来たっぽいですね！</p>

<p>さて、ログインして見てみましょう！</p>

<pre><code>[vagrant@vmclient1 ~]$ su
パスワード:（vagrant といれた）
[root@vmclient1 vagrant]# cat /etc/ssh/sshd_config
（略）
PubkeyAuthentication yes
AuthorizedKeysFile     .ssh/authorized_keys
（略）
</code></pre>

<p><strong>おおー、ちゃんとテンプレートが反映されておりました！</strong></p>

<p>ということは、これで一通り SSH 周りの設定が完了したことになります。（sshd の再起動を除く）</p>

<p>最後に、再度 <code>vangrant reload</code> しておきます。sshd の再起動もそうなんですが、サービスの起動、再起動についてはまた後日やりたいと思います。</p>

<h2 id="鍵認証でログイン">鍵認証でログイン</h2>

<p>ここから先はホストOS上での作業です。</p>

<p><code>ssh</code> のオプションいろいろつけて、鍵ファイル指定するとかめんどくさいので、~/.ssh/config に alice, bob 用の設定を追加しておきましょう。</p>

<pre><code>$ vi ~/.ssh/config
</code></pre>

<p>ここに Host default の設定項目があって、 vagrant ユーザーが接続するための設定がずらずら書いてあるのでこれを流用して、 alice ユーザー、bob ユーザーでログインできるようにしてみます。</p>

<pre><code>Host vmclient1_by_alice
  HostName 192.168.100.11
  User alice
  Port 22
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile &quot;/Users/[ユーザー名]/Vagrant/alice/id_rsa&quot;
  IdentitiesOnly yes
  LogLevel FATAL

Host vmclient1_by_bob
  HostName 192.168.100.11
  User bob
  Port 22
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile &quot;/Users/[ユーザー名]/Vagrant/bob/id_rsa&quot;
  IdentitiesOnly yes
  LogLevel FATAL
</code></pre>

<p>そして、<code>ssh</code> を実行してみます！</p>

<pre><code>$ ssh vmclient1_by_alice
Welcome to your Vagrant-built virtual machine.
[alice@vmclient1 ~]$
</code></pre>

<p><strong>alice 鍵認証きたーーー！！</strong> ええ、もちろんパスワード入力しておりません。</p>

<p>さあ、bob はどうでしょう？</p>

<pre><code>$ ssh vmclient1_by_bob
Welcome to your Vagrant-built virtual machine.
[bob@vmclient1 ~]$
</code></pre>

<p><strong>bob も鍵認証きたーーー！！</strong></p>

<h2 id="まとめ">まとめ</h2>

<p>これで最低限の<strong>ユーザー管理の自動化</strong>が出来るようになったと言ってもいいのかもしれません。</p>

<p>また、汎用的に以下のことが少し出来るようになりました。</p>

<ul>
<li><strong>Cookbook からのファイル、ディレクトリの作成</strong></li>
<li><strong>Cookbook からのユーザーの作成、グループの作成</strong></li>
<li><strong>Data Bag によるデータ管理</strong></li>
<li><strong>Cookbook と Data Bag の連携</strong></li>
<li><strong>Cookbook からのテンプレートファイルの配置</strong></li>
</ul>

<p>次はアプリケーションのインストールを色々やってみて、 この辺がある程度慣れてくれば、レシピも比較的自由に書けるようになるのではないかなーと思います。 がんばります！</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="http://docs.opscode.com/essentials_data_bags.html" target="_blank">http://docs.opscode.com/essentials_data_bags.html</a></li>
<li><a href="http://tech.blog.piyo.org/2012/06/19/chef-data-bag%E6%B4%BB%E7%94%A8%E6%B3%95/" target="_blank">http://tech.blog.piyo.org/2012/06/19/chef-data-bag%E6%B4%BB%E7%94%A8%E6%B3%95/</a></li>
<li><a href="http://ed.victavision.co.uk/blog/post/4-8-2012-chef-solo-encrypted-data-bags" target="_blank">http://ed.victavision.co.uk/blog/post/4-8-2012-chef-solo-encrypted-data-bags</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年5月14日">2013年5月14日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年5月13日">2013年5月13日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>




<p>だんだんと Chef いじりが楽しくなってきた girigiribauer です、こんにちは。</p>

<p>この前<strong>『入門 Chef Solo』</strong>というKindle本（電子書籍）を購入して、休憩時などに少しずつ読み進めていたのですが、 ようやくざっと一通り目を通すことができました。</p>

<p>今回以降、この辺も見ながらいろいろ試してみようと思います。</p>

<h2 id="レシピを書くとどんなことが設定できるの">レシピを書くとどんなことが設定できるの？</h2>

<p><a href="/archives/1013/">前回</a>までで、Vagrant と Chef を連携させて、 超シンプルなレシピを書いてみたわけですが、 今回はレシピを書くことで他にどんなことが出来ちゃうのかを、もう少し試してみようと思います！</p>

<p>『入門 Chef Solo』に、この Cookbook はユーザーの設定やらグループの設定やらが一通り載っていて、 最初に全体像を見るのにいいよ！と書かれていたので、まずはこちらの <a href="https://github.com/treasure-data/chef-td-agent" target="_blank">https://github.com/treasure-data/chef-td-agent</a> を参考にしてみます。</p>

<p><img src="/img/2013/05/chef-user01.png" alt="" /></p>

<p>ログデータの収集に使うツールと、それ専用のユーザーなりを設定してくれる Cookbook のようですね。</p>

<p>recipes/default.rb を早速見てみます。</p>

<pre><code>#
# Cookbook Name:: td-agent
# Recipe:: default
#
# Copyright 2011, Treasure Data, Inc.
#

group 'td-agent' do
  group_name 'td-agent'
  gid        403
  action     [:create]
end

user 'td-agent' do
  comment  'td-agent'
  uid      403
  group    'td-agent'
  home     '/var/run/td-agent'
  shell    '/bin/false'
  password nil
  supports :manage_home =&gt; true
  action   [:create, :manage]
end

directory '/etc/td-agent/' do
  owner  'td-agent'
  group  'td-agent'
  mode   '0755'
  action :create
end
（以下略）
</code></pre>

<p>中身は Ruby のコードとはいえ、見ると何をやっているのかは何となく分かりそうな感じです。</p>

<ul>
<li>一番上のブロックで &#8216;td-agent&#8217; という名前のグループを作る</li>
<li>gid（Linux などでグループに割り振られるID）は 403 にする</li>
</ul>

<p>続けて、</p>

<ul>
<li>&#8216;td-agent&#8217; という名前のユーザーを作る</li>
<li>uid（Linux などでユーザーに割り振られるID）は 403 にする</li>
<li>ホームディレクトリは &#8216;/var/run/td-agent&#8217; にする</li>
<li>シェルは指定せず、パスワードもなし</li>
<li><code>supports :manage_home =&gt; true</code> が何を意味しているのかは後で調べます</li>
</ul>

<p>最後に、</p>

<ul>
<li>&#8216;/etc/td-agent/&#8217; という名前のディレクトリを作る</li>
<li>所有者は、&#8217;td-agent&#8217;、グループは &#8216;td-agent&#8217; になるようにする</li>
<li>権限は &#8216;0755&#8217;（つまり所有者が読み書き実行、同一グループが読み＆実行、それ以外のユーザーも読み＆実行）</li>
</ul>

<p>というレシピのようです。</p>

<h3 id="これ-linux-とかに詳しくないと出来ないの">これ、Linux とかに詳しくないと出来ないの？</h3>

<p>個人的には逆だと思っていて、 <strong>設定すべき項目が明らかになっている分、どういうポイントを調べればいいのかが明確になっています。</strong> そもそも知らなきゃ調べようもなかった設定に対して、ググるチャンスをもらえたと思って、 分からないところはどんどんググるべきだなーと思います。</p>

<p>例えば、シェルの指定が &#8216;/bin/false&#8217; になっている箇所なんかは、 適当に <strong>linux /bin/false</strong> とかでググれば、ログインできないユーザーを作る方法であることが分かるので、 このレシピでは、ログインできないユーザーを作ろうとしていることが分かり、 ググったついでに実際の設定方法なども分かって勉強にもなりますね。</p>

<p>ってことで、分からないところはどんどんググって覚えていこうと思います。</p>

<h2 id="ユーザーの設定項目について">ユーザーの設定項目について</h2>

<p>これは公式を見た方が良さそうなので見てみます。 <a href="http://docs.opscode.com/resource_user.html" target="_blank">http://docs.opscode.com/resource_user.html</a></p>

<p>設定項目は、大きく分けて Actions と Attributes の2種類あるようなので、まず先に Attributes の方を見てみます。</p>

<p><img src="/img/2013/05/chef-user02.png" alt="" /></p>

<p>あれ、読んでも何のことだかさっぱりだなーと思ったら、そのすぐ下に詳しく説明載ってました。</p>

<p><img src="/img/2013/05/chef-user03.png" alt="" /></p>

<p>要するに、 key, value の対になるものを設定できて、設定できるのが <strong>:manage_home</strong>, <strong>:non_unique</strong> の2つ、 :manage_home は<strong>ホームディレクトリの作成有無</strong>、:non_unique は <strong>UID の重複を許すかどうか</strong>のようです。</p>

<p>なるほどなるほどー。</p>

<p>お次は、Actions の方を見てみます。</p>

<p><img src="/img/2013/05/chef-user04.png" alt="" /></p>

<p><code>action   [:create, :manage]</code> とあるので、該当ユーザーがなければユーザーを作り、 Attributes の通りに設定を合わせてくれるようです。 読む限りだと、create だけでも既存ユーザーに対しては設定を合わせてくれるみたいなんですが、 manage も必要なんでしょうかね？後で試してみましょうか。</p>

<h2 id="グループの設定項目について">グループの設定項目について</h2>

<p>グループはこちらですね。<a href="http://docs.opscode.com/resource_group.html" target="_blank">http://docs.opscode.com/resource_group.html</a></p>

<p>こちらも Actions, Attributes を引用します。</p>

<p><img src="/img/2013/05/chef-user05.png" alt="" /></p>

<p>レシピに書かれた内容だけだと、単に create で作って GID を設定しているだけですね。</p>

<p>ユーザーとグループの関係でちょっと気になるところが出て来たのですが、 ユーザーは複数のグループに属することが出来るはずなので、ユーザーの設定項目の group で、配列として指定してやればいいんでしょうか？</p>

<h2 id="ユーザーとグループのレシピを書く">ユーザーとグループのレシピを書く！</h2>

<p>この前 2台構成にしてましたが、一旦1台に戻してレシピを書きましょう。（インストールとか時間かかるので）</p>

<pre><code>group 'samplegroup' do
  group_name 'samplegroup'
  members    ['alice', 'bob', 'carol']
  action     [:create]
end

user 'alice' do
  shell    '/bin/zsh'
  password 'alice'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:create]
end

user 'bob' do
  shell    '/bin/zsh'
  password 'bob'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:create]
end

user 'carol' do
  shell    '/bin/zsh'
  password 'carol'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:create]
end
</code></pre>

<p>ささっと書いて試してみます！</p>

<h3 id="vagrant-up">vagrant up!!</h3>

<pre><code>$ vagrant up

Expected process to exit with [0], but received '3'
---- Begin output of gpasswd -M alice,bob,carol samplegroup ----
STDOUT:
STDERR: gpasswd: user 'alice' does not exist
gpasswd: user 'bob' does not exist
gpasswd: user 'carol' does not exist
---- End output of gpasswd -M alice,bob,carol samplegroup ----
Ran gpasswd -M alice,bob,carol samplegroup returned 3[0m
</code></pre>

<p>なんかエラー出てますね。グループを作るときにそのユーザーがないと言われているようですね。</p>

<p>ちょっとユーザーとグループの作成の順番を変えてやってみます。</p>

<pre><code>[vmclient1] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
[2013-05-10T21:02:02+00:00] INFO: *** Chef 11.4.0 ***
[2013-05-10T21:02:02+00:00] INFO: Setting the run_list to &quot;recipe[vmclient1]&quot; from JSON
[2013-05-10T21:02:02+00:00] INFO: Run List is [recipe[vmclient1]]
[2013-05-10T21:02:02+00:00] INFO: Run List expands to [vmclient1]
[2013-05-10T21:02:02+00:00] INFO: Starting Chef Run for vmclient1
[2013-05-10T21:02:02+00:00] INFO: Running start handlers
[2013-05-10T21:02:02+00:00] INFO: Start handlers complete.
[2013-05-10T21:02:02+00:00] INFO: Processing user[alice] action create (vmclient1::default line 3)
[2013-05-10T21:02:02+00:00] INFO: user[alice] created
[2013-05-10T21:02:02+00:00] INFO: Processing user[bob] action create (vmclient1::default line 10)
[2013-05-10T21:02:02+00:00] INFO: user[bob] created
[2013-05-10T21:02:02+00:00] INFO: Processing user[carol] action create (vmclient1::default line 17)
[2013-05-10T21:02:02+00:00] INFO: user[carol] created
[2013-05-10T21:02:02+00:00] INFO: Processing group[samplegroup] action create (vmclient1::default line 24)
[2013-05-10T21:02:02+00:00] INFO: group[samplegroup] altered
[2013-05-10T21:02:02+00:00] INFO: Chef Run complete in 0.145912047 seconds
[2013-05-10T21:02:02+00:00] INFO: Running report handlers
[2013-05-10T21:02:02+00:00] INFO: Report handlers complete
</code></pre>

<p>お、<code>user[alice] created</code> と表示されているので、今度は上手く行ったようですかね？</p>

<p>早速 vagrant ssh で中を確認してみます。</p>

<pre><code>$ vagrant ssh vmclient1
Welcome to your Vagrant-built virtual machine.
[vagrant@vmclient1 ~]$
</code></pre>

<p>んで、それぞれのユーザーに成り代わります。</p>

<pre><code>[vagrant@vmclient1 ~]$ su alice
パスワード: (ここで alice っていれた)
su: パスワードが違います
[vagrant@vmclient1 ~]$ su bob
パスワード: (ここで bob っていれた)
su: パスワードが違います
[vagrant@vmclient1 ~]$ su carol
パスワード: (ここで carol っていれた)
su: パスワードが違います
[vagrant@vmclient1 ~]$
</code></pre>

<p>むむむ・・・。パスワードが有効でない？？</p>

<p>ついでに /etc/group もみてみます。</p>

<pre><code>samplegroup:x:503:alice,bob,carol
</code></pre>

<p>グループを新規で作って、そこにユーザーを追加するのは出来ているようです。</p>

<h2 id="ユーザーの作成の見直し">ユーザーの作成の見直し</h2>

<p>どうやらパスワードが上手く登録できてないようなので、その辺りを見直してみます。</p>

<p><img src="/img/2013/05/chef-user02.png" alt="" /></p>

<p>さっきのユーザーの Attributes を見直してみると、どうやら<strong>パスワードはハッシュ化</strong>されたものをここに入れる必要があるみたいです。</p>

<pre><code># Cookbook ユーザーとグループのテスト

user 'alice' do
  shell    '/bin/zsh'
  password 'megckhCt3LluU'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:create]
end

user 'bob' do
  shell    '/bin/zsh'
  password '8Q14e7OP5wroc'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:create]
end

user 'carol' do
  shell    '/bin/zsh'
  password 'fcv1NMIRSDH/Y'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:create]
end

group 'samplegroup' do
  group_name 'samplegroup'
  members    ['alice', 'bob', 'carol']
  action     [:create]
end
</code></pre>

<p>一応まだテストなので、 <code>openssl passwd</code> でハッシュ化してみましたが、 この方法で安全かどうかまでは保証できないので、実戦配備するタイミングで同様の機会があれば、この辺見直したいと思います。 （＆安全な方法知ってたら教えてください・・・）</p>

<p>さて、<code>vagrant reload</code> で再起動です。</p>

<pre><code>[2013-05-11T15:54:57+00:00] INFO: *** Chef 11.4.0 ***
[2013-05-11T15:54:58+00:00] INFO: Setting the run_list to &quot;recipe[vmclient1]&quot; from JSON
[2013-05-11T15:54:58+00:00] INFO: Run List is [recipe[vmclient1]]
[2013-05-11T15:54:58+00:00] INFO: Run List expands to [vmclient1]
[2013-05-11T15:54:58+00:00] INFO: Starting Chef Run for vmclient1
[2013-05-11T15:54:58+00:00] INFO: Running start handlers
[2013-05-11T15:54:58+00:00] INFO: Start handlers complete.
[2013-05-11T15:54:58+00:00] INFO: Processing user[alice] action create (vmclient1::default line 3)
[2013-05-11T15:54:58+00:00] INFO: user[alice] altered
[2013-05-11T15:54:58+00:00] INFO: Processing user[bob] action create (vmclient1::default line 10)
[2013-05-11T15:54:58+00:00] INFO: user[bob] altered
[2013-05-11T15:54:58+00:00] INFO: Processing user[carol] action create (vmclient1::default line 17)
[2013-05-11T15:54:58+00:00] INFO: user[carol] altered
[2013-05-11T15:54:58+00:00] INFO: Processing group[samplegroup] action create (vmclient1::default line 24)
[2013-05-11T15:54:58+00:00] INFO: Chef Run complete in 0.099637811 seconds
[2013-05-11T15:54:58+00:00] INFO: Running report handlers
[2013-05-11T15:54:58+00:00] INFO: Report handlers complete
</code></pre>

<p>さっきと違って、created じゃなくて altered になってますね。置き換えてくれたっぽいです。 （ちなみに sandbox は使ってないので、さっきの状態から再起動しただけです）</p>

<p>さて、ログインして見てみます。</p>

<pre><code>[vagrant@vmclient1 ~]$ su alice
パスワード: (ここで alice っていれた)
su: /bin/zsh: そのようなファイルやディレクトリはありません
[vagrant@vmclient1 ~]$ which zsh
/usr/bin/which: no zsh in (/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/vagrant/bin)
[vagrant@vmclient1 ~]$ which bash
/bin/bash
</code></pre>

<p>おおーっと、<strong>zsh がないですねww</strong> 寝ぼけてましたゴメンナサイゴメンナサイ。</p>

<p>シェルの設定は後回しにして、とりあえず存在してる bash に設定変更して、 もう一度 <code>vagrant relaod</code>, <code>vagrant ssh vmclient1</code> でログインして見てみます。</p>

<pre><code>[vagrant@vmclient1 ~]$ su - alice
パスワード: (ここで alice っていれた)
[alice@vmclient1 ~]$ pwd
/home/alice
</code></pre>

<p><strong>きたーーーーー！！！</strong></p>

<pre><code>[alice@vmclient1 ~]$ su - bob
Password: (ここで bob っていれた)
[bob@vmclient1 ~]$ pwd
/home/bob
[bob@vmclient1 ~]$ su - carol
Password: (ここで carol っていれた)
[carol@vmclient1 ~]$ pwd
/home/carol
</code></pre>

<p><strong>きたきたきたーー！！ ユーザー3人分出来ておりました！！</strong></p>

<h2 id="ユーザーの変更があったときどうなるの">ユーザーの変更があったときどうなるの？</h2>

<p>さらに、<strong>ユーザーが居なくなったらどうなるのか気になった</strong>ので、試しに Cookbook の中から carol を消して実行してみます。</p>

<pre><code>[vagrant@vmclient1 ~]$ su - carol
パスワード:
[carol@vmclient1 ~]$ pwd
/home/carol
</code></pre>

<p>うーむなるほど、Cookbook の記述を削除するだけでは、ユーザーは無くならないようですね。ここまでは予想通りです。</p>

<p>さて、さっきの Chef の公式の user のページ中に、<strong>:remove</strong> というアクションがあったので、 おそらく :create のところを、:remove にしてやれば、ユーザーが削除された状態に Chef が合わせてくれることでしょう。</p>

<p>やってみます。</p>

<pre><code># Cookbook ユーザーとグループのテスト

user 'alice' do
  shell    '/bin/bash'
  password 'megckhCt3LluU'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:create]
end

user 'bob' do
  shell    '/bin/bash'
  password '8Q14e7OP5wroc'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:create]
end

user 'carol' do
  shell    '/bin/bash'
  password 'fcv1NMIRSDH/Y'
  supports :manage_home =&gt; true, :non_unique =&gt; false
  action   [:remove]
end

group 'samplegroup' do
  group_name 'samplegroup'
  members    ['alice', 'bob']
  action     [:create]
end
</code></pre>

<p>設定などは一旦そのままで、action のところだけ :remove に変更してみました。</p>

<p>さて、どうなるでしょう。</p>

<pre><code>[2013-05-11T16:21:53+00:00] INFO: Processing user[carol] action remove (vmclient1::default line 17)
[2013-05-11T16:21:53+00:00] INFO: user[carol] removed
</code></pre>

<p>おお？ Chef のログからは削除がされているように見えますね。</p>

<pre><code>[vagrant@vmclient1 ~]$ su - carol
su: carol というユーザは存在しません
</code></pre>

<p><strong>carol さん消えたーーー！</strong></p>

<p>なるほどなるほど、ということは Chef の Cookbook 内で、削除されたユーザーも含めて、こちらにまとめておいた方がいいんでしょうかね。</p>

<h2 id="まとめ">まとめ</h2>

<p>ちょっと長くなってきちゃったので、一旦ここでまとめたいと思います。</p>

<ul>
<li><strong>Cookbook に記述することで、ユーザー作成、グループ作成が可能</strong></li>
<li><strong>パスワードはハッシュ化されたものを Cookbook 内に記述しておく</strong></li>
<li><strong>ユーザーの削除も可能</strong></li>
</ul>

<p>まだまだユーザー周りについては、試したいこと色々ありますよね。鍵認証にするとか、sudo 出来るようにするとか、この辺も追々試してみようと思います！</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="https://github.com/treasure-data/chef-td-agent" target="_blank">https://github.com/treasure-data/chef-td-agent</a></li>
<li><a href="http://docs.opscode.com/resource_user.html" target="_blank">http://docs.opscode.com/resource_user.html</a></li>
<li><a href="http://docs.opscode.com/resource_group.html" target="_blank">http://docs.opscode.com/resource_group.html</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年5月13日">2013年5月13日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年5月10日">2013年5月10日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualbox/">VirtualBox</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>




<p><a href="/archives/966/">前々回</a>、<a href="/archives/1003/">前回</a>までで、ようやく気軽に作って壊せる仮想環境が用意できたので、 ここからは実際に仮想環境に作っていくところをやりたいと思います。</p>

<p><strong>※まだあやふやな部分が多いので、明らかに違っていた箇所はあとで修正する可能性があります。</strong></p>

<p>もちろんゴールは、実際に少し作れるところまでです。（ファイルを自動で配置するとか、アプリケーションインストール済みの状態にするとか）</p>

<p>ただ、そこまで大規模なものは想定していないので（数百台を一元管理とかは絶対やらない）、ローカル環境だけで気軽に試せる方法をとっていきます。</p>

<p>以下、こんな感じで最小構成で進めていきます。</p>

<ol>
<li>Vagrant を最低限使えるようにする（終わってます）</li>
<li>Chef を最低限使えるようにする</li>
<li>簡単な Cookbook を用意する</li>
<li>Vagrant, Chef を連携させて、仮想環境が変化するか見てみる</li>
</ol>

<h2 id="chef-とは">Chef とは？</h2>

<p>最近かなり頻繁に聞くワードです。</p>

<p>サーバ構築、システム管理の自動化を助けてくれるツールです。アプリケーションのインストールや、OS・ミドルウェアの設定などを、Cookbook と呼ばれる設定ファイルに落とし込んでおくと、各プラットフォームの差異を吸収したうえで、その設定ファイルの状態に保ってくれます。</p>

<p>詳しくはまだまだこれからです。ただ気軽に試せる環境を用意したので、ここからどんどんと試してみようと思います。</p>

<p>また、自動化というメリットの他にも、こういう気軽に試して壊してが出来るってところは大きなメリットだなーと思います。 では早速。</p>

<h2 id="chef-をインストール">Chef をインストール</h2>

<p>まず Chef に関連したパッケージを gem でインストールしてみます。gem ならば比較的すぐです。</p>

<pre><code>$ gem install chef
Fetching: chef-11.4.4.gem (100%)
Successfully installed chef-11.4.4
1 gem installed
$ chef-solo -v
Chef: 11.4.4
</code></pre>

<p>chefというパッケージを入れると、<strong>chef-solo, chef-client, knife</strong> などのコマンドが一式用意されるようです。試しに chef-solo -v と打ってみたら、「Chef のバージョンは11.4.4ですよー」と表示されました。</p>

<p>ちなみに、数百、数千台とか管理するわけでもないので、Chef Server を用意してうんぬん・・・というのは今回やらずに、 サーバの役割を内包しつつ単独で動く、<strong>Chef Solo</strong> を使っていきます。</p>

<p>さてさて、何か Cookbook を作ってみることにします。</p>

<h2 id="cookbook-を作る">Cookbook を作る！</h2>

<p>※以下、2012年10月に発売された『Software Design / Chef 入門』を参考に進めます。</p>

<p>Cookbook 自体は、<strong>ただのディレクトリとテキストファイル群</strong>にすぎないので、 実際 Chef のコマンド一式なくても作れます。 （knife というひな形を作ってくれるコマンドがあるものの、後回しにしようと思います。）</p>

<p>また、設定ファイルも最近よくある、設定ファイルっぽく書いていたら実はそれが Ruby のスクリプトだった（DSL）という類のものなので、 これもエディタさえあれば用意できてしまいます。</p>

<p>実際に Chef が担当するのは、その Cookbook に書かれた設定項目に沿って、アプリケーションなり設定値なりを反映するところになるので、 そのあたりを理解するためにも、最初は手書きで用意してみようと思います。</p>

<h3 id="vagrantfile-を若干見直し">Vagrantfile を若干見直し</h3>

<p>Cookbook を用意する前に、1つだけ Vagrantfile の見直しをしたいと思います。 というのも、今後こちらに Cookbook の置き場所の指定などをするためです。</p>

<pre><code>Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;CentOS_6.4_x86_64_Minimal&quot;

  config.vm.define :vmclient1 do |vmclient|
    vmclient.vm.hostname = &quot;vmclient1&quot;
    vmclient.vm.network :private_network, ip: &quot;192.168.100.11&quot;
  end

  config.vm.define :vmclient2 do |vmclient|
    vmclient.vm.hostname = &quot;vmclient2&quot;
    vmclient.vm.network :private_network, ip: &quot;192.168.100.12&quot;
  end
end
</code></pre>

<p>こんな感じで、<code>config.vm.define</code> で仮想マシンを複数立ち上げることが可能です。 先にも書いたようにこれ実際は Ruby のコードなので、ループとかで回すこともできますね。 （とはいえ、ゲストOS立ち上げまくったらホストOSが重くなるのは必然ですし、それぞれの起動時間もそれなりにかかります。）</p>

<p>ゆくゆくは仮想マシン間のネットワークの検証なども行っていきたいので、最小構成は2台としておきたいなーと思います。</p>

<p>それぞれを、vmclient1, vmclient2 として管理していき、 vmclient1 の方は<strong>簡単なテキストファイルの設置</strong> (/tmp/test.txt) を、 vmclient2 の方は<strong>簡単なアプリケーションの設置</strong> (Webサーバ, Apache) を行ってみようと思います。</p>

<h3 id="レシピを用意する">レシピを用意する</h3>

<p>前回までで、Vagrant 用のディレクトリを作っていたので、その中で Cookbook 用のディレクトリを用意します。</p>

<pre><code>$ cd ~/Vagrant
$ mkdir cookbooks
</code></pre>

<p>vmclient1, vmclient2 用のレシピを用意します。まず vmclient1 から。</p>

<pre><code>cat cookbooks/vmclient1/recipes/default.rb
# Cookbook ファイル設置テスト

file &quot;/tmp/test.txt&quot; do
  content &quot;vmclient1 にダミーテキストファイルを作りました！&quot;
end
</code></pre>

<p>こちらは、content に書かれた内容のファイルを、仮想マシンの /tmp/test.txt へと作成するレシピです。</p>

<p>続けて vmclient2 の方です。</p>

<pre><code>cat cookbooks/vmclient2/recipes/default.rb
# Cookbook アプリケーション設置テスト

package &quot;httpd&quot; do
  action :install
end
</code></pre>

<p>こちらは、httpd（つまりApache）をインストールするというレシピになります。</p>

<p>※まだこのあたりが完全に分かってないのですが、CentOS では httpd で良さげでも、他ディストリビューションなどでは apache2 というパッケージ名にしたりする必要があるらしく、この辺のパッケージ名は吸収してくれないのかなーとか、ちょっと疑問でした。</p>

<h2 id="vagrant-chef-の連携">Vagrant, Chef の連携</h2>

<p>Vagrantfile の中には、<strong>chef-solo</strong> の設定項目も存在します。</p>

<p><a href="http://docs.vagrantup.com/v2/provisioning/chef_solo.html" target="_blank">http://docs.vagrantup.com/v2/provisioning/chef_solo.html</a></p>

<p>これを使って、Vagrant 経由で起動した仮想マシンに対して、レシピを適用してみます。</p>

<h3 id="再度-vagrantfile-を見直し">再度 Vagrantfile を見直し</h3>

<pre><code>Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;CentOS_6.4_x86_64_Minimal&quot;

  config.vm.define :vmclient1 do |vmclient|
    vmclient.vm.hostname = &quot;vmclient1&quot;
    vmclient.vm.network :private_network, ip: &quot;192.168.100.11&quot;

    vmclient.vm.provision :chef_solo do |chef|
      chef.cookbooks_path = &quot;cookbooks&quot;
      chef.run_list = &quot;recipe[vmclient1]&quot;
    end
  end

  config.vm.define :vmclient2 do |vmclient|
    vmclient.vm.hostname = &quot;vmclient2&quot;
    vmclient.vm.network :private_network, ip: &quot;192.168.100.12&quot;

    vmclient.vm.provision :chef_solo do |chef|
      chef.cookbooks_path = &quot;cookbooks&quot;
      chef.run_list = &quot;recipe[vmclient2]&quot;
    end
  end
end
</code></pre>

<p>やってることは簡単で、今回用意した2つの仮想マシンそれぞれに対して、chef-solo の設定項目を設け、 Cookbook のパスとレシピ名を指定しているだけです。</p>

<p>とりあえずここまでやったら、一旦仮想マシンを壊して初期状態に戻しておきます。</p>

<pre><code>$ vagrant destroy
Are you sure you want to destroy the 'vmclient2' VM? [y/N] y
[vmclient2] Forcing shutdown of VM...
[vmclient2] Destroying VM and associated drives...
Are you sure you want to destroy the 'vmclient1' VM? [y/N] y
[vmclient1] Forcing shutdown of VM...
[vmclient1] Destroying VM and associated drives...
</code></pre>

<h3 id="レシピの適用">レシピの適用！</h3>

<p>さて、いよいよレシピを適用してみます。<strong>vagrant up!! vagrant up!!</strong></p>

<pre><code>$ vagrant up
</code></pre>

<p>すると、ずらずらーっとログが出力されます。</p>

<pre><code>Bringing machine 'vmclient1' up with 'virtualbox' provider...
Bringing machine 'vmclient2' up with 'virtualbox' provider...
[vmclient1] Importing base box 'CentOS_6.4_x86_64_Minimal'...

[vmclient1] Matching MAC address for NAT networking...
[vmclient1] Setting the name of the VM...
[vmclient1] Clearing any previously set forwarded ports...
[vmclient1] Fixed port collision for 22 =&gt; 2222. Now on port 2202.
[vmclient1] Creating shared folders metadata...
[vmclient1] Clearing any previously set network interfaces...
[vmclient1] Preparing network interfaces based on configuration...
[vmclient1] Forwarding ports...
[vmclient1] -- 22 =&gt; 2202 (adapter 1)
[vmclient1] Booting VM...
[vmclient1] Waiting for VM to boot. This can take a few minutes.
[vmclient1] VM booted and ready for use!
[vmclient1] Setting hostname...
[vmclient1] Configuring and enabling network interfaces...
[vmclient1] Mounting shared folders...
[vmclient1] -- /vagrant
</code></pre>

<p>2つの仮想マシンを立ち上げているので、それぞれログにも名前がついてます。 ただ基本的に1台のときとやっていることは同じで、 ネットワークの設定やら共有ディレクトリの設定やらをやってくれてます。</p>

<p>ここまでは同じですね！　さらに出力は続きます。</p>

<pre><code>[vmclient1] -- /tmp/vagrant-chef-1/chef-solo-1/cookbooks
[vmclient1] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
</code></pre>

<p>おっと、ここから chef-solo が起動してることが確認できました。</p>

<pre><code>[2013-05-09T22:14:33+00:00] INFO: *** Chef 11.4.0 ***
[2013-05-09T22:14:33+00:00] INFO: Setting the run_list to &quot;recipe[vmclient1]&quot; from JSON
[2013-05-09T22:14:33+00:00] INFO: Run List is [recipe[vmclient1]]
[2013-05-09T22:14:33+00:00] INFO: Run List expands to [vmclient1]
[2013-05-09T22:14:33+00:00] INFO: Starting Chef Run for vmclient1
[2013-05-09T22:14:33+00:00] INFO: Running start handlers
[2013-05-09T22:14:33+00:00] INFO: Start handlers complete.
[2013-05-09T22:14:33+00:00] INFO: Processing file[/tmp/test.txt] action create (vmclient1::default line 3)
[2013-05-09T22:14:33+00:00] INFO: entered create
[2013-05-09T22:14:33+00:00] INFO: file[/tmp/test.txt] created file /tmp/test.txt
[2013-05-09T22:14:33+00:00] INFO: Chef Run complete in 0.060882068 seconds
[2013-05-09T22:14:33+00:00] INFO: Running report handlers
[2013-05-09T22:14:33+00:00] INFO: Report handlers complete
</code></pre>

<p>・・・vmclient1 のログはここまでのようですね。</p>

<p>Vagrantfile に指定されたレシピが、 chef-solo を介して実行され、実際にファイルの設置が行われていたようです。</p>

<p>確認は後回しにして、さらに vmclient2 のログも見てみます。</p>

<pre><code>[vmclient2] Importing base box 'CentOS_6.4_x86_64_Minimal'...

[vmclient2] Matching MAC address for NAT networking...
[vmclient2] Setting the name of the VM...
[vmclient2] Clearing any previously set forwarded ports...
[vmclient2] Fixed port collision for 22 =&gt; 2202. Now on port 2203.
[vmclient2] Creating shared folders metadata...
[vmclient2] Clearing any previously set network interfaces...
[vmclient2] Preparing network interfaces based on configuration...
[vmclient2] Forwarding ports...
[vmclient2] -- 22 =&gt; 2203 (adapter 1)
[vmclient2] Booting VM...
[vmclient2] Waiting for VM to boot. This can take a few minutes.
[vmclient2] VM booted and ready for use!
[vmclient2] Setting hostname...
[vmclient2] Configuring and enabling network interfaces...
[vmclient2] Mounting shared folders...
[vmclient2] -- /vagrant
</code></pre>

<p>vmclient2 も、ここまでは今までと同様です。</p>

<pre><code>[vmclient2] -- /tmp/vagrant-chef-1/chef-solo-1/cookbooks
[vmclient2] Running provisioner: chef_solo...
Generating chef JSON and uploading...
Running chef-solo...
[2013-05-09T22:15:42+00:00] INFO: *** Chef 11.4.0 ***
[2013-05-09T22:15:42+00:00] INFO: Setting the run_list to &quot;recipe[vmclient2]&quot; from JSON
[2013-05-09T22:15:42+00:00] INFO: Run List is [recipe[vmclient2]]
[2013-05-09T22:15:42+00:00] INFO: Run List expands to [vmclient2]
[2013-05-09T22:15:42+00:00] INFO: Starting Chef Run for vmclient2
[2013-05-09T22:15:42+00:00] INFO: Running start handlers
[2013-05-09T22:15:42+00:00] INFO: Start handlers complete.
[2013-05-09T22:15:42+00:00] INFO: Processing package[httpd] action install (vmclient2::default line 3)
[2013-05-09T22:15:59+00:00] INFO: package[httpd] installing httpd-2.2.15-26.el6.centos from base repository
[2013-05-09T22:16:06+00:00] INFO: Chef Run complete in 23.898427112 seconds
[2013-05-09T22:16:06+00:00] INFO: Running report handlers
[2013-05-09T22:16:06+00:00] INFO: Report handlers complete
</code></pre>

<p>こちらのログは、httpd 関連のログになってますね。ログを見る限りではインストールは正しく行われたようです。</p>

<h3 id="正しくレシピが反映されたか確認してみる">正しくレシピが反映されたか確認してみる</h3>

<p>まず vmclient1 の方へログインしてみます。</p>

<pre><code>$ vagrant ssh vmclient1
Welcome to your Vagrant-built virtual machine.
</code></pre>

<p>さて、ファイルは存在しているでしょうか？</p>

<pre><code>[vagrant@vmclient1 ~]$ cat /tmp/test.txt
vmclient1 にダミーテキストファイルを作りました！[vagrant@vmclient1 ~]$
</code></pre>

<p>あ・・・最後に改行が入ってなかったのでちょっとアレですが、 でも<strong>ファイルはちゃんと出来てました！</strong></p>

<p>ついでに、こちらに httpd がインストールされていないことを確認しておきます。</p>

<pre><code>$ which httpd
/usr/bin/which: no httpd in (/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/vagrant/bin)
</code></pre>

<p>入ってませんでした。</p>

<p>続けて、vmclient2 の方へログインしてみます。</p>

<pre><code>$ vagrant ssh vmclient2
Welcome to your Vagrant-built virtual machine.

[vagrant@vmclient2 ~]$ which httpd
/usr/sbin/httpd
</code></pre>

<p><strong>おおー、入ってますね。</strong></p>

<p>こちらもついでに、上記パスにテキストファイルが置かれていないことを確認しておきます。</p>

<pre><code>[vagrant@vmclient2 ~]$ cat /tmp/test.txt
cat: /tmp/test.txt: そのようなファイルやディレクトリはありません
</code></pre>

<p>無かったですね。レシピがきちんと環境ごとに分かれて適用されてました。すげー。</p>

<h2 id="まとめ">まとめ</h2>

<p>Cookbook をローカルで気軽に試してレシピが書ける環境があれば、 <strong>物理マシンや VPS 上などでの作業が格段に減り、かなりの効率化が図れるなーという印象です。</strong></p>

<p>個人的には、何よりも作って試して、時には壊して、という<strong>気持ち的な敷居が低いところがとてもいいなー</strong>と思います。 かなり楽しんでやれちゃいそうです。</p>

<p>ここから先は、Cookbook の書き方を種類ごとに覚えつつも、 自分で作った Cookbook を実践配備するところも併せてやっていけたらなーと思います！</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="http://docs.vagrantup.com/v2/" target="_blank">Vagrant Documentation</a></li>
<li><a href="http://blog.madoro.org/mn/81" target="_blank">Chefを最速で使いこなすためのいくつかのポイント &#8211; Masatomo Nakano Blog</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年5月10日">2013年5月10日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualbox/">VirtualBox</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年5月7日">2013年5月7日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualbox/">VirtualBox</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>




<p>個々の仮想マシンのアプリケーションを入れていく前に、仮想マシンの操作でよくある<strong>『スナップショット機能』</strong>的なものが使えるように、 Vagrant のプラグインの追加をしたいと思います。</p>

<h2 id="sahara-プラグインのインストール">sahara プラグインのインストール</h2>

<p>Vagrant 1.0 までは vagrant に続けて gem サブコマンドで入れられたようですが、 Vagrant 1.1 以降は、<code>plugin</code> サブコマンドを使うようです。</p>

<p>と思って試したら、どうやら Vagrant1.1 以降では対応してないようで・・・。</p>

<p>で色々と調べていたら、対応させている方が！素敵ですねー。</p>

<p><a href="http://www.ryuzee.com/contents/blog/6555" target="_blank">Vagrantの必須プラグインSaharaをVagrant 1.1に対応させました | Ryuzee.com</a></p>

<p>こちらの方の記事にもあるように、『Vagrantを使っている人であれば必携のプラグイン』とあるので、 これはぜひとも入れておき、砂場のように作りは消し、作りは消しが簡単に出来るようにしておきたいですね！ （必携といわれるくらいなので、ひょっとしたら後で記事見直したら、この辺きちんと整備されているかもしれませんね。）</p>

<pre><code>$ git clone https://github.com/ryuzee/sahara.git
（略）
$ cd sahara
$ bundle install
Fetching gem metadata from http://rubygems.org/..........
Fetching gem metadata from http://rubygems.org/..
Resolving dependencies...
Using rake (0.9.2.2)
Installing Platform (0.4.0)
Using bundler (1.3.5)
Installing open4 (1.3.0)
Installing popen4 (0.1.2)
Installing thor (0.18.1)
Using sahara (0.0.14) from source at .
Your bundle is complete!
Use `bundle show [gemname]` to see where a bundled gem is installed.
$ bundle exec rake build
sahara 0.0.14 built to pkg/sahara-0.0.14.gem.
</code></pre>

<p>bundle 使ってビルドすると、 sahara/pkg/ 以下に gem ファイルが出来ました。これを以下の代わりに</p>

<pre><code>$ vagrant plugin install sahara
</code></pre>

<p>gem ファイルを指定してやってインストールする、と。</p>

<pre><code>$ vagrant plugin install pkg/sahara-0.0.14.gem
Installing the 'pkg/sahara-0.0.14.gem' plugin. This can take a few minutes...
Installed the plugin 'sahara (0.0.14)'!
</code></pre>

<p>これで入りました。 （この辺整備されたら、git clone でリポジトリ持ってくるところから <code>vagrant plugin install sahara</code> の手前までは不要ですね。）</p>

<p>入ったことを確認するために、<code>list</code> サブコマンドを使ってみます。</p>

<pre><code>$ vagrant plugin list
sahara (0.0.14)
</code></pre>

<p>これで入りました。</p>

<h2 id="sahara-プラグインを使ってみる">sahara プラグインを使ってみる</h2>

<p>インストールの仕方がちょっと違っただけで、使い方は同じなので、配布先見てみます。</p>

<p><a href="https://github.com/jedi4ever/sahara" target="_blank">https://github.com/jedi4ever/sahara</a></p>

<p>こちらによると、以下のコマンドが用意されているようです。</p>

<pre><code>vagrant sandbox on
vagrant sandbox commit
vagrant sandbox rollback
vagrant sandbox off
</code></pre>

<p>サンドボックスモードをオンにしたあと、commit か rollback でその作業をしたことにするか、あるいはしてなかったことにするかを決められるようです。データベースと同じですね。</p>

<p>では、一番シンプルで分かりやすいであろう、仮想マシンのホームディレクトリに &#8216;hello&#8217; という空ファイルを作り、 rollback して元に戻っているかどうかを検証したいと思います。</p>

<pre><code>$ vagrant sandbox on
0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%
</code></pre>

<p>お、なんですかねこの数字。きっとスナップショットを取るのにある程度時間がかかるのでしょう。（といっても数秒でしたが）</p>

<pre><code>$ vagrant ssh
Last login: Sat May  4 23:10:49 2013 from [your-ip-address]
Welcome to your Vagrant-built virtual machine.
[vagrant@localhost ~]$ touch hello
[vagrant@localhost ~]$ ls
hello
</code></pre>

<p>はい、さくっとホームディレクトリに空の &#8216;hello&#8217; というファイルを作りました。</p>

<p>そして、世界を戻してみます。</p>

<pre><code>$ logout
Connection to 127.0.0.1 closed.
$ vagrant sandbox rollback
0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%
0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%
</code></pre>

<p>おお、なんかスナップショット周りに変化があったようですね。</p>

<p>もう一度さっきのファイルを確認するために、ssh で接続してみます。</p>

<pre><code>vagrant ssh
Last login: Sat May  4 23:10:49 2013 from [your-ip-address]
Welcome to your Vagrant-built virtual machine.
[vagrant@localhost ~]$ ls
[vagrant@localhost ~]$
</code></pre>

<p>おおー！なくなってたー！</p>

<h2 id="まとめ">まとめ</h2>

<p>sahara プラグインのような、スナップショットをコントロールできる機能は、やはり有ると無いのとでは全然違いますね。</p>

<p>ここから先の検証は、上手くいくかどうか怪しいところでスナップショットを取っておいて、 ごにょごにょやったあとで上手く行ったら commit で決定、失敗したら rollback で破棄すれば、 <strong>検証がしやすくなること間違いなしです！</strong></p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年5月7日">2013年5月7日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualbox/">VirtualBox</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年5月5日">2013年5月5日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualbox/">VirtualBox</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>




<p>もう最近では、OSの上にOSを動かす仮想環境が当たり前になってきていますが、そのソフトウェアの1つに <strong>VirtualBox</strong> というものがあります。</p>

<p><strong>Vagrant</strong> は、元々この VirtualBox を CUI（コマンドライン）でいじれるツールだったのですが、 バージョン1.1以降で VirtualBox 以外のソフトウェアにも対応してくれるようになったため、 今では VirtualBox に限らず使えます。</p>

<p>ちなみに個人としては、Windows に関しては描画の再現性なども考慮して、Mac 上で <strong>VMWare Fusion</strong> （有料）を起動して、その上に Windows7 やら Windows8 やらをインストールして検証用に使っています。（それでもさくさく動く Retina MacBook Pro 最高ですね！）</p>

<p>一方で、サーバ用途に用いられるような、描画の再現性を考えなくてもよいOSについての検証は、VirtualBox を起動して、その上に CentOS などを入れて今後検証していこうかなと考えています。（まだまだこれからです）</p>

<p>このような、後者のサーバ用途に用いるOSの検証で、いちいち VirtualBox（や他のソフトウェア） を GUI から立ち上げて、GUI でぽちぽちとインストールを行って、起動させるような作業を毎回繰り返す場合、Vagrant はかなり役に立ってくれるのではないかと思います。</p>

<p>まずは Vagrant の準備の仕方や考え方などを軽くまとめてみました。</p>

<h2 id="virtualbox-vagrant-のインストール">VirtualBox, Vagrant のインストール</h2>

<p>まず、事前に VirtualBox を入れておきます。（Vagrant 1.1 からは必ずしも VirtualBox ではなくてもいいのですが、前述の通り今回はサーバ用途で VirtualBox を使うという前提での準備なので、VirtualBox でやります）</p>

<p>Vagrant の 1.0 も入れたことがあるのですが、こちらは <code>gem install vagrant</code> で一発インストールだったのに比べ、1.1以降は専用のパッケージをインストールします。（ちなみに記事書いてる時点の最新は、1.2.2 のようです）</p>

<p><img src="/img/2013/05/vagrant01.png" alt="" /></p>

<p>なんか開発速度がめちゃ早いので、あとでこの記事見返したらバージョン古くなってることでしょう。</p>

<p><img src="/img/2013/05/vagrant02.png" alt="" /></p>

<p>あとは普通にインストールをしていきます。</p>

<p><img src="/img/2013/05/vagrant03.png" alt="" /></p>

<p>はい、インストール完了しました。</p>

<pre><code>$ which vagrant
/usr/bin/vagrant
</code></pre>

<p>この時点で、vagrant というコマンドが用意されていると思うので、 ここから先は vagrant コマンドとそれに続くサブコマンドで、仮想環境を作って行きます。</p>

<p>ちなみに help は、<code>vagrant -h</code> で出ます。</p>

<pre><code>$ vagrant -h
Usage: vagrant [-v] [-h] command [&lt;args&gt;]

    -v, --version                    Print the version and exit.
    -h, --help                       Print this help.

Available subcommands:
     box
     destroy
     halt
     init
     package
     plugin
     provision
     reload
     resume
     ssh
     ssh-config
     status
     suspend
     up

For help on any individual command run `vagrant COMMAND -h`
</code></pre>

<h2 id="vagrant-でよく使う名前とかコマンドとか">Vagrant でよく使う名前とかコマンドとか</h2>

<p>僕もそんなに物理PCのセットアップを数多くやってきているわけではないのですが、 ここから先は物理PCのセットアップの、どの作業に対応しているかを考えながらやった方が イメージがしやすいのではないかと思います。</p>

<ol>
<li>ボックスを用意する（物理PCにおけるインストールディスクを用意する、に近い）</li>
<li>仮想マシンのインストール（物理PCにおける物理マシンのインストール、に近い）</li>
<li>インストール後の設定など</li>
</ol>

<p>こんな感じの流れで進めていきます。</p>

<h2 id="ボックスを用意する">ボックスを用意する</h2>

<p>まずはボックスを追加してやる必要があります。このボックスから仮想マシンを作るため、<strong>例えるならインストールディスクを用意する工程に相当</strong>するのかもしれません。</p>

<p>ボックスを追加するコマンドは <code>vagrant box add</code> なので、とりあえず help でもみてみます。</p>

<pre><code>vagrant box add -h
Usage: vagrant box add &lt;name&gt; &lt;url&gt; [--provider provider] [-h]

    -f, --force                      Overwrite an existing box if it exists.
        --insecure                   If set, SSL certs will not be validated.
        --provider provider          The provider that backs the box.
    -h, --help                       Print this help
</code></pre>

<p>この name というのは、例えるならインストールディスクに名前をつける行為に相当するので、 例えば CensOS のバージョン何々で・・・みたいな名前になるわけで、（あるいはOSやバージョンに紐づいた用途別の名前など）決して<strong>仮想マシンのPC名になるわけではありません。</strong> （僕はここで勘違いをして、変な名前をつけて混乱してました。）</p>

<p>また、url はボックスファイルが公開されている場所に相当します。ボックスファイルは、各OS、ディストリビューション、初期で入ってるアプリケーションごとに色々以下に用意されています。ありがたいですね。</p>

<p><a href="http://www.vagrantbox.es/" target="_blank">http://www.vagrantbox.es/</a></p>

<p>そもそもこのボックスファイルというのは何なのか、というところなのですが、実はこれ自分で作れます。</p>

<p><a href="http://tk0miya.hatenablog.com/entry/2013/03/15/115710" target="_blank">vagrant ユーザよ、その VM は安全なのか? (veewee のすゝめ) &#8211; Hack like a rolling stone</a></p>

<p>確かにやろうと思えば、不正なプログラムをこっそり入れたボックスファイルを公開して、ってのも全然出来なくない話なので、 相当な信頼性を求められるようなものであれば、こういった自分で作る方法も検討すべきなのですが、 今回はそうではないので vagrantbox.es を利用させていただきます。</p>

<p>また、自分で作る方法を見ればなんとなく予想がつくように、ボックスファイルは配布されている ISO ディスクイメージに 設定ファイルを合わせたようなものにすぎないため、ほぼ公開されているディスクイメージに近いものだと考えてもよさそうです。</p>

<h3 id="どれを選べばいいの">どれを選べばいいの？</h3>

<p>この辺は、知らないキーワードがあれば1つずつぐぐりながら調べていくしかないのですが、 今回はサーバ用途の検証に使うので、よくある VPS（Virtual Private Server）構成に近いものを選びます。</p>

<ul>
<li>CentOS の現時点での最新であるバージョン 6.4</li>
<li>64ビット (i386 が32ビット, x86_64 が64ビットで、最近はほぼ全て64ビット）</li>
<li>GUI で立ち上げたときの必要な設定は予めやっといてほしい（Guest Additions）</li>
<li>余計なアプリケーションが入ってない最小構成（Minimal）</li>
<li>あとでアプリケーションのインストールとかも自動化したい（Chef or Puppet）</li>
</ul>

<p>と考えると、これが一番適してそうに思えます。</p>

<p><img src="/img/2013/05/vagrant04.png" alt="" /></p>

<p>わざわざコピーボタンがついているのは、<code>vagrant box add</code> の url のところにコピペするためです。</p>

<pre><code>$ vagrant box add CentOS_6.4_x86_64_Minimal http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20130309.box
Downloading or copying the box...
Progress: 9% (Rate: 3033k/s, Estimated time remaining: 0:02:47))
</code></pre>

<p>こんな感じで、名前をつけてやりつつ、さっきのURLを指定してボックスを作成し始めると、まずはダウンロードが開始されます。</p>

<p>ちなみに、名前のところに無駄に半角スペースが入っていると、どこが name でどこが url なのかが分からなくなるので、<strong>バックスラッシュで半角スペースの手前をエスケープするとか、そもそも半角スペースやめるとか</strong>しましょう。</p>

<p>ボックスファイルが羅列してあったさっきのページを見てみると分かるように、ボックスファイルはほぼディスクイメージなので重いです。 まったりコーヒーでも飲みながら気長に待ちましょう。</p>

<h3 id="ボックスファイルが用意出来たかどうかの確認">ボックスファイルが用意出来たかどうかの確認</h3>

<p><code>vagrant box -h</code> で help を見てみます。</p>

<pre><code>$ vagrant box -h
Usage: vagrant box &lt;command&gt; [&lt;args&gt;]

Available subcommands:
     add
     list
     remove
     repackage

For help on any individual command run `vagrant box COMMAND -h`
</code></pre>

<p><code>list</code> というサブコマンドがあるので、<code>vagrant box list</code> と入力してみます。</p>

<pre><code>$ vagrant box list
CentOS_6.4_x86_64_Minimal (virtualbox)
</code></pre>

<p>おーー、出来ておりますね。これでボックスは用意できました。</p>

<h3 id="ちなみにボックスを削除するときは">ちなみにボックスを削除するときは</h3>

<pre><code>$ vagrant box remove -h
Usage: vagrant box remove &lt;name&gt; &lt;provider&gt;
    -h, --help                       Print this help
</code></pre>

<p>サブコマンドとして remove がありますね。name, provider（仮想マシンが動くソフトウェア、ここでは virtualbox）を指定してやればいいようです。</p>

<pre><code>$ vagrant box remove CentOS 6.4 x86_64 Minimal virtualbox
Removing box 'CentOS 6.4 x86_64 Minimal' with provider 'virtualbox'...
</code></pre>

<p>試しに半角スペースありの名前で作ったボックスファイルを消しました。</p>

<h3 id="ボックスファイルはいずこへ">ボックスファイルはいずこへ？</h3>

<p>実は、この時点でもうホームディレクトリに .vagrant.d というディレクトリが出来ていて、 その下の boxes ディレクトリにボックスファイルが格納されています。</p>

<pre><code>$ cd ~/.vagrant.d/boxes/
</code></pre>

<p>この下にある virtualbox ディレクトリの中に、実体である box-disk1.vmdk というファイルが用意されているので、 仮想マシンのインストールは、これらを元に行うことになります。</p>

<p><strong>ちなみに、まだボックスファイルを用意しただけなので、仮想マシンは何にも出来てません。</strong> これも僕が初期に勘違いしてたところで、今はまだインストールディスクを用意しただけにすぎないのですね。</p>

<h2 id="仮想マシンのインストール">仮想マシンのインストール</h2>

<p>仮想マシンを作る前に、仮想マシンの置き場所へ移動してからインストール作業を始めた方が良さげです。</p>

<p>さっきのはボックスファイルなので、自動的に .vagrant.d 以下へ格納されますが、仮想マシンは別の場所へ作る必要があります。</p>

<pre><code>$ mkdir ~/Vagrant
$ cd ~/Vagrant
</code></pre>

<p>僕は ホームディレクトリに Vagrant というディレクトリを区切って、そちらで作業することにします。</p>

<h3 id="仮想マシンの設定ファイルを準備する-vagrantfile">仮想マシンの設定ファイルを準備する（Vagrantfile）</h3>

<p>さてさて、早速 help を漁りましょう。</p>

<pre><code>$ vagrant -h
Usage: vagrant [-v] [-h] command [&lt;args&gt;]

    -v, --version                    Print the version and exit.
    -h, --help                       Print this help.

Available subcommands:
     box
     destroy
     halt
     init
     package
     plugin
     provision
     reload
     resume
     ssh
     ssh-config
     status
     suspend
     up

For help on any individual command run `vagrant COMMAND -h`
</code></pre>

<p><code>init</code> というサブコマンドがあります。これを使ってボックスファイルから仮想マシンをインストールしてみます。まずは help から。</p>

<pre><code>$ vagrant init -h
Usage: vagrant init [box-name] [box-url]
    -h, --help                       Print this help
</code></pre>

<p>box-name は、オプションになっていますが、先ほどのボックスファイル名を指定します。</p>

<pre><code>$ vagrant init CentOS_6.4_x86_64_Minimal
A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.
$ ls
Vagrantfile
</code></pre>

<p><code>vagrant init [box-name]</code> を実行すると、同一ディレクトリ内に Vagrantfile なるものが生成されます。 早速これを覗いてみましょう。</p>

<pre><code># -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(&quot;2&quot;) do |config|
  # All Vagrant configuration is done here. The most common configuration
  # options are documented and commented below. For a complete reference,
  # please see the online documentation at vagrantup.com.

  # Every Vagrant virtual environment requires a box to build off of.
  config.vm.box = &quot;CentOS_6.4_x86_64_Minimal&quot;

  # The url from where the 'config.vm.box' box will be fetched if it
  # doesn't already exist on the user's system.
  # config.vm.box_url = &quot;http://domain.com/path/to/above.box&quot;

  # Create a forwarded port mapping which allows access to a specific port
  # within the machine from a port on the host machine. In the example below,
  # accessing &quot;localhost:8080&quot; will access port 80 on the guest machine.
  # config.vm.network :forwarded_port, guest: 80, host: 8080

  # Create a private network, which allows host-only access to the machine
  # using a specific IP.
  # config.vm.network :private_network, ip: &quot;192.168.33.10&quot;

  # Create a public network, which generally matched to bridged network.
  # Bridged networks make the machine appear as another physical device on
  # your network.
  # config.vm.network :public_network
</code></pre>

<p>以下ずらずらとコメント行が続きますが、まずは config.vm.box のところに指定したボックスファイル名が 入っていることが確認できます。</p>

<p>また、コメントから3種類のネットワーク設定が可能であることが分かります。</p>

<ol>
<li>ポートフォワーディング（ゲストOSの特定ポートを、ゲストOSの別ポートにつなぐ）</li>
<li>プライベートネットワーク</li>
<li>パブリックネットワーク（ブリッジ接続）</li>
</ol>

<p>このあたりの設定は、仮想環境を作る際に検討すべき、ホストOS（今いじってるOS）とゲストOS（今作ろうとしてるOS）とをどのように接続するかの話になってきます。</p>

<p>コメント状態のまま仮想マシンを立ち上げると、NAT接続で繋がると思うので、この辺は最初はいじらないでおきます。 NAT接続は、ざっくり言うとゲストOSからの通信が、外から見るとあたかもホストOSが通信しているかのように見えます。</p>

<p>それ以外にも、コメントにいろいろ「こんな設定できるよー」と書いてあるので、読みながら試してみるのも良いのではないでしょうか。 VirtualBox の GUI から設定出来ることは、この設定ファイルから設定できるはずです。</p>

<h2 id="vagrant-up-で仮想マシンの電源オン">Vagrant up で仮想マシンの電源オン</h2>

<p><code>vagrant up -h</code> で help を読んでみます。</p>

<pre><code>$ vagrant up -h
Usage:vagrant up [vm-name] [options] [-h]

        --[no-]provision             Enable or disable provisioning
        --provision-with x,y,z       Enable only certain provisioners, by type.
        --[no-]parallel              Enable or disable parallelism if provider supports it.
        --provider provider          Back the machine with a specific provider.
    -h, --help                       Print this help
</code></pre>

<p>vm-name がオプションになっていますが、一旦仮想マシンは1つだけにしておくので、 複数作って名前を指定するのはまたの機会にしておきます。</p>

<p>ということで、オプションなしで実行します。</p>

<pre><code>$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
[default] Importing base box 'CentOS_6.4_x86_64_Minimal'...
[default] Matching MAC address for NAT networking...
[default] Setting the name of the VM...
[default] Clearing any previously set forwarded ports...
[default] Fixed port collision for 22 =&gt; 2222. Now on port 2201.
[default] Creating shared folders metadata...
[default] Clearing any previously set network interfaces...
[default] Preparing network interfaces based on configuration...
[default] Forwarding ports...
[default] -- 22 =&gt; 2201 (adapter 1)
[default] Booting VM...
[default] Waiting for VM to boot. This can take a few minutes.
[default] VM booted and ready for use!
[default] Configuring and enabling network interfaces...
[default] Mounting shared folders...
[default] -- /vagrant
</code></pre>

<p>実行するとすぐに、<strong>「マシン名は &#8216;default&#8217; にしておいてやったぜ」</strong>という表記が出ます。 Vagrantfile に設定がなかったので &#8216;default&#8217; という仮想マシンを作ろうとしています。</p>

<p>また、ネットワークの設定も特にしていないので、<strong>「ネットワークは &#8216;NAT接続&#8217; にしておいてやったぜ」</strong>という表記が出ます。</p>

<p>さらに、<strong>「ssh の 22番ポートが衝突しちゃうから 2201 で接続できるようにしておいてやったぜ」</strong>という表記も出ています。</p>

<p><strong>・・・けっこう色々初期設定で便利な感じにやってくれてますね。</strong></p>

<p>ついでに /vagrant という共有ディレクトリも用意してくれているようです。</p>

<h3 id="もう立ち上がってるの">もう立ち上がってるの？？？</h3>

<p>実はもう電源オンの状態になっています。コマンドラインなので実感が湧かないかもしれません。</p>

<p>そういうときは、立ち上がっているかどうかを確認する <code>status</code> というサブコマンドを使ってみます。</p>

<pre><code>$ vagrant status
Current machine states:

default                  running (virtualbox)

The VM is running. To stop this VM, you can run `vagrant halt` to
shut it down forcefully, or you can run `vagrant suspend` to simply
suspend the virtual machine. In either case, to restart it again,
simply run `vagrant up`.
</code></pre>

<p>&#8216;default&#8217; という仮想マシン（さっき作りました）が、 &#8216;running&#8217; つまり動いていると。</p>

<p>ついでに止めたいときは &#8216;vagrant halt&#8217; と打てばいいよ、と教えてくれています。</p>

<p>まだまだこれだけだと、普通に1台インストールしただけなので良さは体感できないかもしれませんが、 これが<strong>複数台になった場合</strong>や、<strong>ちょっとだけ設定変えて別々にインストール</strong>、みたいな状況だと、 この設定ファイルの利点が出てくるのではないかなーと思います。</p>

<p>とにかくこれでもうインストール完了してます。便利だなー。</p>

<h2 id="インストール後の設定など">インストール後の設定など</h2>

<p>動いているとはいえ、とりあえず接続してログインまではやりたいですよね。</p>

<p>さて、再び help 漁りをしてみます。</p>

<pre><code>$ vagrant -h
Usage: vagrant [-v] [-h] command [&lt;args&gt;]

    -v, --version                    Print the version and exit.
    -h, --help                       Print this help.

Available subcommands:
     box
     destroy
     halt
     init
     package
     plugin
     provision
     reload
     resume
     ssh
     ssh-config
     status
     suspend
     up
</code></pre>

<p>この中に、<code>ssh</code> と <code>ssh-config</code> があります。 ssh でつなぐためには、<code>vagrant ssh-config</code> で表示された内容を、ホームディレクトリにある <strong>~/.ssh/config</strong> に入れてやればOKです。</p>

<pre><code>$ vagrant ssh-config
Host default
  HostName 127.0.0.1
  User vagrant
  Port 2201
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile &quot;/Users/[your-name]/.vagrant.d/insecure_private_key&quot;
  IdentitiesOnly yes
  LogLevel FATAL
</code></pre>

<p>※~/.ssh/config は、複数のSSHの設定を管理するテキストファイルで、各接続先の接続方法やら、鍵ファイルの場所やらを記述しておくことで、接続時にパスワードなど打たずに接続が可能と成ります。（詳しくはグーグル先生にでも・・・）</p>

<p>接続設定を <strong>~/.ssh/config</strong> に追加したら、そのまま <code>vagrant ssh</code> を実行してみます。</p>

<pre><code>$ vagrant ssh
Welcome to your Vagrant-built virtual machine.
[vagrant@localhost ~]$
</code></pre>

<p>おお〜〜、接続できました。どうやら初期設定で <strong>vagrant</strong> というユーザーを作っているようです。 本当に作った仮想マシンに接続できているか、いくつかコマンド打って確認してみます。</p>

<pre><code>$ uname -a
Linux localhost.localdomain 2.6.32-358.el6.x86_64 #1 SMP Fri Feb 22 00:31:26 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux
$ cat /etc/redhat-release
CentOS release 6.4 (Final)
</code></pre>

<p>うん、間違いなく作った仮想マシンに接続出来ています。</p>

<h2 id="まとめ">まとめ</h2>

<p>とりあえず仮想マシンのインストール、接続確認までですが、思った以上にめんどくさいところが初期設定として用意されていて、 正直ちょっとわくわくしました。</p>

<p>たぶんコマンドラインで仮想マシンを構築する真価が発揮されるのは、もうちょっとやった先になるとは思いますが、とりあえず1台インストール出来たので、今回はここまでにしたいと思います。</p>

<p>続き: <a href="/archives/1003/">Vagrant に仮想マシンのスナップショットがとれる sahara というプラグインを入れた</a></p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="https://www.virtualbox.org/" target="_blank">VirtualBox</a></li>
<li><a href="http://www.vagrantup.com/" target="_blank">Vagrant</a></li>
<li><a href="http://docs.vagrantup.com/v2" target="_blank">Vagrant Documentation</a></li>
<li><a href="http://d.hatena.ne.jp/naoya/20130205/1360062070" target="_blank">Vagrant &#8211; naoyaのはてなダイアリー</a></li>
<li><a href="http://www.ryuzee.com/contents/blog/4292" target="_blank">Vagrantで簡単仮想マシン構築 | Ryuzee.com</a></li>
<li><a href="http://www.vagrantbox.es/" target="_blank">Vagrantbox.es</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年5月5日">2013年5月5日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
    <li class="flow"><a href="/tags/virtualbox/">VirtualBox</a></li>
    <li class="flow"><a href="/tags/virtualization/">virtualization</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年4月8日">2013年4月8日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/wget/">wget</a></li>
    <li class="flow"><a href="/tags/crawler/">Crawler</a></li>
  </ul>
</div>




<p><strong>ええ、知りませんでした。無知もいいところです・・・。</strong></p>

<p>webコンテンツをざっくりローカルで見られるようにしたいなー。と思って、いろいろぐぐってました。</p>

<p>基点のURLからリンクやらリソースやらを辿って、それらをすべて落としてきて、 そこからさらにパスとかを変換してやればいいのかなーとか思っていたのですが、 ぐぐってみると、もうすでに<strong>全部やってくれる便利なコマンドがある</strong>のではないですか。</p>

<p>それが、wget というソースコードをダウンロードするのによく使うコマンドだったことに驚きでした。</p>

<p>ちなみに mac は入ってないっぽいのでさくっと入れました。</p>

<pre><code>brew install wget
</code></pre>

<p>普通の使い方は、wget のあとにダウンロードしたい URL を続けて引数として渡してやるだけです。</p>

<pre><code>wget example.com/path/to/contents.tar.gz
</code></pre>

<p>GUI の無い環境などで、何かアプリケーションをインストールするときなど、tarball や zip などで固められた圧縮ファイルを、コマンドライン上から落としてくるようなシーンでよく使うのではないかと思います。 実際僕もそれしか知りませんでした。</p>

<p><strong>だがしかし！</strong></p>

<p>ぐぐってみると色々なオプションがあるらしいじゃないですか。さっそくオプション読んでみましょう。</p>

<pre><code>man wget
</code></pre>

<h2 id="webクローラーとしての-wget">webクローラーとしての wget</h2>

<p><code>--recursive</code> やら、<code>--convert-links</code> やら、便利なオプションが色々あります。</p>

<p>使えそうなやつ、面白そうなやつをピックアップしてみます。</p>

<h3 id="8211-recursive-r">&#8211;recursive, -r</h3>

<p>再帰的にリンクを辿ってくれます。求めてたのはまさにこれだー。</p>

<h3 id="8211-level-depth-l-depth">&#8211;level=depth, -l depth</h3>

<p>どこまで辿るのか指定できます。 デフォルトは5階層のようですが、<code>--level=inf</code> と指定することで、いけるところまで辿ってくれるようですね。素敵だー。</p>

<h3 id="8211-convert-links-k">&#8211;convert-links, -k</h3>

<p>ちゃんとローカルでも（webサーバ動いてなくても）閲覧できるように、相対パスに書き換えてくれます。 <strong>素敵すぎる！</strong></p>

<h3 id="8211-no-clobber-nc">&#8211;no-clobber, -nc</h3>

<p>同じパスにすでにファイルがあった場合、file.1, file.2 のように別名ではなく、上書きしてくれます。とりあえずざっと閲覧できるものが欲しいときは（動的にコロコロ内容が変わるものでなければ）、つけておいた方が良さげ。</p>

<h3 id="8211-random-wait">&#8211;random-wait</h3>

<p>ファイルを一気にダウンロードすることになるので、サーバ側からしてみたら一気にリクエストを受け付けることになります。 攻撃と勘違いされないよう、適度に空き時間を作ってくれるオプションです。 何回かのリクエストの後、0.5秒から1.5秒の空き時間を自動的にとってくれます。<strong>賢い〜。</strong></p>

<h3 id="8211-restrict-file-names-modes">&#8211;restrict-file-names=modes</h3>

<p>例えば、 index.html?p=123 みたいなパスを、そのまま保存して閲覧すると、Windowsではエンコードの関係上うまく閲覧できません。</p>

<p>そんなときに、&#8211;restrict-file-names=windows とつけてやることで、使えない文字を別のものに置き換えてくれます。</p>

<p><img src="/img/2013/04/wget01.png" alt="" /></p>

<p>ダウンロードされるファイル名もリネーム済みで、ファイルの中身のパス部分もリネーム後のリンクになっています。 <strong>素敵すぎるじゃないですか！</strong></p>

<h3 id="8211-adjust-extension-e">&#8211;adjust-extension, -E</h3>

<p>URLにクエリ文字列がついたり、サーバサイドプログラムで動的に生成されたりするものは、URLの最後が .html になっていないことが多いです。</p>

<p>これらのURLを、最終的に .html で終わるように調整してくれます。 <strong>なんというおもてなし機能なんだ・・・。</strong></p>

<h3 id="8211-no-parent-np">&#8211;no-parent, -np</h3>

<p>再帰的にダウンロードしてるときに、親に辿らないようにしてくれます。今回はつけておくべきですね。</p>

<h3 id="8211-mirror-m">&#8211;mirror, -m</h3>

<p>最後にミラーリングのオプションもあります。これは、以下の複数オプションをつけたときと同じようです。</p>

<pre><code>-r -N -l inf --no-remove-listing
</code></pre>

<p>つまり、 -r(&#8211;recursive), 再帰的にダウンロードして、 -N(&#8211;timestamping), タイムスタンプをチェックして新しいものを保持して、 -l inf(&#8211;level=inf), いけるとこまで辿るあたりの略ですね。</p>

<p>&#8211;no-remove-listing, これはFTPによる接続を用いたときのオプションで、FTPで引っ張ってくるときに生成される .listing ファイルを、消さずにとっておくオプションです。今は目的から考えて不要ですね。</p>

<h3 id="必要なオプション全部つけて試してみる">必要なオプション全部つけて試してみる</h3>

<p>これらをざっと見たうえで、必要なオプションを全てつけて試してみます。</p>

<pre><code>wget --recursive
--level inf
--no-clobber
--random-wait
--restrict-file-names=windows
--convert-links
--no-parent
--adjust-extension
example.com
</code></pre>

<p><img src="/img/2013/04/wget02.png" alt="" /></p>

<p>いやー、試してみましたけど、wget が便利すぎます。</p>

<p>普段 tarball のダウンロードくらいしかやってなかったのですが、wget が「今から本気出す」と言っているかのようです。すごい。</p>

<h2 id="まとめ">まとめ</h2>

<p>当然のことながら、クライアントサイドで動く JavaScript なんかは、動作したものが HTML ファイルとして落とせるわけではないので、そのページを開いて非同期に処理がなされる類のものは落とせません。</p>

<p>そういう意味で、<strong>ざっくりローカルで見たい場合に用途は限られる</strong>とは思いますが、知ってて損は無いツール（というかオプション）ではないかと思います。</p>

<p>というか、知らなかったから損をしていたという言い方のが正しいですね。ホント、無知は罪です。。。</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="http://d.hatena.ne.jp/kanonji/20121011/1349931815" target="_blank">http://d.hatena.ne.jp/kanonji/20121011/1349931815</a></li>
<li><a href="http://d.hatena.ne.jp/ctrlshift/20080129/1201612626" target="_blank">http://d.hatena.ne.jp/ctrlshift/20080129/1201612626</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年4月8日">2013年4月8日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/wget/">wget</a></li>
    <li class="flow"><a href="/tags/crawler/">Crawler</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年3月24日">2013年3月24日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/html5/">HTML5</a></li>
    <li class="flow"><a href="/tags/output/">output</a></li>
    <li class="flow"><a href="/tags/event-conference/">event-conference</a></li>
  </ul>
</div>




<p>最近、こんな勉強会に参加して、 こんなこと話しました、こんなこと聞きましたという記事を けっこう頻繁にアウトプット出来るようになってきて、個人的に嬉しく思っています。</p>

<p>今回は、3/23（土）に大阪で行われた<strong>『第6回 HTML5など勉強会』</strong>に、 名古屋から完全アウェー状態で飛び込みに行って、 興味深いプレゼンをお聞かせいただきつつも、 自分もスーパーサイヤ人に変身して恥をかき捨ててきたよ、というまとめです。</p>

<p><img src="/img/2013/03/html5-west01.png" alt="" /></p>

<h2 id="第6回-html5など勉強会">第6回 HTML5など勉強会</h2>

<p>関西で（おそらく不定期で）行われているHTML5関連の勉強会です。 これはお約束なのですが、HTML5といいつつ、 幅広く最近の特にWebのフロント周りの話を中心に構成された勉強会でした。</p>

<p>僕個人としては、先月の『大なごやJS vol.5』でやった<a href="/archives/834/">『WebRTC + Web Audio API = スーパーサイヤ人』</a>のネタを、もっと会場で実際に見せた方が（＝シャウトしてるのを見せた方が）面白いんじゃないかと思っていたので、良い機会だと思ってこの勉強会に持ち込んでみました。</p>

<p>予想してた以上に興味深い内容ばかりで、得るものも多かった会でした。 発表概要は以下のような感じです。</p>

<ul>
<li>WebアプリビルドツールYeomanを使ってみる 村岡(@bathtimefish)さん</li>
<li>D3.js と SVG を使ってTwitterのデータを視覚的に表現してみよう！ かどっぺ(@kadoppe)さん</li>
<li>Firefox的DOMイベントの基礎から深淵まで なかのん(@d_toybox)さん</li>
<li>自分の発表</li>
<li>パソナテックさんタイム</li>
</ul>

<p>上3つの発表を、それぞれ個人的な視点でまとめておきたいと思います。</p>

<h2 id="webアプリビルドツールyeomanを使ってみる">WebアプリビルドツールYeomanを使ってみる</h2>

<p>資料はこちらにアップされてます。 <a href="http://www.slideshare.net/bathtimefish/yeoman-ria" target="_blank">http://www.slideshare.net/bathtimefish/yeoman-ria</a></p>

<p>初期構築時における<strong>ディレクトリ構成</strong>や、 Webのフロントエンド構築におけるファイルの最小化や結合などの<strong>ビルド工程</strong>などの、 一から全部やってるとかなりめんどい工程を自動化してくれるツールである、Yeomanに関する発表でした。</p>

<p>今現在、1.0のbetaがリリースされているらしく、0.9から1.0ではコマンド名が変わったり、 0.9まででめんどくさかった部分の簡素化が図られているなど、 より実用的になっているよ、とのことでした。</p>

<p>変わっている部分は、公式サイトに migrate guide としてまとめられているので、 そちらを参考にするといいみたいです。</p>

<p><a href="http://yeoman.io/migrate.html" target="_blank">http://yeoman.io/migrate.html</a></p>

<p>また、1.0になり、Yeoman は以下の3つのツールで構成されるようになってきた、とのこと。</p>

<ul>
<li><strong>yo</strong> （足場を作る役割のツール、事前に用意されたパッケージを引数として指定すると、それベースの初期構成で自動で用意してくれる）</li>
<li><strong>bower</strong> （Ruby における gem、node における npm みたいな、JavaScriptのパッケージ管理ツール）</li>
<li><strong>grunt</strong> （もう言わずとしれた JavaScript ベースのビルドツール）</li>
</ul>

<p>一昔前までは、フロント側でそこまでボリュームのあるものを作ることが無かったこともあり、 こういったツールによるサポートという面はあまり考えられてこなかったところがありますが、 ここ最近は、かなりこういった<strong>開発フローを以下に効率化していくか？</strong>という面での ツールの話をかなり頻繁に聞きますね。（乱立してて情報を追うだけでも大変ですね・・・）</p>

<h2 id="d3-js-と-svg-を使ってtwitterのデータを視覚的に表現してみよう">D3.js と SVG を使ってTwitterのデータを視覚的に表現してみよう！</h2>

<p>資料はこちらにアップされてます。 <a href="http://www.slideshare.net/kadoppe/d3js-svg" target="_blank">http://www.slideshare.net/kadoppe/d3js-svg</a></p>

<p><strong>発表の半分以上がライブコーディング</strong>で、やっぱりその場で書いているのを見せるのは、 聞く側にとっても非常に分かりやすくなっていいなーと思いました。</p>

<p>単に表示するまでにどうすればいいか、はもちろんのこと、 そのデータが追加、削除されていたときに非同期で更新するにはどうすればいいかを、 より見えやすく分かりやすく説明されてるところが印象的でした。</p>

<p>具体的には、d3.js の <strong>enter(), exit() の使い方とそのメリット</strong>について、 実際に書きつつ、動かしながら見せていて、 発表内容はビジュアライゼーションだったのですが、 発表そのものもメリット部分の説明を<strong>ライブコーディングで見える化してた</strong>ところが すごく分かりやすくて良かったなーと思いました。</p>

<p>また、これが一番参考になったのですが、 ライブコーディングを発表時にやるにあたって、 だんだんと作り足していく様をきちんと<strong>Gitなどのバージョン管理で保持</strong>しておき、 本番中になんか上手く動かない（本番だと細かな記述ミスに気づかなかったりしますよね）場合でも、 最悪 3分間クッキング方式で、<strong>「はい、出来上がったものがこちらになります」</strong>と さっと戻してやることで、発表の進行もスムーズになるなーと思いました。</p>

<p>これは今後やることあったら、ぜひとも参考に使おう、と思います。なるほどー。</p>

<h2 id="firefox的domイベントの基礎から深淵まで">Firefox的DOMイベントの基礎から深淵まで</h2>

<p>資料はこちらにアップされてます。 <a href="http://www.slideshare.net/masayukinakano560/dom-17527671" target="_blank">http://www.slideshare.net/masayukinakano560/dom-17527671</a></p>

<p>個人的に、<strong>一番わくわくしてしまった</strong>のがこの発表で、 DOM イベントの新しい仕様できたよー的なゆるふわな内容かと思いきや、<strong>全然そんなことはなく</strong>。</p>

<p>単に DOM のイベントってテーマだけでも、 こんなにもブラウザごとの差異があったりそもそも仕様が無く実装のみで突っ走っちゃってたり、 なかなかにカオスが現状の話が所狭しと並べられていたので、 本当にブラウザの実装に関わっていらっしゃる方々には頭が下がるなーという（特に中盤以降が）濃すぎる内容でした。</p>

<p>また、tips的な話も数多くあり、例えば</p>

<ul>
<li>addEventListener において、複数のイベントリスナーが登録されたときの実行順序で、ほぼ全てのブラウザで先に登録されたものから実行されるけど、仕様としては曖昧になっている、とか</li>
<li>initMouseEventの引数がクソみたいに長いけど、DOM 4 Events では new MouseEvent の形で呼べるようになっていて、引数もイベント名とオプションのオブジェクトという形でシンプルになっているよーとか</li>
<li>マウスホイールイベント周りがカオス</li>
<li>キーボードイベント周りがカオス（ry</li>
</ul>

<p>などなど挙げ出したらきりがない感じでした。（詳しくは実際に資料見つつ、1つずつ調べていくのが良さそうです）</p>

<p>実際にWebブラウザ作ってる人の話が聞けたのはすごく嬉しかったですし、新旧の互換性や他ブラウザとの互換性など、考えるところが多すぎて大変そうだなーと感じつつ、<strong>ブラウザベンダーの方々のこういった努力の上に、色々成り立っているんだなーと考えさせられる</strong>、非常に興味深い内容でした。</p>

<h2 id="あと自分の発表とか">あと自分の発表とか</h2>

<p>すごい話ばかりだったので、4番手でこんなネタやっちゃっていいのかと不安もありましたが、 シャウトして変身してすっきりできました。<strong>満足です。</strong></p>

<h2 id="まとめ">まとめ</h2>

<p>今回の勉強会の終わりがけに挨拶させていただいた方や、プチ懇親会でお話させていただいた方は、 実はけっこうTwitterなどで情報を追わせていただいている方々ばかりだった（ということに後から気づいた）ので、 実際に会ってお話できて非常に嬉しかったです。 またどこか別の機会でご一緒できたらいいなーとか思ってます。</p>

<p>そして、やっぱり各地域ごとにすごい方はたくさんいらっしゃるので、そこで大いに刺激を受けつつ、また名古屋に戻って頑張って精進していきたいなーと思います。<strong>ありがとうございました！</strong></p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年3月24日">2013年3月24日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/html5/">HTML5</a></li>
    <li class="flow"><a href="/tags/output/">output</a></li>
    <li class="flow"><a href="/tags/event-conference/">event-conference</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年3月11日">2013年3月11日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/html/">HTML</a></li>
    <li class="flow"><a href="/tags/namespace/">namespace</a></li>
    <li class="flow"><a href="/tags/opengraph/">OpenGraph</a></li>
    <li class="flow"><a href="/tags/rdfa/">RDFa</a></li>
  </ul>
</div>




<p>例えば、</p>

<pre><code>&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:og=&quot;http://ogp.me/ns#&quot; xmlns:fb=&quot;https://www.facebook.com/2008/fbml&quot;&gt;
</code></pre>

<p>『こういうのを HTML に埋め込んでください』とか、</p>

<pre><code>&lt;meta property=&quot;og:title&quot; content=&quot;ソーシャル用のタイトルがここに入る&quot;&gt;
&lt;meta property=&quot;og:type&quot; content=&quot;article&quot;&gt;
</code></pre>

<p>『この記述を入れておきましょう』とか、</p>

<pre><code>&lt;fb:like url=&quot;***&quot; layout=&quot;button_count&quot; width=&quot;300&quot;&gt;いいね!&lt;/fb:like&gt;
</code></pre>

<p>『このコードは古くて廃止されてるから使わないようにしましょう』とか・・・。</p>

<p>次から次へと新しい方法が出て来て、<strong>なんだかよくわからないけど、言われるがままに埋め込んでる</strong>、という人もけっこういるのではないかなーと思ってたりしてます。</p>

<p>この辺を少し掘り下げて、理解を深めたいと思います。</p>

<h2 id="opengraph-のケース">OpenGraph のケース</h2>

<p>og なんとかで始まる埋め込みの記述と以前からの meta 要素とは、少し異なる点があります。</p>

<pre><code>&lt;meta name=&quot;description&quot; content=&quot;ここにページの説明文が入る&quot;&gt;
&lt;meta property=&quot;og:description&quot; content=&quot;ここにogpの説明文が入る&quot;&gt; 
</code></pre>

<p><strong>『meta と property が違うのはなぜ？』</strong></p>

<p>前から存在している、<strong>description</strong> や <strong>keywords</strong>, はたまた最近の <strong>viewport</strong> なんかは、 <strong>meta 要素の name 属性</strong>で記述されているのに対して、 ソーシャルメディアでよく使われる、<strong>og:title</strong> や <strong>og:description</strong>, はたまた Facebook で使われる <strong>fb:appid</strong> あたりは、<strong>meta 要素の property 属性</strong>で記述されています。</p>

<p>両者にどのような違いがあるのでしょうか？</p>

<p>OpenGraph に関する仕様は、<a href="http://ogp.me/" target="_blank">http://ogp.me/</a> に掲載されています。 こちらによると、</p>

<blockquote>
<p>To turn your web pages into graph objects, you need to add basic metadata to your page. We&#8217;ve based the initial version of the protocol on RDFa which means that you&#8217;ll place additional tags in the of your web page.</p>
</blockquote>

<p><strong>「(OpenGraph は、) RDFa というプロトコルの最初のバージョンを基に作ったんだぜー」</strong></p>

<p>と書いてあります。</p>

<p>ということは、RDFa の概要を知ることで、記述の差異が見えてくるのではないでしょうか。ちょっと脇道に逸れて RDFa を調べてみます。</p>

<h2 id="rdfa-とは">RDFa とは？</h2>

<p>ざっくり言うと、RDFa は <strong>セマンティックWeb</strong> を実現するために、その文書（≒HTML）に対して <strong>意味を付与する</strong>メタ情報を記述できる仕様です。類似の仕様に、 Microdata などがあります。</p>

<p>また、最後の &#8220;a&#8221; は、attribute の &#8220;a&#8221; で、HTML の要素の中に書く、<strong>属性（attribute）</strong>に相当しますね。
※より正確な情報は、ぐぐるなりして仕様を読んでほしいところなんですが（僕もそこまで読んでません）・・・。
こちらに <a href="http://www.w3.org/TR/rdfa-core/" target="_blank">http://www.w3.org/TR/rdfa-core/</a> 仕様としてまとめられているので、Example を引用して紹介してみようと思います。</p>

<pre><code>&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; prefix=&quot;foaf: http://xmlns.com/foaf/0.1/ dc: http://purl.org/dc/terms/&quot;&gt;
  &lt;head&gt;
    &lt;title&gt;My home-page&lt;/title&gt;
    &lt;meta property=&quot;dc:creator&quot; content=&quot;Mark Birbeck&quot; /&gt;
    &lt;link rel=&quot;foaf:topic&quot; href=&quot;http://www.example.com/#us&quot; /&gt;
  &lt;/head&gt;
  &lt;body&gt;...&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>html要素の中に、 <strong>prefix 属性</strong>として、<strong>Compact URI Expressions</strong> と呼ばれる形式で、プレフィックス名と URI をコロンでつなげたものを、 複数ずらずらと書くようになってます。</p>

<p>さらに、<strong>meta 要素の property 属性</strong>に、先ほど読み込んだプレフィックス名を用いた <strong>&#8220;dc:creator&#8221;</strong> という形で、メタ情報を記述しています。</p>

<p>property 属性以外にも記述の仕方はあるようですが、本題から逸れすぎてしまうため、割愛します。</p>

<h2 id="rdfa-の仕様を踏まえた-opengraph-の記述方法">RDFa の仕様を踏まえた OpenGraph の記述方法</h2>

<p>こちらも公式のサンプルを引用しています。</p>

<pre><code>&lt;html prefix=&quot;og: http://ogp.me/ns#&quot;&gt;
  &lt;head&gt;
    &lt;title&gt;The Rock (1996)&lt;/title&gt;
    &lt;meta property=&quot;og:title&quot; content=&quot;The Rock&quot; /&gt;
    &lt;meta property=&quot;og:type&quot; content=&quot;video.movie&quot; /&gt;
    &lt;meta property=&quot;og:url&quot; content=&quot;http://www.imdb.com/title/tt0117500/&quot; /&gt;
    &lt;meta property=&quot;og:image&quot; content=&quot;http://ia.media-imdb.com/images/rock.jpg&quot; /&gt;
    ...
  &lt;/head&gt;
  ...
&lt;/html&gt;
</code></pre>

<p>ほぼ、先ほどの RDFa の書き方と同じですね。</p>

<p>ポイントとしては、</p>

<ul>
<li><strong>html 要素の prefix 属性に prefix=&#8221;prefix: uri&#8221; の形で宣言しておく</strong></li>
<li><strong>meta 要素の property 属性に property=&#8221;prefix:name&#8221; の形で記述する</strong></li>
</ul>

<p>あたりですね。</p>

<p>meta 要素の name 属性, property 属性の違いというのも、そもそも別ルールを宣言して読み込んでいるため、違ってててもおかしくないですね。</p>

<h2 id="xmlns-なの-prefix-なの">xmlns なの？ prefix なの？</h2>

<p>ちなみに、xmlns なの？ prefix なの？というあたりに関しては、 <a href="http://dev.w3.org/html5/rdfa/#backwards-compatibility" target="_blank">http://dev.w3.org/html5/rdfa/#backwards-compatibility</a> に詳しくまとめられています。</p>

<p>また、こちらの方が RDFa のバージョンの差異も含めて、分かりやすくまとめられていて読みやすいのではないかと思います <a href="http://domes.lingua.heliohost.org/rdfa/intro-syntax1.html" target="_blank">http://domes.lingua.heliohost.org/rdfa/intro-syntax1.html</a>。</p>

<p>こちらも簡単にポイントだけかいつまんでみると、</p>

<ul>
<li>RDFa 1.0 は古いやつだよ、1.1 が新しいやつだよ</li>
<li>RDFa 1.1 では、xmlns が廃止予定になった代わりに prefix 使ってね</li>
<li>でも後方互換性を考えると、XHTML + RDFa 1.0 のときは xmlns 使うべきじゃない？</li>
</ul>

<p>といった感じかと・・・。</p>

<h2 id="svg-のケース">SVG のケース</h2>

<p>名前空間の話に入る前に、もう1つ事例を見てみようと思います。</p>

<p>SVG でリンクを指定する際は、以下のような感じになります。 こちらも仕様サンプル（<a href="http://www.w3.org/TR/SVG/linking.html#Links" target="_blank">http://www.w3.org/TR/SVG/linking.html#Links</a>）からの引用です。</p>

<pre><code>&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;svg width=&quot;5cm&quot; height=&quot;3cm&quot; viewBox=&quot;0 0 5 3&quot; version=&quot;1.1&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
  &lt;desc&gt;Example link01 – a link on an ellipse &lt;/desc&gt;
  &lt;rect x=&quot;.01&quot; y=&quot;.01&quot; width=&quot;4.98&quot; height=&quot;2.98&quot; fill=&quot;none&quot; stroke=&quot;blue&quot; stroke-width=&quot;.03&quot;/&gt;
  &lt;a xlink:href=&quot;http://www.w3.org&quot;&gt;
    &lt;ellipse cx=&quot;2.5&quot; cy=&quot;1.5&quot; rx=&quot;2&quot; ry=&quot;1&quot; fill=&quot;red&quot; /&gt;
  &lt;/a&gt;
&lt;/svg&gt;
</code></pre>

<p>注目すべきは、<strong>svg 要素の xmlns 属性</strong>と、<strong>svg 要素の中に入っている a 要素</strong>です。</p>

<pre><code>&lt;svg width=&quot;5cm&quot; height=&quot;3cm&quot; viewBox=&quot;0 0 5 3&quot; version=&quot;1.1&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
</code></pre>

<p>こちら、<strong>xlink</strong> というものが指定されてますね。</p>

<pre><code>&lt;a xlink:href=&quot;http://www.w3.org&quot;&gt;
...
&lt;/a&gt;
</code></pre>

<p>さらに、<strong>a 要素の xlink:href 属性</strong>として、リンク先が指定されています。</p>

<p>ここでは、SVG 内でのリンクの指定方法の話がしたかったわけではなくて、 プレフィックス名を使った別ルールの読み込み、および使い方の一例として挙げただけです。</p>

<p>xmlns に『<strong>xlink っていうのはですねー、こういうのなんですよー</strong>』と教えてあげることで、実際に使いたいときに、『<strong>xlink のー、href 属性を使いますよー</strong>』と、プレフィックス付きで使うことが出来るようになります。</p>

<p>xlink というのは、SVG に限った話ではなく、汎用的な XML 文書に対するリンクの仕様です。</p>

<p>このように、外部の別ルールを xmlns などで宣言しておくことで、それぞれの仕様が小さくシンプルになり、<strong>使うところだけ宣言して使うといったスマートな使い方が出来る</strong>ようになっていると言えるのかもしれません。</p>

<h2 id="名前空間-namespace-の話">名前空間（namespace）の話</h2>

<p>さて、ここでようやく<strong>名前空間とは何か？</strong>について掘り下げてみようと思います。</p>

<p>ちなみに、もうお気づきだと思いますが、<strong>xmlns の ns とは、namespace の略</strong>のことですね。まさに名前空間を宣言してます。</p>

<p>一昔前、Facebook が謎の文法『FBML』なるものを使って Facebook ページを作ってね！みたいなのがありましたが、 あれは名前空間の <strong>fb</strong> を使ったものになります。</p>

<pre><code>&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:og=&quot;http://ogp.me/ns#&quot; xmlns:fb=&quot;https://www.facebook.com/2008/fbml&quot;&gt;
</code></pre>

<p>fb という名前空間を宣言する必要があるので、<strong>xmlns:fb=&#8221;<a href="https://www.facebook.com/2008/fbml&amp;#8221" target="_blank">https://www.facebook.com/2008/fbml&amp;#8221</a>;</strong> という記述が必要になりますね。</p>

<pre><code>&lt;fb:like url=&quot;***&quot; layout=&quot;button_count&quot; width=&quot;300&quot;&gt;いいね!&lt;/fb:like&gt;
</code></pre>

<p><strong>like 要素なんてのは、元々のHTMLには存在してない</strong>のですが、fb という名前空間を宣言することで、<strong>その名前空間上で限定的に使える like 要素を記述することが出来る</strong>ようになってます。</p>

<p>これは、先ほど出て来た xlink であっても、他の何かであっても同様で、外部のルールを中に持ち込む場合には、名前空間を宣言して、要素の前にプレフィックスをつけるという手順を踏むことで、名前の重複を起こさずに、既存のものと同様に使えるようになります。</p>

<p>また、Microsoft の Office 製品で HTML ファイルを出力したことがある方なら、ひょっとしたら見たことあるかもしれませんが、</p>

<pre><code>&lt;html xmlns:v=&quot;urn:schemas-microsoft-com:vml&quot; xmlns:o=&quot;urn:schemas-microsoft-com:office:office&quot; xmlns:w=&quot;urn:schemas-microsoft-com:office:word&quot; xmlns=&quot;http://www.w3.org/TR/REC-html40&quot;&gt;
</code></pre>

<p>これは Office Word から吐き出された HTML ファイルの html 要素（ちょっと古いかも）の xmlns で、 o は Office 関連のルール、w は Office Word 関連のルールとして宣言されてます。</p>

<p>さらに、</p>

<pre><code>&lt;o:p&gt;&lt;/o:p&gt;
</code></pre>

<p>ファイル内に、こんな形で Office のプレフィックスのついた p 要素 みたいなのも出てきます。これは HTML の p 要素ではなくて、Office で使われている p 要素という意味ですね。</p>

<p>このように、<strong>名前空間を上手く宣言してやることで、他の仕様を取り込んで利用することが出来る</strong>ようになります。</p>

<h2 id="よく知られた-default-prefix-とは-おまけ">よく知られた default prefix とは？（おまけ）</h2>

<p><a href="http://www.w3.org/TR/xhtml-rdfa-primer/#default_prefixes" target="_blank">http://www.w3.org/TR/xhtml-rdfa-primer/#default_prefixes</a> からの引用です。</p>

<pre><code>&lt;html&gt;
  &lt;head&gt; ... &lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;
      &lt;h2 property=&quot;dc:title&quot;&gt;The trouble with Bob&lt;/h2&gt;
      ...
      &lt;h3 property=&quot;dc:creator&quot; resource=&quot;#me&quot;&gt;Alice&lt;/h3&gt;
      ...
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>prefix 属性が一切書かれていないにも関わらず、dc:title, dc:creator という記述が使えてしまっています。</p>

<p>これは、広く使われている prefix は、デフォルトで宣言なしに使えるようにする、という仕様によるもので、OpenGraph の og も含まれているようです。（その辺の話はこちらに書いてあります <a href="http://www.w3.org/2010/02/rdfa/profile/data/" target="_blank">http://www.w3.org/2010/02/rdfa/profile/data/</a>）</p>

<p>ただ、あくまで書き忘れた場合などでもちゃんと動くようにするためのものらしいので、基本は書いた方がいいようですね。</p>

<h2 id="まとめ">まとめ</h2>

<p>新しいルールがどんどん増えて、混乱しがちかもしれませんが、<strong>『小さなルールが名前空間上で相互連携している』</strong>と考えれば、 それが<strong>必要なタイミングになったら、その小さなルールだけ調べれば良い</strong>ことになりますね。</p>

<p>全体がもやもやして、『巨大で、よくわからない仕様群たち』に見えるかもしれませんが、まず名前空間の概念を押さえて、『ここまでは HTML の話、ここから先は HTML 以外の話』みたく、切り分けて考えられるようになれれば、『これは後で調べればいいやー』と切り分け出来るようになり、不安も減って心も穏やかになれるのではないでしょうか。やらなくてもいいことをどんどん増やして、心を穏やかにしていきましょう！。</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="http://ogp.me/" target="_blank">http://ogp.me/</a></li>
<li><a href="http://www.w3.org/TR/rdfa-core/" target="_blank">http://www.w3.org/TR/rdfa-core/</a></li>
<li><a href="http://dev.w3.org/html5/rdfa/" target="_blank">http://dev.w3.org/html5/rdfa/</a></li>
<li><a href="http://www.w3.org/TR/SVG/linking.html" target="_blank">http://www.w3.org/TR/SVG/linking.html</a></li>
<li><a href="http://www.w3.org/TR/xhtml-rdfa-primer/" target="_blank">http://www.w3.org/TR/xhtml-rdfa-primer/</a></li>
<li><a href="http://www.w3.org/2010/02/rdfa/profile/data/" target="_blank">http://www.w3.org/2010/02/rdfa/profile/data/</a></li>
<li><a href="http://www.skyward-design.net/blog/archives/000133.html" target="_blank">http://www.skyward-design.net/blog/archives/000133.html</a></li>
<li><a href="http://domes.lingua.heliohost.org/rdfa/intro-syntax1.html" target="_blank">http://domes.lingua.heliohost.org/rdfa/intro-syntax1.html</a></li>
<li><a href="http://www.kanzaki.com/docs/sw/names.html" target="_blank">http://www.kanzaki.com/docs/sw/names.html</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年3月11日">2013年3月11日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/html/">HTML</a></li>
    <li class="flow"><a href="/tags/namespace/">namespace</a></li>
    <li class="flow"><a href="/tags/opengraph/">OpenGraph</a></li>
    <li class="flow"><a href="/tags/rdfa/">RDFa</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>





<span><a href="/archives/page/1" >もっと新しい記事へ</a></span>
<span><a href="/archives/page/3" >もっと古い記事へ</a></span>


</div>

<footer>

<h2>Tags</h2>

<ul class="tags">
  <li class="flow">
    <a href="/tags/ansible">Ansible (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/apache">Apache (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/cli">CLI (10)</a>
  </li>
  <li class="flow">
    <a href="/tags/css">CSS (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/css3">CSS3 (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/cssfilter">CSSfilter (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/canvas">Canvas (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/chef">Chef (9)</a>
  </li>
  <li class="flow">
    <a href="/tags/crawler">Crawler (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/dom">DOM (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/docker">Docker (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/ftp">FTP (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/font">Font (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/functionallanguage">FunctionalLanguage (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/glsl">GLSL (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/git">Git (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/golang">Golang (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/html">HTML (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/html5">HTML5 (7)</a>
  </li>
  <li class="flow">
    <a href="/tags/html5-outline">HTML5-outline (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/homebrew">Homebrew (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/hugo">Hugo (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/icon-font">Icon-Font (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/javascript">JavaScript (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/linux">Linux (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/mvc">MVC (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/opengraph">OpenGraph (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/php">PHP (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/rdfa">RDFa (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ssh">SSH (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/svg">SVG (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/scala">Scala (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/shellscript">ShellScript (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/smartphone">Smartphone (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/static-site-generator">Static Site Generator (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/vagrant">Vagrant (15)</a>
  </li>
  <li class="flow">
    <a href="/tags/vim">Vim (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualbox">VirtualBox (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualization">Virtualization (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webapp">WebApp (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webaudioapi">WebAudioAPI (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webfont">WebFont (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webgl">WebGL (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webrtc">WebRTC (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webserver">WebServer (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/yeoman">Yeoman (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/zsh">Zsh (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/ajax">ajax (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/automation">automation (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/bugs">bugs (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/event-conference">event-conference (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/getusermedia">getUserMedia (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/gitconfig">gitconfig (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ios">iOS (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/iterm">iTerm (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jquery">jQuery (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/jinja2">jinja2 (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jq">jq (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jsperf">jsperf (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/mediaquery">mediaQuery (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/namespace">namespace (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/oldie">oldIE (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/output">output (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/polyfills">polyfills (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/preloader">preloader (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/rsync">rsync (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/tmux">tmux (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/viewport">viewport (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/vimrc">vimrc (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualization">virtualization (6)</a>
  </li>
  <li class="flow">
    <a href="/tags/wget">wget (1)</a>
  </li>
</ul>

<h2>Categories</h2>

<ul>
  <li>
    <a href="/categories/tech/">Category / Tech</a>
  </li>
  <li>
    <a href="/categories/twentyfour/">Category / TwentyFour</a>
  </li>
</ul>

<h2>RSS</h2>

<ul>
  <li>
    <a href="/categories/tech/index.xml" target="_blank">RSS: Category / Tech</a>
  </li>
  <li>
    <a href="/index.xml" target="_blank">RSS: All articles</a>
  </li>
</ul>

<p>このブログは個人の見解であり、所属する組織の公式見解ではありません</p>
<p>&copy; ばうあーろぐ Generated by <a href="https://gohugo.io/" target="_blank">Hugo</a> and <a href="https://github.com/sindresorhus/github-markdown-css" target="_blank">github-markdown-css</a></p>

</footer>

</div>


<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36767095-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>



  </body>
</html>

