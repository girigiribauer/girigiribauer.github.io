<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/github-markdown.css" type="text/css" media="all">
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="all">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://girigiribauer.com/index.xml">

    <title>git-diff と git-difftool を混同していた話 - ばうあーろぐ</title>
    <meta property='og:title' content="git-diff と git-difftool を混同していた話 - ばうあーろぐ">
    <meta property="og:type" content="article">

    <meta property="og:url" content="http://girigiribauer.com/archives/20161227/">
    <meta name="description" content="">
    <meta property="og:image" content="http://girigiribauer.com/img/ogimage.png">
<meta name="generator" content="Hugo 0.17" />
  </head>
  <body>

<div class="markdown-body">

<header>

<a href="/">ばうあーろぐ TOP へ戻る</a>

</header>


<div class="maincontents">

<h1>git-diff と git-difftool を混同していた話</h1>

<div class="poststatus">
  <p>  <time datetime="2016年12月27日">2016年12月27日</time>

</p>

  <ul class="tags">

    <li class="flow"><a href="/tags/git/">Git</a></li>

  </ul>
</div>




<p><code>git diff</code> のカスタマイズがしたくて .gitconfig に以下のような記述をしたことがある人もいるかと思います。</p>

<pre><code>[diff]
  tool = vimdiff
</code></pre>

<p>でもこれ、違ったんです。
<strong>git diff</strong> 用の設定じゃなくて、 <strong>git difftool</strong> 用の設定だったのです。</p>

<p><strong>なんだってー！？</strong>（色々略）</p>

<h2 id="git-の-diff-周りの設定の整理">git の diff 周りの設定の整理</h2>

<p>diff 周りの設定を .gitconfig に何も書いてない状態の時は、</p>

<pre><code>% git diff .zsh/basic.zsh
diff --git a/.zsh/basic.zsh b/.zsh/basic.zsh
index beff72b..19ac86c 100644
--- a/.zsh/basic.zsh
+++ b/.zsh/basic.zsh
@@ -12,19 +12,15 @@ export LANG=&quot;ja_JP.UTF-8&quot;
 export SHELL=&quot;/bin/zsh&quot;

 # PAGER
-export PAGER=&quot;less&quot;
+export PAGER=&quot;lv -c&quot;

 # EDITOR
-export EDITOR=&quot;/usr/bin/mvim -v&quot;
-export PATH=&quot;/usr/bin/mvim:$PATH&quot;
+export EDITOR=&quot;/usr/local/bin/vim -v -p&quot;
+export PATH=&quot;/usr/local/bin/vim:$PATH&quot;
</code></pre>

<p>このように <strong>ユニファイド形式</strong> の差分で出力されます。（テキスト自体の内容は本筋とは関係ありません）</p>

<p>Vim とか使ってると、いやそれ以外のエディタであっても、
diff とったときには左右に分割した状態（diff-mode）で比較したいじゃないですか。</p>

<p>となると、この <code>git diff</code> の挙動をカスタマイズしたいと思うのはけっこう自然なことだと思います。</p>

<p>でも、いくら以下のように設定しても、変化はおきません。</p>

<pre><code>[diff]
  tool = vimdiff
</code></pre>

<p>そこで色々調べていくうちに、 <strong>git diff</strong> とは別のコマンドが存在していることを知るのです・・・。</p>

<h2 id="マニュアルをちゃんと読もう">マニュアルをちゃんと読もう</h2>

<p>マニュアルをちゃんと読みましょう（自分）。</p>

<p><code>git help diff</code> を実行してマニュアルをよく読むと、
どこにも tool なんて解説項目はありません。</p>

<p>次に <code>git help config</code> を実行して diff 周りに tool の設定項目がないか調べてみると、
今度は見つかりました。ただ・・・</p>

<pre><code>   diff.tool
       Controls which diff tool is used by git-difftool(1). This variable overrides the value
       configured in merge.tool. The list below shows the valid built-in values. Any other value
       is treated as a custom diff tool and requires that a corresponding difftool.&lt;tool&gt;.cmd
       variable is defined.
</code></pre>

<p><strong>used by git-difftool(1)</strong> とありますね・・・。</p>

<p>そう、 <strong>git-diff</strong> ではなく、 <strong>git-difftool</strong> だったのです・・・。</p>

<h2 id="git-difftool-について">git-difftool について</h2>

<p>試しに <code>git difftool</code> を実行してみると、</p>

<pre><code>% git difftool

This message is displayed because 'diff.tool' is not configured.
See 'git difftool --tool-help' or 'git help config' for more details.
'git difftool' will now attempt to use one of the following tools:
kompare vimdiff emerge

Viewing (1/1): 'path/to/file'
Launch 'vimdiff' [Y/n]:
</code></pre>

<p><code>--tool-help</code> オプション付きでヘルプを見ろとあります。</p>

<p>そのまま付けて実行してみます。</p>

<pre><code>% git difftool --tool-help
'git difftool --tool=&lt;tool&gt;' may be set to one of the following:
                araxis
                emerge
                opendiff
                vimdiff
                vimdiff2
                vimdiff3

The following tools are valid, but not currently available:
                bc
                bc3
                codecompare
                deltawalker
                diffmerge
                diffuse
                ecmerge
                gvimdiff
                gvimdiff2
                gvimdiff3
                kdiff3
                kompare
                meld
                p4merge
                tkdiff
                winmerge
                xxdiff

Some of the tools listed above only work in a windowed
environment. If run in a terminal-only session, they will fail.
</code></pre>

<p>つまり、 <code>git difftool</code> というコマンドが存在していて、 <strong>その差分比較に使える difftool が複数存在しているものの、その標準で使う tool を設定できるのが diff.tool だったのです。</strong></p>

<p>では .gitconfig の diff 周りの設定を空にした状態で <code>git difftool</code> コマンドを使ってみましょう。</p>

<pre><code>% git difftool .zsh/basic.zsh

This message is displayed because 'diff.tool' is not configured.
See 'git difftool --tool-help' or 'git help config' for more details.
'git difftool' will now attempt to use one of the following tools:
kompare vimdiff emerge

Viewing (1/1): '.zsh/basic.zsh'
Launch 'vimdiff' [Y/n]:
</code></pre>

<p>今は .gitconfig の diff 周りが未設定の状態で実行しているため、いくつか使用可能な difftool が列挙されています。</p>

<p>ここで Y を押してもいいですが、先に <strong>diff.tool</strong> の設定を追加してからもう一度実行してみます。</p>

<pre><code>[diff]
  tool = vimdiff
</code></pre>

<p>上記を追加して、もう一度 <code>git difftool</code> コマンドを実行します。</p>

<pre><code>% git difftool .zsh/basic.zsh

Viewing (1/1): '.zsh/basic.zsh'
Launch 'vimdiff' [Y/n]:
</code></pre>

<p>余計なメッセージが減りました。 つまり <strong>diff.tool</strong> の設定が正しく適用されています。そのまま Y キーを押します。</p>

<p><img src="/img/2016/12/gitdiff01.png" alt="" /></p>

<p>こんな感じで左右に分割された差分が表示されます。</p>

<p>ちなみに、毎回 Y/n を打つのは面倒なので、 .gitconfig に <strong>difftool.prompt</strong> を設定しておくと、すぐに分割表示されます。</p>

<pre><code>[difftool]
  prompt = false
</code></pre>

<p>はい。</p>

<h2 id="git-diff-と-git-difftool-の違いについて">git diff と git difftool の違いについて</h2>

<p>結局のところ何が違うのでしょう。 <code>git difftool</code> にはこんな説明文が書いてあります。</p>

<pre><code>DESCRIPTION
       git difftool is a Git command that allows you to compare and edit files between revisions using
       common diff tools. git difftool is a frontend to git diff and accepts the same options and
       arguments. See git-diff(1).
</code></pre>

<p>要するに、 <strong>git-difftool は（普段使っているような）共通の差分比較ツールを使って比較をするためのコマンド</strong> です。</p>

<p>つまり <strong>vimdiff のような比較表示をしたい場合は、本来こっちの git-difftool コマンドを使うべき</strong> であって、 git-diff を vimdiff に近づけるのは本来の用途とはちょっと違う、と言えるかもしれません。</p>

<p>ちなみに、今回は触れていませんが、 difftool に対して同様に <strong>git-mergetool</strong> というのもあります。ほぼ同じような感じなのであとはお調べください。</p>

<h2 id="git-diff-に対するカスタマイズ">git diff に対するカスタマイズ</h2>

<p>それが分かった上で、あえて git diff の挙動を変えることをしようとするならば、 <strong>diff.external</strong> というオプションがありますよ、というのが <strong>git-config</strong> に書いてあります。</p>

<pre><code>   diff.external
       If this config variable is set, diff generation is not performed using the internal diff
       machinery, but using the given command. Can be overridden with the `GIT_EXTERNAL_DIFF'
       environment variable. The command is called with parameters as described under &quot;git Diffs&quot;
       in git(1). Note: if you want to use an external diff program only on a subset of your
       files, you might want to use gitattributes(5) instead.
</code></pre>

<p>ここから先は
<a href="https://technotales.wordpress.com/2009/05/17/git-diff-with-vimdiff/" target="_blank">https://technotales.wordpress.com/2009/05/17/git-diff-with-vimdiff/</a>
に書いてある方が詳しいのですが、
<strong>vimdiff</strong> の入出力の関係上、シェルスクリプトを挟みつつ、 diff の際の pager をオフにしてやる必要があるようです。</p>

<h2 id="まとめ">まとめ</h2>

<p>一言でまとめると、</p>

<pre><code>[diff]
  tool = vimdiff
[difftool]
  prompt = false
</code></pre>

<p><strong>これらの設定は git-diff 用ではなく git-difftool 用です。</strong>
それぞれお間違えなく。</p>

<p>基本的にドキュメント読んだので一応自己解決した話なのですが、
ググって書いてあったからといって盲信するのはよくありません。
<strong>ちゃんとドキュメント読んで自分で検証しましょう。</strong></p>

<p>2016年もあとわずかですが、
来年も引き続きこういった勘違いとか混乱しやすい気づき系の記事を
不定期で細々と書いていって、
同じように困った人にとって助けになればと思います。</p>

<p>（もし解釈が間違ってるよ！ or 誤字脱字がー、などのツッコミなどあれば Twitter 経由などでいただけると幸いです）</p>

<p>では良いお年を。</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="https://git-scm.com/docs/git-config" target="_blank">https://git-scm.com/docs/git-config</a></li>
<li><a href="https://technotales.wordpress.com/2009/05/17/git-diff-with-vimdiff/" target="_blank">https://technotales.wordpress.com/2009/05/17/git-diff-with-vimdiff/</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2016年12月27日">2016年12月27日</time>

</p>

  <ul class="tags">

    <li class="flow"><a href="/tags/git/">Git</a></li>

  </ul>
</div>


</div>

<footer>

<h2>Tags</h2>

<ul class="tags">

  <li class="flow">
    <a href="/tags/ansible">Ansible (5)</a>
  </li>

  <li class="flow">
    <a href="/tags/apache">Apache (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/cli">CLI (7)</a>
  </li>

  <li class="flow">
    <a href="/tags/css">CSS (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/css3">CSS3 (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/cssfilter">CSSfilter (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/canvas">Canvas (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/chef">Chef (9)</a>
  </li>

  <li class="flow">
    <a href="/tags/crawler">Crawler (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/dom">DOM (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/docker">Docker (5)</a>
  </li>

  <li class="flow">
    <a href="/tags/ftp">FTP (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/font">Font (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/functionallanguage">FunctionalLanguage (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/glsl">GLSL (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/git">Git (3)</a>
  </li>

  <li class="flow">
    <a href="/tags/golang">Golang (3)</a>
  </li>

  <li class="flow">
    <a href="/tags/html">HTML (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/html5">HTML5 (7)</a>
  </li>

  <li class="flow">
    <a href="/tags/html5-outline">HTML5-outline (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/homebrew">Homebrew (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/hugo">Hugo (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/icon-font">Icon-Font (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/javascript">JavaScript (5)</a>
  </li>

  <li class="flow">
    <a href="/tags/linux">Linux (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/mvc">MVC (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/opengraph">OpenGraph (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/php">PHP (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/rdfa">RDFa (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/ssh">SSH (4)</a>
  </li>

  <li class="flow">
    <a href="/tags/svg">SVG (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/scala">Scala (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/shellscript">ShellScript (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/smartphone">Smartphone (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/static-site-generator">Static Site Generator (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/vagrant">Vagrant (15)</a>
  </li>

  <li class="flow">
    <a href="/tags/vim">Vim (3)</a>
  </li>

  <li class="flow">
    <a href="/tags/virtualbox">VirtualBox (3)</a>
  </li>

  <li class="flow">
    <a href="/tags/virtualization">Virtualization (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/webapp">WebApp (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/webaudioapi">WebAudioAPI (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/webfont">WebFont (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/webgl">WebGL (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/webrtc">WebRTC (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/webserver">WebServer (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/yeoman">Yeoman (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/zsh">Zsh (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/ajax">ajax (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/automation">automation (3)</a>
  </li>

  <li class="flow">
    <a href="/tags/bugs">bugs (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/event-conference">event-conference (5)</a>
  </li>

  <li class="flow">
    <a href="/tags/getusermedia">getUserMedia (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/gitconfig">gitconfig (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/ios">iOS (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/iterm">iTerm (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/jquery">jQuery (3)</a>
  </li>

  <li class="flow">
    <a href="/tags/jinja2">jinja2 (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/jq">jq (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/jsperf">jsperf (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/mediaquery">mediaQuery (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/namespace">namespace (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/oldie">oldIE (3)</a>
  </li>

  <li class="flow">
    <a href="/tags/output">output (3)</a>
  </li>

  <li class="flow">
    <a href="/tags/polyfills">polyfills (4)</a>
  </li>

  <li class="flow">
    <a href="/tags/preloader">preloader (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/rsync">rsync (1)</a>
  </li>

  <li class="flow">
    <a href="/tags/tmux">tmux (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/viewport">viewport (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/vimrc">vimrc (2)</a>
  </li>

  <li class="flow">
    <a href="/tags/virtualization">virtualization (6)</a>
  </li>

  <li class="flow">
    <a href="/tags/wget">wget (1)</a>
  </li>

</ul>

<h2>Categories</h2>

<ul>
  <li>
    <a href="/categories/tech/">Category / Tech</a>
  </li>
  <li>
    <a href="/categories/twentyfour/">Category / TwentyFour</a>
  </li>
</ul>

<h2>RSS</h2>

<ul>
  <li>
    <a href="/categories/tech/index.xml" target="_blank">RSS: Category / Tech</a>
  </li>
  <li>
    <a href="/index.xml" target="_blank">RSS: All articles</a>
  </li>
</ul>

<p>このブログは個人の見解であり、所属する組織の公式見解ではありません</p>
<p>&copy; ばうあーろぐ Generated by <a href="https://gohugo.io/" target="_blank">Hugo</a> / basic style by <a href="https://github.com/sindresorhus/github-markdown-css" target="_blank">github-markdown-css</a></p>

</footer>

</div>


<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36767095-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.6&appId=396423247105258";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


  </body>
</html>

