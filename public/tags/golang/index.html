<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/github-markdown.css" type="text/css" media="all">
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="all">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://girigiribauer.com/index.xml">
    <title>Golang - ばうあーろぐ</title>
    <meta property="og:title" content="Golang - ばうあーろぐ">
    <meta property="og:type" content="article">
    <meta name="description" content="Webテクノロジーに関するメモ、あるいはTwentyFour">
    <meta property="og:description" content="Webテクノロジーに関するメモ、あるいはTwentyFour">
    <meta property="og:url" content="http://girigiribauer.com/tags/golang/">
    <meta property="fb:app_id" content="396423247105258">
    <meta property="og:image" content="http://girigiribauer.com/img/ogimage.png">
<meta name="generator" content="Hugo 0.17" />
  </head>
  <body>

<div class="markdown-body">
<header>
<a href="/">ばうあーろぐ TOP へ戻る</a>
</header>


<div class="maincontents">

<h1>Tags / Golang</h1>

<div class="poststatus">
  <p>  <time datetime="2017年1月3日">2017年1月3日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/golang/">Golang</a></li>
    <li class="flow"><a href="/tags/cli/">CLI</a></li>
  </ul>
</div>




<p>あけましておめでとうございます。</p>

<p>書き初めとして書きました。</p>

<p>もともと1日かからない程度のものを書き初めとして書きたかったので、大きくずれはなかったです。</p>

<ul>
<li><a href="https://github.com/girigiribauer/go-pwgen" target="_blank">https://github.com/girigiribauer/go-pwgen</a></li>
</ul>

<h2 id="パスワード文字列を生成できるコマンドラインツール">パスワード文字列を生成できるコマンドラインツール</h2>

<p>まず先にやってないこととして、</p>

<ul>
<li><strong>パスワードの強度チェック</strong></li>
</ul>

<p>これを挙げておきます。</p>

<p>パスワード文字列を生成するにあたって、
当然セキュリティは一定担保する必要があったのですが、
かといってこの辺のパスワードの強度チェックをゼロから独自に研究するのは
無理がある＆仮に出来たとしても圧倒的に時間が足らないので、
外部のライブラリを利用しています。</p>

<p>パスワードの強度としては、例えば以下のようなケースが考えられます。</p>

<ul>
<li><strong>連続した同じ文字列</strong> （777 など）</li>
<li><strong>連続した順序を持った文字列</strong> （abc など）</li>
<li><strong>よくある英単語と一致する文字列</strong> や <strong>その逆順</strong></li>
<li><strong>キーボード上の順序を持った文字列</strong> （qwerty など）</li>
</ul>

<p>こういったチェックは学問、アルゴリズムの話になってきてしまい、個人では追いきれないため、
<strong>zxcvbn</strong> というライブラリを利用させてもらってます。</p>

<p><a href="https://github.com/dropbox/zxcvbn" target="_blank">https://github.com/dropbox/zxcvbn</a></p>

<p>提供しているのは Dropbox 社のようですが、 MIT ライセンスで誰でも利用できるようになっています。</p>

<p>実際のところ、上記の JavaScript 実装では新規アカウントを作るフォーム画面中において、
クライアントサイドでのパスワード強度チェックに用いられているようですね。</p>

<p>今回はそちらの Golang 実装を利用します。</p>

<p><a href="https://github.com/nbutton23/zxcvbn-go" target="_blank">https://github.com/nbutton23/zxcvbn-go</a></p>

<p>なお、ライブラリのページを見てもらえれば分かる話なのですが、
<strong>クラックされるまでのおおよその時間（crack_times_display）</strong>や
<strong>パスワード強度の5段階評価（score: 0 - 4）</strong> などの情報を利用することが出来ます。</p>

<p>アルゴリズムなどを追ってみるのも面白いかもしれませんね。</p>

<h3 id="今回の目的-目標">今回の目的、目標</h3>

<p>目的としてはこんな感じです。</p>

<ul>
<li>新年、ブログに目標書くくらいなら <strong>先に作るべき</strong></li>
<li><strong>Web 経由である必要がないもの</strong></li>
<li><strong>GUI である必要がないもの</strong></li>
</ul>

<p>1password を利用しているので、フォーム入力時には強度のあるパスワードが生成できるのですが、
そういった画面も何もないところでパスワードだけ生成したい場合に、
<strong>コマンドをちょっと入力するだけですぐ生成できると便利そう</strong> です。</p>

<p>その割には、毎回欲しいと思ったときに外部の Web サービスを利用しており、
ブックマークの整理をしている際に、
<strong>『これ Web じゃなくていいよなあ、 GUI じゃなくていいよなあ』</strong>
と思っていたところでした。</p>

<p>昨年の <a href="http://girigiribauer.com/archives/20161003/" target="_blank">Golang で DB が簡単に扱える自作コマンドを作ってみた</a>
で、Golang で自作コマンドはすでに作っていたので、
今回も同様に（素早く）作ってみようと思います。</p>

<h3 id="各種オプションと初期値">各種オプションと初期値</h3>

<p>基本的にマニュアル読めば全部書いてあるのですが、
パスワードの桁数は最低8文字ないと、パスワード強度のスコア的にセキュリティが確保できません。
（文字種が少ない、文字数が少ないなどのケースではスコアが 4 にならない）</p>

<p>逆に、桁数が多すぎたとしても今度は各種強度チェックに時間がかかってきてしまいます。</p>

<p>なので、 <strong>最小8文字、最大128文字、初期値を10文字</strong> とすることにしました。</p>

<p>また、文字種を以下のもので定義しました。</p>

<ul>
<li>数値（digit: 0-9）</li>
<li>アルファベット大文字（alphabetlarge: A-Z）</li>
<li>アルファベット小文字（alphabetsmall: a-z）</li>
<li>アンダースコア（underscore: _）</li>
<li>特殊記号（special characters: 制御文字など表示できない文字を除いたもの）</li>
</ul>

<p>よく使うのは数値、アルファベット大文字・小文字の文字種だと思うので、
これらをオプションなしで true になるように、
それ以外のものはオプション付きで明示することで true にできるようにしました。</p>

<p>表示個数ですが、個人的にはパッといくつか表示したうえで
最終的に自分で選んで利用したいので、
<strong>10個ほど初期で表示しつつ、個数の指定も上書きできるようにしました。</strong></p>

<p>あとこれ一番大事ですが、自分でキーボード打つのが面倒にならないようにするため、
コマンド名は一番分かりやすく <strong>pw</strong> で、
なおかつ <strong>オプションを一切何もつけない状態 = 一番自分の利用しやすい設定</strong>
となるようにオプションもろもろ考えました。</p>

<h2 id="作ってみた感想">作ってみた感想</h2>

<ul>
<li>package unicode の存在</li>
<li>ランダム性を含むユニットテストについて</li>
</ul>

<p>さっき気づいたのですが、
unicode というパッケージがあって ASCII 周りも定義されてるっぽいので
独自で定義せずにこの辺に乗っかっておくとひょっとすると楽出来たのでしょうか？
後で調べてみることにします。</p>

<p>あと、ランダムに生成する系のものって毎回テストのやり方に悩みますね・・・。</p>

<p>今回のケースだと、例えば実際にパスワード生成を行う関数とかがそうですかね。
文字数の長さと、構成文字以外の文字が入っていないかのチェックくらいですかねえ、うーん。</p>

<h2 id="まとめ">まとめ</h2>

<p>やろうと思ってから実際に出来るところまでが早い Golang は好きです。</p>

<p>やらなきゃと思ったことをすぐに行動に移せるようになりたいですね。
そういう意味でも、実際に書き初めする行動まで移せたことは幸先が良いと思います。
2017年頑張ります。</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="https://github.com/dropbox/zxcvbn" target="_blank">https://github.com/dropbox/zxcvbn</a></li>
<li><a href="https://nulab-inc.com/ja/blog/nulab/password-strength/" target="_blank">https://nulab-inc.com/ja/blog/nulab/password-strength/</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2017年1月3日">2017年1月3日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/golang/">Golang</a></li>
    <li class="flow"><a href="/tags/cli/">CLI</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2016年10月4日">2016年10月4日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/golang/">Golang</a></li>
    <li class="flow"><a href="/tags/homebrew/">Homebrew</a></li>
    <li class="flow"><a href="/tags/cli/">CLI</a></li>
  </ul>
</div>




<p>超楽だったのでメモっておきます。</p>

<p>こちらにドキュメントあります。（Golang のバイナリの場合ではないので少し異なりますが）</p>

<p><a href="https://github.com/Homebrew/brew/blob/master/docs/Formula-Cookbook.md" target="_blank">https://github.com/Homebrew/brew/blob/master/docs/Formula-Cookbook.md</a></p>

<h2 id="homebrew-対応">Homebrew 対応</h2>

<p>自作コマンド <a href="https://github.com/girigiribauer/db-cli" target="_blank">https://github.com/girigiribauer/db-cli</a> を公開している時に
リリースバイナリまで GitHub に登録できて一息つけたーというタイミングで、
ふと <code>brew install db-cli</code> でインストールできたらいいなあと思ったので
調べてやってみたらさくっと1時間もかからずいけました。</p>

<p>自作コマンド用のリポジトリとは別に、</p>

<p><a href="https://github.com/girigiribauer/homebrew-db-cli" target="_blank">https://github.com/girigiribauer/homebrew-db-cli</a></p>

<p>という &ldquo;homebrew-&rdquo; プレフィックス付きの名前の Homebrew 用のリポジトリを用意し、Ruby ファイルを追加します。</p>

<p><code>brew create</code> コマンドでいけるようですが、
シンプルなので自分で用意しています。</p>

<pre><code>require 'formula'

REPOSITORY_URL='https://github.com/girigiribauer/db-cli'
HOMEBREW_DBCLI_VERSION='0.1.24'

class DbCli &lt; Formula
  desc '`db` command line tools (Docker based)'
  homepage REPOSITORY_URL
  url &quot;#{REPOSITORY_URL}/releases/download/v#{HOMEBREW_DBCLI_VERSION}/db-darwin-amd64.tar.gz&quot;, :tag =&gt; &quot;v#{HOMEBREW_DBCLI_VERSION}&quot;
  sha256 '6bfc2486db1b17ab93d3b3783f5981b3676299319ff9208efd599a4843599a06'
  head REPOSITORY_URL, :branch =&gt; 'master'
  version HOMEBREW_DBCLI_VERSION

  def install
    bin.install 'db'
  end
end
</code></pre>

<p>Formula クラスの継承をしたうえで、各種ローカル変数を定義します。
下に書いてあるのですが、db-cli という名前なのでクラス名は DbCli で自動で決まるみたいですね。
最初は &ldquo;DBCli&rdquo; と書いていました・・・。</p>

<p>install メソッドを定義し、
場合によっては Ruby の外部コマンド実行ができる system コマンドで
実際にインストールに必要なコマンド類を入力してやる必要があるみたいなのですが、
<strong>今回の場合は配布想定のバイナリファイルを配置するだけで Golang 環境は不要なので、
bin.install で指定するだけで問題無い</strong> ようです。</p>

<p>これも Golang の強みの1つですね。
ビルド後のバイナリファイルは、Golang 環境がなくとも（go コマンドがインストールされてなくとも）
普通に動作するので、事前に動作環境をあれこれ入れる必要がないです。</p>

<p>ちなみに bin.install で指定するだけで勝手に圧縮ファイルを展開、配置までしてくれるようですね。</p>

<p>push できたら試しに <code>brew tap</code> してみます。</p>

<pre><code>$ brew tap girigiribauer/db-cli
</code></pre>

<p>どうやら Homebrew 1.0 あたりで auto update が自動で行われるようになったようです。
なのでアップデート待ちです。</p>

<pre><code>==&gt; Tapping girigiribauer/db-cli
Cloning into '/usr/local/Homebrew/Library/Taps/girigiribauer/homebrew-db-cli'...
remote: Counting objects: 4, done.
remote: Compressing objects: 100% (3/3), done.
remote: Total 4 (delta 0), reused 3 (delta 0), pack-reused 0
Unpacking objects: 100% (4/4), done.
Checking connectivity... done.
Error: Invalid formula: /usr/local/Homebrew/Library/Taps/girigiribauer/homebrew-db-cli/db-cli.rb
No available formula with the name &quot;db-cli&quot;
In formula file: /usr/local/Homebrew/Library/Taps/girigiribauer/homebrew-db-cli/db-cli.rb
Expected to find class DbCli, but only found: DBCli.
Error: Cannot tap girigiribauer/db-cli: invalid syntax in tap!
</code></pre>

<p>あっその名前ダメですか・・・。
Golang だと逆に Db は DB にしろって言われるんですけどね・・・。
Ruby に素直に従っておきます。</p>

<p>ということで素直に DbCli に変更して再度トライ。</p>

<pre><code>$ brew tap girigiribauer/db-cli
==&gt; Tapping girigiribauer/db-cli
Cloning into '/usr/local/Homebrew/Library/Taps/girigiribauer/homebrew-db-cli'...
remote: Counting objects: 4, done.
remote: Compressing objects: 100% (3/3), done.
remote: Total 4 (delta 0), reused 2 (delta 0), pack-reused 0
Unpacking objects: 100% (4/4), done.
Checking connectivity... done.
Tapped 1 formula (27 files, 20.3K)

$ brew install db-cli
==&gt; Installing db-cli from girigiribauer/db-cli
==&gt; Downloading https://github.com/girigiribauer/db-cli/releases/download/v0.1.24/db-darwin-amd64.tar.gz
==&gt; Downloading from https://github-cloud.s3.amazonaws.com/releases/69738247/d805382a-8822-11e6-89f4-aff058332cdf.g
######################################################################## 100.0%
🍺  /usr/local/Cellar/db-cli/0.1.24: 3 files, 8.6M, built in 9 seconds
</code></pre>

<p>ひゃっほーい🍺
オレオレ自作コマンドがとうとう Homebrew 経由で自分の元に。</p>

<h2 id="まとめ">まとめ</h2>

<p>バイナリ配置するだけなんで、
Homebrew の install メソッド内部でやってることもすごくシンプルですね。</p>

<p>namespace 的には既存の Homebrew には影響しないので、
今回のように超短いコマンド名で公開しても全く影響ありません。
（全くではないですね、インストール時に名前がかぶる可能性はあるので、その場合は別途リポジトリ指定する必要があるかもです）</p>

<p><img src="/img/2016/10/firsttime-homebrew01.jpg" alt="" /></p>

<p>全然関係ないけど、Homebrew の命名センスは結構好きですね。
ビールの自家醸造に例えて色々コマンド名が決まってて素敵だなあと思います。</p>

<p>僕ももうちょっとセンスのある命名を考えていければなと思います。
（末尾に24とかつけてる場合じゃない）</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="https://github.com/Homebrew/brew/blob/master/docs/Formula-Cookbook.md" target="_blank">https://github.com/Homebrew/brew/blob/master/docs/Formula-Cookbook.md</a></li>
<li><a href="http://dev.classmethod.jp/tool/new-formula-request-to-homebrew/" target="_blank">http://dev.classmethod.jp/tool/new-formula-request-to-homebrew/</a></li>
<li><a href="http://blog.monochromegane.com/blog/2014/05/19/homebrew-formula-for-golang/" target="_blank">http://blog.monochromegane.com/blog/2014/05/19/homebrew-formula-for-golang/</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2016年10月4日">2016年10月4日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/golang/">Golang</a></li>
    <li class="flow"><a href="/tags/homebrew/">Homebrew</a></li>
    <li class="flow"><a href="/tags/cli/">CLI</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2016年10月3日">2016年10月3日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/golang/">Golang</a></li>
    <li class="flow"><a href="/tags/docker/">Docker</a></li>
    <li class="flow"><a href="/tags/cli/">CLI</a></li>
  </ul>
</div>




<p>※どうでもいいけど、9月のブログ記事数が急に増えだしてます。
Hugo 化がここにきてすごく効いてきてますね。</p>

<p>この前 <strong>&ldquo;db-cli&rdquo;</strong> という自作コマンドをリリースしてみました。
コマンド名自体は <code>db</code> です。超短いので何かにかぶってたらゴメンナサイ。</p>

<p><a href="https://github.com/girigiribauer/db-cli" target="_blank">https://github.com/girigiribauer/db-cli</a></p>

<h2 id="経緯">経緯</h2>

<p>何かプログラムなどを書いていて、
試しに MySQL(MariaDB) でもちょこっと立てて検証したいなあ、
みたいなことはたまにあると思います。</p>

<p>最近になって、ローカルにそういったデータベースをインストールせずに
Docker を利用するという選択肢も出てきたのですが、
まだちょっととっつきにくいというか、
<strong>長ったらしいコマンドをずらずらと並べて
コンテナを立てることになる</strong> ので、
結構面倒臭かったりします。</p>

<p>まだコマンドラインのヒストリーから Ctrl+R とかで探していればまだマシなのですが、
とても毎回ゼロから入力する気にはなれません。</p>

<p><strong>「僕は DB をちょこっと使いたいだけなんだよ！」</strong> というところから、
じゃあ試しに <strong>db って打ったら DB コンテナが立ち上がるようなコマンドでも作ってみるかー</strong> と思ったのがきっかけです。</p>

<h2 id="コンセプト">コンセプト</h2>

<ul>
<li><strong>by Golang</strong></li>
<li><strong>ストローク数は超短く。 D! B! Enter!</strong> で終わりにしたい。</li>
<li>僕はほとんど使わないが、必要に応じて <strong>オプションで上書き</strong> 可能。</li>
<li>Docker で名前つけるのすらだるい、 <strong>勝手につけてほしい。</strong></li>
<li>dump, restore も可能な限り楽にやりたい。</li>
</ul>

<p>こんな感じで、後はオプション指定で別のデータベースとか指定できたらいいなあとか、
配布もさくっとできたらいいなあとか、
（僕は使わないけど）Windows とかでも使えたらいいなあとか、
他にも様々ありますが、必要な項目としては上の4つです。</p>

<p>するともう自然とコマンド名は <code>db</code> に決まり、
コマンドラインを作るのに今適してそうな Golang で書くのに決めました。
（というか先に Golang で書くことだけは決まっていた気がする）</p>

<h2 id="インストール">インストール</h2>

<p><strong>先にDocker あるいは Docker for Mac/Windows を入れましょう。</strong></p>

<p>その後 MacOS であれば</p>

<pre><code>$ brew tap girigiribauer/db-cli

$ brew install db-cli
</code></pre>

<p>でインストールできます。
（Homebrew 対応の話はまた別にメモっておきます）</p>

<p>バイナリファイルが直接欲しい人は
<a href="https://github.com/girigiribauer/db-cli/releases" target="_blank">https://github.com/girigiribauer/db-cli/releases</a> にあります。</p>

<h2 id="使い方">使い方</h2>

<p>基本的にヘルプに全部書いてありますのでお読みください。</p>

<p>以下は <a href="https://github.com/girigiribauer/db-cli" target="_blank">https://github.com/girigiribauer/db-cli</a> と同じ内容です。</p>

<h3 id="データベース作る">データベース作る</h3>

<pre><code>$ db
</code></pre>

<p>これだけで DB が立ち上がった状態になります。
MariaDB をイメージとした &ldquo;db0&rdquo; という名前のコンテナが起動状態になっていて、
通常利用するであろう 3306 ポートが空いていれば、その番号がそのままポートフォワーディングされます。</p>

<p>試しにもう1回 <code>db</code> と打てばわかりますが、名前が空いていなければ &ldquo;db1&rdquo;, &ldquo;db2&rdquo; と繰り上がり、
3306 ポートが空いていなければ自動で割り当てられます。</p>

<p>なので、 <strong>1つだけ使って消す、使って消す、みたいな使い方をしていれば、
名前は必ず &ldquo;db0&rdquo; になり、ポートは 3306 になります。</strong>
（実際僕の利用用途の9割くらいはこれで満たされてます）</p>

<p>データベース名は何もつけなければ &ldquo;db&rdquo; です。
ユーザー名もパスワードも初期値 &ldquo;db&rdquo; です。</p>

<h3 id="データベース消す">データベース消す</h3>

<pre><code>$ db -d
</code></pre>

<p><strong>消すのも合計6ストロークです。</strong> けっこう短くないですか？</p>

<p>これも上と同様で、&rdquo;db0&rdquo; があればそれが消えます。なければ &ldquo;db1&rdquo;, &ldquo;db2&rdquo; を探しにいきます。</p>

<h3 id="その他">その他</h3>

<p>オプション以外の設定項目も、一通り <strong>環境変数で上書きできるようになっています。</strong></p>

<p>例えば .bashrc などに</p>

<pre><code>DBCLI_CONTAINER_PREFIX=go
</code></pre>

<p>などと書いておけば、勝手に go0, go1 &hellip; という名前のコンテナが立ち上がります。</p>

<p>dump, restore もできるので、 <a href="https://github.com/girigiribauer/db-cli" target="_blank">https://github.com/girigiribauer/db-cli</a> をお読みください。</p>

<h2 id="まだ微妙なところ">まだ微妙なところ</h2>

<p>TODO というわけではないのですが、うーん・・・と思ってるところが若干あります。
ただ自分用のコマンドを単に見えるようにしただけなので、
正直対応するかどうかは微妙です。</p>

<ul>
<li>Docker コンテナのヘルスチェック</li>
<li>test</li>
<li>PostgreSQL 対応</li>
</ul>

<h3 id="docker-コンテナのヘルスチェック">Docker コンテナのヘルスチェック</h3>

<p>正直なところ、Docker 1.12 あたりで導入された、
コンテナのヘルスチェック周りの知見がちょっと足らないかもです・・・。</p>

<p>この辺いじりだしたのは restore オプションの導入あたりからなのですが、
<code>db</code>, <code>db -d</code> コマンドだけ使っていれば、
ヘルスチェックなどはそもそも不要でした。（create -&gt; start するだけで問題ない）</p>

<p>restore オプションを実装するには、
コンテナを作るときにボリュームをマウントするなどの必要があったのですが、
あまり複雑なことをやりたくなかったので、
データベースが完全に用意できてから dump と同じ要領で <strong>外部からのコマンドを流し込む方法</strong> をとりました。</p>

<p>なお、今回は <strong>ボリュームのマウント機能は一切利用せずにコマンド作ってます。</strong>
ボリュームのマウントまで考慮に入れてしまうと、
じゃあローカルのどのディレクトリをマウント設定するんだとか、
そのオプションがなかった場合にどのような挙動になるんだとか、
色々（オペレーション的に）複雑になりすぎる気がしてたので
ボリュームを一切使わない方法はないか検討しました。</p>

<p>で、この <strong>データベースが完全に用意できてから</strong> というのが曲者で、
MariaDB が使えるようになるまで待機するのがどこまでなのかが未だによくわかっておりません・・・。</p>

<p><strong>mysqladmin の ping が通り始めるタイミング</strong> なのか、
あるいは <strong>&rdquo;/var/run/mysqld/mysqld.sock&rdquo; のファイルができるタイミング</strong> なのか、
いずれにしてもタイミングによって restore ができるときとできないときが出てきてしまうので、
5秒程度余分に待つといったダサい策をとってます。ぐぬぬ。</p>

<p>なのでもうちょっと Docker のヘルスチェックというか、
Docker を利用した MariaDB の起動の仕組みについてもう一段掘り下げてきちんと調べる必要がありそうですが、
正直そこまでコストかけるかどうか微妙なところです。</p>

<h3 id="test">test</h3>

<p>今回は API を叩くのがほとんどで、大きく DockerClient の状態に依存するので、
正直なところあまり頑張らずに DockerClient のエラーなどをそのまま垂れ流してもいいかなと思い、
あまり力を入れてません。</p>

<p>最初はイメージダウンロードしてコンテナ作った状態を再現してから、ってやってたんですが、
僕のストレスが増加しそうだったのでやめました。</p>

<h3 id="postgresql-対応">PostgreSQL 対応</h3>

<p>めんどかったので入れませんでした。
気が向いたら入れるかも。</p>

<p>一応ある程度楽には入れられるような作りにはなってます。</p>

<p>ただこれもヘルスチェックどうするんだ的な話が絡んでくるので、
気が向いたとしてもすぐ飽きるかもしれません。</p>

<h2 id="逆に思ったよりもよくできたところ-割り切ったところ">逆に思ったよりもよくできたところ、割り切ったところ</h2>

<ul>
<li>マルチプラットフォーム対応</li>
<li>そもそもの利用用途</li>
</ul>

<h3 id="マルチプラットフォーム対応">マルチプラットフォーム対応</h3>

<p>Golang のマルチプラットフォーム対応、なめてました。</p>

<pre><code>GOOS=windows GOARCH=amd64 go build -o build/windows-amd64/db.exe cmd/db/*.go
</code></pre>

<p><code>go build</code> コマンドの前に <code>GOOS</code> と <code>GOARCH</code> 環境変数をセットしてやるだけで
<strong>本当に Windows 用のバイナリが出来てしまいました。</strong></p>

<p>僕が使うわけではないので、あわよくば Windows 対応もできればいいなあくらいに思っていたのですが、
<strong>正直そんな手間もかからず（ゼロではないですが）対応できた</strong> のはありがたかったです。Golang マジすげえな。</p>

<p>ちょっと違うところといえば、
裏側で Docker Remote API を用いているのですが、
DockerClient のエンドポイントが Linux, MacOS は UNIX ドメインソケットなのに対して、
Windows では名前付きパイプ（npipe?）なんですよね。</p>

<p>ただこれも、大元のライブラリが普通に対応していて
パスの違いを吸収する程度の手間だったので
「まあこれくらいなら・・・」と思わせてくれるのは良いですね。</p>

<p>ちなみにこの DockerClient ライブラリに大きくお世話になりました。</p>

<p><a href="https://github.com/fsouza/go-dockerclient" target="_blank">https://github.com/fsouza/go-dockerclient</a></p>

<p><code>docker</code> コマンドで一通りできることは問題無くできると思います。</p>

<h3 id="そもそもの利用用途">そもそもの利用用途</h3>

<p>あまり大事にしたくなかったというか、試しに構築してみたいくらいの温度感だったので、
<strong>僕が使うプラスアルファの対応に留めたい</strong> と最初から思っていました。</p>

<p>なので、そもそも開発用としてローカルで使うもの前提だし、
レプリケーションやら dump 時のテーブルロックの話などはばっさり切り捨てています。</p>

<h2 id="まとめ">まとめ</h2>

<p>自分でコマンドを作ることは無くは無かったのですが、
表に出すところまではやったことがなかったので良い経験になりました。
Homebrew 対応についてはまた改めてメモっておきます。</p>

<p>Golang はクロスプラットフォームな CLI を作るのに適していると思います。</p>

<p>最後の方はみんなのGo言語も読みつつ進めていましたが、
ちょうど今回に合った話もちらほらあって読んでてとてもためになりました。</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="https://godoc.org/github.com/fsouza/go-dockerclient" target="_blank">https://godoc.org/github.com/fsouza/go-dockerclient</a></li>
<li><a href="http://dev.classmethod.jp/cloud/aws/docker-healthcheck/" target="_blank">http://dev.classmethod.jp/cloud/aws/docker-healthcheck/</a></li>
<li><a href="https://suin.io/538" target="_blank">https://suin.io/538</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2016年10月3日">2016年10月3日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/golang/">Golang</a></li>
    <li class="flow"><a href="/tags/docker/">Docker</a></li>
    <li class="flow"><a href="/tags/cli/">CLI</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>







</div>

<footer>

<h2>Tags</h2>

<ul class="tags">
  <li class="flow">
    <a href="/tags/ansible">Ansible (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/apache">Apache (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/cli">CLI (10)</a>
  </li>
  <li class="flow">
    <a href="/tags/css">CSS (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/css3">CSS3 (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/cssfilter">CSSfilter (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/canvas">Canvas (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/chef">Chef (9)</a>
  </li>
  <li class="flow">
    <a href="/tags/crawler">Crawler (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/dom">DOM (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/docker">Docker (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/ftp">FTP (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/font">Font (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/functionallanguage">FunctionalLanguage (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/glsl">GLSL (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/git">Git (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/golang">Golang (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/html">HTML (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/html5">HTML5 (7)</a>
  </li>
  <li class="flow">
    <a href="/tags/html5-outline">HTML5-outline (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/homebrew">Homebrew (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/hugo">Hugo (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/icon-font">Icon-Font (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/javascript">JavaScript (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/linux">Linux (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/mvc">MVC (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/opengraph">OpenGraph (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/php">PHP (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/rdfa">RDFa (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ssh">SSH (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/svg">SVG (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/scala">Scala (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/shellscript">ShellScript (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/smartphone">Smartphone (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/static-site-generator">Static Site Generator (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/vagrant">Vagrant (15)</a>
  </li>
  <li class="flow">
    <a href="/tags/vim">Vim (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualbox">VirtualBox (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualization">Virtualization (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webapp">WebApp (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webaudioapi">WebAudioAPI (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webfont">WebFont (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webgl">WebGL (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webrtc">WebRTC (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webserver">WebServer (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/yeoman">Yeoman (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/zsh">Zsh (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/ajax">ajax (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/automation">automation (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/bugs">bugs (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/event-conference">event-conference (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/getusermedia">getUserMedia (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/gitconfig">gitconfig (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ios">iOS (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/iterm">iTerm (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jquery">jQuery (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/jinja2">jinja2 (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jq">jq (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jsperf">jsperf (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/lint">lint (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/mediaquery">mediaQuery (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/namespace">namespace (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/oldie">oldIE (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/output">output (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/polyfills">polyfills (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/preloader">preloader (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/rsync">rsync (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/tmux">tmux (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/viewport">viewport (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/vimrc">vimrc (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualization">virtualization (6)</a>
  </li>
  <li class="flow">
    <a href="/tags/wget">wget (1)</a>
  </li>
</ul>

<h2>Categories</h2>

<ul>
  <li>
    <a href="/categories/tech/">Category / Tech</a>
  </li>
  <li>
    <a href="/categories/twentyfour/">Category / TwentyFour</a>
  </li>
</ul>

<h2>RSS</h2>

<ul>
  <li>
    <a href="/categories/tech/index.xml" target="_blank">RSS: Category / Tech</a>
  </li>
  <li>
    <a href="/index.xml" target="_blank">RSS: All articles</a>
  </li>
</ul>

<p>このブログは個人の見解であり、所属する組織の公式見解ではありません</p>
<p>&copy; ばうあーろぐ Generated by <a href="https://gohugo.io/" target="_blank">Hugo</a> and <a href="https://github.com/sindresorhus/github-markdown-css" target="_blank">github-markdown-css</a></p>

</footer>

</div>


<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36767095-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>



  </body>
</html>


