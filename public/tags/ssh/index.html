<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/github-markdown.css" type="text/css" media="all">
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="all">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://girigiribauer.com/index.xml">
    <title>SSH - ばうあーろぐ</title>
    <meta property="og:title" content="SSH - ばうあーろぐ">
    <meta property="og:type" content="article">
    <meta name="description" content="Webテクノロジーに関するメモ、あるいはTwentyFour">
    <meta property="og:description" content="Webテクノロジーに関するメモ、あるいはTwentyFour">
    <meta property="og:url" content="http://girigiribauer.com/tags/ssh/">
    <meta property="fb:app_id" content="396423247105258">
    <meta property="og:image" content="http://girigiribauer.com/img/ogimage.png">
<meta name="generator" content="Hugo 0.17" />
  </head>
  <body>

<div class="markdown-body">
<header>
<a href="/">ばうあーろぐ TOP へ戻る</a>
</header>


<div class="maincontents">

<h1>Tags / SSH</h1>

<div class="poststatus">
  <p>  <time datetime="2015年4月1日">2015年4月1日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>




<p>2013年に書いていた、『Vagrant で SSH の接続ポート番号を変えると、けっこう複雑になるという話』（<a href="http://girigiribauer.com/archives/1127/" target="_blank">http://girigiribauer.com/archives/1127/</a>）という記事の続きです。</p>

<p>2013年の段階では、まだまだ考え方みたいなものがまとまりきっておらず、Vagrant が用いる接続ポート番号を変えるという方向で色々考えていたのですが、今振り返ってみるとそもそも根本の考え方を見直すべきでした。</p>

<hr />

<h2 id="vagrant-の使いどころ-考えどころ">Vagrant の使いどころ・考えどころ</h2>

<p>ざっと『Vagrant の使いどころ・考えどころ』（<a href="http://girigiribauer.com/archives/1729/" target="_blank">http://girigiribauer.com/archives/1729/</a>）に書いたのですが、Vagrant を用いる用途としては大きく2種類あると考えています。</p>

<ol>
<li><strong>ローカルの開発用</strong>としてローカルでのみ使い続ける</li>
<li><strong>本番環境の検証用</strong>として、同じレシピを仮想マシン・リモート環境にそれぞれ適用</li>
</ol>

<p>SSH の接続ポート番号を変えるという大きな理由は<strong>セキュリティ</strong>にあると思います。 デフォルトの22番ポートで使っていると外部からのアタックに弱いため、ポート番号を変えたい、そのためのレシピを書きたい、という点が根本にあると思います。</p>

<p>つまり、2.の<strong>『本番環境の検証用として、同じレシピを仮想マシン・リモート環境にそれぞれ適用』</strong>ってのがやりたいわけです。</p>

<p>もし1.が目的だったのなら、わざわざポート番号を変える必要はありません。<a href="http://girigiribauer.com/archives/1127/" target="_blank">Vagrant で SSH の接続ポート番号を変えると、けっこう複雑になるという話</a> にもあるように、ホスト OS が 2424 番、ゲスト OS が 22 番で接続している最中に、<strong>ゲスト OS を 22 番をレシピで別ポートに変更してしまうと接続が切れてしまいます。ローカルで動作しているのならわざわざ変える必要はありません。</strong>何が面倒なのかは、詳しくはそちらの記事をご覧ください。</p>

<h2 id="同じレシピをローカル-リモートに適用する">同じレシピをローカル、リモートに適用する</h2>

<p>本番環境の検証用として利用したいという用途で、 同じレシピをローカル、リモートの両方に適用したいということであれば、<strong>json ファイルに設定をくくり出してやれば OK</strong> です。</p>

<p>ローカルは Vagrant で動いていますが、リモートはそうではないので、両方で同じレシピ適用方法が可能な <strong>knife コマンド</strong>を使いましょうー。</p>

<h3 id="ローカル">ローカル</h3>

<p>以下は実際にそのまま使っているわけではないですが、<code>nodes/localhost.json</code> として Vagrant で動作しているローカル VM にレシピを適用するための設定ファイル（の一例）です</p>

<pre><code>{
  &quot;name&quot;: &quot;localhost&quot;,
  &quot;automatic&quot;: {
    &quot;ipaddress&quot;: &quot;192.168.24.24&quot;
  },

  &quot;fqdn&quot;: &quot;localhost&quot;,
  &quot;platform_family&quot;: &quot;rhel&quot;,
  &quot;platform&quot;: &quot;centos&quot;,
  &quot;platform_version&quot;: &quot;6.6&quot;,

  &quot;run_list&quot;: [
    &quot;recipe[openssh]&quot;
  ],

  &quot;openssh&quot;: {
    &quot;server&quot;: {
      &quot;port&quot;: 22,
      &quot;password_authentication&quot;: &quot;no&quot;
    }
  }
}
</code></pre>

<p>あとは knife コマンドにて、</p>

<pre><code>knife solo bootstrap localhost
</code></pre>

<p>あるいは</p>

<pre><code>knife solo prepare localhost
knife solo cook localhost
</code></pre>

<p>でレシピを適用してやるだけです。</p>

<p>Vagrant 上で openssh のレシピを適用するのですが、<strong>ポート番号は 22 から 22 に変える、みたいなレシピにしておく</strong>と良いです。変更後のポート番号を設定値としてくくり出しておきます。</p>

<p>あっ、Berkshelf の説明とか platform, platform_family とかの項目の説明は端折ってますが、また別記事にでも書いておきます。。。</p>

<h3 id="リモート">リモート</h3>

<p>同様に、リモートマシン（nodes/production.json）に対しては、</p>

<pre><code>{
  &quot;name&quot;: &quot;production&quot;,
  &quot;automatic&quot;: {
    &quot;ipaddress&quot;: &quot;123.456.789.012&quot;
  },

  &quot;fqdn&quot;: &quot;example.com&quot;,
  &quot;platform_family&quot;: &quot;rhel&quot;,
  &quot;platform&quot;: &quot;centos&quot;,
  &quot;platform_version&quot;: &quot;6.6&quot;,

  &quot;run_list&quot;: [
    &quot;recipe[openssh]&quot;
  ],

  &quot;openssh&quot;: {
    &quot;server&quot;: {
      &quot;port&quot;: 12345,
      &quot;password_authentication&quot;: &quot;no&quot;
    }
  }
}
</code></pre>

<p>同様にポート番号をくくり出しておき、それを利用してレシピを適用することで、 リモートのサーバの SSH のポート番号を変更することが可能です。</p>

<p>で、ちょっと気をつけないといけないのが、 <strong>初回のレシピ適用時と、2回目以降のレシピ適用時のポート番号が異なる点</strong>です。</p>

<p>僕は以下のように、初回のみオプションで上書きしています。</p>

<pre><code>knife solo bootstrap production -p 22 -x root
</code></pre>

<p><code>knife solo prepare --help</code> には以下のようなオプションがあり、</p>

<pre><code>-p, --ssh-port PORT              The ssh port
-x, --ssh-user USERNAME          The ssh username
</code></pre>

<p>これを利用して、初回のみポート番号を 22 で、かつ root ユーザーにてレシピ適用します。 （この段階ではもちろんパスワード認証なので、何回かパスワードの入力を求められます。）</p>

<h3 id="リモートにレシピを適用するときの注意点">リモートにレシピを適用するときの注意点</h3>

<p>それ以外にも、自分がはまったなーというものをメモっておきます。</p>

<p>初回アクセス時に <code>~/.ssh/known_hosts</code> に接続情報が保持されます。</p>

<p>「あー、ぐちゃぐちゃしてきたから、一旦リセットして最初からレシピを適用し直したいなー」というときに、 上記ファイルに残っている情報をクリアしておかないと接続ができないケースがあるようです。</p>

<p>また、さくらVPS のサービスを利用しているのですが、OS のインストールをし直した際は、少し時間を置いてからでないとうまく適用できません。焦らずコーヒーでも飲みましょう。</p>

<h2 id="まとめ">まとめ</h2>

<ul>
<li>Vagrant を用いる際の目的をはっきりさせる</li>
<li>サーバの設定値をくくり出す</li>
</ul>

<p>なお、本当にどうでもいい話ですが、ドラマ TwentyFour では、テロリストや CTU 職員が IP アドレスを指定するときに、262.xxx.xxx.xxx のような、実際には存在しない 255 を超えた数値をドラマ内で言ったりします。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2015年4月1日">2015年4月1日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2015年3月3日">2015年3月3日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>




<p>Vagrant, Chef 周りの知見が溜まってきたのでそろそろまとめていきたいと思っているのですが、 まだまだ自分の中で分からない部分も多く、 かつ自分はインフラエンジニアではないので、 正直どこまで書いたらいいのか迷っています。</p>

<p>また、chef-solo はなくなるから、これからは chef-zero だ、なんて言われても、 インフラに関する前提知識が薄いので、なかなかついていくことができません・・・。</p>

<p>とはいえ、少なくとも使っていく中で<strong>自分なりの思想</strong>みたいなものははっきりしてきたので、 まずはそこから書いてみようと思います。</p>

<h2 id="vagrant-の用途を考える">Vagrant の用途を考える</h2>

<p>Vagrant が何なのかを知らない人に説明するとすれば、 <strong>仮想マシン（VM）をコマンドラインで統一的に扱えるインターフェース</strong>のようなものだと説明できると思います。</p>

<p>決して仮想環境そのものではなく、仮想環境を提供してくれるものと<strong>セットで</strong>使います。 例えば VirtualBox や VMWare 、あるいはリモートですが AWS(Amazon Web Service) なんかも選択肢になり得ます。</p>

<p>詳しくは <a href="https://www.vagrantup.com/" target="_blank">https://www.vagrantup.com/</a> からインストール手順などを参考にして、実際に試されると良いかと思います。 （今回はこの辺り、一切触れません）</p>

<p>Vagrant をどういう用途で使うかというと、おそらく大きく2種類に分かれると思います。（主観）</p>

<ol>
<li><strong>ローカルの開発用</strong>としてローカルでのみ使い続ける</li>
<li><strong>本番環境の検証用</strong>として、同じレシピを仮想マシン・リモート環境にそれぞれ適用</li>
</ol>

<p>1.は<strong>開発寄り</strong>の人が一番思いつきやすい用途だと思います。 全く同一でもない限り、ローカルで開発したものをリモート環境へ持っていくと、 少なからず環境による差異が問題になってきます。</p>

<p>2.は、<strong>運用寄り</strong>（インフラ寄り？）の人が一番思いつきやすい用途だと思います。 いくら Chef が便利だからといっても、本番環境にトライアンドエラーでレシピ適用して 問題がないケースはほとんどないと言っていいと思います。 この場合、手元の仮想マシンに対してレシピを適用して検証、問題なければ本番マシンに対して適用、 という流れが良いのではないかと考えています。</p>

<h2 id="僕なりの-vagrant-chef-の使い方">僕なりの Vagrant, Chef の使い方</h2>

<p>ここからはポイントに絞ってまとめていきます。</p>

<h3 id="開発と運用とで-vagrantfile-を分けた">開発と運用とで Vagrantfile を分けた</h3>

<p>上記の用途の違いから、もし両方の用途が想定される場合は、 そもそも <strong>Vagrantfile を複数ディレクトリで分けて管理</strong>するとすっきりします。</p>

<p>Vagrantfile 上には、複数の仮想マシンの定義が記述できるため、 まとめて書こうと思えば全然書けてしまうのですが、 目的が全然異なっているので、<strong>使うレシピも共通化しない</strong>ケースが多くなってくると思います。 （例えば開発用であれば、本番環境ほどセキュリティに過敏にならなくても良い場合があります）</p>

<p>Vagrantfile と同階層に cookbooks, site-cookbooks といった 適用するレシピのディレクトリを作って管理していますが、 レシピを共通化しないのであれば、あえて混ぜる理由もありません。</p>

<h3 id="ポート番号-ip-アドレスの管理をしっかり行う">ポート番号、IP アドレスの管理をしっかり行う</h3>

<p>Vagrantfile が複数存在していると、今度は <strong>SSH で接続するためのポート番号や、 VM にアクセスするための IP アドレスが重複してくる可能性</strong>がどんどん高くなります。</p>

<p>開発想定の VM は何番から何番のポートを順に使い、IP アドレスはここから順に割り当てる、 運用想定の VM はこの番号から順に使う、といったように、 ポート番号、IP アドレスの管理をしっかり行うのが重要だと思います。</p>

<p>.ssh/config に、しっかり名前付きで記述しておき、 どの VM にもすぐにアクセスできるようにしておくと気持ちいいです。</p>

<pre><code>Host virtual_machine_name
  HostName 127.0.0.1
  User vagrant
  Port 12345
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /path/to/insecure_private_key
  IdentitiesOnly yes
  LogLevel FATAL
</code></pre>

<p>認証鍵のレシピがうまく適用できるようになったら、 この辺りの設定も、その認証鍵設定済みのユーザーで気軽にアクセスできるようになっていると なお気持ちいいです。 （この辺りの話はまた改めてまとめ直したいです・・・）</p>

<p>あっ、当たり前ですが、Vagrant で VM を複数管理するときは、 ポート番号を全部バラバラにしないといけません。（当たり前）</p>

<pre><code>vagrant ssh-config &gt;&gt; ~/.ssh/config
</code></pre>

<p>上記コマンドで設定を勝手に吐き出して追記してくれる便利なコマンドが用意されていますが、 複数 VM を想定したものになっていない（と思われる）ため、 例えば apple_vm, banana_vm の設定を順に追記してのち、 banana_vm に SSH してたつもりが、ずっと apple_vm に SSH してたことになってた、 なんてことが起こるかもしれません。（体験談）</p>

<p>接続ではまらないためにも、<strong>VM にアクセスするためのポート番号と VM 作成時の IP アドレスは きちんと管理</strong>すると良いと思います。</p>

<h3 id="レシピの適用は-vagrant-provision-よりも-knife-コマンドで">レシピの適用は vagrant provision よりも knife コマンドで</h3>

<p>Vagrant はあくまで<strong>仮想マシン（VM）をコマンドラインで統一的に扱えるインターフェース</strong>なので、 仮想マシンの管理に徹した方がすっきりします。</p>

<p>以下は、Vagrant 1.6.5 で vagrant init したときの初期設定（コメント付き）を抜粋したものです。</p>

<pre><code>config.vm.provision &quot;chef_solo&quot; do |chef|
  chef.cookbooks_path = &quot;../my-recipes/cookbooks&quot;
  chef.roles_path = &quot;../my-recipes/roles&quot;
  chef.data_bags_path = &quot;../my-recipes/data_bags&quot;
  chef.add_recipe &quot;mysql&quot;
  chef.add_role &quot;web&quot;

  # You may also specify custom JSON attributes:
  chef.json = { mysql_password: &quot;foo&quot; }
end
</code></pre>

<p>このような形で、レシピの変更があるたびに Vagrantfile を触るというのは、 なんというか本質的ではないので、あくまで Vagrantfile には以下の情報のみが書かれているのが望ましいのでは？と思っています。（もちろん追加で synced_folder とか）</p>

<ul>
<li>vm.hostname（名前）</li>
<li>vm.box = &#8220;chef/centos-6.6&#8243;（box ファイル用）</li>
<li>vm.network :forwarded_port, id: &#8220;ssh&#8221;, host: 12345, guest: 22（Vagrant 用ポート番号）</li>
<li>vm.network :forwarded_port, host: 8080, guest: 80（HTTP 用ポート番号）</li>
<li>vm.network :private_network, ip: &#8220;192.168.24.24&#8221;（IP アドレス）</li>
</ul>

<p>2つ目のところは自分が使いたい box ファイルを URL で指定すれば良いらしいですが、 以下に公開されているところを名前を指定するだけでも OK です。</p>

<p><a href="https://vagrantcloud.com/boxes/search" target="_blank">https://vagrantcloud.com/boxes/search</a></p>

<p>ちょっと脱線しましたが、<strong>Vagrantfile 上には仮想マシンの定義のみをできるだけシンプルに管理しつつ、 レシピの適用は knife コマンドを用いて行った方がスムーズ</strong>だと思います。</p>

<p>こちらの方法のメリットとして、上記の運用想定の Vagrant 管理において、 ローカル環境、本番環境とで同一の knife コマンドでレシピの適用ができるため、 レシピの適用方法が、適用先の環境に依存することなくスムーズにレシピ適用できる点があると思います。</p>

<p>また、仮想マシンが起動中に Vagrantfile の設定変更を行ってしまうことで、 うまく再起動などができなくなるケースが出てきます。 （例えば Vagrant 自身が SSH で接続するポート番号を途中で変えてしまうなど） <strong>起動中に Vagrantfile はできるだけ触らない方が良い</strong>のではないかと思います。</p>

<p>ただ、vagrant provision でレシピを適用できるようにしておくと、 一通り GUI で扱えるようにしておいた場合に、 コマンドラインが苦手な人とも一緒に扱えるという利点が出てくる場合もあり得ます。</p>

<p>とはいえ、knife コマンドに慣れておいて損はないかなと、使ってみてそう思っています。 （この辺の掘り下げた話も追い追いで・・・）</p>

<h2 id="まとめ">まとめ</h2>

<p>時間もそこまで取れなかったので、とりあえず自分なりの思想的なところまでをまとめてみました。</p>

<p>実際まだまだ書ききれないことも多く、 例えば Vagrant のプラグインでこれ入れておくとこういうシーンで便利とか、 Web サーバにおいて、Vagrant 特有のはまりポイントと解決方法など、 過去に書いた記事の疑問点もだいぶ解消されてきたところもあるので、 改めてまとめ直したいと思います。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2015年3月3日">2015年3月3日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2014年8月12日">2014年8月12日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/automation/">automation</a></li>
  </ul>
</div>




<p>どうしても環境を変えられず SSH のパスフレーズを手動入力せざるをえないときってありますよね？</p>

<p>それが1回、2回であればまだ良いのですが、ある程度定期的に SSH でログインしてあれこれやらなきゃいけないってなると、もう発狂ものです。</p>

<p>こういったケースはときどき発生するのですが、<strong>実は自動入力出来る方法がある</strong>ってことをふいに知ったのでメモっておきます。</p>

<p>※数ヶ月前の話ですが、それでもブログに記録を残しておいた方が良いと思ったので、タイミングずれましたが書いておきます。</p>

<h2 id="ssh-でのログインの仕方">SSH でのログインの仕方</h2>

<p>先に、普通に SSH でログインする方法とベストな選択肢に触れておきます。</p>

<p>一番シンプルに使うのなら、以下の方法ですね。</p>

<pre><code>ssh -p 12345 user@example.com
</code></pre>

<p>ユーザー名: user、ポート番号: 12345 のとき、パスフレーズなしで公開鍵認証の設定がしてあれば、このままログイン出来るはずです。</p>

<h3 id="毎回やることが決まっているとき">毎回やることが決まっているとき</h3>

<p>これも今回のケースが解決してから知ったので余談になりますが、 ログイン先のサーバにて公開鍵を載せておくファイル、<code>.ssh/authorized_keys</code> に <code>command=&quot;command&quot;</code> といった形式でコマンドを書いておくと、<strong>ここに書かれたコマンドしか実行出来なくなる</strong>ようです。</p>

<p>今度改めて調べてみようかな。</p>

<h2 id="手動入力を強いられているんだ">手動入力を強いられているんだ！</h2>

<p>さて、上記の SSH によるログインで、パスフレーズが設定されていた場合、</p>

<pre><code>user@example.com's password: 
</code></pre>

<p>こんな感じに、「パスフレーズを入力してね？」と表示されるわけですが、 毎回毎回与えられたパスフレーズをテキストファイルからコピってターミナルに貼付けて・・・とやっていると、<strong>段々と強いられている感がじわじわきて心情的にもよろしくありません。</strong></p>

<p>実はこちら、<strong>expect, spawn, send</strong> あたりのコマンドを使うことにより、手動想定のインタラクティブな入力画面においても、自動で入力、その後のコマンドが実行できます。（全部使ったことなかった・・・）</p>

<h3 id="expect-コマンド">expect コマンド</h3>

<p>期待した入力と一致した場合に、任意のコマンドを実行できます。</p>

<p>-c オプションとともにコマンドを渡すことが出来ます。さらにこのコマンド内で interact コマンドを呼ぶと、処理をシェルに戻してくれると。</p>

<h3 id="spawn-コマンド">spawn コマンド</h3>

<p>後に続くコマンドを送り先で実行します。expect コマンドとセットで使うこと前提なんですかね？</p>

<h3 id="send-コマンド">send コマンド</h3>

<p>今回のようなケースでは、expect コマンドの後に実際の入力待ちで入力を行う場合などに使います。</p>

<h3 id="組み合わせ例">組み合わせ例</h3>

<pre><code>expect -c &quot;
spawn command arg1 arg2
expect \&quot;user@example.com's password: \&quot;
sleep 1
send \&quot;passphrase123\n\&quot;
interact
&quot;
</code></pre>

<p>あとは、これを例えばシェルコマンドとしてファイルにまとめておいて、任意のタイミングで実行してあげれば良いだけですね。</p>

<p>内部の expect コマンドで「パスフレーズを入力してね？」と聞かれた際に、 予めこういうテキストが入力されたら、と用意されているところにマッチするので、パスフレーズを send コマンドで送ってくれます。<strong>自動化最高。</strong></p>

<h2 id="まとめ">まとめ</h2>

<p>『なぜ知らなかった』の一言に尽きます。</p>

<p>今度機会があれば、もうちょっと掘り下げて使えるようになりたいですね！</p>

<h2 id="ref">参考URL</h2>

<ul>
<li><a href="http://www.uetyi.mydns.jp/wordpress/command/entry-158.html" target="_blank">expectコマンドの使い方 – No:158 – Linuxで自宅サーバ構築（新森からの雑記）</a></li>
<li><a href="http://blog.wnotes.net/blog/article/expect-other-programs" target="_blank">http://blog.wnotes.net/blog/article/expect-other-programs</a></li>
<li><a href="http://d.hatena.ne.jp/lurker/20060728/1154093951" target="_blank">http://d.hatena.ne.jp/lurker/20060728/1154093951</a></li>
</ul>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2014年8月12日">2014年8月12日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/automation/">automation</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>

<div class="poststatus">
  <p>  <time datetime="2013年7月26日">2013年7月26日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>




<p>2015/04/01追記：続き書きました。<a href="/archives/1749/">Vagrant で SSH の接続ポート番号を変える、という発想がそもそも間違ってた</a></p>

<p>最近は、隙を見つけて（あんまりないけど） Vagrant + Chef で色々検証をしてたりします。</p>

<p>現実のサーバ構築になるべく即した形でレシピを書こうとしたとき、 <strong>SSH のポート番号を変更する</strong>、といったケースは往々にして出てくるかと思います。（デフォルトは22ですが、そのまま22を使うとアタックを受けやすくなるので変えましょう、という記事は山のようにありますね）</p>

<p><a href="http://easyramble.com/change-ssh-port-number.html" target="_blank">SSH 接続のポート番号を変更 | EasyRamble</a></p>

<p>ただ、Vagrant で SSH のポート番号を変更すると、ちょっとしたところではまってしまって 思いのほか時間がかかったところがあったので、その部分だけメモっておきたいと思います。</p>

<p>なお、CentOS 6 での検証です。他のディストリビューションで設定ファイルなどが異なる可能性はありますが、考え方などはほぼ共通しているかと思いますので、適宜置き換えて考えていただければと思います。</p>

<h2 id="通常のサーバの設定箇所">通常のサーバの設定箇所</h2>

<p>まず、Vagrant などを使わずに設定する場合、どのファイルをいじる必要があるかというと、以下のファイルになるかと思います。</p>

<ol>
<li>/etc/ssh/sshd_config</li>
<li>/etc/sysconfig/iptables</li>
</ol>

<p>1.は、SSH のポート番号を何番にするか？などの設定ファイルです。（もちろん他にも色々項目ありますが）</p>

<p>こちらに、</p>

<pre><code>Port 22
</code></pre>

<p>という設定が書かれているので、これを適当な番号、</p>

<pre><code>Port 12424
</code></pre>

<p>などとして、 <code>/etc/init.d/sshd restart</code> で SSH のサービスを再起動することで設定が有効になります。</p>

<p>2.は、そのポート番号の通信を許可するかどうか？などの設定ファイルです。</p>

<p>こちらに、</p>

<pre><code>-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
</code></pre>

<p>という設定が書かれているので、こちらも先ほどの番号に合わせる形で</p>

<pre><code>-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 12424 -j ACCEPT
</code></pre>

<p>などとします。 こちらも同様に <code>/etc/init.d/networking restart</code> でネットワークの再起動をすることで設定が有効になります。</p>

<p>ここまでは特に新しいことではなく、&#8221;linux ssh ポート 変更&#8221; とか、&#8221;linux iptables&#8221; とかでググればたくさんありますので、紹介程度にとどめておきます。</p>

<h2 id="vagrant-chef-で行う場合">Vagrant + Chef で行う場合</h2>

<p>今までの記事、<a href="http://girigiribauer.localhost/archives/1048" target="_blank">http://girigiribauer.localhost/archives/1048</a> などを見てもらえれば分かるように、 各 Resource のうち、以下だけで上記レシピは書くことができるはずです。</p>

<ul>
<li>file（ファイルの設置）</li>
<li>service（サービスの起動・停止・再起動）</li>
</ul>

<p>ですが、結論から言うと、 SSH のポート番号を変えた際に、vagrant コマンド経由で仮想マシンへの接続が出来なくなってしまい、 （正確には、ポート番号を変えてサービスの再起動を行ったタイミングですね） 結果として上手くいきませんでした。</p>

<p>具体的には、<code>vagrant up</code> にて、最初のレシピが実行され、<code>vagrant up</code> の終了までは上手くいきます。 ですが、そこから <code>vagrant halt</code> や、<code>vagrant reload</code> などを行っても、そもそも仮想マシンとの通信が上手くいかなくなってしまい、最終的には <code>vagrant destroy</code> で世界の終わりを迎えるしかなくなってしまいます。</p>

<p>うーん、困りましたね。みなさんどうしているのでしょうか？</p>

<h3 id="vagrant-up-などで使うポート">vagrant up などで使うポート</h3>

<p><code>vagrant up</code> や、<code>vagrant halt</code> 、または <code>vagrant reload</code> のコマンドで仮想マシンに接続するのですが、 こちらの接続にも（おそらく）SSH が使われています。 デフォルトで22番ポートを使用することになるかと思います。</p>

<p>1回も仮想マシンを動かしておらず、Chef のレシピも実行されていないとき、仮想マシンのセットアップ処理が走ります。</p>

<p>結果として、vagrant という名前のユーザーとともに、すべて初期の設定ファイルが設置されるため、 SSH の接続も、最初は22番ポートでせざるをえないのかなーと思います。</p>

<h2 id="解決方法を色々考えてみた">解決方法を色々考えてみた</h2>

<p>まず前置きとして、Vagrantfile に書かれていない SSH の設定項目が存在しています。</p>

<p>ホストOSとゲストOSを SSH で接続する際、ホストOSの22番ポートを使わず、代わりに別の番号（2222番とか）を使用する、<strong>ポートフォワーディング</strong>の設定が暗黙的に行われています。</p>

<ul>
<li>host:2222 =&gt; guest: 22</li>
</ul>

<p>この設定が暗黙的に行われることで、ホスト側の2222番ポートでアクセスすると、ゲスト側である仮想OSの22番ポートに接続される、といった仕組みです。</p>

<p>今回やりたいのは、初回のレシピが実行され、SSH のポート番号が変更された時点で、</p>

<ul>
<li>host: 2222 =&gt; guest: 12424</li>
</ul>

<p>という接続ポート番号の変更を行いたいわけです。</p>

<h2 id="無理っぽくね">無理っぽくね？</h2>

<p>Vagrantfile が解釈されるのは、<code>vagrant up</code> などのコマンドが入力された時点になるかと思います。</p>

<p>その後レシピが実行されて SSH のポート番号が変更になっても、初回実行時はまだ22番ポートで普通に接続しているので、 レシピの実行が終わり、<code>vagrant halt</code> もしくは <code>vagrant reload</code> で再度仮想マシンに接続し直すと、 もうすでにポート番号が変わっていて、22番で接続できなくなっているという状態に陥ります。</p>

<h3 id="vagrantfile-上での-ssh-のポート番号の変更">Vagrantfile 上での SSH のポート番号の変更</h3>

<p>ちなみに、Vagrantfile 上で SSH のポート番号の変更をするには、以下のように書けば良いっぽいです。</p>

<pre><code>ssh_port = 12424

Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;CentOS_6.4_x86_64_Minimal&quot;

  config.ssh.guest_port = ssh_port

  config.vm.define :vmclient1 do |vmclient|

    vmclient.vm.hostname = &quot;vmclient1&quot;
    vmclient.vm.network :private_network, ip: &quot;192.168.100.11&quot;
    vmclient.vm.network :forwarded_port, guest: ssh_port, host: 2222, id: &quot;ssh&quot;
（以下略）
</code></pre>

<p>ゲスト側、つまりレシピが実際に動いている仮想OS上の SSH ポート番号を、変数 ssh_port としてありますが、当然直に書いても動きます。</p>

<p>forwarded_port の設定で、 <strong>id: &#8220;ssh&#8221; と付け加えてやることで、SSH のデフォルトで動くポートフォワーディングの設定の上書きが出来る</strong>ようです。</p>

<h3 id="レシピ実行中に-ssh-のポート番号を変える">レシピ実行中に SSH のポート番号を変える・・・？</h3>

<p>Vagrantfile 上でなんとかレシピの実行中にポート番号変えられないかと色々調べてもみましたが、やはり無理そうです。</p>

<p>となると、 Vagrantfile 上でポート番号を変えるまでは、サービスの再起動などをしてはいけないことになります。</p>

<p>初回だけは、22番ポートを使って接続しつつ、設定ファイルのみ書き換えておき、サービスの再起動は後回し。 その後仮想OSをシャットダウンさせ（<code>vagrant reload</code> だと、この後 Vagrantfile を書き換えるタイミングを見失うので、ここでは <code>vagrant halt</code> でシャットダウンさせる）、 Vagrantfile の、さっきの ssh_port の変数のところを 22 から 12424 などに変え、<code>vagrant up</code> でゲストOSを立ち上げます。</p>

<p>こうすれば、SSH のポート番号の変更が可能になるわけですが、非常にめんどくさい話ですね。</p>

<h2 id="まとめ">まとめ</h2>

<p>本当に何から何まで自動化したい場合は、vagrant コマンドの外側を管理する何かが必要になるんじゃないかなーとか思ってます。 （1回目の起動は22番使って、そこから自動で <code>vagrant halt</code> して、Vagrantfile のポート書き換えて再度 <code>vagrant up</code> してくれる何か）</p>

<p>とはいっても、そこまで厳密にワンストップですべて自動化したいかと言われると、そうでもなかったりするので、 SSH のポート番号を変えたいときは、以下の手順でやろうと思いました。</p>

<ol>
<li><strong>初回だけ22番</strong>で動かし、ssh の設定を走らせる（<strong>サービスの再起動はしない</strong>）</li>
<li><code>vagrant halt</code> で一旦シャットダウンする</li>
<li>Vagrantfile の<strong>ポート部分書き換え</strong></li>
<li>普通に <code>vagrant up</code></li>
</ol>

<p>逆になんかいい方法あれば教えてほしいです。ぜひ。</p>


<ul class="socialbuttons">
  <li class="flow">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja" data-count="vertical">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </li>
  <li class="flow">
    <div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="false" data-share="false"></div>
  </li>
  <li class="flow">
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
</ul>

<div class="poststatus">
  <p>  <time datetime="2013年7月26日">2013年7月26日</time>
</p>

  <ul class="tags">
    <li class="flow"><a href="/tags/chef/">Chef</a></li>
    <li class="flow"><a href="/tags/ssh/">SSH</a></li>
    <li class="flow"><a href="/tags/vagrant/">Vagrant</a></li>
  </ul>
</div>

<small>もし記事内に誤りなどございましたら、 <a href="https://twitter.com/girigiribauer" target="_blank">@girigiribauer</a> までご一報いただけると助かります。</small>







</div>

<footer>

<h2>Tags</h2>

<ul class="tags">
  <li class="flow">
    <a href="/tags/ansible">Ansible (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/apache">Apache (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/cli">CLI (10)</a>
  </li>
  <li class="flow">
    <a href="/tags/css">CSS (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/css3">CSS3 (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/cssfilter">CSSfilter (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/canvas">Canvas (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/chef">Chef (9)</a>
  </li>
  <li class="flow">
    <a href="/tags/crawler">Crawler (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/dom">DOM (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/docker">Docker (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/ftp">FTP (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/font">Font (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/functionallanguage">FunctionalLanguage (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/glsl">GLSL (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/git">Git (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/golang">Golang (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/html">HTML (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/html5">HTML5 (7)</a>
  </li>
  <li class="flow">
    <a href="/tags/html5-outline">HTML5-outline (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/homebrew">Homebrew (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/hugo">Hugo (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/icon-font">Icon-Font (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/javascript">JavaScript (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/linux">Linux (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/mvc">MVC (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/opengraph">OpenGraph (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/php">PHP (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/rdfa">RDFa (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ssh">SSH (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/svg">SVG (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/scala">Scala (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/shellscript">ShellScript (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/smartphone">Smartphone (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/static-site-generator">Static Site Generator (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/vagrant">Vagrant (15)</a>
  </li>
  <li class="flow">
    <a href="/tags/vim">Vim (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualbox">VirtualBox (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualization">Virtualization (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webapp">WebApp (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webaudioapi">WebAudioAPI (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webfont">WebFont (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webgl">WebGL (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webrtc">WebRTC (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/webserver">WebServer (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/yeoman">Yeoman (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/zsh">Zsh (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/ajax">ajax (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/automation">automation (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/bugs">bugs (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/event-conference">event-conference (5)</a>
  </li>
  <li class="flow">
    <a href="/tags/getusermedia">getUserMedia (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/gitconfig">gitconfig (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/ios">iOS (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/iterm">iTerm (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jquery">jQuery (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/jinja2">jinja2 (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jq">jq (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/jsperf">jsperf (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/mediaquery">mediaQuery (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/namespace">namespace (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/oldie">oldIE (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/output">output (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/polyfills">polyfills (4)</a>
  </li>
  <li class="flow">
    <a href="/tags/preloader">preloader (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/rsync">rsync (1)</a>
  </li>
  <li class="flow">
    <a href="/tags/tmux">tmux (3)</a>
  </li>
  <li class="flow">
    <a href="/tags/viewport">viewport (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/vimrc">vimrc (2)</a>
  </li>
  <li class="flow">
    <a href="/tags/virtualization">virtualization (6)</a>
  </li>
  <li class="flow">
    <a href="/tags/wget">wget (1)</a>
  </li>
</ul>

<h2>Categories</h2>

<ul>
  <li>
    <a href="/categories/tech/">Category / Tech</a>
  </li>
  <li>
    <a href="/categories/twentyfour/">Category / TwentyFour</a>
  </li>
</ul>

<h2>RSS</h2>

<ul>
  <li>
    <a href="/categories/tech/index.xml" target="_blank">RSS: Category / Tech</a>
  </li>
  <li>
    <a href="/index.xml" target="_blank">RSS: All articles</a>
  </li>
</ul>

<p>このブログは個人の見解であり、所属する組織の公式見解ではありません</p>
<p>&copy; ばうあーろぐ Generated by <a href="https://gohugo.io/" target="_blank">Hugo</a> and <a href="https://github.com/sindresorhus/github-markdown-css" target="_blank">github-markdown-css</a></p>

</footer>

</div>


<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36767095-1']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>



  </body>
</html>


